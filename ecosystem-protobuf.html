<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protobuf 数据序列化 - Go 学习教程</title>
    <link rel="stylesheet" href="styles.css?v=1.4">
    </head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- 导航栏将通过JavaScript动态加载 -->
    </aside>
                <div class="content">
            <a href="ecosystem.html" class="back-link">← 返回社区库</a>
            <h2 id="protobuf">Protobuf 数据序列化</h2>
            <p>Protocol Buffers (Protobuf) 是 Google 开发的一种语言无关、平台无关的序列化结构数据的方法。</p>
            
            <h3>快速开始</h3>
            <pre><code><span class="comment">// 安装 protoc 编译器</span>
<span class="comment">// macOS: brew install protobuf</span>
<span class="comment">// Ubuntu: apt-get install protobuf-compiler</span>

<span class="comment">// 安装 Go 插件</span>
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></pre>
            
            <h3>定义 .proto 文件</h3>
            <pre><code><span class="comment">// user.proto</span>
syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> user;

<span class="keyword">option</span> go_package = <span class="string">"./user"</span>;

<span class="keyword">message</span> User {
    <span class="keyword">int32</span> id = 1;
    <span class="keyword">string</span> name = 2;
    <span class="keyword">string</span> email = 3;
    <span class="keyword">repeated</span> <span class="keyword">string</span> tags = 4;
    <span class="keyword">enum</span> Status {
        UNKNOWN = 0;
        ACTIVE = 1;
        INACTIVE = 2;
    }
    Status status = 5;
}

<span class="keyword">message</span> GetUserRequest {
    <span class="keyword">int32</span> id = 1;
}

<span class="keyword">message</span> GetUserResponse {
    User user = 1;
}</code></pre>
            
            <h3>生成 Go 代码</h3>
            <pre><code><span class="comment">// 生成代码</span>
protoc --go_out=. --go_opt=paths=source_relative \
       --go-grpc_out=. --go-grpc_opt=paths=source_relative \
       user.proto</code></pre>
            
            <h3>序列化和反序列化</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"google.golang.org/protobuf/proto"</span>
    <span class="string">"path/to/user"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建消息</span>
    u := &user.User{
        Id:    1,
        Name:  <span class="string">"张三"</span>,
        Email: <span class="string">"zhangsan@example.com"</span>,
        Tags:  []<span class="keyword">string</span>{<span class="string">"admin"</span>, <span class="string">"user"</span>},
        Status: user.User_ACTIVE,
    }
    
    <span class="comment">// 序列化</span>
    data, err := proto.<span class="function">Marshal</span>(u)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"序列化结果: %x\n"</span>, data)
    
    <span class="comment">// 反序列化</span>
    <span class="keyword">var</span> u2 user.User
    err = proto.<span class="function">Unmarshal</span>(data, &u2)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"反序列化结果: %+v\n"</span>, u2)
}</code></pre>
            
            <h3>Protobuf 最佳实践</h3>
            <div class="note-box">
                <h4>1. 字段编号规范</h4>
                <pre><code><span class="comment">// 1-15: 单字节编码，常用字段</span>
<span class="comment">// 16-2047: 两字节编码，不常用字段</span>
<span class="comment">// 保留字段编号：19000-19999</span>

<span class="keyword">message</span> User {
    <span class="keyword">string</span> name = 1;   <span class="comment">// 常用字段</span>
    <span class="keyword">string</span> email = 2;  <span class="comment">// 常用字段</span>
    <span class="keyword">string</span> phone = 16; <span class="comment">// 不常用字段</span>
}</code></pre>
                
                <h4>2. 使用 oneof</h4>
                <pre><code><span class="keyword">message</span> Result {
    <span class="keyword">oneof</span> result {
        <span class="keyword">string</span> error = 1;
        <span class="keyword">string</span> data = 2;
    }
}</code></pre>
                
                <h4>3. 使用 map</h4>
                <pre><code><span class="keyword">message</span> User {
    <span class="keyword">map</span>&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; metadata = 10;
}</code></pre>
                
                <h4>4. 版本兼容性</h4>
                <pre><code><span class="comment">// 新增字段时使用 optional</span>
<span class="keyword">message</span> User {
    <span class="keyword">string</span> name = 1;
    <span class="keyword">optional</span> <span class="keyword">string</span> nickname = 10; <span class="comment">// 新增字段</span>
}

<span class="comment">// 保留废弃字段</span>
<span class="keyword">message</span> User {
    <span class="keyword">int32</span> old_id = 1 [deprecated = <span class="keyword">true</span>];
    <span class="keyword">string</span> new_id = 2;
}</code></pre>
            </div>

            
        </div>
    </div>
<script src="code-collapse.js"></script>

</body>
    <script src="navigation.js"></script>
</html>