<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åŒºåº“ - Go å­¦ä¹ æ•™ç¨‹</title>
    <link rel="stylesheet" href="styles.css?v=1.3">
    <script src="scroll.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h3>ğŸ“š å­¦ä¹ ç›®å½•</h3>
            <ul>
                <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
                
                                <li class="level-1">
                    <span class="level-badge">é˜¶æ®µä¸€ï¼šå…¥é—¨</span>
                </li>
                <li class="nav-item">
                    <a href="introduction.html"><span>ğŸ“– 1. Go è¯­è¨€ç®€ä»‹</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="introduction.html#history">Go çš„å†å²</a></li>
                        <li><a href="introduction.html#features">Go çš„ç‰¹ç‚¹</a></li>
                        <li><a href="introduction.html#install">å®‰è£…ä¸é…ç½®</a></li>
                        <li><a href="introduction.html#helloworld">Hello World</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="basics.html"><span>ğŸ”¤ 2. åŸºç¡€è¯­æ³•</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="basics.html#variables">å˜é‡å£°æ˜</a></li>
                        <li><a href="basics.html#datatypes">æ•°æ®ç±»å‹</a></li>
                        <li><a href="basics.html#operators">è¿ç®—ç¬¦</a></li>
                        <li><a href="basics.html#arrays">æ•°ç»„ä¸åˆ‡ç‰‡</a></li>
                        <li><a href="basics.html#maps">æ˜ å°„</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="control-flow.html"><span>ğŸ”„ 3. æ§åˆ¶æµ</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="control-flow.html#if">if è¯­å¥</a></li>
                        <li><a href="control-flow.html#switch">switch è¯­å¥</a></li>
                        <li><a href="control-flow.html#for">for å¾ªç¯</a></li>
                        <li><a href="control-flow.html#defer">defer è¯­å¥</a></li>
                    </ul>
                </li>
                <li class="level-1">
                    <span class="level-badge">é˜¶æ®µäºŒï¼šè¿›é˜¶</span>
                </li>
                <li class="nav-item">
                    <a href="functions.html"><span>âš¡ 4. å‡½æ•°</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="functions.html#basic">åŸºæœ¬å‡½æ•°</a></li>
                        <li><a href="functions.html#multiple">å¤šè¿”å›å€¼</a></li>
                        <li><a href="functions.html#variadic">å¯å˜å‚æ•°</a></li>
                        <li><a href="functions.html#closure">é—­åŒ…</a></li>
                        <li><a href="functions.html#methods">æ–¹æ³•</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="structs.html"><span>ğŸ—ï¸ 5. ç»“æ„ä½“ä¸æ¥å£</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="structs.html#struct">ç»“æ„ä½“</a></li>
                        <li><a href="structs.html#nested">åµŒå¥—ç»“æ„ä½“</a></li>
                        <li><a href="structs.html#methods">ç»“æ„ä½“æ–¹æ³•</a></li>
                        <li><a href="structs.html#interface">æ¥å£</a></li>
                        <li><a href="structs.html#tags">ç»“æ„ä½“æ ‡ç­¾</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="modules.html"><span>ğŸ“¦ 6. æ¨¡å—åŒ–ä¸ Go Module</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="modules.html#introduction">Go Module ç®€ä»‹</a></li>
                        <li><a href="modules.html#init">åˆå§‹åŒ– Module</a></li>
                        <li><a href="modules.html#dependency">ä¾èµ–ç®¡ç†</a></li>
                        <li><a href="modules.html#version">ç‰ˆæœ¬æ§åˆ¶</a></li>
                        <li><a href="modules.html#private">ç§æœ‰ Module</a></li>
                    </ul>
                </li>
                <li class="level-1">
                    <span class="level-badge">é˜¶æ®µä¸‰ï¼šé«˜çº§</span>
                </li>
                <li class="nav-item">
                    <a href="concurrency.html"><span>ğŸš€ 8. å¹¶å‘ç¼–ç¨‹</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="concurrency.html#goroutine">Goroutine</a></li>
                        <li><a href="concurrency.html#channel">Channel</a></li>
                        <li><a href="concurrency.html#select">Select</a></li>
                        <li><a href="concurrency.html#mutex">äº’æ–¥é”</a></li>
                        <li><a href="concurrency.html#context">Context</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="stdlib.html"><span>ğŸ“š 9. å¸¸ç”¨æ ‡å‡†åº“</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="stdlib.html#regexp">regexp æ­£åˆ™è¡¨è¾¾å¼</a></li>
                        <li><a href="stdlib.html#sync">sync å¹¶å‘åŸè¯­</a></li>
                        <li><a href="stdlib.html#json">json æ•°æ®ç¼–ç </a></li>
                        <li><a href="stdlib.html#time">time æ—¶é—´å¤„ç†</a></li>
                        <li><a href="stdlib.html#io">io è¾“å…¥è¾“å‡º</a></li>
                        <li><a href="stdlib.html#bufio">bufio ç¼“å†² I/O</a></li>
                        <li><a href="stdlib.html#exp">exp å®éªŒæ€§åº“</a></li>
                        <li><a href="stdlib.html#embed">embed æ–‡ä»¶åµŒå…¥</a></li>
                        <li><a href="stdlib.html#bestpractices">æœ€ä½³å®è·µ</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="tips.html"><span>ğŸ’¡ 10. å¸¸ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="tips.html#idioms">æƒ¯ç”¨æ¨¡å¼</a></li>
                        <li><a href="tips.html#performance">æ€§èƒ½ä¼˜åŒ–</a></li>
                        <li><a href="tips.html#error">é”™è¯¯å¤„ç†</a></li>
                        <li><a href="tips.html#testing">æµ‹è¯•æŠ€å·§</a></li>
                        <li><a href="tips.html#debug">è°ƒè¯•æŠ€å·§</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="ecosystem.html"><span>ğŸŒ 11. ç¤¾åŒºåº“</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="ecosystem.html#gin">Gin Web æ¡†æ¶</a></li>
                        <li><a href="ecosystem.html#gorm">GORM ORM</a></li>
                        <li><a href="ecosystem.html#viper">Viper é…ç½®</a></li>
                        <li><a href="ecosystem.html#zap">Zap æ—¥å¿—</a></li>
                        <li><a href="ecosystem.html#validator">Validator å‚æ•°æ ¡éªŒ</a></li>
                        <li><a href="ecosystem.html#cobra">Cobra å‘½ä»¤è¡Œå·¥å…·</a></li>
                        <li><a href="ecosystem.html#gomicro">Go-Micro å¾®æœåŠ¡</a></li>
                        <li><a href="ecosystem.html#etcd">Etcd åˆ†å¸ƒå¼å­˜å‚¨</a></li>
                                                <li><a href="ecosystem.html#protobuf">Protobuf æ•°æ®åºåˆ—åŒ–</a></li>
                        <li><a href="ecosystem.html#redis">Redis å®¢æˆ·ç«¯</a></li>
                        <li><a href="ecosystem.html#mysql">MySQL å®¢æˆ·ç«¯</a></li>
                        <li><a href="ecosystem.html#bestpractices">æœ€ä½³å®è·µ</a></li>
                    </ul>
                </li><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="generics.html#functions">æ³›å‹å‡½æ•°</a></li>
                        <li><a href="generics.html#types">æ³›å‹ç±»å‹</a></li>
                        <li><a href="generics.html#constraints">ç±»å‹çº¦æŸ</a></li>
                        <li><a href="generics.html#inference">ç±»å‹æ¨æ–­</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="reflection.html"><span>ğŸ” 13. åå°„</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="reflection.html#typevalue">Type å’Œ Value</a></li>
                        <li><a href="reflection.html#struct">ç»“æ„ä½“åå°„</a></li>
                        <li><a href="reflection.html#modify">ä¿®æ”¹å€¼</a></li>
                        <li><a href="reflection.html#methods">è°ƒç”¨æ–¹æ³•</a></li>
                        <li><a href="reflection.html#performance">æ€§èƒ½è€ƒè™‘</a></li>
                    </ul>
                </li>

        </aside>
        <div class="content">
            <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <h1>ç¤¾åŒºåº“</h1>
            
            <p>Go è¯­è¨€æ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºå’Œä¸°å¯Œçš„ç¬¬ä¸‰æ–¹åº“ã€‚æœ¬ç« å°†ä»‹ç» Go ç”Ÿæ€ä¸­æœ€æµè¡Œçš„å‡ ä¸ªåº“ï¼šGinï¼ˆWeb æ¡†æ¶ï¼‰ã€GORMï¼ˆORMï¼‰ã€Viperï¼ˆé…ç½®ï¼‰å’Œ Zapï¼ˆæ—¥å¿—ï¼‰ã€‚</p>

            <h2 id="gin">Gin Web æ¡†æ¶</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>Gin æ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„é«˜æ€§èƒ½ HTTP Web æ¡†æ¶ï¼Œå…·æœ‰ç±»ä¼¼ Martini çš„ APIï¼Œä½†æ€§èƒ½æ›´å¥½ï¼ˆé«˜è¾¾ 40 å€ï¼‰ã€‚å®ƒæä¾›äº†è·¯ç”±ã€ä¸­é—´ä»¶ã€JSON éªŒè¯ç­‰åŠŸèƒ½ï¼Œæ˜¯ Go ç¤¾åŒºæœ€æµè¡Œçš„ Web æ¡†æ¶ä¹‹ä¸€ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/gin-gonic/gin</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºé»˜è®¤è·¯ç”±</span>
    r := gin.<span class="function">Default</span>()

    <span class="comment">// å®šä¹‰è·¯ç”±</span>
    r.<span class="function">GET</span>(<span class="string">"/ping"</span>, <span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{
            <span class="string">"message"</span>: <span class="string">"pong"</span>,
        })
    })

    <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span>
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>è·¯ç”±</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()

    <span class="comment">// GET è¯·æ±‚</span>
    r.<span class="function">GET</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{
            <span class="string">"users"</span>: []<span class="keyword">string</span>{<span class="string">"Alice"</span>, <span class="string">"Bob"</span>},
        })
    })

    <span class="comment">// POST è¯·æ±‚</span>
    r.<span class="function">POST</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
        <span class="keyword">var</span> user <span class="keyword">struct</span> {
            Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span>
            Email <span class="keyword">string</span> <span class="string">`json:"email"`</span>
        }
        
        <span class="keyword">if</span> err := c.<span class="function">ShouldBindJSON</span>(&user); err != <span class="keyword">nil</span> {
            c.<span class="function">JSON</span>(http.StatusBadRequest, gin.H{<span class="string">"error"</span>: err.<span class="function">Error</span>()})
            <span class="keyword">return</span>
        }
        
        c.<span class="function">JSON</span>(http.StatusCreated, gin.H{
            <span class="string">"message"</span>: <span class="string">"User created"</span>,
            <span class="string">"user"</span>:    user,
        })
    })

    <span class="comment">// è·¯å¾„å‚æ•°</span>
    r.<span class="function">GET</span>(<span class="string">"/users/:id"</span>, <span class="keyword">func</span>(c *gin.Context) {
        id := c.<span class="function">Param</span>(<span class="string">"id"</span>)
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{<span class="string">"id"</span>: id})
    })

    <span class="comment">// æŸ¥è¯¢å‚æ•°</span>
    r.<span class="function">GET</span>(<span class="string">"/search"</span>, <span class="keyword">func</span>(c *gin.Context) {
        query := c.<span class="function">Query</span>(<span class="string">"q"</span>)
        page := c.<span class="function">DefaultQuery</span>(<span class="string">"page"</span>, <span class="string">"1"</span>)
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{
            <span class="string">"query"</span>: query,
            <span class="string">"page"</span>:  page,
        })
    })

    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>ä¸­é—´ä»¶</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
    <span class="string">"time"</span>
)

<span class="comment">// è‡ªå®šä¹‰ä¸­é—´ä»¶</span>
<span class="function">func</span> <span class="function">Logger</span>() gin.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(c *gin.Context) {
        start := time.<span class="function">Now</span>()
        
        c.<span class="function">Next</span>()
        
        latency := time.<span class="function">Since</span>(start)
        fmt.<span class="function">Printf</span>(<span class="string">"%s %s %v\n"</span>, c.<span class="function">Request</span>.Method, c.<span class="function">Request</span>.URL.Path, latency)
    }
}

<span class="comment">// è®¤è¯ä¸­é—´ä»¶</span>
<span class="function">func</span> <span class="function">AuthMiddleware</span>() gin.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(c *gin.Context) {
        token := c.<span class="function">GetHeader</span>(<span class="string">"Authorization"</span>)
        
        <span class="keyword">if</span> token == <span class="string">""</span> {
            c.<span class="function">JSON</span>(http.StatusUnauthorized, gin.H{<span class="string">"error"</span>: <span class="string">"Unauthorized"</span>})
            c.<span class="function">Abort</span>()
            <span class="keyword">return</span>
        }
        
        c.<span class="function">Set</span>(<span class="string">"user_id"</span>, <span class="string">"123"</span>)
        c.<span class="function">Next</span>()
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// å…¨å±€ä¸­é—´ä»¶</span>
    r.<span class="function">Use</span>(<span class="function">Logger</span>())
    
    <span class="comment">// è·¯ç”±ç»„</span>
    api := r.<span class="function">Group</span>(<span class="string">"/api"</span>)
    api.<span class="function">Use</span>(<span class="function">AuthMiddleware</span>())
    
    api.<span class="function">GET</span>(<span class="string">"/profile"</span>, <span class="keyword">func</span>(c *gin.Context) {
        userID := c.<span class="function">GetString</span>(<span class="string">"user_id"</span>)
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{<span class="string">"user_id"</span>: userID})
    })
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>è·¯ç”±ç»„</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// v1 è·¯ç”±ç»„</span>
    v1 := r.<span class="function">Group</span>(<span class="string">"/v1"</span>)
    {
        v1.<span class="function">GET</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v1 users"</span>)
        })
        v1.<span class="function">GET</span>(<span class="string">"/posts"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v1 posts"</span>)
        })
    }
    
    <span class="comment">// v2 è·¯ç”±ç»„</span>
    v2 := r.<span class="function">Group</span>(<span class="string">"/v2"</span>)
    {
        v2.<span class="function">GET</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v2 users"</span>)
        })
        v2.<span class="function">GET</span>(<span class="string">"/posts"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v2 posts"</span>)
        })
    }
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>é”™è¯¯å¤„ç†</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// è‡ªå®šä¹‰é”™è¯¯å¤„ç†</span>
    r.<span class="function">NoRoute</span>(<span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusNotFound, gin.H{
            <span class="string">"error"</span>: <span class="string">"Route not found"</span>,
        })
    })
    
    r.<span class="function">NoMethod</span>(<span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusMethodNotAllowed, gin.H{
            <span class="string">"error"</span>: <span class="string">"Method not allowed"</span>,
        })
    })
    
    <span class="comment">// Panic æ¢å¤</span>
    r.<span class="function">Use</span>(gin.<span class="function">Recovery</span>())
    
    r.<span class="function">GET</span>(<span class="string">"/panic"</span>, <span class="keyword">func</span>(c *gin.Context) {
        <span class="function">panic</span>(<span class="string">"Something went wrong"</span>)
    })
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h2 id="gorm">GORM ORM</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>GORM æ˜¯ Go è¯­è¨€ä¸­æœ€æµè¡Œçš„ ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰åº“ï¼Œæä¾›äº†å‹å¥½çš„ APIï¼Œæ”¯æŒå¤šç§æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLã€SQLiteã€SQL Server ç­‰ï¼‰ï¼Œå¹¶åŒ…å«è‡ªåŠ¨è¿ç§»ã€å…³è”ã€é’©å­ç­‰åŠŸèƒ½ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get -u gorm.io/gorm
<span class="keyword">go</span> get -u gorm.io/driver/mysql</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"gorm.io/driver/mysql"</span>
    <span class="string">"gorm.io/gorm"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID       <span class="keyword">uint</span>   <span class="string">`gorm:"primaryKey"`</span>
    Name     <span class="keyword">string</span> <span class="string">`gorm:"size:255;not null"`</span>
    Email    <span class="keyword">string</span> <span class="string">`gorm:"size:255;uniqueIndex;not null"`</span>
    Age      <span class="keyword">int</span>    <span class="string">`gorm:"default:0"`</span>
    CreatedAt time.Time
    UpdatedAt time.Time
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// è¿æ¥æ•°æ®åº“</span>
    dsn := <span class="string">"user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"</span>
    db, err := gorm.<span class="function">Open</span>(mysql.<span class="function">Open</span>(dsn), &gorm.Config{})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(<span class="string">"Failed to connect database"</span>)
    }
    
    <span class="comment">// è‡ªåŠ¨è¿ç§»</span>
    db.<span class="function">AutoMigrate</span>(&User{})
    
    <span class="comment">// åˆ›å»ºè®°å½•</span>
    user := User{Name: <span class="string">"Alice"</span>, Email: <span class="string">"alice@example.com"</span>, Age: <span class="number">25</span>}
    result := db.<span class="function">Create</span>(&user)
    fmt.<span class="function">Println</span>(<span class="string">"Created user ID:"</span>, user.ID)
    fmt.<span class="function">Println</span>(<span class="string">"Rows affected:"</span>, result.RowsAffected)
}</code></pre>
            
            <h3>åˆ›å»ºè®°å½•</h3>
            <pre><code><span class="comment">// åˆ›å»ºå•æ¡è®°å½•</span>
user := User{Name: <span class="string">"Bob"</span>, Email: <span class="string">"bob@example.com"</span>, Age: <span class="number">30</span>}
db.<span class="function">Create</span>(&user)

<span class="comment">// åˆ›å»ºå¤šæ¡è®°å½•</span>
users := []User{
    {Name: <span class="string">"Charlie"</span>, Email: <span class="string">"charlie@example.com"</span>, Age: <span class="number">28</span>},
    {Name: <span class="string">"David"</span>, Email: <span class="string">"david@example.com"</span>, Age: <span class="number">32</span>},
}
db.<span class="function">Create</span>(&users)

<span class="comment">// ä½¿ç”¨ Select æŒ‡å®šå­—æ®µ</span>
db.<span class="function">Select</span>(<span class="string">"Name"</span>, <span class="string">"Email"</span>).<span class="function">Create</span>(&user)

<span class="comment">// ä½¿ç”¨ Omit å¿½ç•¥å­—æ®µ</span>
db.<span class="function">Omit</span>(<span class="string">"Age"</span>).<span class="function">Create</span>(&user)</code></pre>
            
            <h3>æŸ¥è¯¢è®°å½•</h3>
            <pre><code><span class="comment">// æŸ¥è¯¢ç¬¬ä¸€æ¡è®°å½•</span>
<span class="keyword">var</span> user User
db.<span class="function">First</span>(&user)
<span class="comment">// SELECT * FROM users ORDER BY id LIMIT 1;</span>

<span class="comment">// æ ¹æ®ä¸»é”®æŸ¥è¯¢</span>
db.<span class="function">First</span>(&user, <span class="number">1</span>)
<span class="comment">// SELECT * FROM users WHERE id = 1;</span>

<span class="comment">// æŸ¥è¯¢æ‰€æœ‰è®°å½•</span>
<span class="keyword">var</span> users []User
db.<span class="function">Find</span>(&users)
<span class="comment">// SELECT * FROM users;</span>

<span class="comment">// æ¡ä»¶æŸ¥è¯¢</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"Alice"</span>).<span class="function">First</span>(&user)
db.<span class="function">Where</span>(<span class="string">"age > ?"</span>, <span class="number">25</span>).<span class="function">Find</span>(&users)
db.<span class="function">Where</span>(<span class="string">"name LIKE ?"</span>, <span class="string">"%A%"</span>).<span class="function">Find</span>(&users)

<span class="comment">// å¤šæ¡ä»¶</span>
db.<span class="function">Where</span>(<span class="string">"name = ? AND age > ?"</span>, <span class="string">"Alice"</span>, <span class="number">20</span>).<span class="function">First</span>(&user)

<span class="comment">// ä½¿ç”¨ Map</span>
db.<span class="function">Where</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"Alice"</span>, <span class="string">"age"</span>: <span class="number">25</span>}).<span class="function">First</span>(&user)

<span class="comment">// ä½¿ç”¨ Struct</span>
db.<span class="function">Where</span>(User{Name: <span class="string">"Alice"</span>, Age: <span class="number">25</span>}).<span class="function">First</span>(&user)

<span class="comment">// Or æ¡ä»¶</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"Alice"</span>).<span class="function">Or</span>(<span class="string">"name = ?"</span>, <span class="string">"Bob"</span>).<span class="function">Find</span>(&users)

<span class="comment">// Not æ¡ä»¶</span>
db.<span class="function">Not</span>(<span class="string">"name = ?"</span>, <span class="string">"Alice"</span>).<span class="function">Find</span>(&users)

<span class="comment">// æ’åº</span>
db.<span class="function">Order</span>(<span class="string">"age desc"</span>).<span class="function">Find</span>(&users)

<span class="comment">// é™åˆ¶å’Œåç§»</span>
db.<span class="function">Limit</span>(<span class="number">10</span>).<span class="function">Offset</span>(<span class="number">20</span>).<span class="function">Find</span>(&users)

<span class="comment">// ç»Ÿè®¡</span>
<span class="keyword">var</span> count <span class="keyword">int64</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Count</span>(&count)

<span class="comment">// é€‰æ‹©ç‰¹å®šå­—æ®µ</span>
db.<span class="function">Select</span>(<span class="string">"name"</span>, <span class="string">"email"</span>).<span class="function">Find</span>(&users)</code></pre>
            
            <h3>æ›´æ–°è®°å½•</h3>
            <pre><code><span class="comment">// æ›´æ–°å•ä¸ªå­—æ®µ</span>
db.<span class="function">Model</span>(&user).<span class="function">Update</span>(<span class="string">"age"</span>, <span class="number">26</span>)

<span class="comment">// æ›´æ–°å¤šä¸ªå­—æ®µ</span>
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{
    <span class="string">"name"</span>: <span class="string">"Alice Updated"</span>,
    <span class="string">"age"</span>:  <span class="number">26</span>,
})

<span class="comment">// ä½¿ç”¨ Struct æ›´æ–°</span>
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(User{Name: <span class="string">"Alice Updated"</span>, Age: <span class="number">26</span>})

<span class="comment">// åªæ›´æ–°éé›¶å­—æ®µ</span>
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(User{Name: <span class="string">"Alice"</span>})

<span class="comment">// æ›´æ–°æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬é›¶å€¼ï¼‰</span>
db.<span class="function">Model</span>(&user).<span class="function">Select</span>(<span class="string">"*"</span>).<span class="function">Updates</span>(User{Name: <span class="string">""</span>, Age: <span class="number">0</span>})

<span class="comment">// æ¡ä»¶æ›´æ–°</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Where</span>(<span class="string">"age > ?"</span>, <span class="number">20</span>).<span class="function">Update</span>(<span class="string">"status"</span>, <span class="string">"active"</span>)

<span class="comment">// æ‰¹é‡æ›´æ–°</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Where</span>(<span class="string">"age > ?"</span>, <span class="number">20</span>).<span class="function">Updates</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"status"</span>: <span class="string">"active"</span>})</code></pre>
            
            <h3>åˆ é™¤è®°å½•</h3>
            <pre><code><span class="comment">// åˆ é™¤è®°å½•</span>
db.<span class="function">Delete</span>(&user)
<span class="comment">// DELETE FROM users WHERE id = 1;</span>

<span class="comment">// æ ¹æ®ä¸»é”®åˆ é™¤</span>
db.<span class="function">Delete</span>(&User{}, <span class="number">1</span>)

<span class="comment">// æ‰¹é‡åˆ é™¤</span>
db.<span class="function">Where</span>(<span class="string">"age < ?"</span>, <span class="number">18</span>).<span class="function">Delete</span>(&User{})

<span class="comment">// è½¯åˆ é™¤</span>
<span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID        <span class="keyword">uint</span>
    Name      <span class="keyword">string</span>
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}
<span class="comment">// è½¯åˆ é™¤ä¸ä¼šçœŸæ­£åˆ é™¤è®°å½•ï¼Œè€Œæ˜¯è®¾ç½® deleted_at å­—æ®µ</span>

<span class="comment">// æ°¸ä¹…åˆ é™¤</span>
db.<span class="function">Unscoped</span>().<span class="function">Delete</span>(&user)</code></pre>
            
            <h3>å…³è”</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    gorm.Model
    Name   <span class="keyword">string</span>
    Posts  []Post
}

<span class="keyword">type</span> Post <span class="keyword">struct</span> {
    gorm.Model
    Title   <span class="keyword">string</span>
    UserID  <span class="keyword">uint</span>
    User    User
}

<span class="comment">// é¢„åŠ è½½å…³è”</span>
<span class="keyword">var</span> users []User
db.<span class="function">Preload</span>(<span class="string">"Posts"</span>).<span class="function">Find</span>(&users)

<span class="comment">// åˆ›å»ºå…³è”</span>
user := User{Name: <span class="string">"Alice"</span>}
db.<span class="function">Create</span>(&user)
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Append</span>([]Post{
    {Title: <span class="string">"Post 1"</span>},
    {Title: <span class="string">"Post 2"</span>},
})

<span class="comment">// æŸ¥æ‰¾å…³è”</span>
<span class="keyword">var</span> posts []Post
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Find</span>(&posts)

<span class="comment">// æ›¿æ¢å…³è”</span>
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Replace</span>([]Post{
    {Title: <span class="string">"New Post 1"</span>},
})

<span class="comment">// åˆ é™¤å…³è”</span>
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Delete</span>(posts)

<span class="comment">// æ¸…ç©ºå…³è”</span>
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Clear</span>()</code></pre>
            
            <h3>é’©å­</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    gorm.Model
    Name  <span class="keyword">string</span>
    Email <span class="keyword">string</span>
}

<span class="comment">// åˆ›å»ºå‰é’©å­</span>
<span class="function">func</span> (u *User) <span class="function">BeforeCreate</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"Before create:"</span>, u.Name)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// åˆ›å»ºåé’©å­</span>
<span class="function">func</span> (u *User) <span class="function">AfterCreate</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"After create:"</span>, u.ID)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// æ›´æ–°å‰é’©å­</span>
<span class="function">func</span> (u *User) <span class="function">BeforeUpdate</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"Before update:"</span>, u.Name)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// æŸ¥è¯¢å‰é’©å­</span>
<span class="function">func</span> (u *User) <span class="function">AfterFind</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"After find:"</span>, u.Name)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h3>äº‹åŠ¡</h3>
            <pre><code><span class="comment">// è‡ªåŠ¨äº‹åŠ¡</span>
err := db.<span class="function">Transaction</span>(<span class="keyword">func</span>(tx *gorm.DB) <span class="keyword">error</span> {
    <span class="comment">// åˆ›å»ºç”¨æˆ·</span>
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&User{Name: <span class="string">"Alice"</span>}).Error; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="comment">// åˆ›å»ºè®¢å•</span>
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&Order{UserID: <span class="number">1</span>}).Error; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="keyword">return</span> <span class="keyword">nil</span>
})

<span class="comment">// æ‰‹åŠ¨äº‹åŠ¡</span>
tx := db.<span class="function">Begin</span>()

<span class="keyword">if</span> err := tx.<span class="function">Create</span>(&User{Name: <span class="string">"Bob"</span>}).Error; err != <span class="keyword">nil</span> {
    tx.<span class="function">Rollback</span>()
}

<span class="keyword">if</span> err := tx.<span class="function">Commit</span>().Error; err != <span class="keyword">nil</span> {
    tx.<span class="function">Rollback</span>()
}</code></pre>
            
            <h2 id="viper">Viper é…ç½®</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>Viper æ˜¯ Go è¯­è¨€çš„é…ç½®ç®¡ç†åº“ï¼Œæ”¯æŒå¤šç§é…ç½®æ ¼å¼ï¼ˆJSONã€TOMLã€YAMLã€HCLã€envfile ç­‰ï¼‰ï¼Œå¯ä»¥ä»æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°ç­‰å¤šç§æ¥æºè¯»å–é…ç½®ï¼Œå¹¶æ”¯æŒé…ç½®çƒ­é‡è½½ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get github.com/spf13/viper</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// è®¾ç½®é…ç½®æ–‡ä»¶åå’Œè·¯å¾„</span>
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    
    <span class="comment">// è¯»å–é…ç½®æ–‡ä»¶</span>
    <span class="keyword">if</span> err := v.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(fmt.<span class="function">Errorf</span>(<span class="string">"Failed to read config file: %s"</span>, err))
    }
    
    <span class="comment">// è·å–é…ç½®å€¼</span>
    fmt.<span class="function">Println</span>(<span class="string">"Server Port:"</span>, v.<span class="function">GetString</span>(<span class="string">"server.port"</span>))
    fmt.<span class="function">Println</span>(<span class="string">"Database Host:"</span>, v.<span class="function">GetString</span>(<span class="string">"database.host"</span>))
}</code></pre>
            
            <h3>é…ç½®æ–‡ä»¶ç¤ºä¾‹</h3>
            <pre><code><span class="comment"># config.yaml</span>
server:
  port: <span class="number">8080</span>
  host: localhost

database:
  host: localhost
  port: <span class="number">3306</span>
  name: mydb
  user: root
  password: secret

logging:
  level: info
  format: json</code></pre>
            
            <h3>è¯»å–é…ç½®</h3>
            <pre><code><span class="comment">// è·å–å­—ç¬¦ä¸²</span>
port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)

<span class="comment">// è·å–æ•´æ•°</span>
port := v.<span class="function">GetInt</span>(<span class="string">"server.port"</span>)

<span class="comment">// è·å–å¸ƒå°”å€¼</span>
debug := v.<span class="function">GetBool</span>(<span class="string">"debug"</span>)

<span class="comment">// è·å–æµ®ç‚¹æ•°</span>
timeout := v.<span class="function">GetFloat64</span>(<span class="string">"timeout"</span>)

<span class="comment">// è·å–æ—¶é—´</span>
duration := v.<span class="function">GetDuration</span>(<span class="string">"timeout"</span>)

<span class="comment">// è·å–å­—ç¬¦ä¸²åˆ‡ç‰‡</span>
hosts := v.<span class="function">GetStringSlice</span>(<span class="string">"servers.hosts"</span>)

<span class="comment">// è·å–æ‰€æœ‰é…ç½®</span>
all := v.<span class="function">AllSettings</span>()

<span class="comment">// æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨</span>
<span class="keyword">if</span> v.<span class="function">IsSet</span>(<span class="string">"server.port"</span>) {
    port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
}

<span class="comment">// è·å–å­é…ç½®</span>
server := v.<span class="function">Sub</span>(<span class="string">"server"</span>)
port := server.<span class="function">GetString</span>(<span class="string">"port"</span>)</code></pre>
            
            <h3>ç¯å¢ƒå˜é‡</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// ç»‘å®šç¯å¢ƒå˜é‡</span>
    v.<span class="function">BindEnv</span>(<span class="string">"server.port"</span>, <span class="string">"SERVER_PORT"</span>)
    v.<span class="function">BindEnv</span>(<span class="string">"database.host"</span>, <span class="string">"DB_HOST"</span>)
    
    <span class="comment">// è‡ªåŠ¨ç»‘å®šç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨å‰ç¼€ï¼‰</span>
    v.<span class="function">SetEnvPrefix</span>(<span class="string">"APP"</span>)
    v.<span class="function">AutomaticEnv</span>()
    <span class="comment">// APP_SERVER_PORT -> server.port</span>
    
    <span class="comment">// è®¾ç½®é»˜è®¤å€¼</span>
    v.<span class="function">SetDefault</span>(<span class="string">"server.port"</span>, <span class="number">8080</span>)
    v.<span class="function">SetDefault</span>(<span class="string">"debug"</span>, <span class="keyword">false</span>)
    
    <span class="comment">// è¯»å–ç¯å¢ƒå˜é‡</span>
    port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
}</code></pre>
            
            <h3>å‘½ä»¤è¡Œå‚æ•°</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="keyword">var</span> rootCmd = &cobra.Command{
    <span class="function">Run</span>: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
        port := viper.<span class="function">GetInt</span>(<span class="string">"port"</span>)
        fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
    },
}

<span class="function">func</span> <span class="function">init</span>() {
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">Int</span>(<span class="string">"port"</span>, <span class="number">8080</span>, <span class="string">"Server port"</span>)
    viper.<span class="function">BindPFlag</span>(<span class="string">"port"</span>, rootCmd.<span class="function">PersistentFlags</span>().<span class="function">Lookup</span>(<span class="string">"port"</span>))
}

<span class="function">func</span> <span class="function">main</span>() {
    cobra.<span class="function">Execute</span>()
}</code></pre>
            
            <h3>é…ç½®çƒ­é‡è½½</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"log"</span>
    <span class="string">"github.com/fsnotify/fsnotify"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    
    <span class="keyword">if</span> err := v.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    
    <span class="comment">// ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–</span>
    v.<span class="function">OnConfigChange</span>(<span class="keyword">func</span>(e fsnotify.Event) {
        fmt.<span class="function">Printf</span>(<span class="string">"Config file changed: %s\n"</span>, e.Name)
        log.<span class="function">Println</span>(<span class="string">"Reloading config..."</span>)
    })
    
    v.<span class="function">WatchConfig</span>()
    
    <span class="comment">// ä¸»å¾ªç¯</span>
    <span class="keyword">select</span> {}
}</code></pre>
            
            <h3>å¤šé…ç½®æº</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// 1. è®¾ç½®é»˜è®¤å€¼</span>
    v.<span class="function">SetDefault</span>(<span class="string">"server.port"</span>, <span class="number">8080</span>)
    
    <span class="comment">// 2. è¯»å–é…ç½®æ–‡ä»¶</span>
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    v.<span class="function">ReadInConfig</span>()
    
    <span class="comment">// 3. è¯»å–ç¯å¢ƒå˜é‡</span>
    v.<span class="function">SetEnvPrefix</span>(<span class="string">"APP"</span>)
    v.<span class="function">AutomaticEnv</span>()
    
    <span class="comment">// 4. è¯»å–å‘½ä»¤è¡Œå‚æ•°</span>
    <span class="comment">// ä½¿ç”¨ cobra ç»‘å®š</span>
    
    <span class="comment">// ä¼˜å…ˆçº§ï¼šå‘½ä»¤è¡Œå‚æ•° > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼</span>
    port := v.<span class="function">GetInt</span>(<span class="string">"server.port"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
}</code></pre>
            
            <h2 id="zap">Zap æ—¥å¿—</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>Zap æ˜¯ Uber å¼€å‘çš„é«˜æ€§èƒ½ã€ç»“æ„åŒ–æ—¥å¿—åº“ï¼Œä¸“ä¸º Go è¯­è¨€è®¾è®¡ã€‚å®ƒæä¾›äº†é›¶å†…å­˜åˆ†é…çš„æ—¥å¿—è®°å½•å’Œç»“æ„åŒ–æ—¥å¿—æ”¯æŒï¼Œæ€§èƒ½è¿œè¶…æ ‡å‡†åº“çš„ log åŒ…å’Œå…¶ä»–æ—¥å¿—åº“ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get -u go.uber.org/zap
<span class="keyword">go</span> get -u go.uber.org/zap/zapcore</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºå¼€å‘ç¯å¢ƒ logger</span>
    logger, _ := zap.<span class="function">NewDevelopment</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// è®°å½•æ—¥å¿—</span>
    logger.<span class="function">Info</span>(<span class="string">"Hello, World!"</span>)
    logger.<span class="function">Debug</span>(<span class="string">"Debug message"</span>)
    logger.<span class="function">Warn</span>(<span class="string">"Warning message"</span>)
    logger.<span class="function">Error</span>(<span class="string">"Error message"</span>)
}</code></pre>
            
            <h3>ç”Ÿäº§ç¯å¢ƒ Logger</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºç”Ÿäº§ç¯å¢ƒ logger</span>
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// è®°å½•æ—¥å¿—</span>
    logger.<span class="function">Info</span>(<span class="string">"Server started"</span>,
        zap.<span class="function">String</span>(<span class="string">"host"</span>, <span class="string">"localhost"</span>),
        zap.<span class="function">Int</span>(<span class="string">"port"</span>, <span class="number">8080</span>),
    )
}</code></pre>
            
            <h3>è‡ªå®šä¹‰ Logger</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"os"</span>
    
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// è‡ªå®šä¹‰é…ç½®</span>
    config := zap.Config{
        Level:            zap.NewAtomicLevelAt(zapcore.InfoLevel),
        Development:      <span class="keyword">false</span>,
        Encoding:         <span class="string">"json"</span>,
        EncoderConfig: zapcore.EncoderConfig{
            TimeKey:        <span class="string">"timestamp"</span>,
            LevelKey:       <span class="string">"level"</span>,
            NameKey:        <span class="string">"logger"</span>,
            CallerKey:      <span class="string">"caller"</span>,
            MessageKey:     <span class="string">"msg"</span>,
            StacktraceKey:  <span class="string">"stacktrace"</span>,
            LineEnding:     zapcore.DefaultLineEnding,
            EncodeLevel:    zapcore.LowercaseLevelEncoder,
            EncodeTime:     zapcore.ISO8601TimeEncoder,
            EncodeDuration: zapcore.SecondsDurationEncoder,
            EncodeCaller:   zapcore.ShortCallerEncoder,
        },
        OutputPaths:      []<span class="keyword">string</span>{<span class="string">"stdout"</span>},
        ErrorOutputPaths: []<span class="keyword">string</span>{<span class="string">"stderr"</span>},
    }
    
    logger, _ := config.<span class="function">Build</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    logger.<span class="function">Info</span>(<span class="string">"Custom logger initialized"</span>)
}</code></pre>
            
            <h3>ç»“æ„åŒ–æ—¥å¿—</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// æ·»åŠ å­—æ®µ</span>
    logger.<span class="function">Info</span>(<span class="string">"User logged in"</span>,
        zap.<span class="function">String</span>(<span class="string">"user_id"</span>, <span class="string">"123"</span>),
        zap.<span class="function">String</span>(<span class="string">"username"</span>, <span class="string">"alice"</span>),
        zap.<span class="function">String</span>(<span class="string">"ip"</span>, <span class="string">"192.168.1.1"</span>),
    )
    
    <span class="comment">// ä½¿ç”¨ç»“æ„åŒ–å¯¹è±¡</span>
    <span class="keyword">type</span> User <span class="keyword">struct</span> {
        ID    <span class="keyword">string</span>
        Name  <span class="keyword">string</span>
        Email <span class="keyword">string</span>
    }
    
    user := User{ID: <span class="string">"123"</span>, Name: <span class="string">"Alice"</span>, Email: <span class="string">"alice@example.com"</span>}
    logger.<span class="function">Info</span>(<span class="string">"User created"</span>, zap.<span class="function">Any</span>(<span class="string">"user"</span>, user))
}</code></pre>
            
            <h3>æ—¥å¿—çº§åˆ«</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// è®¾ç½®æ—¥å¿—çº§åˆ«</span>
    config := zap.NewProductionConfig()
    config.Level = zap.NewAtomicLevelAt(zapcore.DebugLevel)
    
    logger, _ := config.<span class="function">Build</span>(zap.<span class="function">AddCaller</span>())
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// ä¸åŒçº§åˆ«çš„æ—¥å¿—</span>
    logger.<span class="function">Debug</span>(<span class="string">"Debug information"</span>)
    logger.<span class="function">Info</span>(<span class="string">"Information"</span>)
    logger.<span class="function">Warn</span>(<span class="string">"Warning"</span>)
    logger.<span class="function">Error</span>(<span class="string">"Error occurred"</span>)
    
    <span class="comment">// Fatal ä¼šè°ƒç”¨ os.Exit(1)</span>
    <span class="comment">// logger.Fatal("Fatal error")</span>
    
    <span class="comment">// Panic ä¼šè°ƒç”¨ panic()</span>
    <span class="comment">// logger.Panic("Panic situation")</span>
}</code></pre>
            
            <h3>è¾“å‡ºåˆ°æ–‡ä»¶</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
    <span class="string">"gopkg.in/natefinch/lumberjack.v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// æ—¥å¿—è½®è½¬é…ç½®</span>
    writer := &lumberjack.Logger{
        Filename:   <span class="string">"logs/app.log"</span>,
        MaxSize:    <span class="number">100</span>, <span class="comment">// MB</span>
        MaxBackups: <span class="number">3</span>,
        MaxAge:     <span class="number">28</span>,   <span class="comment">// days</span>
        Compress:   <span class="keyword">true</span>,
    }
    
    <span class="comment">// åˆ›å»º core</span>
    core := zapcore.<span class="function">NewCore</span>(
        zapcore.<span class="function">NewJSONEncoder</span>(zap.NewProductionEncoderConfig()),
        zapcore.<span class="function">AddSync</span>(writer),
        zapcore.InfoLevel,
    )
    
    logger := zap.<span class="function">New</span>(core, zap.<span class="function">AddCaller</span>())
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    logger.<span class="function">Info</span>(<span class="string">"Logging to file"</span>)
}</code></pre>
            
            <h3>åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªåœ°æ–¹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"os"</span>
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
    <span class="string">"gopkg.in/natefinch/lumberjack.v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// æ–‡ä»¶è¾“å‡º</span>
    fileWriter := &lumberjack.Logger{
        Filename:   <span class="string">"logs/app.log"</span>,
        MaxSize:    <span class="number">100</span>,
        MaxBackups: <span class="number">3</span>,
        MaxAge:     <span class="number">28</span>,
        Compress:   <span class="keyword">true</span>,
    }
    
    <span class="comment">// æ§åˆ¶å°è¾“å‡º</span>
    consoleWriter := zapcore.<span class="function">AddSync</span>(os.Stdout)
    
    <span class="comment">// åˆ›å»º encoder</span>
    encoderConfig := zap.NewProductionEncoderConfig()
    encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder
    encoder := zapcore.<span class="function">NewJSONEncoder</span>(encoderConfig)
    
    <span class="comment">// åˆ›å»º core</span>
    core := zapcore.<span class="function">NewTee</span>(
        zapcore.<span class="function">NewCore</span>(encoder, zapcore.<span class="function">AddSync</span>(fileWriter), zapcore.InfoLevel),
        zapcore.<span class="function">NewCore</span>(encoder, consoleWriter, zapcore.DebugLevel),
    )
    
    logger := zap.<span class="function">New</span>(core, zap.<span class="function">AddCaller</span>())
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    logger.<span class="function">Info</span>(<span class="string">"Logging to both file and console"</span>)
}</code></pre>
            
            <h3>Sugar Logger</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// Sugar logger æä¾›æ›´æ–¹ä¾¿çš„ API</span>
    sugar := logger.<span class="function">Sugar</span>()
    
    <span class="comment">// Printf é£æ ¼</span>
    sugar.<span class="function">Infof</span>(<span class="string">"User %s logged in from %s"</span>, <span class="string">"alice"</span>, <span class="string">"192.168.1.1"</span>)
    
    <span class="comment">// æƒ¯ç”¨é£æ ¼</span>
    sugar.<span class="function">Infow</span>(<span class="string">"User logged in"</span>,
        <span class="string">"user"</span>, <span class="string">"alice"</span>,
        <span class="string">"ip"</span>, <span class="string">"192.168.1.1"</span>,
    )
    
    <span class="comment">// ç®€å•é£æ ¼</span>
    sugar.<span class="function">Info</span>(<span class="string">"Simple log message"</span>, <span class="string">"arg1"</span>, <span class="string">"arg2"</span>)
}</code></pre>
            
            <h3>é”™è¯¯å¤„ç†</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"errors"</span>
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// è®°å½•é”™è¯¯</span>
    err := errors.<span class="function">New</span>(<span class="string">"something went wrong"</span>)
    logger.<span class="function">Error</span>(<span class="string">"Operation failed"</span>,
        zap.<span class="function">Error</span>(err),
        zap.<span class="function">String</span>(<span class="string">"operation"</span>, <span class="string">"create_user"</span>),
    )
    
    <span class="comment">// è®°å½•å †æ ˆ</span>
    logger.<span class="function">Error</span>(<span class="string">"Error with stack"</span>,
        zap.<span class="function">Error</span>(err),
        zap.<span class="function">Stack</span>(<span class="string">"stack"</span>),
    )
}</code></pre>
            
            <h2 id="bestpractices">æœ€ä½³å®è·µ</h2>
            
            <h3>Gin æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. é¡¹ç›®ç»“æ„</h4>
                <pre><code>project/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ handler/
â”‚   â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ repository/
â”‚   â””â”€â”€ model/
â”œâ”€â”€ pkg/
â”œâ”€â”€ configs/
â””â”€â”€ go.mod</code></pre>
                
                <h4>2. ä½¿ç”¨ä¾èµ–æ³¨å…¥</h4>
                <pre><code><span class="keyword">type</span> Server <span class="keyword">struct</span> {
    router *gin.Engine
    userHandler *UserHandler
}

<span class="function">func</span> <span class="function">NewServer</span>(userHandler *UserHandler) *Server {
    s := &Server{
        router: gin.<span class="function">Default</span>(),
        userHandler: userHandler,
    }
    s.<span class="function">setupRoutes</span>()
    <span class="keyword">return</span> s
}</code></pre>
                
                <h4>3. ç»Ÿä¸€é”™è¯¯å¤„ç†</h4>
                <pre><code><span class="keyword">type</span> ErrorResponse <span class="keyword">struct</span> {
    Error   <span class="keyword">string</span> <span class="string">`json:"error"`</span>
    Code    <span class="keyword">int</span>    <span class="string">`json:"code"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">HandleError</span>(c *gin.Context, err <span class="keyword">error</span>) {
    <span class="keyword">if</span> errors.<span class="function">Is</span>(err, ErrNotFound) {
        c.<span class="function">JSON</span>(http.StatusNotFound, ErrorResponse{
            Error:   <span class="string">"not_found"</span>,
            Code:    <span class="number">404</span>,
            Message: err.<span class="function">Error</span>(),
        })
        <span class="keyword">return</span>
    }
    c.<span class="function">JSON</span>(http.StatusInternalServerError, ErrorResponse{
        Error:   <span class="string">"internal_error"</span>,
        Code:    <span class="number">500</span>,
        Message: <span class="string">"Internal server error"</span>,
    })
}</code></pre>
                
                <h4>4. ä½¿ç”¨ Context ä¼ é€’è¯·æ±‚ä½œç”¨åŸŸæ•°æ®</h4>
                <pre><code><span class="comment">// åœ¨ä¸­é—´ä»¶ä¸­è®¾ç½®</span>
c.<span class="function">Set</span>(<span class="string">"user_id"</span>, userID)

<span class="comment">// åœ¨ handler ä¸­è·å–</span>
userID := c.<span class="function">GetString</span>(<span class="string">"user_id"</span>)</code></pre>
            </div>
            
            <h3>GORM æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. ä½¿ç”¨æ¨¡å‹å±‚æŠ½è±¡</h4>
                <pre><code><span class="keyword">type</span> Repository <span class="keyword">interface</span> {
    <span class="function">Create</span>(user *User) <span class="keyword">error</span>
    <span class="function">FindByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>)
    <span class="function">Update</span>(user *User) <span class="keyword">error</span>
    <span class="function">Delete</span>(id <span class="keyword">uint</span>) <span class="keyword">error</span>
}

<span class="keyword">type</span> UserRepository <span class="keyword">struct</span> {
    db *gorm.DB
}

<span class="function">func</span> (r *UserRepository) <span class="function">FindByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>) {
    <span class="keyword">var</span> user User
    err := r.db.<span class="function">First</span>(&user, id).Error
    <span class="keyword">return</span> &user, err
}</code></pre>
                
                <h4>2. ä½¿ç”¨äº‹åŠ¡ç®¡ç†</h4>
                <pre><code><span class="keyword">func</span> (s *UserService) <span class="function">CreateUserWithOrder</span>(user *User, order *Order) <span class="keyword">error</span> {
    <span class="keyword">return</span> s.db.<span class="function">Transaction</span>(<span class="keyword">func</span>(tx *gorm.DB) <span class="keyword">error</span> {
        <span class="keyword">if</span> err := tx.<span class="function">Create</span>(user).Error; err != <span class="keyword">nil</span> {
            <span class="keyword">return</span> err
        }
        order.UserID = user.ID
        <span class="keyword">return</span> tx.<span class="function">Create</span>(order).Error
    })
}</code></pre>
                
                <h4>3. ä½¿ç”¨è½¯åˆ é™¤</h4>
                <pre><code><span class="keyword">type</span> BaseModel <span class="keyword">struct</span> {
    ID        <span class="keyword">uint</span>
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    BaseModel
    Name  <span class="keyword">string</span>
    Email <span class="keyword">string</span>
}</code></pre>
                
                <h4>4. ä½¿ç”¨é¢„åŠ è½½é¿å… N+1 æŸ¥è¯¢</h4>
                <pre><code><span class="comment">// é”™è¯¯ï¼šN+1 æŸ¥è¯¢</span>
<span class="keyword">var</span> users []User
db.<span class="function">Find</span>(&users)
<span class="keyword">for</span> _, user := <span class="keyword">range</span> users {
    db.<span class="function">Where</span>(<span class="string">"user_id = ?"</span>, user.ID).<span class="function">Find</span>(&user.Posts)
}

<span class="comment">// æ­£ç¡®ï¼šä½¿ç”¨é¢„åŠ è½½</span>
db.<span class="function">Preload</span>(<span class="string">"Posts"</span>).<span class="function">Find</span>(&users)</code></pre>
            </div>
            
            <h3>Viper æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. é…ç½®ä¼˜å…ˆçº§</h4>
                <pre><code><span class="comment">// ä¼˜å…ˆçº§ä»é«˜åˆ°ä½</span>
<span class="comment">// 1. å‘½ä»¤è¡Œå‚æ•°</span>
<span class="comment">// 2. ç¯å¢ƒå˜é‡</span>
<span class="comment">// 3. é…ç½®æ–‡ä»¶</span>
<span class="comment">// 4. é»˜è®¤å€¼</span></code></pre>
                
                <h4>2. ä½¿ç”¨é…ç½®éªŒè¯</h4>
                <pre><code><span class="keyword">func</span> <span class="function">ValidateConfig</span>(v *viper.Viper) <span class="keyword">error</span> {
    <span class="keyword">if</span> !v.<span class="function">IsSet</span>(<span class="string">"server.port"</span>) {
        <span class="keyword">return</span> errors.<span class="function">New</span>(<span class="string">"server.port is required"</span>)
    }
    <span class="keyword">if</span> !v.<span class="function">IsSet</span>(<span class="string">"database.host"</span>) {
        <span class="keyword">return</span> errors.<span class="function">New</span>(<span class="string">"database.host is required"</span>)
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
                
                <h4>3. æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡</h4>
                <pre><code><span class="comment">// config.yaml</span>
database:
  host: localhost
  port: <span class="number">3306</span>
  name: mydb
  user: root
  password: ${DB_PASSWORD}  <span class="comment">// ä»ç¯å¢ƒå˜é‡è¯»å–</span></code></pre>
            </div>
            
            <h3>Zap æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. ä½¿ç”¨å…¨å±€ Logger</h4>
                <pre><code><span class="keyword">var</span> logger *zap.Logger

<span class="function">func</span> <span class="function">InitLogger</span>(config *Config) <span class="keyword">error</span> {
    <span class="keyword">var</span> err <span class="keyword">error</span>
    logger, err = config.<span class="function">BuildLogger</span>()
    <span class="keyword">return</span> err
}

<span class="function">func</span> <span class="function">GetLogger</span>() *zap.Logger {
    <span class="keyword">return</span> logger
}</code></pre>
                
                <h4>2. ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—</h4>
                <pre><code><span class="comment">// å¥½çš„å®è·µ</span>
logger.<span class="function">Info</span>(<span class="string">"User logged in"</span>,
    zap.<span class="function">String</span>(<span class="string">"user_id"</span>, userID),
    zap.<span class="function">String</span>(<span class="string">"ip"</span>, ip),
)

<span class="comment">// ä¸å¥½çš„å®è·µ</span>
logger.<span class="function">Info</span>(fmt.<span class="function">Sprintf</span>(<span class="string">"User %s logged in from %s"</span>, userID, ip))</code></pre>
                
                <h4>3. æ—¥å¿—çº§åˆ«æ§åˆ¶</h4>
                <pre><code><span class="comment">// å¼€å‘ç¯å¢ƒ</span>
config.Level = zap.NewAtomicLevelAt(zapcore.DebugLevel)

<span class="comment">// ç”Ÿäº§ç¯å¢ƒ</span>
config.Level = zap.NewAtomicLevelAt(zapcore.InfoLevel)</code></pre>
                
                <h4>4. æ—¥å¿—è½®è½¬</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ lumberjack è¿›è¡Œæ—¥å¿—è½®è½¬</span>
writer := &lumberjack.Logger{
    Filename:   <span class="string">"logs/app.log"</span>,
    MaxSize:    <span class="number">100</span>, <span class="comment">// MB</span>
    MaxBackups: <span class="number">3</span>,
    MaxAge:     <span class="number">28</span>,   <span class="comment">// days</span>
    Compress:   <span class="keyword">true</span>,
}</code></pre>
            </div>
            
            <h3>é›†æˆç¤ºä¾‹</h3>
            <div class="note-box">
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"github.com/spf13/viper"</span>
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"gorm.io/driver/mysql"</span>
    <span class="string">"gorm.io/gorm"</span>
)

<span class="keyword">type</span> App <span class="keyword">struct</span> {
    Router *gin.Engine
    DB     *gorm.DB
    Config *viper.Viper
    Logger *zap.Logger
}

<span class="function">func</span> <span class="function">NewApp</span>() *App {
    <span class="comment">// åˆå§‹åŒ–é…ç½®</span>
    config := viper.<span class="function">New</span>()
    config.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    config.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    config.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    config.<span class="function">ReadInConfig</span>()
    
    <span class="comment">// åˆå§‹åŒ–æ—¥å¿—</span>
    logger, _ := zap.<span class="function">NewProduction</span>()
    
    <span class="comment">// åˆå§‹åŒ–æ•°æ®åº“</span>
    dsn := config.<span class="function">GetString</span>(<span class="string">"database.dsn"</span>)
    db, _ := gorm.<span class="function">Open</span>(mysql.<span class="function">Open</span>(dsn), &gorm.Config{})
    
    <span class="comment">// åˆå§‹åŒ–è·¯ç”±</span>
    router := gin.<span class="function">Default</span>()
    
    <span class="keyword">return</span> &App{
        Router: router,
        DB:     db,
        Config: config,
        Logger: logger,
    }
}

<span class="function">func</span> (a *App) <span class="function">Run</span>() {
    port := a.Config.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
    a.Logger.<span class="function">Info</span>(<span class="string">"Starting server"</span>, zap.<span class="function">String</span>(<span class="string">"port"</span>, port))
    a.Router.<span class="function">Run</span>(<span class="string">":"</span> + port)
}

<span class="function">func</span> <span class="function">main</span>() {
    app := <span class="function">NewApp</span>()
    app.<span class="function">Run</span>()
}</code></pre>
            </div>
            
            <h2 id="validator">Validator å‚æ•°æ ¡éªŒ</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>Validator æ˜¯ Go è¯­è¨€ä¸­æœ€æµè¡Œçš„å‚æ•°æ ¡éªŒåº“ï¼ŒåŸºäºç»“æ„ä½“æ ‡ç­¾å®ç°ï¼Œæ”¯æŒå¤šç§æ ¡éªŒè§„åˆ™ï¼Œå¯ä»¥è½»æ¾é›†æˆåˆ° Gin ç­‰ Web æ¡†æ¶ä¸­ã€‚å®ƒæ”¯æŒè‡ªå®šä¹‰æ ¡éªŒè§„åˆ™ã€å›½é™…åŒ–é”™è¯¯æ¶ˆæ¯ç­‰åŠŸèƒ½ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/go-playground/validator/v10</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name  <span class="keyword">string</span> <span class="string">`validate:"required,min=3,max=32"`</span>
    Email <span class="keyword">string</span> <span class="string">`validate:"required,email"`</span>
    Age   <span class="keyword">int</span>    <span class="string">`validate:"required,gte=0,lte=130"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    validate := validator.<span class="function">New</span>()
    
    user := User{
        Name:  <span class="string">"Alice"</span>,
        Email: <span class="string">"alice@example.com"</span>,
        Age:   <span class="number">25</span>,
    }
    
    err := validate.<span class="function">Struct</span>(user)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Validation failed:"</span>, err)
        <span class="keyword">return</span>
    }
    
    fmt.<span class="function">Println</span>(<span class="string">"Validation passed!"</span>)
}</code></pre>
            
            <h3>å¸¸ç”¨æ ¡éªŒè§„åˆ™</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    <span class="comment">// å¿…å¡«å­—æ®µ</span>
    Name <span class="keyword">string</span> <span class="string">`validate:"required"`</span>
    
    <span class="comment">// å­—ç¬¦ä¸²é•¿åº¦</span>
    Username <span class="keyword">string</span> <span class="string">`validate:"min=3,max=20"`</span>
    
    <span class="comment">// é‚®ç®±æ ¼å¼</span>
    Email <span class="keyword">string</span> <span class="string">`validate:"email"`</span>
    
    <span class="comment">// URL æ ¼å¼</span>
    Website <span class="keyword">string</span> <span class="string">`validate:"url"`</span>
    
    <span class="comment">// æ•°å€¼èŒƒå›´</span>
    Age <span class="keyword">int</span> <span class="string">`validate:"gte=0,lte=130"`</span>
    
    <span class="comment">// å¤§äºç­‰äº (gte)ã€å¤§äº (gt)ã€å°äºç­‰äº (lte)ã€å°äº (lt)</span>
    Price <span class="keyword">float64</span> <span class="string">`validate:"gt=0"`</span>
    
    <span class="comment">// æ­£åˆ™è¡¨è¾¾å¼</span>
    Phone <span class="keyword">string</span> <span class="string">`validate:"required,^1[3-9]\\d{9}$"`</span>
    
    <span class="comment">// æšä¸¾å€¼</span>
    Gender <span class="keyword">string</span> <span class="string">`validate:"oneof=male female other"`</span>
    
    <span class="comment">// å­—ç¬¦ä¸²åŒ…å«</span>
    Password <span class="keyword">string</span> <span class="string">`validate:"containsany=!@#$%"`</span>
    
    <span class="comment">// å”¯ä¸€æ€§ï¼ˆéœ€è¦è‡ªå®šä¹‰æ ¡éªŒï¼‰</span>
    Username <span class="keyword">string</span> <span class="string">`validate:"unique"`</span>
    
    <span class="comment">// å¯é€‰å­—æ®µ</span>
    Nickname <span class="keyword">string</span> <span class="string">`validate:"omitempty,min=2"`</span>
    
    <span class="comment">// æ’é™¤æŸäº›å€¼</span>
    Role <span class="keyword">string</span> <span class="string">`validate:"nefield=Password"`</span>
    
    <span class="comment">// å­—æ®µç›¸ç­‰</span>
    ConfirmPassword <span class="keyword">string</span> <span class="string">`validate:"eqfield=Password"`</span>
    
    <span class="comment">// å­—æ®µä¸ç­‰</span>
    NewEmail <span class="keyword">string</span> <span class="string">`validate:"nefield=OldEmail"`</span>
}</code></pre>
            
            <h3>é”™è¯¯å¤„ç†</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
)

<span class="function">func</span> <span class="function">handleValidationError</span>(err <span class="keyword">error</span>) {
    <span class="comment">// ç±»å‹æ–­è¨€</span>
    validationErrors, ok := err.(validator.ValidationErrors)
    <span class="keyword">if</span> !ok {
        fmt.<span class="function">Println</span>(<span class="string">"Unknown error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    <span class="comment">// éå†æ‰€æœ‰é”™è¯¯</span>
    <span class="keyword">for</span>, e := <span class="keyword">range</span> validationErrors {
        fmt.<span class="function">Printf</span>(<span class="string">"Field: %s, Tag: %s, Param: %s\n"</span>, e.<span class="function">Field</span>(), e.<span class="function">Tag</span>(), e.<span class="function">Param</span>())
    }
}

<span class="comment">// è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯</span>
<span class="keyword">type</span> ErrorResponse <span class="keyword">struct</span> {
    Field   <span class="keyword">string</span> <span class="string">`json:"field"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">getValidationErrors</span>(err <span class="keyword">error</span>) []ErrorResponse {
    <span class="keyword">var</span> errors []ErrorResponse
    
    validationErrors := err.(validator.ValidationErrors)
    <span class="keyword">for</span>, e := <span class="keyword">range</span> validationErrors {
        errors = <span class="function">append</span>(errors, ErrorResponse{
            Field:   e.<span class="function">Field</span>(),
            Message: <span class="function">getErrorMessage</span>(e),
        })
    }
    
    <span class="keyword">return</span> errors
}

<span class="function">func</span> <span class="function">getErrorMessage</span>(e validator.FieldError) <span class="keyword">string</span> {
    <span class="keyword">switch</span> e.<span class="function">Tag</span>() {
    <span class="keyword">case</span> <span class="string">"required"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s is required"</span>, e.<span class="function">Field</span>())
    <span class="keyword">case</span> <span class="string">"email"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s must be a valid email"</span>, e.<span class="function">Field</span>())
    <span class="keyword">case</span> <span class="string">"min"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s must be at least %s characters"</span>, e.<span class="function">Field</span>(), e.<span class="function">Param</span>())
    <span class="keyword">case</span> <span class="string">"max"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s must be at most %s characters"</span>, e.<span class="function">Field</span>(), e.<span class="function">Param</span>())
    <span class="keyword">default</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s is invalid"</span>, e.<span class="function">Field</span>())
    }
}</code></pre>
            
            <h3>è‡ªå®šä¹‰æ ¡éªŒè§„åˆ™</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
    <span class="string">"regexp"</span>
)

<span class="comment">// è‡ªå®šä¹‰æ ¡éªŒï¼šæ‰‹æœºå·</span>
<span class="function">func</span> <span class="function">validateMobile</span>(fl validator.FieldLevel) <span class="keyword">bool</span> {
    mobile := fl.<span class="function">Field</span>().<span class="function">String</span>()
    matched, _ := regexp.<span class="function">MatchString</span>(<span class="string">`^1[3-9]\d{9}$`</span>, mobile)
    <span class="keyword">return</span> matched
}

<span class="comment">// è‡ªå®šä¹‰æ ¡éªŒï¼šç”¨æˆ·åå”¯ä¸€æ€§</span>
<span class="function">func</span> <span class="function">validateUsernameUnique</span>(fl validator.FieldLevel) <span class="keyword">bool</span> {
    username := fl.<span class="function">Field</span>().<span class="function">String</span>()
    <span class="comment">// è¿™é‡Œåº”è¯¥æŸ¥è¯¢æ•°æ®åº“æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨</span>
    <span class="comment">// ç®€åŒ–ç¤ºä¾‹ï¼šå‡è®¾ç”¨æˆ·åä¸èƒ½æ˜¯ "admin"</span>
    <span class="keyword">return</span> username != <span class="string">"admin"</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    validate := validator.<span class="function">New</span>()
    
    <span class="comment">// æ³¨å†Œè‡ªå®šä¹‰æ ¡éªŒ</span>
    validate.<span class="function">RegisterValidation</span>(<span class="string">"mobile"</span>, <span class="function">validateMobile</span>)
    validate.<span class="function">RegisterValidation</span>(<span class="string">"username_unique"</span>, <span class="function">validateUsernameUnique</span>)
    
    <span class="keyword">type</span> User <span class="keyword">struct</span> {
        Username <span class="keyword">string</span> <span class="string">`validate:"required,username_unique"`</span>
        Mobile   <span class="keyword">string</span> <span class="string">`validate:"required,mobile"`</span>
    }
    
    user := User{
        Username: <span class="string">"admin"</span>,
        Mobile:   <span class="string">"13800138000"</span>,
    }
    
    err := validate.<span class="function">Struct</span>(user)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Validation failed:"</span>, err)
    }
}</code></pre>
            
            <h3>ä¸ Gin é›†æˆ</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
    <span class="string">"net/http"</span>
)

<span class="keyword">type</span> CreateUserRequest <span class="keyword">struct</span> {
    Name     <span class="keyword">string</span> <span class="string">`json:"name" validate:"required,min=3,max=32"`</span>
    Email    <span class="keyword">string</span> <span class="string">`json:"email" validate:"required,email"`</span>
    Password <span class="keyword">string</span> <span class="string">`json:"password" validate:"required,min=8"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// è·å– Gin çš„ validator</span>
    <span class="keyword">if</span> v, ok := binding.Validator.<span class="function">Engine</span>().(*validator.Validate); ok {
        <span class="comment">// æ³¨å†Œè‡ªå®šä¹‰æ ¡éªŒ</span>
        v.<span class="function">RegisterValidation</span>(<span class="string">"mobile"</span>, <span class="function">validateMobile</span>)
    }
    
    r.<span class="function">POST</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
        <span class="keyword">var</span> req CreateUserRequest
        
        <span class="comment">// ç»‘å®šå’Œæ ¡éªŒ</span>
        <span class="keyword">if</span> err := c.<span class="function">ShouldBindJSON</span>(&req); err != <span class="keyword">nil</span> {
            c.<span class="function">JSON</span>(http.StatusBadRequest, gin.H{
                <span class="string">"error"</span>: <span class="function">getValidationErrors</span>(err),
            })
            <span class="keyword">return</span>
        }
        
        c.<span class="function">JSON</span>(http.StatusCreated, gin.H{
            <span class="string">"message"</span>: <span class="string">"User created"</span>,
            <span class="string">"user"</span>:    req,
        })
    })
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>ç»“æ„ä½“åµŒå¥—æ ¡éªŒ</h3>
            <pre><code><span class="keyword">type</span> Address <span class="keyword">struct</span> {
    Street  <span class="keyword">string</span> <span class="string">`validate:"required"`</span>
    City    <span class="keyword">string</span> <span class="string">`validate:"required"`</span>
    ZipCode <span class="keyword">string</span> <span class="string">`validate:"required,len=6"`</span>
}

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name    <span class="keyword">string</span>  <span class="string">`validate:"required"`</span>
    Address Address  <span class="string">`validate:"required,dive"`</span>  <span class="comment">// dive è¡¨ç¤ºæ ¡éªŒåµŒå¥—ç»“æ„ä½“</span>
}</code></pre>
            
            <h3>æ•°ç»„/åˆ‡ç‰‡æ ¡éªŒ</h3>
            <pre><code><span class="keyword">type</span> Order <span class="keyword">struct</span> {
    Items []Item <span class="string">`validate:"required,min=1,dive"`</span>  <span class="comment">// æ ¡éªŒæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ </span>
}

<span class="keyword">type</span> Item <span class="keyword">struct</span> {
    Name  <span class="keyword">string</span>  <span class="string">`validate:"required"`</span>
    Price <span class="keyword">float64</span> <span class="string">`validate:"required,gt=0"`</span>
}</code></pre>
            
            <h2 id="cobra">Cobra å‘½ä»¤è¡Œå·¥å…·</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>Cobra æ˜¯ Go è¯­è¨€ä¸­æœ€æµè¡Œçš„å‘½ä»¤è¡Œåº”ç”¨æ¡†æ¶ï¼Œè¢«å¹¿æ³›ç”¨äºè®¸å¤šçŸ¥åé¡¹ç›®ï¼ˆå¦‚ Dockerã€Kubernetesã€Hugo ç­‰ï¼‰ã€‚å®ƒæä¾›äº†å¼ºå¤§çš„å‘½ä»¤è§£æã€å­å‘½ä»¤æ”¯æŒã€è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©æ–‡æ¡£ç­‰åŠŸèƒ½ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/spf13/cobra
<span class="keyword">go</span> get -u github.com/spf13/pflag</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> name <span class="keyword">string</span>
    
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        Long:  <span class="string">"A longer description of my application"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Printf</span>(<span class="string">"Hello, %s!\n"</span>, name)
        },
    }
    
    rootCmd.<span class="function">Flags</span>().<span class="function">StringVarP</span>(&name, <span class="string">"name"</span>, <span class="string">"n"</span>, <span class="string">"World"</span>, <span class="string">"Name to greet"</span>)
    
    rootCmd.<span class="function">Execute</span>()
}</code></pre>
            
            <h3>å­å‘½ä»¤</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
    }
    
    <span class="comment">// æ·»åŠ å­å‘½ä»¤</span>
    rootCmd.<span class="function">AddCommand</span>(<span class="function">createCommand</span>())
    rootCmd.<span class="function">AddCommand</span>(<span class="function">listCommand</span>())
    rootCmd.<span class="function">AddCommand</span>(<span class="function">deleteCommand</span>())
    
    rootCmd.<span class="function">Execute</span>()
}

<span class="function">func</span> <span class="function">createCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"create"</span>,
        Short: <span class="string">"Create a new resource"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Creating resource..."</span>)
        },
    }
}

<span class="function">func</span> <span class="function">listCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"list"</span>,
        Short: <span class="string">"List all resources"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Listing resources..."</span>)
        },
    }
}

<span class="function">func</span> <span class="function">deleteCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"delete [id]"</span>,
        Short: <span class="string">"Delete a resource"</span>,
        Args:  cobra.ExactArgs(<span class="number">1</span>),
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Printf</span>(<span class="string">"Deleting resource: %s\n"</span>, args[<span class="number">0</span>])
        },
    }
}</code></pre>
            
            <h3>å‚æ•°éªŒè¯</h3>
            <pre><code><span class="keyword">func</span> <span class="function">createCommand</span>() *cobra.Command {
    <span class="keyword">var</span> name <span class="keyword">string</span>
    <span class="keyword">var</span> age <span class="keyword">int</span>
    
    cmd := &cobra.Command{
        Use:   <span class="string">"create"</span>,
        Short: <span class="string">"Create a new user"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            <span class="comment">// éªŒè¯å‚æ•°</span>
            <span class="keyword">if</span> name == <span class="string">""</span> {
                fmt.<span class="function">Println</span>(<span class="string">"Error: name is required"</span>)
                <span class="keyword">return</span>
            }
            <span class="keyword">if</span> age <= <span class="number">0</span> {
                fmt.<span class="function">Println</span>(<span class="string">"Error: age must be positive"</span>)
                <span class="keyword">return</span>
            }
            
            fmt.<span class="function">Printf</span>(<span class="string">"Creating user: %s, age: %d\n"</span>, name, age)
        },
    }
    
    cmd.<span class="function">Flags</span>().<span class="function">StringVarP</span>(&name, <span class="string">"name"</span>, <span class="string">"n"</span>, <span class="string">""</span>, <span class="string">"User name"</span>)
    cmd.<span class="function">Flags</span>().<span class="function">IntVarP</span>(&age, <span class="string">"age"</span>, <span class="string">"a"</span>, <span class="number">0</span>, <span class="string">"User age"</span>)
    
    <span class="comment">// æ ‡è®°ä¸ºå¿…å¡«</span>
    cmd.<span class="function">MarkFlagRequired</span>(<span class="string">"name"</span>)
    
    <span class="keyword">return</span> cmd
}</code></pre>
            
            <h3>æŒä¹…åŒ–æ ‡å¿—</h3>
            <pre><code><span class="keyword">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> verbose <span class="keyword">bool</span>
    <span class="keyword">var</span> config <span class="keyword">string</span>
    
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        PersistentPreRun: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            <span class="keyword">if</span> verbose {
                fmt.<span class="function">Println</span>(<span class="string">"Verbose mode enabled"</span>)
            }
            fmt.<span class="function">Printf</span>(<span class="string">"Using config: %s\n"</span>, config)
        },
    }
    
    <span class="comment">// æŒä¹…åŒ–æ ‡å¿—ï¼šæ‰€æœ‰å­å‘½ä»¤éƒ½å¯ä»¥ä½¿ç”¨</span>
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">BoolVarP</span>(&verbose, <span class="string">"verbose"</span>, <span class="string">"v"</span>, <span class="keyword">false</span>, <span class="string">"Verbose output"</span>)
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">StringVarP</span>(&config, <span class="string">"config"</span>, <span class="string">"c"</span>, <span class="string">"config.yaml"</span>, <span class="string">"Config file"</span>)
    
    rootCmd.<span class="function">AddCommand</span>(<span class="function">createCommand</span>())
    rootCmd.<span class="function">Execute</span>()
}</code></pre>
            
            <h3>é…ç½®æ–‡ä»¶é›†æˆ</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        PersistentPreRun: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            <span class="comment">// åˆå§‹åŒ– Viper</span>
            viper.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
            viper.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
            viper.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
            
            <span class="keyword">if</span> err := viper.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
                fmt.<span class="function">Println</span>(<span class="string">"Using default config"</span>)
            }
            
            <span class="comment">// ç»‘å®šå‘½ä»¤è¡Œæ ‡å¿—</span>
            viper.<span class="function">BindPFlag</span>(<span class="string">"port"</span>, cmd.<span class="function">PersistentFlags</span>().<span class="function">Lookup</span>(<span class="string">"port"</span>))
        },
    }
    
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">IntP</span>(<span class="string">"port"</span>, <span class="string">"p"</span>, <span class="number">8080</span>, <span class="string">"Server port"</span>)
    
    rootCmd.<span class="function">AddCommand</span>(<span class="function">serveCommand</span>())
    rootCmd.<span class="function">Execute</span>()
}

<span class="function">func</span> <span class="function">serveCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"serve"</span>,
        Short: <span class="string">"Start the server"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            port := viper.<span class="function">GetInt</span>(<span class="string">"port"</span>)
            fmt.<span class="function">Printf</span>(<span class="string">"Starting server on port %d\n"</span>, port)
        },
    }
}</code></pre>
            
            <h3>è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
    <span class="string">"github.com/spf13/cobra/doc"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Hello, World!"</span>)
        },
    }
    
    rootCmd.<span class="function">AddCommand</span>(&cobra.Command{
        Use:   <span class="string">"version"</span>,
        Short: <span class="string">"Print version"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Version 1.0.0"</span>)
        },
    })
    
    <span class="comment">// ç”Ÿæˆ Markdown æ–‡æ¡£</span>
    doc.<span class="function">GenMarkdownTree</span>(rootCmd, <span class="string">"./docs"</span>)
    
    <span class="comment">// ç”Ÿæˆ Man é¡µé¢</span>
    doc.<span class="function">GenManTree</span>(rootCmd, &doc.GenManHeader{
        Section: <span class="string">"1"</span>,
    }, <span class="string">"./man"</span>)
    
    <span class="comment">// ç”Ÿæˆ ReStructuredText</span>
    doc.<span class="function">GenReSTTree</span>(rootCmd, <span class="string">"./rst"</span>)
}</code></pre>
            
            <h3>Shell è‡ªåŠ¨è¡¥å…¨</h3>
            <pre><code><span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
    }
    
    <span class="comment">// ç”Ÿæˆ Bash è¡¥å…¨</span>
    rootCmd.<span class="function">GenBashCompletionFile</span>(<span class="string">"/etc/bash_completion.d/myapp"</span>)
    
    <span class="comment">// ç”Ÿæˆ Zsh è¡¥å…¨</span>
    rootCmd.<span class="function">GenZshCompletionFile</span>(<span class="string">"/usr/local/share/zsh/site-functions/_myapp"</span>)
    
    <span class="comment">// ç”Ÿæˆ Fish è¡¥å…¨</span>
    rootCmd.<span class="function">GenFishCompletionFile</span>(<span class="string">"/usr/share/fish/vendor_completions.d/myapp.fish"</span>)
    
    rootCmd.<span class="function">Execute</span>()
}</code></pre>
            
            <h2 id="gomicro">Go-Micro å¾®æœåŠ¡æ¡†æ¶</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>Go-Micro æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¾®æœåŠ¡çš„ Go è¯­è¨€æ¡†æ¶ï¼Œæä¾›æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ¶ˆæ¯ç¼–ç ã€RPC é€šä¿¡ç­‰åŠŸèƒ½ã€‚å®ƒæ”¯æŒå¤šç§ä¼ è¾“åè®®ã€ç¼–ç æ ¼å¼å’ŒæœåŠ¡å‘ç°æœºåˆ¶ï¼Œæ˜¯æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ç†æƒ³é€‰æ‹©ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/micro/go-micro/v2
<span class="keyword">go</span> get -u github.com/micro/go-micro/v2/api</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"github.com/micro/go-micro/v2"</span>
    proto <span class="string">"github.com/micro/go-micro/v2/examples/greeter/proto"</span>
)

<span class="keyword">type</span> Greeter <span class="keyword">struct</span> {}

<span class="function">func</span> (g *Greeter) <span class="function">Hello</span>(ctx context.Context, req *proto.HelloRequest, rsp *proto.HelloResponse) <span class="keyword">error</span> {
    rsp.Greeting = <span class="string">"Hello "</span> + req.Name
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºæœåŠ¡</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"greeter"</span>),
        micro.<span class="function">Version</span>(<span class="string">"latest"</span>),
    )
    
    <span class="comment">// åˆå§‹åŒ–æœåŠ¡</span>
    service.<span class="function">Init</span>()
    
    <span class="comment">// æ³¨å†Œå¤„ç†å™¨</span>
    proto.<span class="function">RegisterGreeterHandler</span>(service.<span class="function">Server</span>(), &Greeter{})
    
    <span class="comment">// è¿è¡ŒæœåŠ¡</span>
    <span class="keyword">if</span> err := service.<span class="function">Run</span>(); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
    }
}</code></pre>
            
            <h3>æœåŠ¡å‘ç°</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"github.com/micro/go-micro/v2"</span>
    <span class="string">"github.com/micro/go-micro/v2/client"</span>
    <span class="string">"github.com/micro/go-micro/v2/registry"</span>
    <span class="string">"github.com/micro/go-micro/v2/registry/etcd"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// ä½¿ç”¨ Etcd ä½œä¸ºæ³¨å†Œä¸­å¿ƒ</span>
    reg := etcd.<span class="function">NewRegistry</span>(registry.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:2379"</span>))
    
    <span class="comment">// åˆ›å»ºæœåŠ¡</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Registry</span>(reg),
        micro.<span class="function">Name</span>(<span class="string">"greeter"</span>),
    )
    
    service.<span class="function">Init</span>()
    
    <span class="comment">// åˆ›å»ºå®¢æˆ·ç«¯</span>
    cli := service.<span class="function">Client</span>()
    
    <span class="comment">// è°ƒç”¨æœåŠ¡</span>
    rsp := &HelloResponse{}
    err := cli.<span class="function">Call</span>(
        context.<span class="function">Background</span>(),
        client.NewRequest(<span class="string">"greeter"</span>, <span class="string">"Greeter.Hello"</span>, &HelloRequest{Name: <span class="string">"World"</span>}),
        rsp,
        client.<span class="function">WithRetries</span>(<span class="number">3</span>),
        client.<span class="function">WithRequestTimeout</span>(time.Second * <span class="number">5</span>),
    )
    
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    fmt.<span class="function">Println</span>(<span class="string">"Response:"</span>, rsp.Greeting)
}</code></pre>
            
            <h3>æœåŠ¡é—´é€šä¿¡</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"github.com/micro/go-micro/v2"</span>
)

<span class="comment">// å®šä¹‰æœåŠ¡æ¥å£</span>
<span class="keyword">type</span> UserService <span class="keyword">interface</span> {
    <span class="function">GetUser</span>(ctx context.Context, req *GetUserRequest, rsp *GetUserResponse) <span class="keyword">error</span>
}

<span class="comment">// æœåŠ¡ Aï¼šç”¨æˆ·æœåŠ¡</span>
<span class="keyword">type</span> UserHandler <span class="keyword">struct</span> {}

<span class="function">func</span> (h *UserHandler) <span class="function">GetUser</span>(ctx context.Context, req *GetUserRequest, rsp *GetUserResponse) <span class="keyword">error</span> {
    <span class="comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span>
    rsp.User = &User{ID: req.Id, Name: <span class="string">"Alice"</span>}
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// æœåŠ¡ Bï¼šè®¢å•æœåŠ¡</span>
<span class="keyword">type</span> OrderHandler <span class="keyword">struct</span> {
    userService UserService
}

<span class="function">func</span> (h *OrderHandler) <span class="function">CreateOrder</span>(ctx context.Context, req *CreateOrderRequest, rsp *CreateOrderResponse) <span class="keyword">error</span> {
    <span class="comment">// è°ƒç”¨ç”¨æˆ·æœåŠ¡</span>
    userReq := &GetUserRequest{Id: req.UserId}
    userRsp := &GetUserResponse{}
    err := h.userService.<span class="function">GetUser</span>(ctx, userReq, userRsp)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="comment">// åˆ›å»ºè®¢å•</span>
    rsp.Order = &Order{ID: <span class="string">"1"</span>, User: userRsp.User}
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºæœåŠ¡</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"order"</span>),
    )
    
    service.<span class="function">Init</span>()
    
    <span class="comment">// åˆ›å»ºç”¨æˆ·æœåŠ¡å®¢æˆ·ç«¯</span>
    userService := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"order"</span>),  <span class="comment">// ä½¿ç”¨å½“å‰æœåŠ¡çš„å®¢æˆ·ç«¯</span>
    )
    
    <span class="comment">// æ³¨å†Œè®¢å•æœåŠ¡</span>
    micro.<span class="function">RegisterHandler</span>(service.<span class="function">Server</span>(), &OrderHandler{
        userService: userService.<span class="function">Client</span>(),
    })
    
    service.<span class="function">Run</span>()
}</code></pre>
            
            <h3>æ¶ˆæ¯å‘å¸ƒè®¢é˜…</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"github.com/micro/go-micro/v2"</span>
    <span class="string">"github.com/micro/go-micro/v2/broker"</span>
    <span class="string">"github.com/micro/go-micro/v2/broker/nats"</span>
)

<span class="comment">// å‘å¸ƒè€…</span>
<span class="function">func</span> <span class="function">publisher</span>() {
    <span class="comment">// åˆ›å»º Broker</span>
    b := nats.<span class="function">NewBroker</span>(broker.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:4222"</span>))
    
    <span class="keyword">if</span> err := b.<span class="function">Connect</span>(); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Broker connect error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    <span class="comment">// å‘å¸ƒæ¶ˆæ¯</span>
    msg := &broker.Message{
        Header: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{
            <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,
        },
        Body: []<span class="keyword">byte</span>(<span class="string">`{"event":"user.created","user_id":"123"}`</span>),
    }
    
    <span class="keyword">if</span> err := b.<span class="function">Publish</span>(<span class="string">"user.created"</span>, msg); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Publish error:"</span>, err)
    }
}

<span class="comment">// è®¢é˜…è€…</span>
<span class="function">func</span> <span class="function">subscriber</span>() {
    <span class="comment">// åˆ›å»ºæœåŠ¡</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Broker</span>(nats.<span class="function">NewBroker</span>(broker.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:4222"</span>))),
    )
    
    service.<span class="function">Init</span>()
    
    <span class="comment">// è®¢é˜…æ¶ˆæ¯</span>
    micro.<span class="function">RegisterSubscriber</span>(<span class="string">"user.created"</span>, service.<span class="function">Server</span>(), <span class="keyword">func</span>(ctx context.Context, msg *broker.Message) <span class="keyword">error</span> {
        fmt.<span class="function">Printf</span>(<span class="string">"Received message: %s\n"</span>, string(msg.Body))
        <span class="keyword">return</span> <span class="keyword">nil</span>
    })
    
    service.<span class="function">Run</span>()
}</code></pre>
            
            <h3>ä¸­é—´ä»¶</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"github.com/micro/go-micro/v2"</span>
    <span class="string">"github.com/micro/go-micro/v2/server"</span>
)

<span class="comment">// æ—¥å¿—ä¸­é—´ä»¶</span>
<span class="function">func</span> <span class="function">logWrapper</span>(fn server.HandlerFunc) server.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(ctx context.Context, req server.Request, rsp interface{}) <span class="keyword">error</span> {
        fmt.<span class="function">Printf</span>(<span class="string">"[Request] %s %s\n"</span>, req.<span class="function">Method</span>(), req.<span class="function">Endpoint</span>())
        err := fn(ctx, req, rsp)
        fmt.<span class="function">Printf</span>(<span class="string">"[Response] %s\n"</span>, err)
        <span class="keyword">return</span> err
    }
}

<span class="comment">// è®¤è¯ä¸­é—´ä»¶</span>
<span class="function">func</span> <span class="function">authWrapper</span>(fn server.HandlerFunc) server.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(ctx context.Context, req server.Request, rsp interface{}) <span class="keyword">error</span> {
        <span class="comment">// æ£€æŸ¥è®¤è¯ä»¤ç‰Œ</span>
        token := req.<span class="function">Header</span>().<span class="function">Get</span>(<span class="string">"Authorization"</span>)
        <span class="keyword">if</span> token == <span class="string">""</span> {
            <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"Unauthorized"</span>)
        }
        
        <span class="keyword">return</span> fn(ctx, req, rsp)
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºæœåŠ¡</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"greeter"</span>),
        micro.<span class="function">WrapHandler</span>(logWrapper),
        micro.<span class="function">WrapHandler</span>(authWrapper),
    )
    
    service.<span class="function">Init</span>()
    service.<span class="function">Run</span>()
}</code></pre>
            
            <h2 id="etcd">Etcd åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨</h2>
            
            <h3>ç®€ä»‹</h3>
            <p>Etcd æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¯é çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œç”¨äºé…ç½®ç®¡ç†å’ŒæœåŠ¡å‘ç°ã€‚å®ƒä½¿ç”¨ Raft ç®—æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œæ”¯æŒå¼ºä¸€è‡´æ€§è¯»å†™ã€äº‹åŠ¡ã€ç§Ÿçº¦ç­‰åŠŸèƒ½ï¼Œæ˜¯ Kubernetes ç­‰é¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶ã€‚</p>
            
            <h3>å®‰è£…</h3>
            <pre><code><span class="keyword">go</span> get -u go.etcd.io/etcd/client/v3</code></pre>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"go.etcd.io/etcd/client/v3"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºå®¢æˆ·ç«¯</span>
    cli, err := clientv3.<span class="function">New</span>(clientv3.Config{
        Endpoints:   []<span class="keyword">string</span>{<span class="string">"127.0.0.1:2379"</span>},
        DialTimeout: <span class="number">5</span> * time.Second,
    })
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    <span class="keyword">defer</span> cli.<span class="function">Close</span>()
    
    <span class="comment">// è®¾ç½®é”®å€¼</span>
    ctx, cancel := context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), <span class="number">5</span>*time.Second)
    resp, err := cli.<span class="function">Put</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>)
    cancel()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    fmt.<span class="function">Println</span>(<span class="string">"Revision:"</span>, resp.Header.Revision)
    
    <span class="comment">// è·å–é”®å€¼</span>
    ctx, cancel = context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), <span class="number">5</span>*time.Second)
    resp, err = cli.<span class="function">Get</span>(ctx, <span class="string">"key"</span>)
    cancel()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    
    <span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs {
        fmt.<span class="function">Printf</span>(<span class="string">"%s : %s\n"</span>, ev.Key, ev.Value)
    }
}</code></pre>
            
            <h3>é”®å€¼æ“ä½œ</h3>
            <pre><code><span class="comment">// è®¾ç½®é”®å€¼</span>
resp, err := cli.<span class="function">Put</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>)

<span class="comment">// è·å–å•ä¸ªé”®</span>
resp, err := cli.<span class="function">Get</span>(ctx, <span class="string">"key"</span>)

<span class="comment">// è·å–å¤šä¸ªé”®ï¼ˆå‰ç¼€åŒ¹é…ï¼‰</span>
resp, err := cli.<span class="function">Get</span>(ctx, <span class="string">"prefix"</span>, clientv3.<span class="function">WithPrefix</span>())

<span class="comment">// è·å–æ‰€æœ‰é”®</span>
resp, err := cli.<span class="function">Get</span>(ctx, <span class="string">""</span>, clientv3.<span class="function">WithFromKey</span>(), clientv3.<span class="function">WithLimit</span>(<span class="number">100</span>))

<span class="comment">// åˆ é™¤é”®</span>
resp, err := cli.<span class="function">Delete</span>(ctx, <span class="string">"key"</span>)

<span class="comment">// åˆ é™¤å¤šä¸ªé”®ï¼ˆå‰ç¼€åŒ¹é…ï¼‰</span>
resp, err := cli.<span class="function">Delete</span>(ctx, <span class="string">"prefix"</span>, clientv3.<span class="function">WithPrefix</span>())

<span class="comment">// åˆ é™¤æ‰€æœ‰é”®</span>
resp, err := cli.<span class="function">Delete</span>(ctx, <span class="string">""</span>, clientv3.<span class="function">WithPrefix</span>())</code></pre>
            
            <h3>ç§Ÿçº¦ï¼ˆLeaseï¼‰</h3>
            <pre><code><span class="comment">// åˆ›å»ºç§Ÿçº¦ï¼ˆ10ç§’è¿‡æœŸï¼‰</span>
lease, err := cli.<span class="function">Grant</span>(ctx, <span class="number">10</span>)
<span class="keyword">if</span> err != <span class="keyword">nil</span> {
    <span class="function">panic</span>(err)
}

<span class="comment">// ç»‘å®šç§Ÿçº¦åˆ°é”®</span>
resp, err := cli.<span class="function">Put</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>, clientv3.<span class="function">WithLease</span>(lease.ID))

<span class="comment">// ç»­ç§Ÿ</span>
keepAlive, err := cli.<span class="function">KeepAlive</span>(ctx, lease.ID)
<span class="keyword">for</span> ka := <span class="keyword">range</span> keepAlive {
    fmt.<span class="function">Printf</span>(<span class="string">"TTL: %d\n"</span>, ka.TTL)
}

<span class="comment">// æ’¤é”€ç§Ÿçº¦</span>
_, err = cli.<span class="function">Revoke</span>(ctx, lease.ID)</code></pre>
            
            <h3>äº‹åŠ¡</h3>
            <pre><code><span class="comment">// äº‹åŠ¡æ“ä½œ</span>
txn := cli.<span class="function">Txn</span>(ctx)

<span class="comment">// If æ¡ä»¶</span>
txn.<span class="function">If</span>(
    clientv3.<span class="function">Compare</span>(clientv3.<span class="function">Value</span>(<span class="string">"key"</span>), <span class="string">"="</span>, <span class="string">"value"</span>),
).
<span class="function">Then</span>(
    clientv3.<span class="function">OpPut</span>(<span class="string">"key"</span>, <span class="string">"new_value"</span>),
).
<span class="function">Else</span>(
    clientv3.<span class="function">OpPut</span>(<span class="string">"key"</span>, <span class="string">"default_value"</span>),
).
<span class="function">Commit</span>()

<span class="comment">// äº‹åŠ¡ç¤ºä¾‹ï¼šåˆ†å¸ƒå¼é”</span>
<span class="function">func</span> <span class="function">acquireLock</span>(cli *clientv3.Client, key <span class="keyword">string</span>, ttl <span class="keyword">int64</span>) (<span class="keyword">bool</span>, error) {
    <span class="comment">// åˆ›å»ºç§Ÿçº¦</span>
    lease, err := cli.<span class="function">Grant</span>(context.<span class="function">Background</span>(), ttl)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">false</span>, err
    }
    
    <span class="comment">// äº‹åŠ¡ï¼šå¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™è®¾ç½®</span>
    txn := cli.<span class="function">Txn</span>(context.<span class="function">Background</span>())
    txn.<span class="function">If</span>(
        clientv3.<span class="function">Compare</span>(clientv3.<span class="function">CreateRevision</span>(key), <span class="string">"="</span>, <span class="number">0</span>),
    ).
    <span class="function">Then</span>(
        clientv3.<span class="function">OpPut</span>(key, <span class="string">"locked"</span>, clientv3.<span class="function">WithLease</span>(lease.ID)),
    ).
    <span class="function">Commit</span>()
    
    <span class="keyword">return</span> txn.<span class="function">Succeeded</span>(), <span class="keyword">nil</span>
}</code></pre>
            
            <h3>ç›‘å¬å˜åŒ–</h3>
            <pre><code><span class="comment">// ç›‘å¬å•ä¸ªé”®</span>
watchChan := cli.<span class="function">Watch</span>(ctx, <span class="string">"key"</span>)
<span class="keyword">for</span> watchResp := <span class="keyword">range</span> watchChan {
    <span class="keyword">for</span> _, event := <span class="keyword">range</span> watchResp.Events {
        fmt.<span class="function">Printf</span>(<span class="string">"Type: %s, Key: %s, Value: %s\n"</span>, 
            event.Type, event.Kv.Key, event.Kv.Value)
    }
}

<span class="comment">// ç›‘å¬å‰ç¼€</span>
watchChan = cli.<span class="function">Watch</span>(ctx, <span class="string">"prefix"</span>, clientv3.<span class="function">WithPrefix</span>())
<span class="keyword">for</span> watchResp := <span class="keyword">range</span> watchChan {
    <span class="keyword">for</span> _, event := <span class="keyword">range</span> watchResp.Events {
        fmt.<span class="function">Printf</span>(<span class="string">"Type: %s, Key: %s, Value: %s\n"</span>, 
            event.Type, event.Kv.Key, event.Kv.Value)
    }
}

<span class="comment">// ä»æŒ‡å®šç‰ˆæœ¬å¼€å§‹ç›‘å¬</span>
watchChan = cli.<span class="function">Watch</span>(ctx, <span class="string">"key"</span>, clientv3.<span class="function">WithRev</span>(<span class="number">100</span>))</code></pre>
            
            <h3>æœåŠ¡å‘ç°</h3>
            <pre><code><span class="comment">// æ³¨å†ŒæœåŠ¡</span>
<span class="function">func</span> <span class="function">registerService</span>(cli *clientv3.Client, serviceID, address <span class="keyword">string</span>, ttl <span class="keyword">int64</span>) (<span class="keyword">string</span>, error) {
    <span class="comment">// åˆ›å»ºç§Ÿçº¦</span>
    lease, err := cli.<span class="function">Grant</span>(context.<span class="function">Background</span>(), ttl)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="comment">// æ³¨å†ŒæœåŠ¡</span>
    key := fmt.<span class="function">Sprintf</span>(<span class="string">"/services/%s"</span>, serviceID)
    _, err = cli.<span class="function">Put</span>(context.<span class="function">Background</span>(), key, address, clientv3.<span class="function">WithLease</span>(lease.ID))
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="comment">// ç»­ç§Ÿ</span>
    keepAlive, err := cli.<span class="function">KeepAlive</span>(context.<span class="function">Background</span>(), lease.ID)
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        <span class="keyword">for</span> <span class="keyword">range</span> keepAlive {
            <span class="comment">// ä¿æŒç»­ç§Ÿ</span>
        }
    }()
    
    <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%d"</span>, lease.ID), <span class="keyword">nil</span>
}

<span class="comment">// å‘ç°æœåŠ¡</span>
<span class="function">func</span> <span class="function">discoverService</span>(cli *clientv3.Client, serviceID <span class="keyword">string</span>) (<span class="keyword">string</span>, error) {
    key := fmt.<span class="function">Sprintf</span>(<span class="string">"/services/%s"</span>, serviceID)
    resp, err := cli.<span class="function">Get</span>(context.<span class="function">Background</span>(), key)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="keyword">if</span> <span class="function">len</span>(resp.Kvs) == <span class="number">0</span> {
        <span class="keyword">return</span> <span class="string">""</span>, fmt.<span class="function">Errorf</span>(<span class="string">"service not found"</span>)
    }
    
    <span class="keyword">return</span> string(resp.Kvs[<span class="number">0</span>].Value), <span class="keyword">nil</span>
}</code></pre>
            
            <h3>é…ç½®ç®¡ç†</h3>
            <pre><code><span class="comment">// ç›‘å¬é…ç½®å˜åŒ–</span>
<span class="function">func</span> <span class="function">watchConfig</span>(cli *clientv3.Client, key <span class="keyword">string</span>) {
    watchChan := cli.<span class="function">Watch</span>(context.<span class="function">Background</span>(), key)
    <span class="keyword">for</span> watchResp := <span class="keyword">range</span> watchChan {
        <span class="keyword">for</span> _, event := <span class="keyword">range</span> watchResp.Events {
            <span class="keyword">switch</span> event.Type {
            <span class="keyword">case</span> clientv3.EventTypePut:
                fmt.<span class="function">Printf</span>(<span class="string">"Config updated: %s\n"</span>, event.Kv.Value)
                <span class="comment">// é‡æ–°åŠ è½½é…ç½®</span>
            <span class="keyword">case</span> clientv3.EventTypeDelete:
                fmt.<span class="function">Println</span>(<span class="string">"Config deleted"</span>)
            }
        }
    }
}

<span class="comment">// è·å–é…ç½®</span>
<span class="function">func</span> <span class="function">getConfig</span>(cli *clientv3.Client, key <span class="keyword">string</span>) (<span class="keyword">string</span>, error) {
    resp, err := cli.<span class="function">Get</span>(context.<span class="function">Background</span>(), key)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="keyword">if</span> <span class="function">len</span>(resp.Kvs) == <span class="number">0</span> {
        <span class="keyword">return</span> <span class="string">""</span>, fmt.<span class="function">Errorf</span>(<span class="string">"config not found"</span>)
    }
    
    <span class="keyword">return</span> string(resp.Kvs[<span class="number">0</span>].Value), <span class="keyword">nil</span>
}</code></pre>
            
            <h2 id="bestpractices">æœ€ä½³å®è·µ</h2>
            
            <h3>Validator æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. ç»Ÿä¸€é”™è¯¯å¤„ç†</h4>
                <pre><code><span class="keyword">type</span> ValidationError <span class="keyword">struct</span> {
    Field   <span class="keyword">string</span> <span class="string">`json:"field"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">HandleValidationError</span>(err <span class="keyword">error</span>) []ValidationError {
    <span class="keyword">var</span> errors []ValidationError
    validationErrors := err.(validator.ValidationErrors)
    <span class="keyword">for</span>, e := <span class="keyword">range</span> validationErrors {
        errors = <span class="function">append</span>(errors, ValidationError{
            Field:   e.<span class="function">Field</span>(),
            Message: <span class="function">getErrorMessage</span>(e),
        })
    }
    <span class="keyword">return</span> errors
}</code></pre>
                
                <h4>2. è‡ªå®šä¹‰æ ¡éªŒè§„åˆ™</h4>
                <pre><code><span class="comment">// ä¸šåŠ¡ç›¸å…³çš„è‡ªå®šä¹‰æ ¡éªŒ</span>
<span class="function">func</span> <span class="function">validateBusinessRule</span>(fl validator.FieldLevel) <span class="keyword">bool</span> {
    <span class="comment">// å®ç°ä¸šåŠ¡è§„åˆ™æ ¡éªŒ</span>
    <span class="keyword">return</span> <span class="keyword">true</span>
}</code></pre>
                
                <h4>3. åˆ†å±‚æ ¡éªŒ</h4>
                <pre><code><span class="comment">// Controller å±‚ï¼šæ ¼å¼æ ¡éªŒ</span>
<span class="keyword">if</span> err := c.<span class="function">ShouldBindJSON</span>(&req); err != <span class="keyword">nil</span> {
    <span class="keyword">return</span> err
}

<span class="comment">// Service å±‚ï¼šä¸šåŠ¡æ ¡éªŒ</span>
<span class="keyword">if</span> err := s.<span class="function">ValidateBusiness</span>(&req); err != <span class="keyword">nil</span> {
    <span class="keyword">return</span> err
}</code></pre>
            </div>
            
            <h3>Cobra æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. ç»“æ„åŒ–å‘½ä»¤</h4>
                <pre><code><span class="comment">// cmd/root.go</span>
<span class="keyword">package</span> cmd

<span class="keyword">var</span> rootCmd = &cobra.Command{
    Use:   <span class="string">"myapp"</span>,
    Short: <span class="string">"My application"</span>,
}

<span class="function">func</span> <span class="function">Execute</span>() {
    <span class="keyword">if</span> err := rootCmd.<span class="function">Execute</span>(); err != <span class="keyword">nil</span> {
        os.<span class="function">Exit</span>(<span class="number">1</span>)
    }
}

<span class="comment">// cmd/create.go</span>
<span class="keyword">package</span> cmd

<span class="keyword">var</span> createCmd = &cobra.Command{
    Use:   <span class="string">"create"</span>,
    Short: <span class="string">"Create resource"</span>,
}

<span class="function">func</span> <span class="function">init</span>() {
    rootCmd.<span class="function">AddCommand</span>(createCmd)
}</code></pre>
                
                <h4>2. é…ç½®ç®¡ç†</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ Viper ç®¡ç†é…ç½®</span>
<span class="keyword">var</span> cfgFile <span class="keyword">string</span>

<span class="function">func</span> <span class="function">init</span>() {
    cobra.<span class="function">OnInitialize</span>(<span class="function">initConfig</span>)
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">StringVar</span>(&cfgFile, <span class="string">"config"</span>, <span class="string">""</span>, <span class="string">"config file"</span>)
}

<span class="function">func</span> <span class="function">initConfig</span>() {
    <span class="keyword">if</span> cfgFile != <span class="string">""</span> {
        viper.<span class="function">SetConfigFile</span>(cfgFile)
    } <span class="keyword">else</span> {
        home, _ := os.<span class="function">UserHomeDir</span>()
        viper.<span class="function">AddConfigPath</span>(home)
        viper.<span class="function">SetConfigName</span>(<span class="string">".myapp"</span>)
    }
    
    viper.<span class="function">ReadInConfig</span>()
}</code></pre>
                
                <h4>3. ç”Ÿæˆæ–‡æ¡£</h4>
                <pre><code><span class="comment">// è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£</span>
<span class="keyword">go</span> run main.go docs</code></pre>
            </div>
            
            <h3>Go-Micro æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. æœåŠ¡æ‹†åˆ†</h4>
                <pre><code><span class="comment">// æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†æœåŠ¡</span>
<span class="comment">// - user-service</span>
<span class="comment">// - order-service</span>
<span class="comment">// - payment-service</span></code></pre>
                
                <h4>2. æ¥å£è®¾è®¡</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ Protobuf å®šä¹‰æ¥å£</span>
syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> user;

<span class="keyword">service</span> UserService {
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
}</code></pre>
                
                <h4>3. é”™è¯¯å¤„ç†</h4>
                <pre><code><span class="comment">// ç»Ÿä¸€é”™è¯¯å¤„ç†</span>
<span class="keyword">type</span> ErrorResponse <span class="keyword">struct</span> {
    Code    <span class="keyword">string</span> <span class="string">`json:"code"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">HandleError</span>(err <span class="keyword">error</span>) *ErrorResponse {
    <span class="keyword">return</span> &ErrorResponse{
        Code:    <span class="string">"ERROR"</span>,
        Message: err.<span class="function">Error</span>(),
    }
}</code></pre>
            </div>
            
            <h3>Etcd æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. é”®å‘½åè§„èŒƒ</h4>
                <pre><code><span class="comment">// ä½¿ç”¨å±‚æ¬¡åŒ–çš„é”®å</span>
<span class="comment">// /services/user-service/instances/192.168.1.1:8080</span>
<span class="comment">// /config/database/host</span>
<span class="comment">// /locks/resource-123</span></code></pre>
                
                <h4>2. ç§Ÿçº¦ç®¡ç†</h4>
                <pre><code><span class="comment">// è‡ªåŠ¨ç»­ç§Ÿ</span>
keepAlive, err := cli.<span class="function">KeepAlive</span>(ctx, lease.ID)
<span class="keyword">defer</span> cli.<span class="function">Revoke</span>(ctx, lease.ID)</code></pre>
                
                <h4>3. äº‹åŠ¡ä½¿ç”¨</h4>
                <pre><code><span class="comment">// ä½¿ç”¨äº‹åŠ¡å®ç°åŸå­æ“ä½œ</span>
txn := cli.<span class="function">Txn</span>(ctx)
<span class="comment">// ...</span>
txn.<span class="function">Commit</span>()</code></pre>
                
                <h4>4. ç›‘å¬æœºåˆ¶</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ç›‘å¬å®ç°é…ç½®çƒ­æ›´æ–°</span>
watchChan := cli.<span class="function">Watch</span>(ctx, <span class="string">"/config"</span>, clientv3.<span class="function">WithPrefix</span>())</code></pre>
            </div>
            
            <h3>å¾®æœåŠ¡æ¶æ„æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. æœåŠ¡æ³¨å†Œä¸å‘ç°</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ Etcd ä½œä¸ºæ³¨å†Œä¸­å¿ƒ</span>
registry := etcd.<span class="function">NewRegistry</span>(registry.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:2379"</span>))
service := micro.<span class="function">NewService</span>(micro.<span class="function">Registry</span>(registry))</code></pre>
                
                <h4>2. é…ç½®ä¸­å¿ƒ</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ Etcd å­˜å‚¨é…ç½®</span>
cli.<span class="function">Put</span>(ctx, <span class="string">"/config/database/host"</span>, <span class="string">"localhost"</span>)</code></pre>
                
                <h4>3. åˆ†å¸ƒå¼é”</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ Etcd å®ç°åˆ†å¸ƒå¼é”</span>
<span class="function">func</span> <span class="function">acquireLock</span>(cli *clientv3.Client, key <span class="keyword">string</span>) (<span class="keyword">bool</span>, error) {
    <span class="comment">// ...</span>
}</code></pre>
                
                <h4>4. æ¶ˆæ¯é˜Ÿåˆ—</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ Go-Micro Broker</span>
micro.<span class="function">RegisterSubscriber</span>(<span class="string">"topic"</span>, service.<span class="function">Server</span>(), handler)</code></pre>
            </div>
            
            
            <h2 id="protobuf">Protobuf æ•°æ®åºåˆ—åŒ–</h2>
            <p>Protocol Buffers (Protobuf) æ˜¯ Google å¼€å‘çš„ä¸€ç§è¯­è¨€æ— å…³ã€å¹³å°æ— å…³çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ã€‚</p>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="comment">// å®‰è£… protoc ç¼–è¯‘å™¨</span>
<span class="comment">// macOS: brew install protobuf</span>
<span class="comment">// Ubuntu: apt-get install protobuf-compiler</span>

<span class="comment">// å®‰è£… Go æ’ä»¶</span>
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></pre>
            
            <h3>å®šä¹‰ .proto æ–‡ä»¶</h3>
            <pre><code><span class="comment">// user.proto</span>
syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> user;

<span class="keyword">option</span> go_package = <span class="string">"./user"</span>;

<span class="keyword">message</span> User {
    <span class="keyword">int32</span> id = 1;
    <span class="keyword">string</span> name = 2;
    <span class="keyword">string</span> email = 3;
    <span class="keyword">repeated</span> <span class="keyword">string</span> tags = 4;
    <span class="keyword">enum</span> Status {
        UNKNOWN = 0;
        ACTIVE = 1;
        INACTIVE = 2;
    }
    Status status = 5;
}

<span class="keyword">message</span> GetUserRequest {
    <span class="keyword">int32</span> id = 1;
}

<span class="keyword">message</span> GetUserResponse {
    User user = 1;
}</code></pre>
            
            <h3>ç”Ÿæˆ Go ä»£ç </h3>
            <pre><code><span class="comment">// ç”Ÿæˆä»£ç </span>
protoc --go_out=. --go_opt=paths=source_relative \
       --go-grpc_out=. --go-grpc_opt=paths=source_relative \
       user.proto</code></pre>
            
            <h3>åºåˆ—åŒ–å’Œååºåˆ—åŒ–</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"google.golang.org/protobuf/proto"</span>
    <span class="string">"path/to/user"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºæ¶ˆæ¯</span>
    u := &user.User{
        Id:    1,
        Name:  <span class="string">"å¼ ä¸‰"</span>,
        Email: <span class="string">"zhangsan@example.com"</span>,
        Tags:  []<span class="keyword">string</span>{<span class="string">"admin"</span>, <span class="string">"user"</span>},
        Status: user.User_ACTIVE,
    }
    
    <span class="comment">// åºåˆ—åŒ–</span>
    data, err := proto.<span class="function">Marshal</span>(u)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"åºåˆ—åŒ–ç»“æœ: %x\n"</span>, data)
    
    <span class="comment">// ååºåˆ—åŒ–</span>
    <span class="keyword">var</span> u2 user.User
    err = proto.<span class="function">Unmarshal</span>(data, &u2)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"ååºåˆ—åŒ–ç»“æœ: %+v\n"</span>, u2)
}</code></pre>
            
            <h3>Protobuf æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. å­—æ®µç¼–å·è§„èŒƒ</h4>
                <pre><code><span class="comment">// 1-15: å•å­—èŠ‚ç¼–ç ï¼Œå¸¸ç”¨å­—æ®µ</span>
<span class="comment">// 16-2047: ä¸¤å­—èŠ‚ç¼–ç ï¼Œä¸å¸¸ç”¨å­—æ®µ</span>
<span class="comment">// ä¿ç•™å­—æ®µç¼–å·ï¼š19000-19999</span>

<span class="keyword">message</span> User {
    <span class="keyword">string</span> name = 1;   <span class="comment">// å¸¸ç”¨å­—æ®µ</span>
    <span class="keyword">string</span> email = 2;  <span class="comment">// å¸¸ç”¨å­—æ®µ</span>
    <span class="keyword">string</span> phone = 16; <span class="comment">// ä¸å¸¸ç”¨å­—æ®µ</span>
}</code></pre>
                
                <h4>2. ä½¿ç”¨ oneof</h4>
                <pre><code><span class="keyword">message</span> Result {
    <span class="keyword">oneof</span> result {
        <span class="keyword">string</span> error = 1;
        <span class="keyword">string</span> data = 2;
    }
}</code></pre>
                
                <h4>3. ä½¿ç”¨ map</h4>
                <pre><code><span class="keyword">message</span> User {
    <span class="keyword">map</span>&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; metadata = 10;
}</code></pre>
                
                <h4>4. ç‰ˆæœ¬å…¼å®¹æ€§</h4>
                <pre><code><span class="comment">// æ–°å¢å­—æ®µæ—¶ä½¿ç”¨ optional</span>
<span class="keyword">message</span> User {
    <span class="keyword">string</span> name = 1;
    <span class="keyword">optional</span> <span class="keyword">string</span> nickname = 10; <span class="comment">// æ–°å¢å­—æ®µ</span>
}

<span class="comment">// ä¿ç•™åºŸå¼ƒå­—æ®µ</span>
<span class="keyword">message</span> User {
    <span class="keyword">int32</span> old_id = 1 [deprecated = <span class="keyword">true</span>];
    <span class="keyword">string</span> new_id = 2;
}</code></pre>
            </div>

            <h2 id="redis">Redis å®¢æˆ·ç«¯</h2>
            <p>Redis æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„é”®å€¼å­˜å‚¨æ•°æ®åº“ï¼ŒGo ä¸­å¸¸ç”¨ go-redis åº“è¿›è¡Œæ“ä½œã€‚</p>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">go get</span> github.com/redis/go-redis/v9</code></pre>
            
            <h3>åŸºæœ¬æ“ä½œ</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    <span class="string">"github.com/redis/go-redis/v9"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºå®¢æˆ·ç«¯</span>
    rdb := redis.<span class="function">NewClient</span>(&redis.Options{
        Addr:     <span class="string">"localhost:6379"</span>,
        Password: <span class="string">""</span>,
        DB:       0,
    })
    
    ctx := context.<span class="function">Background</span>()
    
    <span class="comment">// è®¾ç½®é”®å€¼</span>
    err := rdb.<span class="function">Set</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>, 0).<span class="function">Err</span>()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    
    <span class="comment">// è·å–é”®å€¼</span>
    val, err := rdb.<span class="function">Get</span>(ctx, <span class="string">"key"</span>).<span class="function">Result</span>()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Println</span>(<span class="string">"key:"</span>, val)
    
    <span class="comment">// è®¾ç½®è¿‡æœŸæ—¶é—´</span>
    rdb.<span class="function">Set</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>, 10*time.Minute)
    
    <span class="comment">// åˆ é™¤é”®</span>
    rdb.<span class="function">Del</span>(ctx, <span class="string">"key"</span>)
}</code></pre>
            
            <h3>æ•°æ®ç»“æ„æ“ä½œ</h3>
            <pre><code><span class="comment">// 1. Hash æ“ä½œ</span>
rdb.<span class="function">HSet</span>(ctx, <span class="string">"user:1"</span>, <span class="string">"name"</span>, <span class="string">"å¼ ä¸‰"</span>)
rdb.<span class="function">HSet</span>(ctx, <span class="string">"user:1"</span>, <span class="string">"email"</span>, <span class="string">"zhangsan@example.com"</span>)
name, _ := rdb.<span class="function">HGet</span>(ctx, <span class="string">"user:1"</span>, <span class="string">"name"</span>).<span class="function">Result</span>()

<span class="comment">// 2. List æ“ä½œ</span>
rdb.<span class="function">LPush</span>(ctx, <span class="string">"list"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>)
val, _ := rdb.<span class="function">RPop</span>(ctx, <span class="string">"list"</span>).<span class="function">Result</span>()

<span class="comment">// 3. Set æ“ä½œ</span>
rdb.<span class="function">SAdd</span>(ctx, <span class="string">"set"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>)
members, _ := rdb.<span class="function">SMembers</span>(ctx, <span class="string">"set"</span>).<span class="function">Result</span>()

<span class="comment">// 4. Sorted Set æ“ä½œ</span>
rdb.<span class="function">ZAdd</span>(ctx, <span class="string">"zset"</span>, redis.Z{Score: 1, Member: <span class="string">"a"</span>})
rdb.<span class="function">ZAdd</span>(ctx, <span class="string">"zset"</span>, redis.Z{Score: 2, Member: <span class="string">"b"</span>})
result, _ := rdb.<span class="function">ZRangeWithScores</span>(ctx, <span class="string">"zset"</span>, 0, -1).<span class="function">Result</span>()</code></pre>
            
            <h3>å‘å¸ƒè®¢é˜…</h3>
            <pre><code><span class="comment">// å‘å¸ƒæ¶ˆæ¯</span>
err := rdb.<span class="function">Publish</span>(ctx, <span class="string">"channel"</span>, <span class="string">"message"</span>).<span class="function">Err</span>()

<span class="comment">// è®¢é˜…æ¶ˆæ¯</span>
pubsub := rdb.<span class="function">Subscribe</span>(ctx, <span class="string">"channel"</span>)
<span class="keyword">defer</span> pubsub.<span class="function">Close</span>()

<span class="keyword">for</span> {
    msg, err := pubsub.<span class="function">ReceiveMessage</span>(ctx)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Println</span>(<span class="string">"æ”¶åˆ°æ¶ˆæ¯:"</span>, msg.Payload)
}</code></pre>
            
            <h3>äº‹åŠ¡</h3>
            <pre><code><span class="comment">// ä½¿ç”¨äº‹åŠ¡</span>
<span class="function">func</span> <span class="function">transfer</span>(from, to <span class="keyword">string</span>, amount <span class="keyword">int64</span>) <span class="keyword">error</span> {
    tx := rdb.<span class="function">TxPipeline</span>()
    
    err := tx.<span class="function">DecrBy</span>(ctx, from, amount).<span class="function">Err</span>()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    tx.<span class="function">IncrBy</span>(ctx, to, amount)
    
    _, err = tx.<span class="function">Exec</span>(ctx)
    <span class="keyword">return</span> err
}</code></pre>
            
            <h3>Redis æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. è¿æ¥æ± é…ç½®</h4>
                <pre><code>rdb := redis.<span class="function">NewClient</span>(&redis.Options{
    Addr:         <span class="string">"localhost:6379"</span>,
    Password:     <span class="string">""</span>,
    DB:           0,
    PoolSize:     10,   <span class="comment">// è¿æ¥æ± å¤§å°</span>
    MinIdleConns: 5,    <span class="comment">// æœ€å°ç©ºé—²è¿æ¥</span>
    MaxRetries:   3,    <span class="comment">// æœ€å¤§é‡è¯•æ¬¡æ•°</span>
})</code></pre>
                
                <h4>2. ä½¿ç”¨ Pipeline</h4>
                <pre><code><span class="comment">// æ‰¹é‡æ“ä½œä½¿ç”¨ Pipeline</span>
pipe := rdb.<span class="function">Pipeline</span>()
pipe.<span class="function">Set</span>(ctx, <span class="string">"key1"</span>, <span class="string">"value1"</span>, 0)
pipe.<span class="function">Set</span>(ctx, <span class="string">"key2"</span>, <span class="string">"value2"</span>, 0)
pipe.<span class="function">Set</span>(ctx, <span class="string">"key3"</span>, <span class="string">"value3"</span>, 0)
cmds, err := pipe.<span class="function">Exec</span>(ctx)</code></pre>
                
                <h4>3. é”®å‘½åè§„èŒƒ</h4>
                <pre><code><span class="comment">// ä½¿ç”¨å†’å·åˆ†éš”çš„å±‚æ¬¡ç»“æ„</span>
<span class="string">"user:1:name"</span>
<span class="string">"user:1:email"</span>
<span class="string">"session:abc123"</span>
<span class="string">"cache:product:123"</span></code></pre>
                
                <h4>4. ç¼“å­˜ç­–ç•¥</h4>
                <pre><code><span class="comment">// Cache-Aside æ¨¡å¼</span>
<span class="function">func</span> <span class="function">getUser</span>(id <span class="keyword">int64</span>) (*User, <span class="keyword">error</span>) {
    <span class="comment">// 1. å…ˆæŸ¥ç¼“å­˜</span>
    key := fmt.<span class="function">Sprintf</span>(<span class="string">"user:%d"</span>, id)
    val, err := rdb.<span class="function">Get</span>(ctx, key).<span class="function">Result</span>()
    <span class="keyword">if</span> err == <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="function">unmarshalUser</span>(val)
    }
    
    <span class="comment">// 2. æŸ¥æ•°æ®åº“</span>
    user, err := db.<span class="function">GetUser</span>(id)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">nil</span>, err
    }
    
    <span class="comment">// 3. å†™å…¥ç¼“å­˜</span>
    data, _ := json.<span class="function">Marshal</span>(user)
    rdb.<span class="function">Set</span>(ctx, key, data, 10*time.Minute)
    
    <span class="keyword">return</span> user, <span class="keyword">nil</span>
}</code></pre>
            </div>

            <h2 id="mysql">MySQL å®¢æˆ·ç«¯</h2>
            <p>Go ä¸­å¸¸ç”¨ GORM æˆ– database/sql æ“ä½œ MySQL æ•°æ®åº“ã€‚</p>
            
            <h3>å¿«é€Ÿå¼€å§‹</h3>
            <pre><code><span class="keyword">go get</span> gorm.io/gorm
<span class="keyword">go get</span> gorm.io/driver/mysql</code></pre>
            
            <h3>è¿æ¥æ•°æ®åº“</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"gorm.io/driver/mysql"</span>
    <span class="string">"gorm.io/gorm"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dsn := <span class="string">"user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"</span>
    db, err := gorm.<span class="function">Open</span>(mysql.<span class="function">Open</span>(dsn), &gorm.Config{})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
}</code></pre>
            
            <h3>å®šä¹‰æ¨¡å‹</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID        <span class="keyword">uint</span>           <span class="string">`gorm:"primaryKey"`</span>
    Name      <span class="keyword">string</span>         <span class="string">`gorm:"size:255;not null"`</span>
    Email     <span class="keyword">string</span>         <span class="string">`gorm:"size:255;uniqueIndex"`</span>
    Age       <span class="keyword">int</span>            <span class="string">`gorm:"default:0"`</span>
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}

<span class="comment">// è‡ªåŠ¨è¿ç§»</span>
db.<span class="function">AutoMigrate</span>(&User{})</code></pre>
            
            <h3>CRUD æ“ä½œ</h3>
            <pre><code><span class="comment">// åˆ›å»º</span>
user := User{Name: <span class="string">"å¼ ä¸‰"</span>, Email: <span class="string">"zhangsan@example.com"</span>}
result := db.<span class="function">Create</span>(&user)

<span class="comment">// æŸ¥è¯¢</span>
<span class="keyword">var</span> user User
db.<span class="function">First</span>(&user, 1)  <span class="comment">// æ ¹æ® ID æŸ¥è¯¢</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"å¼ ä¸‰"</span>).<span class="function">First</span>(&user)
db.<span class="function">Find</span>(&users)  <span class="comment">// æŸ¥è¯¢æ‰€æœ‰</span>

<span class="comment">// æ›´æ–°</span>
db.<span class="function">Model</span>(&user).<span class="function">Update</span>(<span class="string">"name"</span>, <span class="string">"æå››"</span>)
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(User{Name: <span class="string">"æå››"</span>, Age: 30})

<span class="comment">// åˆ é™¤</span>
db.<span class="function">Delete</span>(&user)  <span class="comment">// è½¯åˆ é™¤</span>
db.<span class="function">Unscoped</span>().<span class="function">Delete</span>(&user)  <span class="comment">// æ°¸ä¹…åˆ é™¤</span></code></pre>
            
            <h3>å¤æ‚æŸ¥è¯¢</h3>
            <pre><code><span class="comment">// æ¡ä»¶æŸ¥è¯¢</span>
db.<span class="function">Where</span>(<span class="string">"age > ?"</span>, 18).<span class="function">Find</span>(&users)
db.<span class="function">Where</span>(<span class="string">"name LIKE ?"</span>, <span class="string">"%å¼ %"</span>).<span class="function">Find</span>(&users)

<span class="comment">// Or æŸ¥è¯¢</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"å¼ ä¸‰"</span>).<span class="function">Or</span>(<span class="string">"name = ?"</span>, <span class="string">"æå››"</span>).<span class="function">Find</span>(&users)

<span class="comment">// æ’åºå’Œåˆ†é¡µ</span>
db.<span class="function">Order</span>(<span class="string">"age desc"</span>).<span class="function">Offset</span>(0).<span class="function">Limit</span>(10).<span class="function">Find</span>(&users)

<span class="comment">// ç»Ÿè®¡</span>
<span class="keyword">var</span> count <span class="keyword">int64</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Count</span>(&count)

<span class="comment">// åŸç”Ÿ SQL</span>
db.<span class="function">Raw</span>(<span class="string">"SELECT * FROM users WHERE age > ?"</span>, 18).<span class="function">Scan</span>(&users)</code></pre>
            
            <h3>äº‹åŠ¡</h3>
            <pre><code><span class="comment">// è‡ªåŠ¨äº‹åŠ¡</span>
err := db.<span class="function">Transaction</span>(<span class="keyword">func</span>(tx *gorm.DB) <span class="keyword">error</span> {
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&user1).<span class="function">Error</span>; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&user2).<span class="function">Error</span>; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
})

<span class="comment">// æ‰‹åŠ¨äº‹åŠ¡</span>
tx := db.<span class="function">Begin</span>()
<span class="keyword">defer</span> <span class="function">func</span>() {
    <span class="keyword">if</span> r := <span class="function">recover</span>(); r != <span class="keyword">nil</span> {
        tx.<span class="function">Rollback</span>()
    }
}()

<span class="keyword">if</span> err := tx.<span class="function">Create</span>(&user).<span class="function">Error</span>; err != <span class="keyword">nil</span> {
    tx.<span class="function">Rollback</span>()
    <span class="keyword">return</span> err
}

tx.<span class="function">Commit</span>()</code></pre>
            
            <h3>MySQL æœ€ä½³å®è·µ</h3>
            <div class="note-box">
                <h4>1. è¿æ¥æ± é…ç½®</h4>
                <pre><code>sqlDB, _ := db.<span class="function">DB</span>()
sqlDB.<span class="function">SetMaxIdleConns</span>(10)
sqlDB.<span class="function">SetMaxOpenConns</span>(100)
sqlDB.<span class="function">SetConnMaxLifetime</span>(time.Hour)</code></pre>
                
                <h4>2. ä½¿ç”¨ç´¢å¼•</h4>
                <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    Email <span class="keyword">string</span> <span class="string">`gorm:"uniqueIndex"`</span>
    Age   <span class="keyword">int</span>    <span class="string">`gorm:"index"`</span>
}</code></pre>
                
                <h4>3. æ‰¹é‡æ“ä½œ</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ CreateInBatches æ‰¹é‡æ’å…¥</span>
users := []User{{Name: <span class="string">"a"</span>}, {Name: <span class="string">"b"</span>}, {Name: <span class="string">"c"</span>}}
db.<span class="function">CreateInBatches</span>(users, 100)</code></pre>
                
                <h4>4. é¢„åŠ è½½é¿å… N+1</h4>
                <pre><code><span class="comment">// ä½¿ç”¨ Preload é¢„åŠ è½½å…³è”</span>
db.<span class="function">Preload</span>(<span class="string">"Orders"</span>).<span class="function">Find</span>(&users)</code></pre>
                
                <h4>5. ä½¿ç”¨è½¯åˆ é™¤</h4>
                <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}</code></pre>
            </div>

            <h3>é›†æˆæœ€ä½³å®è·µ</h3>
            <div class="example-box">
                <h4>å®Œæ•´çš„æ•°æ®è®¿é—®å±‚</h4>
                <pre><code><span class="keyword">type</span> UserRepository <span class="keyword">interface</span> {
    <span class="function">Create</span>(user *User) <span class="keyword">error</span>
    <span class="function">GetByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>)
    <span class="function">GetByEmail</span>(email <span class="keyword">string</span>) (*User, <span class="keyword">error</span>)
    <span class="function">Update</span>(user *User) <span class="keyword">error</span>
    <span class="function">Delete</span>(id <span class="keyword">uint</span>) <span class="keyword">error</span>
}

<span class="keyword">type</span> userRepository <span class="keyword">struct</span> {
    db *gorm.DB
}

<span class="function">func</span> <span class="function">NewUserRepository</span>(db *gorm.DB) UserRepository {
    <span class="keyword">return</span> &userRepository{db: db}
}

<span class="function">func</span> (r *userRepository) <span class="function">GetByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>) {
    <span class="keyword">var</span> user User
    err := r.db.<span class="function">First</span>(&user, id).<span class="function">Error</span>
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">nil</span>, err
    }
    <span class="keyword">return</span> &user, <span class="keyword">nil</span>
}</code></pre>
            </div>
<h3>æ€»ç»“</h3>
            <div class="example-box">
                <p>æœ¬ç« ä»‹ç»äº† Go è¯­è¨€ç”Ÿæ€ä¸­æ›´å¤šé‡è¦çš„ç¤¾åŒºåº“ï¼š</p>
                <ul>
                    <li><strong>Validator</strong>ï¼šå¼ºå¤§çš„å‚æ•°æ ¡éªŒåº“ï¼Œæ”¯æŒå¤šç§æ ¡éªŒè§„åˆ™å’Œè‡ªå®šä¹‰è§„åˆ™</li>
                    <li><strong>Cobra</strong>ï¼šåŠŸèƒ½ä¸°å¯Œçš„å‘½ä»¤è¡Œæ¡†æ¶ï¼Œé€‚åˆæ„å»º CLI åº”ç”¨</li>
                    <li><strong>Go-Micro</strong>ï¼šå¾®æœåŠ¡æ¡†æ¶ï¼Œæä¾›æœåŠ¡å‘ç°ã€RPC é€šä¿¡ç­‰åŠŸèƒ½</li>
                    <li><strong>Etcd</strong>ï¼šåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œç”¨äºé…ç½®ç®¡ç†å’ŒæœåŠ¡å‘ç°</li>
                </ul>
                <p>è¿™äº›åº“åœ¨æ„å»ºä¼ä¸šçº§åº”ç”¨æ—¶éå¸¸æœ‰ç”¨ï¼ŒæŒæ¡å®ƒä»¬å¯ä»¥å¸®åŠ©æ‚¨æ„å»ºé«˜æ€§èƒ½ã€å¯æ‰©å±•çš„å¾®æœåŠ¡æ¶æ„ã€‚</p>
            </div>
        </div>
    </div>
</body>
</html>