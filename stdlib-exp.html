<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exp 实验性库 - Go 学习教程</title>
    <link rel="stylesheet" href="styles.css?v=1.3">
    <script src="navigation.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- 导航栏将通过JavaScript动态加载 -->
    </aside>
                <div class="content">
            <a href="stdlib.html" class="back-link">← 返回 stdlib</a>
            <h2 id="exp">exp 实验性标准库</h2>
            
            <h3>简介</h3>
            <p>exp（experimental）是 Go 语言的实验性标准库，包含了一些新功能和实验性的实现。这些库可能会在未来成为标准库的一部分，也可能被移除或修改。常用的 exp 库包括 expvar（变量监控）、slog（结构化日志）等。</p>
            
            <h3>expvar 变量监控</h3>
            <p>expvar 提供了一种标准化的方式来发布和监控运行时的变量，特别适合用于监控和调试。</p>
            
            <h4>基本使用</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"expvar"</span>
    <span class="string">"fmt"</span>
    <span class="string">"net/http"</span>
    <span class="string">"time"</span>
)

<span class="keyword">var</span> (
    requests    = expvar.<span class="function">NewInt</span>(<span class="string">"requests"</span>)
    errors      = expvar.<span class="function">NewInt</span>(<span class="string">"errors"</span>)
    connections = expvar.<span class="function">NewInt</span>(<span class="string">"connections"</span>)
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 注册 HTTP 处理器</span>
    http.<span class="function">Handle</span>(<span class="string">"/debug/vars"</span>, expvar.<span class="function">Handler</span>())
    
    <span class="comment">// 模拟请求处理</span>
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        <span class="keyword">for</span> {
            requests.<span class="function">Add</span>(<span class="number">1</span>)
            time.<span class="function">Sleep</span>(time.Second)
        }
    }()
    
    fmt.<span class="function">Println</span>(<span class="string">"Server started on :8080"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Visit http://localhost:8080/debug/vars to see metrics"</span>)
    http.<span class="function">ListenAndServe</span>(<span class="string">":8080"</span>, <span class="keyword">nil</span>)
}</code></pre>
            
            <h4>自定义变量</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"expvar"</span>
    <span class="string">"fmt"</span>
    <span class="string">"sync"</span>
)

<span class="comment">// 自定义计数器</span>
<span class="keyword">type</span> Counter <span class="keyword">struct</span> {
    mu    sync.Mutex
    count <span class="keyword">int</span>
}

<span class="function">func</span> (c *Counter) <span class="function">String</span>() <span class="keyword">string</span> {
    c.mu.<span class="function">Lock</span>()
    <span class="keyword">defer</span> c.mu.<span class="function">Unlock</span>()
    <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%d"</span>, c.count)
}

<span class="function">func</span> (c *Counter) <span class="function">Add</span>(n <span class="keyword">int</span>) {
    c.mu.<span class="function">Lock</span>()
    <span class="keyword">defer</span> c.mu.<span class="function">Unlock</span>()
    c.count += n
}

<span class="keyword">var</span> customCounter = &Counter{}

<span class="function">func</span> <span class="function">init</span>() {
    expvar.<span class="function">Publish</span>(<span class="string">"custom_counter"</span>, customCounter)
}

<span class="function">func</span> <span class="function">main</span>() {
    customCounter.<span class="function">Add</span>(<span class="number">1</span>)
    customCounter.<span class="function">Add</span>(<span class="number">2</span>)
    
    <span class="comment">// 获取变量值</span>
    val := expvar.<span class="function">Get</span>(<span class="string">"custom_counter"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Custom counter:"</span>, val.<span class="function">String</span>())
}</code></pre>
            
            <h4>Map 类型</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"expvar"</span>
    <span class="string">"fmt"</span>
)

<span class="keyword">var</span> (
    <span class="comment">// 创建 Map</span>
    stats = expvar.<span class="function">NewMap</span>(<span class="string">"stats"</span>)
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 添加键值对</span>
    stats.<span class="function">Add</span>(<span class="string">"requests"</span>, <span class="number">100</span>)
    stats.<span class="function">Add</span>(<span class="string">"errors"</span>, <span class="number">5</span>)
    
    <span class="comment">// 设置值</span>
    stats.<span class="function">Set</span>(<span class="string">"version"</span>, expvar.<span class="function">String</span>(<span class="string">"1.0.0"</span>))
    
    <span class="comment">// 获取值</span>
    requests := stats.<span class="function">Get</span>(<span class="string">"requests"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Requests:"</span>, requests.<span class="function">String</span>())
    
    <span class="comment">// 遍历所有键</span>
    stats.<span class="function">Do</span>(<span class="keyword">func</span>(kv expvar.KeyValue) <span class="keyword">bool</span> {
        fmt.<span class="function">Printf</span>(<span class="string">"%s: %s\n"</span>, kv.Key, kv.Value.<span class="function">String</span>())
        <span class="keyword">return</span> <span class="keyword">true</span>
    })
}</code></pre>
            
            <h4>Float 类型</h4>
            <pre><code><span class="keyword">var</span> (
    cpuUsage = expvar.<span class="function">NewFloat</span>(<span class="string">"cpu_usage"</span>)
    memory   = expvar.<span class="function">NewFloat</span>(<span class="string">"memory_usage"</span>)
)

<span class="function">func</span> <span class="function">updateMetrics</span>() {
    cpuUsage.<span class="function">Set</span>(<span class="number">45.5</span>)
    memory.<span class="function">Set</span>(<span class="number">1024.5</span>)
}</code></pre>
            
            <h4>String 类型</h4>
            <pre><code><span class="keyword">var</span> (
    version   = expvar.<span class="function">NewString</span>(<span class="string">"version"</span>)
    buildTime = expvar.<span class="function">NewString</span>(<span class="string">"build_time"</span>)
)

<span class="function">func</span> <span class="function">init</span>() {
    version.<span class="function">Set</span>(<span class="string">"1.0.0"</span>)
    buildTime.<span class="function">Set</span>(<span class="string">"2024-01-01 00:00:00"</span>)
}</code></pre>
            
            <h4>在 Web 服务器中使用</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"expvar"</span>
    <span class="string">"fmt"</span>
    <span class="string">"net/http"</span>
    <span class="string">"time"</span>
)

<span class="keyword">var</span> (
    requestCount = expvar.<span class="function">NewInt</span>(<span class="string">"request_count"</span>)
    errors       = expvar.<span class="function">NewInt</span>(<span class="string">"errors"</span>)
    avgTime      = expvar.<span class="function">NewFloat</span>(<span class="string">"avg_time_ms"</span>)
)

<span class="function">func</span> <span class="function">handler</span>(w http.ResponseWriter, r *http.Request) {
    start := time.<span class="function">Now</span>()
    
    requestCount.<span class="function">Add</span>(<span class="number">1</span>)
    
    <span class="comment">// 模拟处理</span>
    time.<span class="function">Sleep</span>(time.Millisecond * <span class="number">10</span>)
    
    <span class="comment">// 计算平均时间</span>
    elapsed := time.<span class="function">Since</span>(start).<span class="function">Milliseconds</span>()
    avgTime.<span class="function">Set</span>(<span class="function">float64</span>(elapsed))
    
    fmt.<span class="function">Fprintln</span>(w, <span class="string">"Hello, World!"</span>)
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 注册 expvar 处理器</span>
    http.<span class="function">Handle</span>(<span class="string">"/debug/vars"</span>, expvar.<span class="function">Handler</span>())
    
    <span class="comment">// 注册业务处理器</span>
    http.<span class="function">HandleFunc</span>(<span class="string">"/"</span>, handler)
    
    fmt.<span class="function">Println</span>(<span class="string">"Server started on :8080"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Metrics: http://localhost:8080/debug/vars"</span>)
    http.<span class="function">ListenAndServe</span>(<span class="string">":8080"</span>, <span class="keyword">nil</span>)
}</code></pre>
            
            <h3>slog 结构化日志</h3>
            <p>slog 是 Go 1.21+ 引入的结构化日志库，提供了结构化的日志记录功能，比传统的 log 包更强大和灵活。</p>
            
            <h4>基本使用</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log/slog"</span>
    <span class="string">"os"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建默认 logger</span>
    logger := slog.<span class="function">New</span>(slog.<span class="function">NewTextHandler</span>(os.Stdout, <span class="keyword">nil</span>))
    
    <span class="comment">// 记录不同级别的日志</span>
    logger.<span class="function">Debug</span>(<span class="string">"Debug message"</span>)
    logger.<span class="function">Info</span>(<span class="string">"Info message"</span>)
    logger.<span class="function">Warn</span>(<span class="string">"Warning message"</span>)
    logger.<span class="function">Error</span>(<span class="string">"Error message"</span>)
}</code></pre>
            
            <h4>结构化字段</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log/slog"</span>
    <span class="string">"os"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger := slog.<span class="function">New</span>(slog.<span class="function">NewJSONHandler</span>(os.Stdout, <span class="keyword">nil</span>))
    
    <span class="comment">// 添加结构化字段</span>
    logger.<span class="function">Info</span>(<span class="string">"User logged in"</span>,
        slog.<span class="function">String</span>(<span class="string">"user_id"</span>, <span class="string">"123"</span>),
        slog.<span class="function">String</span>(<span class="string">"username"</span>, <span class="string">"alice"</span>),
        slog.<span class="function">String</span>(<span class="string">"ip"</span>, <span class="string">"192.168.1.1"</span>),
    )
    
    logger.<span class="function">Error</span>(<span class="string">"Request failed"</span>,
        slog.<span class="function">String</span>(<span class="string">"path"</span>, <span class="string">"/api/users"</span>),
        slog.<span class="function">Int</span>(<span class="string">"status"</span>, <span class="number">500</span>),
        slog.<span class="function">Duration</span>(<span class="string">"duration_ms"</span>, <span class="number">150</span>),
    )
}</code></pre>
            
            <h4>自定义 Handler</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"encoding/json"</span>
    <span class="string">"log/slog"</span>
    <span class="string">"os"</span>
)

<span class="comment">// 自定义 Handler</span>
<span class="keyword">type</span> CustomHandler <span class="keyword">struct</span> {
    slog.Handler
}

<span class="function">func</span> (h *CustomHandler) <span class="function">Handle</span>(ctx context.Context, r slog.Record) <span class="keyword">error</span> {
    <span class="comment">// 添加自定义字段</span>
    r.<span class="function">AddAttrs</span>(slog.<span class="function">String</span>(<span class="string">"service"</span>, <span class="string">"myapp"</span>))
    <span class="keyword">return</span> h.Handler.<span class="function">Handle</span>(ctx, r)
}

<span class="function">func</span> <span class="function">main</span>() {
    handler := &CustomHandler{
        Handler: slog.<span class="function">NewJSONHandler</span>(os.Stdout, <span class="keyword">nil</span>),
    }
    
    logger := slog.<span class="function">New</span>(handler)
    logger.<span class="function">Info</span>(<span class="string">"Test message"</span>)
}</code></pre>
            
            <h4>日志级别控制</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log/slog"</span>
    <span class="string">"os"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 设置日志级别</span>
    opts := &slog.HandlerOptions{
        Level: slog.LevelInfo,
    }
    
    logger := slog.<span class="function">New</span>(slog.<span class="function">NewJSONHandler</span>(os.Stdout, opts))
    
    <span class="comment">// Debug 级别的日志不会输出</span>
    logger.<span class="function">Debug</span>(<span class="string">"Debug message"</span>)
    logger.<span class="function">Info</span>(<span class="string">"Info message"</span>)
}</code></pre>
            
            <h4>上下文支持</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"log/slog"</span>
    <span class="string">"os"</span>
)

<span class="keyword">type</span> contextKey <span class="keyword">struct</span>{}

<span class="function">func</span> <span class="function">main</span>() {
    logger := slog.<span class="function">New</span>(slog.<span class="function">NewJSONHandler</span>(os.Stdout, <span class="keyword">nil</span>))
    
    <span class="comment">// 在上下文中添加值</span>
    ctx := context.<span class="function">WithValue</span>(context.<span class="function">Background</span>(), contextKey{}, <span class="string">"request-123"</span>)
    
    <span class="comment">// 使用上下文记录日志</span>
    logger.<span class="function">InfoContext</span>(ctx, <span class="string">"Processing request"</span>)
}</code></pre>
            
            <h4>分组日志</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log/slog"</span>
    <span class="string">"os"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger := slog.<span class="function">New</span>(slog.<span class="function">NewJSONHandler</span>(os.Stdout, <span class="keyword">nil</span>))
    
    <span class="comment">// 使用分组</span>
    logger.<span class="function">Info</span>(<span class="string">"User action"</span>,
        slog.<span class="function">Group</span>(<span class="string">"user"</span>,
            slog.<span class="function">String</span>(<span class="string">"id"</span>, <span class="string">"123"</span>),
            slog.<span class="function">String</span>(<span class="string">"name"</span>, <span class="string">"alice"</span>),
        ),
        slog.<span class="function">Group</span>(<span class="string">"request"</span>,
            slog.<span class="function">String</span>(<span class="string">"path"</span>, <span class="string">"/api/users"</span>),
            slog.<span class="function">String</span>(<span class="string">"method"</span>, <span class="string">"GET"</span>),
        ),
    )
}</code></pre>
            
            <h4>与 Gin 集成</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log/slog"</span>
    <span class="string">"net/http"</span>
    
    <span class="string">"github.com/gin-gonic/gin"</span>
)

<span class="keyword">var</span> logger = slog.<span class="function">New</span>(slog.<span class="function">NewJSONHandler</span>(os.Stdout, <span class="keyword">nil</span>))

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// 自定义中间件</span>
    r.<span class="function">Use</span>(<span class="keyword">func</span>(c *gin.Context) {
        start := time.<span class="function">Now</span>()
        path := c.<span class="function">Request</span>.URL.Path
        
        c.<span class="function">Next</span>()
        
        logger.<span class="function">Info</span>(<span class="string">"Request"</span>,
            slog.<span class="function">String</span>(<span class="string">"method"</span>, c.<span class="function">Request</span>.Method),
            slog.<span class="function">String</span>(<span class="string">"path"</span>, path),
            slog.<span class="function">Int</span>(<span class="string">"status"</span>, c.<span class="function">Writer</span>().<span class="function">Status</span>()),
            slog.<span class="function">Duration</span>(<span class="string">"duration"</span>, time.<span class="function">Since</span>(start)),
        )
    })
    
    r.<span class="function">GET</span>(<span class="string">"/"</span>, <span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">String</span>(<span class="number">200</span>, <span class="string">"Hello, World!"</span>)
    })
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>exp 最佳实践</h3>
            <div class="note-box">
                <h4>1. expvar 使用建议</h4>
                <ul>
                    <li><strong>监控关键指标</strong>：监控请求计数、错误计数、连接数等关键指标</li>
                    <li><strong>原子操作</strong>：使用 expvar.Int 和 expvar.Float 确保线程安全</li>
                    <li><strong>合理命名</strong>：使用有意义的变量名，便于理解</li>
                    <li><strong>定期清理</strong>：避免积累过多的监控数据</li>
                    <li><strong>安全考虑</strong>：在生产环境中限制 /debug/vars 的访问权限</li>
                </ul>
                
                <h4>2. slog 使用建议</h4>
                <ul>
                    <li><strong>结构化字段</strong>：使用结构化字段而不是字符串拼接</li>
                    <li><strong>日志级别</strong>：合理使用不同级别的日志</li>
                    <li><strong>上下文传递</strong>：使用上下文传递请求相关信息</li>
                    <li><strong>性能考虑</strong>：避免在高频路径中记录过多日志</li>
                    <li><strong>日志轮转</strong>：配合日志轮转工具管理日志文件</li>
                </ul>
                
                <h4>3. 集成建议</h4>
                <pre><code><span class="comment">// 在应用启动时初始化</span>
<span class="function">func</span> <span class="function">InitMonitoring</span>() {
    <span class="comment">// 注册 expvar</span>
    expvar.<span class="function">Publish</span>(<span class="string">"version"</span>, expvar.<span class="function">String</span>(Version))
    expvar.<span class="function">Publish</span>(<span class="string">"build_time"</span>, expvar.<span class="function">String</span>(BuildTime))
    
    <span class="comment">// 初始化 logger</span>
    opts := &slog.HandlerOptions{
        Level: slog.LevelInfo,
    }
    logger = slog.<span class="function">New</span>(slog.<span class="function">NewJSONHandler</span>(os.Stdout, opts))
}</code></pre>
            
        </div>
    </div>
</body>
</html>