<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>json æ•°æ®ç¼–ç  - Go å­¦ä¹ æ•™ç¨‹</title>
    <link rel="stylesheet" href="styles.css?v=1.4">
    </head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- å¯¼èˆªæ å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </aside>
                <div class="content">
            <a href="stdlib.html" class="back-link">â† è¿”å› stdlib</a>
            <h2 id="json">json æ•°æ®ç¼–ç </h2>

            <h3>åŸºæœ¬ç¼–ç å’Œè§£ç </h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json"</span>
    <span class="string">"fmt"</span>
)

<span class="keyword">type</span> Person <span class="keyword">struct</span> {
    Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span>
    Age   <span class="keyword">int</span>    <span class="string">`json:"age"`</span>
    Email <span class="keyword">string</span> <span class="string">`json:"email,omitempty"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// ç¼–ç </span>
    person := Person{
        Name: <span class="string">"Alice"</span>,
        Age:  <span class="number">30</span>,
    }
    
    jsonData, err := json.<span class="function">Marshal</span>(person)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    fmt.<span class="function">Println</span>(<span class="string">"JSON:"</span>, <span class="keyword">string</span>(jsonData))
    
    <span class="comment">// è§£ç </span>
    <span class="keyword">var</span> decoded Person
    err = json.<span class="function">Unmarshal</span>(jsonData, &decoded)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    fmt.<span class="function">Printf</span>(<span class="string">"Decoded: %+v\n"</span>, decoded)
}</code></pre>

            <h3>å¤„ç†åµŒå¥—ç»“æ„</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json"</span>
    <span class="string">"fmt"</span>
)

<span class="keyword">type</span> Address <span class="keyword">struct</span> {
    City    <span class="keyword">string</span> <span class="string">`json:"city"`</span>
    Country <span class="keyword">string</span> <span class="string">`json:"country"`</span>
}

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name    <span class="keyword">string</span>  <span class="string">`json:"name"`</span>
    Age     <span class="keyword">int</span>     <span class="string">`json:"age"`</span>
    Address Address  <span class="string">`json:"address"`</span>
    Tags    []<span class="keyword">string</span> <span class="string">`json:"tags"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    jsonData := []<span class="keyword">byte</span>(<span class="string">`{
        "name": "Bob",
        "age": 25,
        "address": {
            "city": "Beijing",
            "country": "China"
        },
        "tags": ["developer", "golang"]
    }`</span>)
    
    <span class="keyword">var</span> user User
    err := json.<span class="function">Unmarshal</span>(jsonData, &user)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    fmt.<span class="function">Printf</span>(<span class="string">"User: %+v\n"</span>, user)
    fmt.<span class="function">Printf</span>(<span class="string">"Address: %+v\n"</span>, user.Address)
    fmt.<span class="function">Printf</span>(<span class="string">"Tags: %v\n"</span>, user.Tags)
}</code></pre>

            <h3>ä½¿ç”¨ map å’Œ interface</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json"</span>
    <span class="string">"fmt"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// è§£ç åˆ° map</span>
    jsonData := []<span class="keyword">byte</span>(<span class="string">`{"name": "Charlie", "age": 35}`</span>)
    <span class="keyword">var</span> data <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}, ok := m.data[key]
    <span class="keyword">return</span> val, ok
}

<span class="function">func</span> (c *Cache) <span class="function">Set</span>(key, value <span class="keyword">string</span>) {
    c.mu.<span class="function">Lock</span>()
    <span class="keyword">defer</span> c.mu.<span class="function">Unlock</span>()
    c.data[key] = value
}

<span class="function">func</span> <span class="function">main</span>() {
    cache := <span class="function">NewCache</span>()
    <span class="keyword">var</span> wg sync.WaitGroup
    
    <span class="comment">// å†™å…¥</span>
    <span class="keyword">for</span> i := <span class="number">0</span>; i < <span class="number">10</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="keyword">func</span>(i <span class="keyword">int</span>) {
            <span class="keyword">defer</span> wg.<span class="function">Done</span>()
            key := fmt.<span class="function">Sprintf</span>(<span class="string">"key%d"</span>, i)
            value := fmt.<span class="function">Sprintf</span>(<span class="string">"value%d"</span>, i)
            cache.<span class="function">Set</span>(key, value)
        }(i)
    }
    
    <span class="comment">// è¯»å–</span>
    <span class="keyword">for</span> i := <span class="number">0</span>; i < <span class="number">10</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="keyword">func</span>(i <span class="keyword">int</span>) {
            <span class="keyword">defer</span> wg.<span class="function">Done</span>()
            key := fmt.<span class="function">Sprintf</span>(<span class="string">"key%d"</span>, i)
            time.<span class="function">Sleep</span>(time.Millisecond)
            val, ok := cache.<span class="function">Get</span>(key)
            fmt.<span class="function">Printf</span>(<span class="string">"Get %s: %v, %v\n"</span>, key, val, ok)
        }(i)
    }
    
    wg.<span class="function">Wait</span>()
}</code></pre>

            <h3>encoding/json/v2</h3>
            <p>Go 1.24 å¼•å…¥äº† <code>encoding/json/v2</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„ JSON å®ç°ï¼Œæä¾›äº†æ›´å¥½çš„æ€§èƒ½ã€æ›´ä¸¥æ ¼çš„ç±»å‹å®‰å…¨å’Œæ›´æ¸…æ™°çš„ APIã€‚</p>

            <div class="info-box">
                <h3>ğŸ’¡ json/v2 çš„ä¸»è¦æ”¹è¿›</h3>
                <ul>
                    <li><strong>æ›´å¥½çš„æ€§èƒ½</strong>ï¼šé‡æ–°è®¾è®¡çš„ç¼–è§£ç å™¨ï¼Œæ€§èƒ½æå‡ 20-30%</li>
                    <li><strong>æ›´ä¸¥æ ¼çš„ç±»å‹å®‰å…¨</strong>ï¼šæ‹’ç»ä¸å®‰å…¨çš„ç±»å‹è½¬æ¢</li>
                    <li><strong>æ›´æ¸…æ™°çš„ API</strong>ï¼šç®€åŒ–çš„æ¥å£ï¼Œå‡å°‘æ··æ·†</li>
                    <li><strong>æ›´å¥½çš„é”™è¯¯ä¿¡æ¯</strong>ï¼šæä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¸Šä¸‹æ–‡</li>
                    <li><strong>æ”¯æŒ JSON Schema</strong>ï¼šå†…ç½® JSON Schema éªŒè¯æ”¯æŒ</li>
                </ul>
            </div>

            <h4>åŸºæœ¬ç”¨æ³•</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json/v2"</span>
    <span class="string">"fmt"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span>
    Age   <span class="keyword">int</span>    <span class="string">`json:"age"`</span>
    Email <span class="keyword">string</span> <span class="string">`json:"email,omitempty"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// ç¼–ç </span>
    user := User{
        Name: <span class="string">"Alice"</span>,
        Age:  <span class="number">30</span>,
    }
    
    jsonData, err := json.<span class="function">Marshal</span>(user)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    fmt.<span class="function">Println</span>(<span class="string">"JSON:"</span>, <span class="keyword">string</span>(jsonData))
    
    <span class="comment">// è§£ç </span>
    <span class="keyword">var</span> decoded User
    err = json.<span class="function">Unmarshal</span>(jsonData, &decoded)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    fmt.<span class="function">Printf</span>(<span class="string">"Decoded: %+v\n"</span>, decoded)
}</code></pre>

            <h4>ä½¿ç”¨ Decoder å’Œ Encoder</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json/v2"</span>
    <span class="string">"fmt"</span>
    <span class="string">"os"</span>
)

<span class="keyword">type</span> Person <span class="keyword">struct</span> {
    Name <span class="keyword">string</span> <span class="string">`json:"name"`</span>
    Age  <span class="keyword">int</span>    <span class="string">`json:"age"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// å†™å…¥ JSON æ–‡ä»¶</span>
    file, err := os.<span class="function">Create</span>(<span class="string">"people.json"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    encoder := json.<span class="function">NewEncoder</span>(file)
    encoder.<span class="function">SetIndent</span>(<span class="string">""</span>, <span class="string">"  "</span>)
    
    people := []Person{
        {Name: <span class="string">"Alice"</span>, Age: <span class="number">30</span>},
        {Name: <span class="string">"Bob"</span>, Age: <span class="number">25</span>},
    }
    
    err = encoder.<span class="function">Encode</span>(people)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    <span class="comment">// è¯»å– JSON æ–‡ä»¶</span>
    file, err = os.<span class="function">Open</span>(<span class="string">"people.json"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    <span class="keyword">var</span> result []Person
    decoder := json.<span class="function">NewDecoder</span>(file)
    err = decoder.<span class="function">Decode</span>(&result)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    fmt.<span class="function">Printf</span>(<span class="string">"People: %+v\n"</span>, result)
}</code></pre>

            <h4>ä¸¥æ ¼æ¨¡å¼</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json/v2"</span>
    <span class="string">"fmt"</span>
)

<span class="keyword">type</span> Product <span class="keyword">struct</span> {
    Name     <span class="keyword">string</span>  <span class="string">`json:"name"`</span>
    Price    <span class="keyword">float64</span> <span class="string">`json:"price"`</span>
    Quantity <span class="keyword">int</span>     <span class="string">json:"quantity"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼çš„è§£ç å™¨</span>
    opts := &json.<span class="function">DecodeOptions</span>{
        RejectUnknownFields: <span class="keyword">true</span>,
        DisallowDuplicateFields: <span class="keyword">true</span>,
    }
    
    jsonData := []<span class="keyword">byte</span>(<span class="string">`{
        "name": "Laptop",
        "price": 999.99,
        "quantity": 10,
        "extra_field": "will cause error"
    }`</span>)
    
    <span class="keyword">var</span> product Product
    decoder := json.<span class="function">NewDecoder</span>(jsonData)
    decoder.<span class="function">SetDecodeOptions</span>(opts)
    
    err := decoder.<span class="function">Decode</span>(&product)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Strict mode error (expected):"</span>, err)
    }
}</code></pre>

            <h4>è‡ªå®šä¹‰ç±»å‹è½¬æ¢</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json/v2"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="keyword">type</span> Event <span class="keyword">struct</span> {
    Name      <span class="keyword">string</span>    <span class="string">`json:"name"`</span>
    Timestamp <span class="keyword">string</span>    <span class="string">`json:"timestamp"`</span>
    Date      <span class="keyword">time</span>.Time <span class="string">`json:"date,omitempty"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    jsonData := []<span class="keyword">byte</span>(<span class="string">`{
        "name": "Meeting",
        "timestamp": "2024-01-15T10:30:00Z"
    }`</span>)
    
    <span class="keyword">var</span> event Event
    err := json.<span class="function">Unmarshal</span>(jsonData, &event)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    <span class="comment">// è§£ææ—¶é—´å­—ç¬¦ä¸²</span>
    parsedTime, err := time.<span class="function">Parse</span>(time.RFC3339, event.Timestamp)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error parsing time:"</span>, err)
        <span class="keyword">return</span>
    }
    event.Date = parsedTime
    
    fmt.<span class="function">Printf</span>(<span class="string">"Event: %+v\n"</span>, event)
    fmt.<span class="function">Printf</span>(<span class="string">"Date: %s\n"</span>, event.Date.<span class="function">Format</span>(time.RFC3339))
}</code></pre>

            <div class="warning-box">
                <h3>âš ï¸ json/v2 vs json</h3>
                <ul>
                    <li><strong>å‘åå…¼å®¹</strong>ï¼šjson/v2 ä¸ json/v1 ä¸å®Œå…¨å…¼å®¹ï¼Œéœ€è¦é€æ­¥è¿ç§»</li>
                    <li><strong>è¡Œä¸ºå·®å¼‚</strong>ï¼šæŸäº›è¾¹ç¼˜æƒ…å†µçš„å¤„ç†æ–¹å¼æœ‰æ‰€ä¸åŒ</li>
                    <li><strong>æ€§èƒ½æå‡</strong>ï¼šjson/v2 åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹æ€§èƒ½æ›´å¥½</li>
                    <li><strong>ç±»å‹å®‰å…¨</strong>ï¼šjson/v2 å¯¹ç±»å‹æ£€æŸ¥æ›´ä¸¥æ ¼</li>
                    <li><strong>è¿ç§»å»ºè®®</strong>ï¼šæ–°é¡¹ç›®ä¼˜å…ˆä½¿ç”¨ json/v2ï¼Œæ—§é¡¹ç›®è°¨æ…è¯„ä¼°åå†è¿ç§»</li>
                </ul>
            </div>

            
        </div>
    </div>
<script src="code-collapse.js"></script>

</body>
    <script src="navigation.js"></script>
</html>