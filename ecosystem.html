<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社区库 - Go 学习教程</title>
    <link rel="stylesheet" href="styles.css?v=1.3">
    <script src="scroll.js"></script>
    </head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- 导航栏将通过JavaScript动态加载 -->
    </aside>
        <div class="content">
            <a href="index.html" class="back-link">← 返回首页</a>
            <h1>社区库</h1>
            
            <p>Go 语言拥有活跃的社区和丰富的第三方库。本章将介绍 Go 生态中最流行的几个库：Gin（Web 框架）、GORM（ORM）、Viper（配置）和 Zap（日志）。</p>

            <h2 id="gin">Gin Web 框架</h2>
            
            <h3>简介</h3>
            <p>Gin 是一个用 Go 语言编写的高性能 HTTP Web 框架，具有类似 Martini 的 API，但性能更好（高达 40 倍）。它提供了路由、中间件、JSON 验证等功能，是 Go 社区最流行的 Web 框架之一。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/gin-gonic/gin</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建默认路由</span>
    r := gin.<span class="function">Default</span>()

    <span class="comment">// 定义路由</span>
    r.<span class="function">GET</span>(<span class="string">"/ping"</span>, <span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{
            <span class="string">"message"</span>: <span class="string">"pong"</span>,
        })
    })

    <span class="comment">// 启动服务器</span>
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>路由</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()

    <span class="comment">// GET 请求</span>
    r.<span class="function">GET</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{
            <span class="string">"users"</span>: []<span class="keyword">string</span>{<span class="string">"Alice"</span>, <span class="string">"Bob"</span>},
        })
    })

    <span class="comment">// POST 请求</span>
    r.<span class="function">POST</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
        <span class="keyword">var</span> user <span class="keyword">struct</span> {
            Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span>
            Email <span class="keyword">string</span> <span class="string">`json:"email"`</span>
        }
        
        <span class="keyword">if</span> err := c.<span class="function">ShouldBindJSON</span>(&user); err != <span class="keyword">nil</span> {
            c.<span class="function">JSON</span>(http.StatusBadRequest, gin.H{<span class="string">"error"</span>: err.<span class="function">Error</span>()})
            <span class="keyword">return</span>
        }
        
        c.<span class="function">JSON</span>(http.StatusCreated, gin.H{
            <span class="string">"message"</span>: <span class="string">"User created"</span>,
            <span class="string">"user"</span>:    user,
        })
    })

    <span class="comment">// 路径参数</span>
    r.<span class="function">GET</span>(<span class="string">"/users/:id"</span>, <span class="keyword">func</span>(c *gin.Context) {
        id := c.<span class="function">Param</span>(<span class="string">"id"</span>)
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{<span class="string">"id"</span>: id})
    })

    <span class="comment">// 查询参数</span>
    r.<span class="function">GET</span>(<span class="string">"/search"</span>, <span class="keyword">func</span>(c *gin.Context) {
        query := c.<span class="function">Query</span>(<span class="string">"q"</span>)
        page := c.<span class="function">DefaultQuery</span>(<span class="string">"page"</span>, <span class="string">"1"</span>)
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{
            <span class="string">"query"</span>: query,
            <span class="string">"page"</span>:  page,
        })
    })

    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>中间件</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
    <span class="string">"time"</span>
)

<span class="comment">// 自定义中间件</span>
<span class="function">func</span> <span class="function">Logger</span>() gin.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(c *gin.Context) {
        start := time.<span class="function">Now</span>()
        
        c.<span class="function">Next</span>()
        
        latency := time.<span class="function">Since</span>(start)
        fmt.<span class="function">Printf</span>(<span class="string">"%s %s %v\n"</span>, c.<span class="function">Request</span>.Method, c.<span class="function">Request</span>.URL.Path, latency)
    }
}

<span class="comment">// 认证中间件</span>
<span class="function">func</span> <span class="function">AuthMiddleware</span>() gin.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(c *gin.Context) {
        token := c.<span class="function">GetHeader</span>(<span class="string">"Authorization"</span>)
        
        <span class="keyword">if</span> token == <span class="string">""</span> {
            c.<span class="function">JSON</span>(http.StatusUnauthorized, gin.H{<span class="string">"error"</span>: <span class="string">"Unauthorized"</span>})
            c.<span class="function">Abort</span>()
            <span class="keyword">return</span>
        }
        
        c.<span class="function">Set</span>(<span class="string">"user_id"</span>, <span class="string">"123"</span>)
        c.<span class="function">Next</span>()
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// 全局中间件</span>
    r.<span class="function">Use</span>(<span class="function">Logger</span>())
    
    <span class="comment">// 路由组</span>
    api := r.<span class="function">Group</span>(<span class="string">"/api"</span>)
    api.<span class="function">Use</span>(<span class="function">AuthMiddleware</span>())
    
    api.<span class="function">GET</span>(<span class="string">"/profile"</span>, <span class="keyword">func</span>(c *gin.Context) {
        userID := c.<span class="function">GetString</span>(<span class="string">"user_id"</span>)
        c.<span class="function">JSON</span>(http.StatusOK, gin.H{<span class="string">"user_id"</span>: userID})
    })
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>路由组</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// v1 路由组</span>
    v1 := r.<span class="function">Group</span>(<span class="string">"/v1"</span>)
    {
        v1.<span class="function">GET</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v1 users"</span>)
        })
        v1.<span class="function">GET</span>(<span class="string">"/posts"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v1 posts"</span>)
        })
    }
    
    <span class="comment">// v2 路由组</span>
    v2 := r.<span class="function">Group</span>(<span class="string">"/v2"</span>)
    {
        v2.<span class="function">GET</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v2 users"</span>)
        })
        v2.<span class="function">GET</span>(<span class="string">"/posts"</span>, <span class="keyword">func</span>(c *gin.Context) {
            c.<span class="function">String</span>(http.StatusOK, <span class="string">"v2 posts"</span>)
        })
    }
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>错误处理</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"net/http"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// 自定义错误处理</span>
    r.<span class="function">NoRoute</span>(<span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusNotFound, gin.H{
            <span class="string">"error"</span>: <span class="string">"Route not found"</span>,
        })
    })
    
    r.<span class="function">NoMethod</span>(<span class="keyword">func</span>(c *gin.Context) {
        c.<span class="function">JSON</span>(http.StatusMethodNotAllowed, gin.H{
            <span class="string">"error"</span>: <span class="string">"Method not allowed"</span>,
        })
    })
    
    <span class="comment">// Panic 恢复</span>
    r.<span class="function">Use</span>(gin.<span class="function">Recovery</span>())
    
    r.<span class="function">GET</span>(<span class="string">"/panic"</span>, <span class="keyword">func</span>(c *gin.Context) {
        <span class="function">panic</span>(<span class="string">"Something went wrong"</span>)
    })
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h2 id="gorm">GORM ORM</h2>
            
            <h3>简介</h3>
            <p>GORM 是 Go 语言中最流行的 ORM（对象关系映射）库，提供了友好的 API，支持多种数据库（MySQL、PostgreSQL、SQLite、SQL Server 等），并包含自动迁移、关联、钩子等功能。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u gorm.io/gorm
<span class="keyword">go</span> get -u gorm.io/driver/mysql</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"gorm.io/driver/mysql"</span>
    <span class="string">"gorm.io/gorm"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID       <span class="keyword">uint</span>   <span class="string">`gorm:"primaryKey"`</span>
    Name     <span class="keyword">string</span> <span class="string">`gorm:"size:255;not null"`</span>
    Email    <span class="keyword">string</span> <span class="string">`gorm:"size:255;uniqueIndex;not null"`</span>
    Age      <span class="keyword">int</span>    <span class="string">`gorm:"default:0"`</span>
    CreatedAt time.Time
    UpdatedAt time.Time
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 连接数据库</span>
    dsn := <span class="string">"user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"</span>
    db, err := gorm.<span class="function">Open</span>(mysql.<span class="function">Open</span>(dsn), &gorm.Config{})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(<span class="string">"Failed to connect database"</span>)
    }
    
    <span class="comment">// 自动迁移</span>
    db.<span class="function">AutoMigrate</span>(&User{})
    
    <span class="comment">// 创建记录</span>
    user := User{Name: <span class="string">"Alice"</span>, Email: <span class="string">"alice@example.com"</span>, Age: <span class="number">25</span>}
    result := db.<span class="function">Create</span>(&user)
    fmt.<span class="function">Println</span>(<span class="string">"Created user ID:"</span>, user.ID)
    fmt.<span class="function">Println</span>(<span class="string">"Rows affected:"</span>, result.RowsAffected)
}</code></pre>
            
            <h3>创建记录</h3>
            <pre><code><span class="comment">// 创建单条记录</span>
user := User{Name: <span class="string">"Bob"</span>, Email: <span class="string">"bob@example.com"</span>, Age: <span class="number">30</span>}
db.<span class="function">Create</span>(&user)

<span class="comment">// 创建多条记录</span>
users := []User{
    {Name: <span class="string">"Charlie"</span>, Email: <span class="string">"charlie@example.com"</span>, Age: <span class="number">28</span>},
    {Name: <span class="string">"David"</span>, Email: <span class="string">"david@example.com"</span>, Age: <span class="number">32</span>},
}
db.<span class="function">Create</span>(&users)

<span class="comment">// 使用 Select 指定字段</span>
db.<span class="function">Select</span>(<span class="string">"Name"</span>, <span class="string">"Email"</span>).<span class="function">Create</span>(&user)

<span class="comment">// 使用 Omit 忽略字段</span>
db.<span class="function">Omit</span>(<span class="string">"Age"</span>).<span class="function">Create</span>(&user)</code></pre>
            
            <h3>查询记录</h3>
            <pre><code><span class="comment">// 查询第一条记录</span>
<span class="keyword">var</span> user User
db.<span class="function">First</span>(&user)
<span class="comment">// SELECT * FROM users ORDER BY id LIMIT 1;</span>

<span class="comment">// 根据主键查询</span>
db.<span class="function">First</span>(&user, <span class="number">1</span>)
<span class="comment">// SELECT * FROM users WHERE id = 1;</span>

<span class="comment">// 查询所有记录</span>
<span class="keyword">var</span> users []User
db.<span class="function">Find</span>(&users)
<span class="comment">// SELECT * FROM users;</span>

<span class="comment">// 条件查询</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"Alice"</span>).<span class="function">First</span>(&user)
db.<span class="function">Where</span>(<span class="string">"age > ?"</span>, <span class="number">25</span>).<span class="function">Find</span>(&users)
db.<span class="function">Where</span>(<span class="string">"name LIKE ?"</span>, <span class="string">"%A%"</span>).<span class="function">Find</span>(&users)

<span class="comment">// 多条件</span>
db.<span class="function">Where</span>(<span class="string">"name = ? AND age > ?"</span>, <span class="string">"Alice"</span>, <span class="number">20</span>).<span class="function">First</span>(&user)

<span class="comment">// 使用 Map</span>
db.<span class="function">Where</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"Alice"</span>, <span class="string">"age"</span>: <span class="number">25</span>}).<span class="function">First</span>(&user)

<span class="comment">// 使用 Struct</span>
db.<span class="function">Where</span>(User{Name: <span class="string">"Alice"</span>, Age: <span class="number">25</span>}).<span class="function">First</span>(&user)

<span class="comment">// Or 条件</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"Alice"</span>).<span class="function">Or</span>(<span class="string">"name = ?"</span>, <span class="string">"Bob"</span>).<span class="function">Find</span>(&users)

<span class="comment">// Not 条件</span>
db.<span class="function">Not</span>(<span class="string">"name = ?"</span>, <span class="string">"Alice"</span>).<span class="function">Find</span>(&users)

<span class="comment">// 排序</span>
db.<span class="function">Order</span>(<span class="string">"age desc"</span>).<span class="function">Find</span>(&users)

<span class="comment">// 限制和偏移</span>
db.<span class="function">Limit</span>(<span class="number">10</span>).<span class="function">Offset</span>(<span class="number">20</span>).<span class="function">Find</span>(&users)

<span class="comment">// 统计</span>
<span class="keyword">var</span> count <span class="keyword">int64</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Count</span>(&count)

<span class="comment">// 选择特定字段</span>
db.<span class="function">Select</span>(<span class="string">"name"</span>, <span class="string">"email"</span>).<span class="function">Find</span>(&users)</code></pre>
            
            <h3>更新记录</h3>
            <pre><code><span class="comment">// 更新单个字段</span>
db.<span class="function">Model</span>(&user).<span class="function">Update</span>(<span class="string">"age"</span>, <span class="number">26</span>)

<span class="comment">// 更新多个字段</span>
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{
    <span class="string">"name"</span>: <span class="string">"Alice Updated"</span>,
    <span class="string">"age"</span>:  <span class="number">26</span>,
})

<span class="comment">// 使用 Struct 更新</span>
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(User{Name: <span class="string">"Alice Updated"</span>, Age: <span class="number">26</span>})

<span class="comment">// 只更新非零字段</span>
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(User{Name: <span class="string">"Alice"</span>})

<span class="comment">// 更新所有字段（包括零值）</span>
db.<span class="function">Model</span>(&user).<span class="function">Select</span>(<span class="string">"*"</span>).<span class="function">Updates</span>(User{Name: <span class="string">""</span>, Age: <span class="number">0</span>})

<span class="comment">// 条件更新</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Where</span>(<span class="string">"age > ?"</span>, <span class="number">20</span>).<span class="function">Update</span>(<span class="string">"status"</span>, <span class="string">"active"</span>)

<span class="comment">// 批量更新</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Where</span>(<span class="string">"age > ?"</span>, <span class="number">20</span>).<span class="function">Updates</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"status"</span>: <span class="string">"active"</span>})</code></pre>
            
            <h3>删除记录</h3>
            <pre><code><span class="comment">// 删除记录</span>
db.<span class="function">Delete</span>(&user)
<span class="comment">// DELETE FROM users WHERE id = 1;</span>

<span class="comment">// 根据主键删除</span>
db.<span class="function">Delete</span>(&User{}, <span class="number">1</span>)

<span class="comment">// 批量删除</span>
db.<span class="function">Where</span>(<span class="string">"age < ?"</span>, <span class="number">18</span>).<span class="function">Delete</span>(&User{})

<span class="comment">// 软删除</span>
<span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID        <span class="keyword">uint</span>
    Name      <span class="keyword">string</span>
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}
<span class="comment">// 软删除不会真正删除记录，而是设置 deleted_at 字段</span>

<span class="comment">// 永久删除</span>
db.<span class="function">Unscoped</span>().<span class="function">Delete</span>(&user)</code></pre>
            
            <h3>关联</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    gorm.Model
    Name   <span class="keyword">string</span>
    Posts  []Post
}

<span class="keyword">type</span> Post <span class="keyword">struct</span> {
    gorm.Model
    Title   <span class="keyword">string</span>
    UserID  <span class="keyword">uint</span>
    User    User
}

<span class="comment">// 预加载关联</span>
<span class="keyword">var</span> users []User
db.<span class="function">Preload</span>(<span class="string">"Posts"</span>).<span class="function">Find</span>(&users)

<span class="comment">// 创建关联</span>
user := User{Name: <span class="string">"Alice"</span>}
db.<span class="function">Create</span>(&user)
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Append</span>([]Post{
    {Title: <span class="string">"Post 1"</span>},
    {Title: <span class="string">"Post 2"</span>},
})

<span class="comment">// 查找关联</span>
<span class="keyword">var</span> posts []Post
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Find</span>(&posts)

<span class="comment">// 替换关联</span>
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Replace</span>([]Post{
    {Title: <span class="string">"New Post 1"</span>},
})

<span class="comment">// 删除关联</span>
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Delete</span>(posts)

<span class="comment">// 清空关联</span>
db.<span class="function">Model</span>(&user).<span class="function">Association</span>(<span class="string">"Posts"</span>).<span class="function">Clear</span>()</code></pre>
            
            <h3>钩子</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    gorm.Model
    Name  <span class="keyword">string</span>
    Email <span class="keyword">string</span>
}

<span class="comment">// 创建前钩子</span>
<span class="function">func</span> (u *User) <span class="function">BeforeCreate</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"Before create:"</span>, u.Name)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// 创建后钩子</span>
<span class="function">func</span> (u *User) <span class="function">AfterCreate</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"After create:"</span>, u.ID)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// 更新前钩子</span>
<span class="function">func</span> (u *User) <span class="function">BeforeUpdate</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"Before update:"</span>, u.Name)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// 查询前钩子</span>
<span class="function">func</span> (u *User) <span class="function">AfterFind</span>(tx *gorm.DB) <span class="keyword">error</span> {
    fmt.<span class="function">Println</span>(<span class="string">"After find:"</span>, u.Name)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h3>事务</h3>
            <pre><code><span class="comment">// 自动事务</span>
err := db.<span class="function">Transaction</span>(<span class="keyword">func</span>(tx *gorm.DB) <span class="keyword">error</span> {
    <span class="comment">// 创建用户</span>
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&User{Name: <span class="string">"Alice"</span>}).Error; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="comment">// 创建订单</span>
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&Order{UserID: <span class="number">1</span>}).Error; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="keyword">return</span> <span class="keyword">nil</span>
})

<span class="comment">// 手动事务</span>
tx := db.<span class="function">Begin</span>()

<span class="keyword">if</span> err := tx.<span class="function">Create</span>(&User{Name: <span class="string">"Bob"</span>}).Error; err != <span class="keyword">nil</span> {
    tx.<span class="function">Rollback</span>()
}

<span class="keyword">if</span> err := tx.<span class="function">Commit</span>().Error; err != <span class="keyword">nil</span> {
    tx.<span class="function">Rollback</span>()
}</code></pre>
            
            <h2 id="viper">Viper 配置</h2>
            
            <h3>简介</h3>
            <p>Viper 是 Go 语言的配置管理库，支持多种配置格式（JSON、TOML、YAML、HCL、envfile 等），可以从文件、环境变量、命令行参数等多种来源读取配置，并支持配置热重载。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/spf13/viper</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// 设置配置文件名和路径</span>
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    
    <span class="comment">// 读取配置文件</span>
    <span class="keyword">if</span> err := v.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(fmt.<span class="function">Errorf</span>(<span class="string">"Failed to read config file: %s"</span>, err))
    }
    
    <span class="comment">// 获取配置值</span>
    fmt.<span class="function">Println</span>(<span class="string">"Server Port:"</span>, v.<span class="function">GetString</span>(<span class="string">"server.port"</span>))
    fmt.<span class="function">Println</span>(<span class="string">"Database Host:"</span>, v.<span class="function">GetString</span>(<span class="string">"database.host"</span>))
}</code></pre>
            
            <h3>配置文件示例</h3>
            <pre><code><span class="comment"># config.yaml</span>
server:
  port: <span class="number">8080</span>
  host: localhost

database:
  host: localhost
  port: <span class="number">3306</span>
  name: mydb
  user: root
  password: secret

logging:
  level: info
  format: json</code></pre>
            
            <h3>读取配置</h3>
            <pre><code><span class="comment">// 获取字符串</span>
port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)

<span class="comment">// 获取整数</span>
port := v.<span class="function">GetInt</span>(<span class="string">"server.port"</span>)

<span class="comment">// 获取布尔值</span>
debug := v.<span class="function">GetBool</span>(<span class="string">"debug"</span>)

<span class="comment">// 获取浮点数</span>
timeout := v.<span class="function">GetFloat64</span>(<span class="string">"timeout"</span>)

<span class="comment">// 获取时间</span>
duration := v.<span class="function">GetDuration</span>(<span class="string">"timeout"</span>)

<span class="comment">// 获取字符串切片</span>
hosts := v.<span class="function">GetStringSlice</span>(<span class="string">"servers.hosts"</span>)

<span class="comment">// 获取所有配置</span>
all := v.<span class="function">AllSettings</span>()

<span class="comment">// 检查键是否存在</span>
<span class="keyword">if</span> v.<span class="function">IsSet</span>(<span class="string">"server.port"</span>) {
    port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
}

<span class="comment">// 获取子配置</span>
server := v.<span class="function">Sub</span>(<span class="string">"server"</span>)
port := server.<span class="function">GetString</span>(<span class="string">"port"</span>)</code></pre>
            
            <h3>环境变量</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// 绑定环境变量</span>
    v.<span class="function">BindEnv</span>(<span class="string">"server.port"</span>, <span class="string">"SERVER_PORT"</span>)
    v.<span class="function">BindEnv</span>(<span class="string">"database.host"</span>, <span class="string">"DB_HOST"</span>)
    
    <span class="comment">// 自动绑定环境变量（使用前缀）</span>
    v.<span class="function">SetEnvPrefix</span>(<span class="string">"APP"</span>)
    v.<span class="function">AutomaticEnv</span>()
    <span class="comment">// APP_SERVER_PORT -> server.port</span>
    
    <span class="comment">// 设置默认值</span>
    v.<span class="function">SetDefault</span>(<span class="string">"server.port"</span>, <span class="number">8080</span>)
    v.<span class="function">SetDefault</span>(<span class="string">"debug"</span>, <span class="keyword">false</span>)
    
    <span class="comment">// 读取环境变量</span>
    port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
}</code></pre>
            
            <h3>命令行参数</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="keyword">var</span> rootCmd = &cobra.Command{
    <span class="function">Run</span>: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
        port := viper.<span class="function">GetInt</span>(<span class="string">"port"</span>)
        fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
    },
}

<span class="function">func</span> <span class="function">init</span>() {
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">Int</span>(<span class="string">"port"</span>, <span class="number">8080</span>, <span class="string">"Server port"</span>)
    viper.<span class="function">BindPFlag</span>(<span class="string">"port"</span>, rootCmd.<span class="function">PersistentFlags</span>().<span class="function">Lookup</span>(<span class="string">"port"</span>))
}

<span class="function">func</span> <span class="function">main</span>() {
    cobra.<span class="function">Execute</span>()
}</code></pre>
            
            <h3>配置热重载</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"log"</span>
    <span class="string">"github.com/fsnotify/fsnotify"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    
    <span class="keyword">if</span> err := v.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    
    <span class="comment">// 监听配置文件变化</span>
    v.<span class="function">OnConfigChange</span>(<span class="keyword">func</span>(e fsnotify.Event) {
        fmt.<span class="function">Printf</span>(<span class="string">"Config file changed: %s\n"</span>, e.Name)
        log.<span class="function">Println</span>(<span class="string">"Reloading config..."</span>)
    })
    
    v.<span class="function">WatchConfig</span>()
    
    <span class="comment">// 主循环</span>
    <span class="keyword">select</span> {}
}</code></pre>
            
            <h3>多配置源</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// 1. 设置默认值</span>
    v.<span class="function">SetDefault</span>(<span class="string">"server.port"</span>, <span class="number">8080</span>)
    
    <span class="comment">// 2. 读取配置文件</span>
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    v.<span class="function">ReadInConfig</span>()
    
    <span class="comment">// 3. 读取环境变量</span>
    v.<span class="function">SetEnvPrefix</span>(<span class="string">"APP"</span>)
    v.<span class="function">AutomaticEnv</span>()
    
    <span class="comment">// 4. 读取命令行参数</span>
    <span class="comment">// 使用 cobra 绑定</span>
    
    <span class="comment">// 优先级：命令行参数 > 环境变量 > 配置文件 > 默认值</span>
    port := v.<span class="function">GetInt</span>(<span class="string">"server.port"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
}</code></pre>
            
            <h2 id="zap">Zap 日志</h2>
            
            <h3>简介</h3>
            <p>Zap 是 Uber 开发的高性能、结构化日志库，专为 Go 语言设计。它提供了零内存分配的日志记录和结构化日志支持，性能远超标准库的 log 包和其他日志库。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u go.uber.org/zap
<span class="keyword">go</span> get -u go.uber.org/zap/zapcore</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建开发环境 logger</span>
    logger, _ := zap.<span class="function">NewDevelopment</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// 记录日志</span>
    logger.<span class="function">Info</span>(<span class="string">"Hello, World!"</span>)
    logger.<span class="function">Debug</span>(<span class="string">"Debug message"</span>)
    logger.<span class="function">Warn</span>(<span class="string">"Warning message"</span>)
    logger.<span class="function">Error</span>(<span class="string">"Error message"</span>)
}</code></pre>
            
            <h3>生产环境 Logger</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建生产环境 logger</span>
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// 记录日志</span>
    logger.<span class="function">Info</span>(<span class="string">"Server started"</span>,
        zap.<span class="function">String</span>(<span class="string">"host"</span>, <span class="string">"localhost"</span>),
        zap.<span class="function">Int</span>(<span class="string">"port"</span>, <span class="number">8080</span>),
    )
}</code></pre>
            
            <h3>自定义 Logger</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"os"</span>
    
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 自定义配置</span>
    config := zap.Config{
        Level:            zap.NewAtomicLevelAt(zapcore.InfoLevel),
        Development:      <span class="keyword">false</span>,
        Encoding:         <span class="string">"json"</span>,
        EncoderConfig: zapcore.EncoderConfig{
            TimeKey:        <span class="string">"timestamp"</span>,
            LevelKey:       <span class="string">"level"</span>,
            NameKey:        <span class="string">"logger"</span>,
            CallerKey:      <span class="string">"caller"</span>,
            MessageKey:     <span class="string">"msg"</span>,
            StacktraceKey:  <span class="string">"stacktrace"</span>,
            LineEnding:     zapcore.DefaultLineEnding,
            EncodeLevel:    zapcore.LowercaseLevelEncoder,
            EncodeTime:     zapcore.ISO8601TimeEncoder,
            EncodeDuration: zapcore.SecondsDurationEncoder,
            EncodeCaller:   zapcore.ShortCallerEncoder,
        },
        OutputPaths:      []<span class="keyword">string</span>{<span class="string">"stdout"</span>},
        ErrorOutputPaths: []<span class="keyword">string</span>{<span class="string">"stderr"</span>},
    }
    
    logger, _ := config.<span class="function">Build</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    logger.<span class="function">Info</span>(<span class="string">"Custom logger initialized"</span>)
}</code></pre>
            
            <h3>结构化日志</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// 添加字段</span>
    logger.<span class="function">Info</span>(<span class="string">"User logged in"</span>,
        zap.<span class="function">String</span>(<span class="string">"user_id"</span>, <span class="string">"123"</span>),
        zap.<span class="function">String</span>(<span class="string">"username"</span>, <span class="string">"alice"</span>),
        zap.<span class="function">String</span>(<span class="string">"ip"</span>, <span class="string">"192.168.1.1"</span>),
    )
    
    <span class="comment">// 使用结构化对象</span>
    <span class="keyword">type</span> User <span class="keyword">struct</span> {
        ID    <span class="keyword">string</span>
        Name  <span class="keyword">string</span>
        Email <span class="keyword">string</span>
    }
    
    user := User{ID: <span class="string">"123"</span>, Name: <span class="string">"Alice"</span>, Email: <span class="string">"alice@example.com"</span>}
    logger.<span class="function">Info</span>(<span class="string">"User created"</span>, zap.<span class="function">Any</span>(<span class="string">"user"</span>, user))
}</code></pre>
            
            <h3>日志级别</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 设置日志级别</span>
    config := zap.NewProductionConfig()
    config.Level = zap.NewAtomicLevelAt(zapcore.DebugLevel)
    
    logger, _ := config.<span class="function">Build</span>(zap.<span class="function">AddCaller</span>())
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// 不同级别的日志</span>
    logger.<span class="function">Debug</span>(<span class="string">"Debug information"</span>)
    logger.<span class="function">Info</span>(<span class="string">"Information"</span>)
    logger.<span class="function">Warn</span>(<span class="string">"Warning"</span>)
    logger.<span class="function">Error</span>(<span class="string">"Error occurred"</span>)
    
    <span class="comment">// Fatal 会调用 os.Exit(1)</span>
    <span class="comment">// logger.Fatal("Fatal error")</span>
    
    <span class="comment">// Panic 会调用 panic()</span>
    <span class="comment">// logger.Panic("Panic situation")</span>
}</code></pre>
            
            <h3>输出到文件</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
    <span class="string">"gopkg.in/natefinch/lumberjack.v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 日志轮转配置</span>
    writer := &lumberjack.Logger{
        Filename:   <span class="string">"logs/app.log"</span>,
        MaxSize:    <span class="number">100</span>, <span class="comment">// MB</span>
        MaxBackups: <span class="number">3</span>,
        MaxAge:     <span class="number">28</span>,   <span class="comment">// days</span>
        Compress:   <span class="keyword">true</span>,
    }
    
    <span class="comment">// 创建 core</span>
    core := zapcore.<span class="function">NewCore</span>(
        zapcore.<span class="function">NewJSONEncoder</span>(zap.NewProductionEncoderConfig()),
        zapcore.<span class="function">AddSync</span>(writer),
        zapcore.InfoLevel,
    )
    
    logger := zap.<span class="function">New</span>(core, zap.<span class="function">AddCaller</span>())
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    logger.<span class="function">Info</span>(<span class="string">"Logging to file"</span>)
}</code></pre>
            
            <h3>同时输出到多个地方</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"os"</span>
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"go.uber.org/zap/zapcore"</span>
    <span class="string">"gopkg.in/natefinch/lumberjack.v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 文件输出</span>
    fileWriter := &lumberjack.Logger{
        Filename:   <span class="string">"logs/app.log"</span>,
        MaxSize:    <span class="number">100</span>,
        MaxBackups: <span class="number">3</span>,
        MaxAge:     <span class="number">28</span>,
        Compress:   <span class="keyword">true</span>,
    }
    
    <span class="comment">// 控制台输出</span>
    consoleWriter := zapcore.<span class="function">AddSync</span>(os.Stdout)
    
    <span class="comment">// 创建 encoder</span>
    encoderConfig := zap.NewProductionEncoderConfig()
    encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder
    encoder := zapcore.<span class="function">NewJSONEncoder</span>(encoderConfig)
    
    <span class="comment">// 创建 core</span>
    core := zapcore.<span class="function">NewTee</span>(
        zapcore.<span class="function">NewCore</span>(encoder, zapcore.<span class="function">AddSync</span>(fileWriter), zapcore.InfoLevel),
        zapcore.<span class="function">NewCore</span>(encoder, consoleWriter, zapcore.DebugLevel),
    )
    
    logger := zap.<span class="function">New</span>(core, zap.<span class="function">AddCaller</span>())
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    logger.<span class="function">Info</span>(<span class="string">"Logging to both file and console"</span>)
}</code></pre>
            
            <h3>Sugar Logger</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// Sugar logger 提供更方便的 API</span>
    sugar := logger.<span class="function">Sugar</span>()
    
    <span class="comment">// Printf 风格</span>
    sugar.<span class="function">Infof</span>(<span class="string">"User %s logged in from %s"</span>, <span class="string">"alice"</span>, <span class="string">"192.168.1.1"</span>)
    
    <span class="comment">// 惯用风格</span>
    sugar.<span class="function">Infow</span>(<span class="string">"User logged in"</span>,
        <span class="string">"user"</span>, <span class="string">"alice"</span>,
        <span class="string">"ip"</span>, <span class="string">"192.168.1.1"</span>,
    )
    
    <span class="comment">// 简单风格</span>
    sugar.<span class="function">Info</span>(<span class="string">"Simple log message"</span>, <span class="string">"arg1"</span>, <span class="string">"arg2"</span>)
}</code></pre>
            
            <h3>错误处理</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"errors"</span>
    <span class="string">"go.uber.org/zap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    logger, _ := zap.<span class="function">NewProduction</span>()
    <span class="keyword">defer</span> logger.<span class="function">Sync</span>()
    
    <span class="comment">// 记录错误</span>
    err := errors.<span class="function">New</span>(<span class="string">"something went wrong"</span>)
    logger.<span class="function">Error</span>(<span class="string">"Operation failed"</span>,
        zap.<span class="function">Error</span>(err),
        zap.<span class="function">String</span>(<span class="string">"operation"</span>, <span class="string">"create_user"</span>),
    )
    
    <span class="comment">// 记录堆栈</span>
    logger.<span class="function">Error</span>(<span class="string">"Error with stack"</span>,
        zap.<span class="function">Error</span>(err),
        zap.<span class="function">Stack</span>(<span class="string">"stack"</span>),
    )
}</code></pre>
            
            <h2 id="bestpractices">最佳实践</h2>
            
            <h3>Gin 最佳实践</h3>
            <div class="note-box">
                <h4>1. 项目结构</h4>
                <pre><code>project/
├── cmd/
│   └── server/
│       └── main.go
├── internal/
│   ├── handler/
│   ├── service/
│   ├── repository/
│   └── model/
├── pkg/
├── configs/
└── go.mod</code></pre>
                
                <h4>2. 使用依赖注入</h4>
                <pre><code><span class="keyword">type</span> Server <span class="keyword">struct</span> {
    router *gin.Engine
    userHandler *UserHandler
}

<span class="function">func</span> <span class="function">NewServer</span>(userHandler *UserHandler) *Server {
    s := &Server{
        router: gin.<span class="function">Default</span>(),
        userHandler: userHandler,
    }
    s.<span class="function">setupRoutes</span>()
    <span class="keyword">return</span> s
}</code></pre>
                
                <h4>3. 统一错误处理</h4>
                <pre><code><span class="keyword">type</span> ErrorResponse <span class="keyword">struct</span> {
    Error   <span class="keyword">string</span> <span class="string">`json:"error"`</span>
    Code    <span class="keyword">int</span>    <span class="string">`json:"code"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">HandleError</span>(c *gin.Context, err <span class="keyword">error</span>) {
    <span class="keyword">if</span> errors.<span class="function">Is</span>(err, ErrNotFound) {
        c.<span class="function">JSON</span>(http.StatusNotFound, ErrorResponse{
            Error:   <span class="string">"not_found"</span>,
            Code:    <span class="number">404</span>,
            Message: err.<span class="function">Error</span>(),
        })
        <span class="keyword">return</span>
    }
    c.<span class="function">JSON</span>(http.StatusInternalServerError, ErrorResponse{
        Error:   <span class="string">"internal_error"</span>,
        Code:    <span class="number">500</span>,
        Message: <span class="string">"Internal server error"</span>,
    })
}</code></pre>
                
                <h4>4. 使用 Context 传递请求作用域数据</h4>
                <pre><code><span class="comment">// 在中间件中设置</span>
c.<span class="function">Set</span>(<span class="string">"user_id"</span>, userID)

<span class="comment">// 在 handler 中获取</span>
userID := c.<span class="function">GetString</span>(<span class="string">"user_id"</span>)</code></pre>
            </div>
            
            <h3>GORM 最佳实践</h3>
            <div class="note-box">
                <h4>1. 使用模型层抽象</h4>
                <pre><code><span class="keyword">type</span> Repository <span class="keyword">interface</span> {
    <span class="function">Create</span>(user *User) <span class="keyword">error</span>
    <span class="function">FindByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>)
    <span class="function">Update</span>(user *User) <span class="keyword">error</span>
    <span class="function">Delete</span>(id <span class="keyword">uint</span>) <span class="keyword">error</span>
}

<span class="keyword">type</span> UserRepository <span class="keyword">struct</span> {
    db *gorm.DB
}

<span class="function">func</span> (r *UserRepository) <span class="function">FindByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>) {
    <span class="keyword">var</span> user User
    err := r.db.<span class="function">First</span>(&user, id).Error
    <span class="keyword">return</span> &user, err
}</code></pre>
                
                <h4>2. 使用事务管理</h4>
                <pre><code><span class="keyword">func</span> (s *UserService) <span class="function">CreateUserWithOrder</span>(user *User, order *Order) <span class="keyword">error</span> {
    <span class="keyword">return</span> s.db.<span class="function">Transaction</span>(<span class="keyword">func</span>(tx *gorm.DB) <span class="keyword">error</span> {
        <span class="keyword">if</span> err := tx.<span class="function">Create</span>(user).Error; err != <span class="keyword">nil</span> {
            <span class="keyword">return</span> err
        }
        order.UserID = user.ID
        <span class="keyword">return</span> tx.<span class="function">Create</span>(order).Error
    })
}</code></pre>
                
                <h4>3. 使用软删除</h4>
                <pre><code><span class="keyword">type</span> BaseModel <span class="keyword">struct</span> {
    ID        <span class="keyword">uint</span>
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    BaseModel
    Name  <span class="keyword">string</span>
    Email <span class="keyword">string</span>
}</code></pre>
                
                <h4>4. 使用预加载避免 N+1 查询</h4>
                <pre><code><span class="comment">// 错误：N+1 查询</span>
<span class="keyword">var</span> users []User
db.<span class="function">Find</span>(&users)
<span class="keyword">for</span> _, user := <span class="keyword">range</span> users {
    db.<span class="function">Where</span>(<span class="string">"user_id = ?"</span>, user.ID).<span class="function">Find</span>(&user.Posts)
}

<span class="comment">// 正确：使用预加载</span>
db.<span class="function">Preload</span>(<span class="string">"Posts"</span>).<span class="function">Find</span>(&users)</code></pre>
            </div>
            
            <h3>Viper 最佳实践</h3>
            <div class="note-box">
                <h4>1. 配置优先级</h4>
                <pre><code><span class="comment">// 优先级从高到低</span>
<span class="comment">// 1. 命令行参数</span>
<span class="comment">// 2. 环境变量</span>
<span class="comment">// 3. 配置文件</span>
<span class="comment">// 4. 默认值</span></code></pre>
                
                <h4>2. 使用配置验证</h4>
                <pre><code><span class="keyword">func</span> <span class="function">ValidateConfig</span>(v *viper.Viper) <span class="keyword">error</span> {
    <span class="keyword">if</span> !v.<span class="function">IsSet</span>(<span class="string">"server.port"</span>) {
        <span class="keyword">return</span> errors.<span class="function">New</span>(<span class="string">"server.port is required"</span>)
    }
    <span class="keyword">if</span> !v.<span class="function">IsSet</span>(<span class="string">"database.host"</span>) {
        <span class="keyword">return</span> errors.<span class="function">New</span>(<span class="string">"database.host is required"</span>)
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
                
                <h4>3. 敏感信息使用环境变量</h4>
                <pre><code><span class="comment">// config.yaml</span>
database:
  host: localhost
  port: <span class="number">3306</span>
  name: mydb
  user: root
  password: ${DB_PASSWORD}  <span class="comment">// 从环境变量读取</span></code></pre>
            </div>
            
            <h3>Zap 最佳实践</h3>
            <div class="note-box">
                <h4>1. 使用全局 Logger</h4>
                <pre><code><span class="keyword">var</span> logger *zap.Logger

<span class="function">func</span> <span class="function">InitLogger</span>(config *Config) <span class="keyword">error</span> {
    <span class="keyword">var</span> err <span class="keyword">error</span>
    logger, err = config.<span class="function">BuildLogger</span>()
    <span class="keyword">return</span> err
}

<span class="function">func</span> <span class="function">GetLogger</span>() *zap.Logger {
    <span class="keyword">return</span> logger
}</code></pre>
                
                <h4>2. 使用结构化日志</h4>
                <pre><code><span class="comment">// 好的实践</span>
logger.<span class="function">Info</span>(<span class="string">"User logged in"</span>,
    zap.<span class="function">String</span>(<span class="string">"user_id"</span>, userID),
    zap.<span class="function">String</span>(<span class="string">"ip"</span>, ip),
)

<span class="comment">// 不好的实践</span>
logger.<span class="function">Info</span>(fmt.<span class="function">Sprintf</span>(<span class="string">"User %s logged in from %s"</span>, userID, ip))</code></pre>
                
                <h4>3. 日志级别控制</h4>
                <pre><code><span class="comment">// 开发环境</span>
config.Level = zap.NewAtomicLevelAt(zapcore.DebugLevel)

<span class="comment">// 生产环境</span>
config.Level = zap.NewAtomicLevelAt(zapcore.InfoLevel)</code></pre>
                
                <h4>4. 日志轮转</h4>
                <pre><code><span class="comment">// 使用 lumberjack 进行日志轮转</span>
writer := &lumberjack.Logger{
    Filename:   <span class="string">"logs/app.log"</span>,
    MaxSize:    <span class="number">100</span>, <span class="comment">// MB</span>
    MaxBackups: <span class="number">3</span>,
    MaxAge:     <span class="number">28</span>,   <span class="comment">// days</span>
    Compress:   <span class="keyword">true</span>,
}</code></pre>
            </div>
            
            <h3>集成示例</h3>
            <div class="note-box">
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"github.com/spf13/viper"</span>
    <span class="string">"go.uber.org/zap"</span>
    <span class="string">"gorm.io/driver/mysql"</span>
    <span class="string">"gorm.io/gorm"</span>
)

<span class="keyword">type</span> App <span class="keyword">struct</span> {
    Router *gin.Engine
    DB     *gorm.DB
    Config *viper.Viper
    Logger *zap.Logger
}

<span class="function">func</span> <span class="function">NewApp</span>() *App {
    <span class="comment">// 初始化配置</span>
    config := viper.<span class="function">New</span>()
    config.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    config.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    config.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    config.<span class="function">ReadInConfig</span>()
    
    <span class="comment">// 初始化日志</span>
    logger, _ := zap.<span class="function">NewProduction</span>()
    
    <span class="comment">// 初始化数据库</span>
    dsn := config.<span class="function">GetString</span>(<span class="string">"database.dsn"</span>)
    db, _ := gorm.<span class="function">Open</span>(mysql.<span class="function">Open</span>(dsn), &gorm.Config{})
    
    <span class="comment">// 初始化路由</span>
    router := gin.<span class="function">Default</span>()
    
    <span class="keyword">return</span> &App{
        Router: router,
        DB:     db,
        Config: config,
        Logger: logger,
    }
}

<span class="function">func</span> (a *App) <span class="function">Run</span>() {
    port := a.Config.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
    a.Logger.<span class="function">Info</span>(<span class="string">"Starting server"</span>, zap.<span class="function">String</span>(<span class="string">"port"</span>, port))
    a.Router.<span class="function">Run</span>(<span class="string">":"</span> + port)
}

<span class="function">func</span> <span class="function">main</span>() {
    app := <span class="function">NewApp</span>()
    app.<span class="function">Run</span>()
}</code></pre>
            </div>
            
            <h2 id="validator">Validator 参数校验</h2>
            
            <h3>简介</h3>
            <p>Validator 是 Go 语言中最流行的参数校验库，基于结构体标签实现，支持多种校验规则，可以轻松集成到 Gin 等 Web 框架中。它支持自定义校验规则、国际化错误消息等功能。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/go-playground/validator/v10</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name  <span class="keyword">string</span> <span class="string">`validate:"required,min=3,max=32"`</span>
    Email <span class="keyword">string</span> <span class="string">`validate:"required,email"`</span>
    Age   <span class="keyword">int</span>    <span class="string">`validate:"required,gte=0,lte=130"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    validate := validator.<span class="function">New</span>()
    
    user := User{
        Name:  <span class="string">"Alice"</span>,
        Email: <span class="string">"alice@example.com"</span>,
        Age:   <span class="number">25</span>,
    }
    
    err := validate.<span class="function">Struct</span>(user)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Validation failed:"</span>, err)
        <span class="keyword">return</span>
    }
    
    fmt.<span class="function">Println</span>(<span class="string">"Validation passed!"</span>)
}</code></pre>
            
            <h3>常用校验规则</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    <span class="comment">// 必填字段</span>
    Name <span class="keyword">string</span> <span class="string">`validate:"required"`</span>
    
    <span class="comment">// 字符串长度</span>
    Username <span class="keyword">string</span> <span class="string">`validate:"min=3,max=20"`</span>
    
    <span class="comment">// 邮箱格式</span>
    Email <span class="keyword">string</span> <span class="string">`validate:"email"`</span>
    
    <span class="comment">// URL 格式</span>
    Website <span class="keyword">string</span> <span class="string">`validate:"url"`</span>
    
    <span class="comment">// 数值范围</span>
    Age <span class="keyword">int</span> <span class="string">`validate:"gte=0,lte=130"`</span>
    
    <span class="comment">// 大于等于 (gte)、大于 (gt)、小于等于 (lte)、小于 (lt)</span>
    Price <span class="keyword">float64</span> <span class="string">`validate:"gt=0"`</span>
    
    <span class="comment">// 正则表达式</span>
    Phone <span class="keyword">string</span> <span class="string">`validate:"required,^1[3-9]\\d{9}$"`</span>
    
    <span class="comment">// 枚举值</span>
    Gender <span class="keyword">string</span> <span class="string">`validate:"oneof=male female other"`</span>
    
    <span class="comment">// 字符串包含</span>
    Password <span class="keyword">string</span> <span class="string">`validate:"containsany=!@#$%"`</span>
    
    <span class="comment">// 唯一性（需要自定义校验）</span>
    Username <span class="keyword">string</span> <span class="string">`validate:"unique"`</span>
    
    <span class="comment">// 可选字段</span>
    Nickname <span class="keyword">string</span> <span class="string">`validate:"omitempty,min=2"`</span>
    
    <span class="comment">// 排除某些值</span>
    Role <span class="keyword">string</span> <span class="string">`validate:"nefield=Password"`</span>
    
    <span class="comment">// 字段相等</span>
    ConfirmPassword <span class="keyword">string</span> <span class="string">`validate:"eqfield=Password"`</span>
    
    <span class="comment">// 字段不等</span>
    NewEmail <span class="keyword">string</span> <span class="string">`validate:"nefield=OldEmail"`</span>
}</code></pre>
            
            <h3>错误处理</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
)

<span class="function">func</span> <span class="function">handleValidationError</span>(err <span class="keyword">error</span>) {
    <span class="comment">// 类型断言</span>
    validationErrors, ok := err.(validator.ValidationErrors)
    <span class="keyword">if</span> !ok {
        fmt.<span class="function">Println</span>(<span class="string">"Unknown error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    <span class="comment">// 遍历所有错误</span>
    <span class="keyword">for</span>, e := <span class="keyword">range</span> validationErrors {
        fmt.<span class="function">Printf</span>(<span class="string">"Field: %s, Tag: %s, Param: %s\n"</span>, e.<span class="function">Field</span>(), e.<span class="function">Tag</span>(), e.<span class="function">Param</span>())
    }
}

<span class="comment">// 自定义错误消息</span>
<span class="keyword">type</span> ErrorResponse <span class="keyword">struct</span> {
    Field   <span class="keyword">string</span> <span class="string">`json:"field"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">getValidationErrors</span>(err <span class="keyword">error</span>) []ErrorResponse {
    <span class="keyword">var</span> errors []ErrorResponse
    
    validationErrors := err.(validator.ValidationErrors)
    <span class="keyword">for</span>, e := <span class="keyword">range</span> validationErrors {
        errors = <span class="function">append</span>(errors, ErrorResponse{
            Field:   e.<span class="function">Field</span>(),
            Message: <span class="function">getErrorMessage</span>(e),
        })
    }
    
    <span class="keyword">return</span> errors
}

<span class="function">func</span> <span class="function">getErrorMessage</span>(e validator.FieldError) <span class="keyword">string</span> {
    <span class="keyword">switch</span> e.<span class="function">Tag</span>() {
    <span class="keyword">case</span> <span class="string">"required"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s is required"</span>, e.<span class="function">Field</span>())
    <span class="keyword">case</span> <span class="string">"email"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s must be a valid email"</span>, e.<span class="function">Field</span>())
    <span class="keyword">case</span> <span class="string">"min"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s must be at least %s characters"</span>, e.<span class="function">Field</span>(), e.<span class="function">Param</span>())
    <span class="keyword">case</span> <span class="string">"max"</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s must be at most %s characters"</span>, e.<span class="function">Field</span>(), e.<span class="function">Param</span>())
    <span class="keyword">default</span>:
        <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%s is invalid"</span>, e.<span class="function">Field</span>())
    }
}</code></pre>
            
            <h3>自定义校验规则</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
    <span class="string">"regexp"</span>
)

<span class="comment">// 自定义校验：手机号</span>
<span class="function">func</span> <span class="function">validateMobile</span>(fl validator.FieldLevel) <span class="keyword">bool</span> {
    mobile := fl.<span class="function">Field</span>().<span class="function">String</span>()
    matched, _ := regexp.<span class="function">MatchString</span>(<span class="string">`^1[3-9]\d{9}$`</span>, mobile)
    <span class="keyword">return</span> matched
}

<span class="comment">// 自定义校验：用户名唯一性</span>
<span class="function">func</span> <span class="function">validateUsernameUnique</span>(fl validator.FieldLevel) <span class="keyword">bool</span> {
    username := fl.<span class="function">Field</span>().<span class="function">String</span>()
    <span class="comment">// 这里应该查询数据库检查用户名是否已存在</span>
    <span class="comment">// 简化示例：假设用户名不能是 "admin"</span>
    <span class="keyword">return</span> username != <span class="string">"admin"</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    validate := validator.<span class="function">New</span>()
    
    <span class="comment">// 注册自定义校验</span>
    validate.<span class="function">RegisterValidation</span>(<span class="string">"mobile"</span>, <span class="function">validateMobile</span>)
    validate.<span class="function">RegisterValidation</span>(<span class="string">"username_unique"</span>, <span class="function">validateUsernameUnique</span>)
    
    <span class="keyword">type</span> User <span class="keyword">struct</span> {
        Username <span class="keyword">string</span> <span class="string">`validate:"required,username_unique"`</span>
        Mobile   <span class="keyword">string</span> <span class="string">`validate:"required,mobile"`</span>
    }
    
    user := User{
        Username: <span class="string">"admin"</span>,
        Mobile:   <span class="string">"13800138000"</span>,
    }
    
    err := validate.<span class="function">Struct</span>(user)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Validation failed:"</span>, err)
    }
}</code></pre>
            
            <h3>与 Gin 集成</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gin-gonic/gin"</span>
    <span class="string">"github.com/go-playground/validator/v10"</span>
    <span class="string">"net/http"</span>
)

<span class="keyword">type</span> CreateUserRequest <span class="keyword">struct</span> {
    Name     <span class="keyword">string</span> <span class="string">`json:"name" validate:"required,min=3,max=32"`</span>
    Email    <span class="keyword">string</span> <span class="string">`json:"email" validate:"required,email"`</span>
    Password <span class="keyword">string</span> <span class="string">`json:"password" validate:"required,min=8"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    r := gin.<span class="function">Default</span>()
    
    <span class="comment">// 获取 Gin 的 validator</span>
    <span class="keyword">if</span> v, ok := binding.Validator.<span class="function">Engine</span>().(*validator.Validate); ok {
        <span class="comment">// 注册自定义校验</span>
        v.<span class="function">RegisterValidation</span>(<span class="string">"mobile"</span>, <span class="function">validateMobile</span>)
    }
    
    r.<span class="function">POST</span>(<span class="string">"/users"</span>, <span class="keyword">func</span>(c *gin.Context) {
        <span class="keyword">var</span> req CreateUserRequest
        
        <span class="comment">// 绑定和校验</span>
        <span class="keyword">if</span> err := c.<span class="function">ShouldBindJSON</span>(&req); err != <span class="keyword">nil</span> {
            c.<span class="function">JSON</span>(http.StatusBadRequest, gin.H{
                <span class="string">"error"</span>: <span class="function">getValidationErrors</span>(err),
            })
            <span class="keyword">return</span>
        }
        
        c.<span class="function">JSON</span>(http.StatusCreated, gin.H{
            <span class="string">"message"</span>: <span class="string">"User created"</span>,
            <span class="string">"user"</span>:    req,
        })
    })
    
    r.<span class="function">Run</span>(<span class="string">":8080"</span>)
}</code></pre>
            
            <h3>结构体嵌套校验</h3>
            <pre><code><span class="keyword">type</span> Address <span class="keyword">struct</span> {
    Street  <span class="keyword">string</span> <span class="string">`validate:"required"`</span>
    City    <span class="keyword">string</span> <span class="string">`validate:"required"`</span>
    ZipCode <span class="keyword">string</span> <span class="string">`validate:"required,len=6"`</span>
}

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name    <span class="keyword">string</span>  <span class="string">`validate:"required"`</span>
    Address Address  <span class="string">`validate:"required,dive"`</span>  <span class="comment">// dive 表示校验嵌套结构体</span>
}</code></pre>
            
            <h3>数组/切片校验</h3>
            <pre><code><span class="keyword">type</span> Order <span class="keyword">struct</span> {
    Items []Item <span class="string">`validate:"required,min=1,dive"`</span>  <span class="comment">// 校验数组中的每个元素</span>
}

<span class="keyword">type</span> Item <span class="keyword">struct</span> {
    Name  <span class="keyword">string</span>  <span class="string">`validate:"required"`</span>
    Price <span class="keyword">float64</span> <span class="string">`validate:"required,gt=0"`</span>
}</code></pre>
            
            <h2 id="cobra">Cobra 命令行工具</h2>
            
            <h3>简介</h3>
            <p>Cobra 是 Go 语言中最流行的命令行应用框架，被广泛用于许多知名项目（如 Docker、Kubernetes、Hugo 等）。它提供了强大的命令解析、子命令支持、自动生成帮助文档等功能。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/spf13/cobra
<span class="keyword">go</span> get -u github.com/spf13/pflag</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> name <span class="keyword">string</span>
    
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        Long:  <span class="string">"A longer description of my application"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Printf</span>(<span class="string">"Hello, %s!\n"</span>, name)
        },
    }
    
    rootCmd.<span class="function">Flags</span>().<span class="function">StringVarP</span>(&name, <span class="string">"name"</span>, <span class="string">"n"</span>, <span class="string">"World"</span>, <span class="string">"Name to greet"</span>)
    
    rootCmd.<span class="function">Execute</span>()
}</code></pre>
            
            <h3>子命令</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
    }
    
    <span class="comment">// 添加子命令</span>
    rootCmd.<span class="function">AddCommand</span>(<span class="function">createCommand</span>())
    rootCmd.<span class="function">AddCommand</span>(<span class="function">listCommand</span>())
    rootCmd.<span class="function">AddCommand</span>(<span class="function">deleteCommand</span>())
    
    rootCmd.<span class="function">Execute</span>()
}

<span class="function">func</span> <span class="function">createCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"create"</span>,
        Short: <span class="string">"Create a new resource"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Creating resource..."</span>)
        },
    }
}

<span class="function">func</span> <span class="function">listCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"list"</span>,
        Short: <span class="string">"List all resources"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Listing resources..."</span>)
        },
    }
}

<span class="function">func</span> <span class="function">deleteCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"delete [id]"</span>,
        Short: <span class="string">"Delete a resource"</span>,
        Args:  cobra.ExactArgs(<span class="number">1</span>),
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Printf</span>(<span class="string">"Deleting resource: %s\n"</span>, args[<span class="number">0</span>])
        },
    }
}</code></pre>
            
            <h3>参数验证</h3>
            <pre><code><span class="keyword">func</span> <span class="function">createCommand</span>() *cobra.Command {
    <span class="keyword">var</span> name <span class="keyword">string</span>
    <span class="keyword">var</span> age <span class="keyword">int</span>
    
    cmd := &cobra.Command{
        Use:   <span class="string">"create"</span>,
        Short: <span class="string">"Create a new user"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            <span class="comment">// 验证参数</span>
            <span class="keyword">if</span> name == <span class="string">""</span> {
                fmt.<span class="function">Println</span>(<span class="string">"Error: name is required"</span>)
                <span class="keyword">return</span>
            }
            <span class="keyword">if</span> age <= <span class="number">0</span> {
                fmt.<span class="function">Println</span>(<span class="string">"Error: age must be positive"</span>)
                <span class="keyword">return</span>
            }
            
            fmt.<span class="function">Printf</span>(<span class="string">"Creating user: %s, age: %d\n"</span>, name, age)
        },
    }
    
    cmd.<span class="function">Flags</span>().<span class="function">StringVarP</span>(&name, <span class="string">"name"</span>, <span class="string">"n"</span>, <span class="string">""</span>, <span class="string">"User name"</span>)
    cmd.<span class="function">Flags</span>().<span class="function">IntVarP</span>(&age, <span class="string">"age"</span>, <span class="string">"a"</span>, <span class="number">0</span>, <span class="string">"User age"</span>)
    
    <span class="comment">// 标记为必填</span>
    cmd.<span class="function">MarkFlagRequired</span>(<span class="string">"name"</span>)
    
    <span class="keyword">return</span> cmd
}</code></pre>
            
            <h3>持久化标志</h3>
            <pre><code><span class="keyword">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> verbose <span class="keyword">bool</span>
    <span class="keyword">var</span> config <span class="keyword">string</span>
    
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        PersistentPreRun: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            <span class="keyword">if</span> verbose {
                fmt.<span class="function">Println</span>(<span class="string">"Verbose mode enabled"</span>)
            }
            fmt.<span class="function">Printf</span>(<span class="string">"Using config: %s\n"</span>, config)
        },
    }
    
    <span class="comment">// 持久化标志：所有子命令都可以使用</span>
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">BoolVarP</span>(&verbose, <span class="string">"verbose"</span>, <span class="string">"v"</span>, <span class="keyword">false</span>, <span class="string">"Verbose output"</span>)
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">StringVarP</span>(&config, <span class="string">"config"</span>, <span class="string">"c"</span>, <span class="string">"config.yaml"</span>, <span class="string">"Config file"</span>)
    
    rootCmd.<span class="function">AddCommand</span>(<span class="function">createCommand</span>())
    rootCmd.<span class="function">Execute</span>()
}</code></pre>
            
            <h3>配置文件集成</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        PersistentPreRun: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            <span class="comment">// 初始化 Viper</span>
            viper.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
            viper.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
            viper.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
            
            <span class="keyword">if</span> err := viper.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
                fmt.<span class="function">Println</span>(<span class="string">"Using default config"</span>)
            }
            
            <span class="comment">// 绑定命令行标志</span>
            viper.<span class="function">BindPFlag</span>(<span class="string">"port"</span>, cmd.<span class="function">PersistentFlags</span>().<span class="function">Lookup</span>(<span class="string">"port"</span>))
        },
    }
    
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">IntP</span>(<span class="string">"port"</span>, <span class="string">"p"</span>, <span class="number">8080</span>, <span class="string">"Server port"</span>)
    
    rootCmd.<span class="function">AddCommand</span>(<span class="function">serveCommand</span>())
    rootCmd.<span class="function">Execute</span>()
}

<span class="function">func</span> <span class="function">serveCommand</span>() *cobra.Command {
    <span class="keyword">return</span> &cobra.Command{
        Use:   <span class="string">"serve"</span>,
        Short: <span class="string">"Start the server"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            port := viper.<span class="function">GetInt</span>(<span class="string">"port"</span>)
            fmt.<span class="function">Printf</span>(<span class="string">"Starting server on port %d\n"</span>, port)
        },
    }
}</code></pre>
            
            <h3>自动生成文档</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
    <span class="string">"github.com/spf13/cobra/doc"</span>
)

<span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Hello, World!"</span>)
        },
    }
    
    rootCmd.<span class="function">AddCommand</span>(&cobra.Command{
        Use:   <span class="string">"version"</span>,
        Short: <span class="string">"Print version"</span>,
        Run: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
            fmt.<span class="function">Println</span>(<span class="string">"Version 1.0.0"</span>)
        },
    })
    
    <span class="comment">// 生成 Markdown 文档</span>
    doc.<span class="function">GenMarkdownTree</span>(rootCmd, <span class="string">"./docs"</span>)
    
    <span class="comment">// 生成 Man 页面</span>
    doc.<span class="function">GenManTree</span>(rootCmd, &doc.GenManHeader{
        Section: <span class="string">"1"</span>,
    }, <span class="string">"./man"</span>)
    
    <span class="comment">// 生成 ReStructuredText</span>
    doc.<span class="function">GenReSTTree</span>(rootCmd, <span class="string">"./rst"</span>)
}</code></pre>
            
            <h3>Shell 自动补全</h3>
            <pre><code><span class="keyword">func</span> <span class="function">main</span>() {
    rootCmd := &cobra.Command{
        Use:   <span class="string">"myapp"</span>,
        Short: <span class="string">"My application"</span>,
    }
    
    <span class="comment">// 生成 Bash 补全</span>
    rootCmd.<span class="function">GenBashCompletionFile</span>(<span class="string">"/etc/bash_completion.d/myapp"</span>)
    
    <span class="comment">// 生成 Zsh 补全</span>
    rootCmd.<span class="function">GenZshCompletionFile</span>(<span class="string">"/usr/local/share/zsh/site-functions/_myapp"</span>)
    
    <span class="comment">// 生成 Fish 补全</span>
    rootCmd.<span class="function">GenFishCompletionFile</span>(<span class="string">"/usr/share/fish/vendor_completions.d/myapp.fish"</span>)
    
    rootCmd.<span class="function">Execute</span>()
}</code></pre>
            
            <h2 id="gomicro">Go-Micro 微服务框架</h2>
            
            <h3>简介</h3>
            <p>Go-Micro 是一个用于构建微服务的 Go 语言框架，提供服务发现、负载均衡、消息编码、RPC 通信等功能。它支持多种传输协议、编码格式和服务发现机制，是构建分布式系统的理想选择。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/micro/go-micro/v2
<span class="keyword">go</span> get -u github.com/micro/go-micro/v2/api</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"github.com/micro/go-micro/v2"</span>
    proto <span class="string">"github.com/micro/go-micro/v2/examples/greeter/proto"</span>
)

<span class="keyword">type</span> Greeter <span class="keyword">struct</span> {}

<span class="function">func</span> (g *Greeter) <span class="function">Hello</span>(ctx context.Context, req *proto.HelloRequest, rsp *proto.HelloResponse) <span class="keyword">error</span> {
    rsp.Greeting = <span class="string">"Hello "</span> + req.Name
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建服务</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"greeter"</span>),
        micro.<span class="function">Version</span>(<span class="string">"latest"</span>),
    )
    
    <span class="comment">// 初始化服务</span>
    service.<span class="function">Init</span>()
    
    <span class="comment">// 注册处理器</span>
    proto.<span class="function">RegisterGreeterHandler</span>(service.<span class="function">Server</span>(), &Greeter{})
    
    <span class="comment">// 运行服务</span>
    <span class="keyword">if</span> err := service.<span class="function">Run</span>(); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
    }
}</code></pre>
            
            <h3>服务发现</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"github.com/micro/go-micro/v2"</span>
    <span class="string">"github.com/micro/go-micro/v2/client"</span>
    <span class="string">"github.com/micro/go-micro/v2/registry"</span>
    <span class="string">"github.com/micro/go-micro/v2/registry/etcd"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 使用 Etcd 作为注册中心</span>
    reg := etcd.<span class="function">NewRegistry</span>(registry.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:2379"</span>))
    
    <span class="comment">// 创建服务</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Registry</span>(reg),
        micro.<span class="function">Name</span>(<span class="string">"greeter"</span>),
    )
    
    service.<span class="function">Init</span>()
    
    <span class="comment">// 创建客户端</span>
    cli := service.<span class="function">Client</span>()
    
    <span class="comment">// 调用服务</span>
    rsp := &HelloResponse{}
    err := cli.<span class="function">Call</span>(
        context.<span class="function">Background</span>(),
        client.NewRequest(<span class="string">"greeter"</span>, <span class="string">"Greeter.Hello"</span>, &HelloRequest{Name: <span class="string">"World"</span>}),
        rsp,
        client.<span class="function">WithRetries</span>(<span class="number">3</span>),
        client.<span class="function">WithRequestTimeout</span>(time.Second * <span class="number">5</span>),
    )
    
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    fmt.<span class="function">Println</span>(<span class="string">"Response:"</span>, rsp.Greeting)
}</code></pre>
            
            <h3>服务间通信</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"github.com/micro/go-micro/v2"</span>
)

<span class="comment">// 定义服务接口</span>
<span class="keyword">type</span> UserService <span class="keyword">interface</span> {
    <span class="function">GetUser</span>(ctx context.Context, req *GetUserRequest, rsp *GetUserResponse) <span class="keyword">error</span>
}

<span class="comment">// 服务 A：用户服务</span>
<span class="keyword">type</span> UserHandler <span class="keyword">struct</span> {}

<span class="function">func</span> (h *UserHandler) <span class="function">GetUser</span>(ctx context.Context, req *GetUserRequest, rsp *GetUserResponse) <span class="keyword">error</span> {
    <span class="comment">// 获取用户信息</span>
    rsp.User = &User{ID: req.Id, Name: <span class="string">"Alice"</span>}
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="comment">// 服务 B：订单服务</span>
<span class="keyword">type</span> OrderHandler <span class="keyword">struct</span> {
    userService UserService
}

<span class="function">func</span> (h *OrderHandler) <span class="function">CreateOrder</span>(ctx context.Context, req *CreateOrderRequest, rsp *CreateOrderResponse) <span class="keyword">error</span> {
    <span class="comment">// 调用用户服务</span>
    userReq := &GetUserRequest{Id: req.UserId}
    userRsp := &GetUserResponse{}
    err := h.userService.<span class="function">GetUser</span>(ctx, userReq, userRsp)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="comment">// 创建订单</span>
    rsp.Order = &Order{ID: <span class="string">"1"</span>, User: userRsp.User}
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建服务</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"order"</span>),
    )
    
    service.<span class="function">Init</span>()
    
    <span class="comment">// 创建用户服务客户端</span>
    userService := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"order"</span>),  <span class="comment">// 使用当前服务的客户端</span>
    )
    
    <span class="comment">// 注册订单服务</span>
    micro.<span class="function">RegisterHandler</span>(service.<span class="function">Server</span>(), &OrderHandler{
        userService: userService.<span class="function">Client</span>(),
    })
    
    service.<span class="function">Run</span>()
}</code></pre>
            
            <h3>消息发布订阅</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"github.com/micro/go-micro/v2"</span>
    <span class="string">"github.com/micro/go-micro/v2/broker"</span>
    <span class="string">"github.com/micro/go-micro/v2/broker/nats"</span>
)

<span class="comment">// 发布者</span>
<span class="function">func</span> <span class="function">publisher</span>() {
    <span class="comment">// 创建 Broker</span>
    b := nats.<span class="function">NewBroker</span>(broker.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:4222"</span>))
    
    <span class="keyword">if</span> err := b.<span class="function">Connect</span>(); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Broker connect error:"</span>, err)
        <span class="keyword">return</span>
    }
    
    <span class="comment">// 发布消息</span>
    msg := &broker.Message{
        Header: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{
            <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,
        },
        Body: []<span class="keyword">byte</span>(<span class="string">`{"event":"user.created","user_id":"123"}`</span>),
    }
    
    <span class="keyword">if</span> err := b.<span class="function">Publish</span>(<span class="string">"user.created"</span>, msg); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"Publish error:"</span>, err)
    }
}

<span class="comment">// 订阅者</span>
<span class="function">func</span> <span class="function">subscriber</span>() {
    <span class="comment">// 创建服务</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Broker</span>(nats.<span class="function">NewBroker</span>(broker.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:4222"</span>))),
    )
    
    service.<span class="function">Init</span>()
    
    <span class="comment">// 订阅消息</span>
    micro.<span class="function">RegisterSubscriber</span>(<span class="string">"user.created"</span>, service.<span class="function">Server</span>(), <span class="keyword">func</span>(ctx context.Context, msg *broker.Message) <span class="keyword">error</span> {
        fmt.<span class="function">Printf</span>(<span class="string">"Received message: %s\n"</span>, string(msg.Body))
        <span class="keyword">return</span> <span class="keyword">nil</span>
    })
    
    service.<span class="function">Run</span>()
}</code></pre>
            
            <h3>中间件</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"github.com/micro/go-micro/v2"</span>
    <span class="string">"github.com/micro/go-micro/v2/server"</span>
)

<span class="comment">// 日志中间件</span>
<span class="function">func</span> <span class="function">logWrapper</span>(fn server.HandlerFunc) server.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(ctx context.Context, req server.Request, rsp interface{}) <span class="keyword">error</span> {
        fmt.<span class="function">Printf</span>(<span class="string">"[Request] %s %s\n"</span>, req.<span class="function">Method</span>(), req.<span class="function">Endpoint</span>())
        err := fn(ctx, req, rsp)
        fmt.<span class="function">Printf</span>(<span class="string">"[Response] %s\n"</span>, err)
        <span class="keyword">return</span> err
    }
}

<span class="comment">// 认证中间件</span>
<span class="function">func</span> <span class="function">authWrapper</span>(fn server.HandlerFunc) server.HandlerFunc {
    <span class="keyword">return</span> <span class="keyword">func</span>(ctx context.Context, req server.Request, rsp interface{}) <span class="keyword">error</span> {
        <span class="comment">// 检查认证令牌</span>
        token := req.<span class="function">Header</span>().<span class="function">Get</span>(<span class="string">"Authorization"</span>)
        <span class="keyword">if</span> token == <span class="string">""</span> {
            <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"Unauthorized"</span>)
        }
        
        <span class="keyword">return</span> fn(ctx, req, rsp)
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建服务</span>
    service := micro.<span class="function">NewService</span>(
        micro.<span class="function">Name</span>(<span class="string">"greeter"</span>),
        micro.<span class="function">WrapHandler</span>(logWrapper),
        micro.<span class="function">WrapHandler</span>(authWrapper),
    )
    
    service.<span class="function">Init</span>()
    service.<span class="function">Run</span>()
}</code></pre>
            
            <h2 id="etcd">Etcd 分布式键值存储</h2>
            
            <h3>简介</h3>
            <p>Etcd 是一个分布式、可靠的键值存储系统，用于配置管理和服务发现。它使用 Raft 算法保证数据一致性，支持强一致性读写、事务、租约等功能，是 Kubernetes 等项目的核心组件。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u go.etcd.io/etcd/client/v3</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    
    <span class="string">"go.etcd.io/etcd/client/v3"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建客户端</span>
    cli, err := clientv3.<span class="function">New</span>(clientv3.Config{
        Endpoints:   []<span class="keyword">string</span>{<span class="string">"127.0.0.1:2379"</span>},
        DialTimeout: <span class="number">5</span> * time.Second,
    })
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    <span class="keyword">defer</span> cli.<span class="function">Close</span>()
    
    <span class="comment">// 设置键值</span>
    ctx, cancel := context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), <span class="number">5</span>*time.Second)
    resp, err := cli.<span class="function">Put</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>)
    cancel()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    fmt.<span class="function">Println</span>(<span class="string">"Revision:"</span>, resp.Header.Revision)
    
    <span class="comment">// 获取键值</span>
    ctx, cancel = context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), <span class="number">5</span>*time.Second)
    resp, err = cli.<span class="function">Get</span>(ctx, <span class="string">"key"</span>)
    cancel()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    
    <span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs {
        fmt.<span class="function">Printf</span>(<span class="string">"%s : %s\n"</span>, ev.Key, ev.Value)
    }
}</code></pre>
            
            <h3>键值操作</h3>
            <pre><code><span class="comment">// 设置键值</span>
resp, err := cli.<span class="function">Put</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>)

<span class="comment">// 获取单个键</span>
resp, err := cli.<span class="function">Get</span>(ctx, <span class="string">"key"</span>)

<span class="comment">// 获取多个键（前缀匹配）</span>
resp, err := cli.<span class="function">Get</span>(ctx, <span class="string">"prefix"</span>, clientv3.<span class="function">WithPrefix</span>())

<span class="comment">// 获取所有键</span>
resp, err := cli.<span class="function">Get</span>(ctx, <span class="string">""</span>, clientv3.<span class="function">WithFromKey</span>(), clientv3.<span class="function">WithLimit</span>(<span class="number">100</span>))

<span class="comment">// 删除键</span>
resp, err := cli.<span class="function">Delete</span>(ctx, <span class="string">"key"</span>)

<span class="comment">// 删除多个键（前缀匹配）</span>
resp, err := cli.<span class="function">Delete</span>(ctx, <span class="string">"prefix"</span>, clientv3.<span class="function">WithPrefix</span>())

<span class="comment">// 删除所有键</span>
resp, err := cli.<span class="function">Delete</span>(ctx, <span class="string">""</span>, clientv3.<span class="function">WithPrefix</span>())</code></pre>
            
            <h3>租约（Lease）</h3>
            <pre><code><span class="comment">// 创建租约（10秒过期）</span>
lease, err := cli.<span class="function">Grant</span>(ctx, <span class="number">10</span>)
<span class="keyword">if</span> err != <span class="keyword">nil</span> {
    <span class="function">panic</span>(err)
}

<span class="comment">// 绑定租约到键</span>
resp, err := cli.<span class="function">Put</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>, clientv3.<span class="function">WithLease</span>(lease.ID))

<span class="comment">// 续租</span>
keepAlive, err := cli.<span class="function">KeepAlive</span>(ctx, lease.ID)
<span class="keyword">for</span> ka := <span class="keyword">range</span> keepAlive {
    fmt.<span class="function">Printf</span>(<span class="string">"TTL: %d\n"</span>, ka.TTL)
}

<span class="comment">// 撤销租约</span>
_, err = cli.<span class="function">Revoke</span>(ctx, lease.ID)</code></pre>
            
            <h3>事务</h3>
            <pre><code><span class="comment">// 事务操作</span>
txn := cli.<span class="function">Txn</span>(ctx)

<span class="comment">// If 条件</span>
txn.<span class="function">If</span>(
    clientv3.<span class="function">Compare</span>(clientv3.<span class="function">Value</span>(<span class="string">"key"</span>), <span class="string">"="</span>, <span class="string">"value"</span>),
).
<span class="function">Then</span>(
    clientv3.<span class="function">OpPut</span>(<span class="string">"key"</span>, <span class="string">"new_value"</span>),
).
<span class="function">Else</span>(
    clientv3.<span class="function">OpPut</span>(<span class="string">"key"</span>, <span class="string">"default_value"</span>),
).
<span class="function">Commit</span>()

<span class="comment">// 事务示例：分布式锁</span>
<span class="function">func</span> <span class="function">acquireLock</span>(cli *clientv3.Client, key <span class="keyword">string</span>, ttl <span class="keyword">int64</span>) (<span class="keyword">bool</span>, error) {
    <span class="comment">// 创建租约</span>
    lease, err := cli.<span class="function">Grant</span>(context.<span class="function">Background</span>(), ttl)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">false</span>, err
    }
    
    <span class="comment">// 事务：如果键不存在，则设置</span>
    txn := cli.<span class="function">Txn</span>(context.<span class="function">Background</span>())
    txn.<span class="function">If</span>(
        clientv3.<span class="function">Compare</span>(clientv3.<span class="function">CreateRevision</span>(key), <span class="string">"="</span>, <span class="number">0</span>),
    ).
    <span class="function">Then</span>(
        clientv3.<span class="function">OpPut</span>(key, <span class="string">"locked"</span>, clientv3.<span class="function">WithLease</span>(lease.ID)),
    ).
    <span class="function">Commit</span>()
    
    <span class="keyword">return</span> txn.<span class="function">Succeeded</span>(), <span class="keyword">nil</span>
}</code></pre>
            
            <h3>监听变化</h3>
            <pre><code><span class="comment">// 监听单个键</span>
watchChan := cli.<span class="function">Watch</span>(ctx, <span class="string">"key"</span>)
<span class="keyword">for</span> watchResp := <span class="keyword">range</span> watchChan {
    <span class="keyword">for</span> _, event := <span class="keyword">range</span> watchResp.Events {
        fmt.<span class="function">Printf</span>(<span class="string">"Type: %s, Key: %s, Value: %s\n"</span>, 
            event.Type, event.Kv.Key, event.Kv.Value)
    }
}

<span class="comment">// 监听前缀</span>
watchChan = cli.<span class="function">Watch</span>(ctx, <span class="string">"prefix"</span>, clientv3.<span class="function">WithPrefix</span>())
<span class="keyword">for</span> watchResp := <span class="keyword">range</span> watchChan {
    <span class="keyword">for</span> _, event := <span class="keyword">range</span> watchResp.Events {
        fmt.<span class="function">Printf</span>(<span class="string">"Type: %s, Key: %s, Value: %s\n"</span>, 
            event.Type, event.Kv.Key, event.Kv.Value)
    }
}

<span class="comment">// 从指定版本开始监听</span>
watchChan = cli.<span class="function">Watch</span>(ctx, <span class="string">"key"</span>, clientv3.<span class="function">WithRev</span>(<span class="number">100</span>))</code></pre>
            
            <h3>服务发现</h3>
            <pre><code><span class="comment">// 注册服务</span>
<span class="function">func</span> <span class="function">registerService</span>(cli *clientv3.Client, serviceID, address <span class="keyword">string</span>, ttl <span class="keyword">int64</span>) (<span class="keyword">string</span>, error) {
    <span class="comment">// 创建租约</span>
    lease, err := cli.<span class="function">Grant</span>(context.<span class="function">Background</span>(), ttl)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="comment">// 注册服务</span>
    key := fmt.<span class="function">Sprintf</span>(<span class="string">"/services/%s"</span>, serviceID)
    _, err = cli.<span class="function">Put</span>(context.<span class="function">Background</span>(), key, address, clientv3.<span class="function">WithLease</span>(lease.ID))
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="comment">// 续租</span>
    keepAlive, err := cli.<span class="function">KeepAlive</span>(context.<span class="function">Background</span>(), lease.ID)
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        <span class="keyword">for</span> <span class="keyword">range</span> keepAlive {
            <span class="comment">// 保持续租</span>
        }
    }()
    
    <span class="keyword">return</span> fmt.<span class="function">Sprintf</span>(<span class="string">"%d"</span>, lease.ID), <span class="keyword">nil</span>
}

<span class="comment">// 发现服务</span>
<span class="function">func</span> <span class="function">discoverService</span>(cli *clientv3.Client, serviceID <span class="keyword">string</span>) (<span class="keyword">string</span>, error) {
    key := fmt.<span class="function">Sprintf</span>(<span class="string">"/services/%s"</span>, serviceID)
    resp, err := cli.<span class="function">Get</span>(context.<span class="function">Background</span>(), key)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="keyword">if</span> <span class="function">len</span>(resp.Kvs) == <span class="number">0</span> {
        <span class="keyword">return</span> <span class="string">""</span>, fmt.<span class="function">Errorf</span>(<span class="string">"service not found"</span>)
    }
    
    <span class="keyword">return</span> string(resp.Kvs[<span class="number">0</span>].Value), <span class="keyword">nil</span>
}</code></pre>
            
            <h3>配置管理</h3>
            <pre><code><span class="comment">// 监听配置变化</span>
<span class="function">func</span> <span class="function">watchConfig</span>(cli *clientv3.Client, key <span class="keyword">string</span>) {
    watchChan := cli.<span class="function">Watch</span>(context.<span class="function">Background</span>(), key)
    <span class="keyword">for</span> watchResp := <span class="keyword">range</span> watchChan {
        <span class="keyword">for</span> _, event := <span class="keyword">range</span> watchResp.Events {
            <span class="keyword">switch</span> event.Type {
            <span class="keyword">case</span> clientv3.EventTypePut:
                fmt.<span class="function">Printf</span>(<span class="string">"Config updated: %s\n"</span>, event.Kv.Value)
                <span class="comment">// 重新加载配置</span>
            <span class="keyword">case</span> clientv3.EventTypeDelete:
                fmt.<span class="function">Println</span>(<span class="string">"Config deleted"</span>)
            }
        }
    }
}

<span class="comment">// 获取配置</span>
<span class="function">func</span> <span class="function">getConfig</span>(cli *clientv3.Client, key <span class="keyword">string</span>) (<span class="keyword">string</span>, error) {
    resp, err := cli.<span class="function">Get</span>(context.<span class="function">Background</span>(), key)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="string">""</span>, err
    }
    
    <span class="keyword">if</span> <span class="function">len</span>(resp.Kvs) == <span class="number">0</span> {
        <span class="keyword">return</span> <span class="string">""</span>, fmt.<span class="function">Errorf</span>(<span class="string">"config not found"</span>)
    }
    
    <span class="keyword">return</span> string(resp.Kvs[<span class="number">0</span>].Value), <span class="keyword">nil</span>
}</code></pre>
            
            <h2 id="bestpractices">最佳实践</h2>
            
            <h3>Validator 最佳实践</h3>
            <div class="note-box">
                <h4>1. 统一错误处理</h4>
                <pre><code><span class="keyword">type</span> ValidationError <span class="keyword">struct</span> {
    Field   <span class="keyword">string</span> <span class="string">`json:"field"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">HandleValidationError</span>(err <span class="keyword">error</span>) []ValidationError {
    <span class="keyword">var</span> errors []ValidationError
    validationErrors := err.(validator.ValidationErrors)
    <span class="keyword">for</span>, e := <span class="keyword">range</span> validationErrors {
        errors = <span class="function">append</span>(errors, ValidationError{
            Field:   e.<span class="function">Field</span>(),
            Message: <span class="function">getErrorMessage</span>(e),
        })
    }
    <span class="keyword">return</span> errors
}</code></pre>
                
                <h4>2. 自定义校验规则</h4>
                <pre><code><span class="comment">// 业务相关的自定义校验</span>
<span class="function">func</span> <span class="function">validateBusinessRule</span>(fl validator.FieldLevel) <span class="keyword">bool</span> {
    <span class="comment">// 实现业务规则校验</span>
    <span class="keyword">return</span> <span class="keyword">true</span>
}</code></pre>
                
                <h4>3. 分层校验</h4>
                <pre><code><span class="comment">// Controller 层：格式校验</span>
<span class="keyword">if</span> err := c.<span class="function">ShouldBindJSON</span>(&req); err != <span class="keyword">nil</span> {
    <span class="keyword">return</span> err
}

<span class="comment">// Service 层：业务校验</span>
<span class="keyword">if</span> err := s.<span class="function">ValidateBusiness</span>(&req); err != <span class="keyword">nil</span> {
    <span class="keyword">return</span> err
}</code></pre>
            </div>
            
            <h3>Cobra 最佳实践</h3>
            <div class="note-box">
                <h4>1. 结构化命令</h4>
                <pre><code><span class="comment">// cmd/root.go</span>
<span class="keyword">package</span> cmd

<span class="keyword">var</span> rootCmd = &cobra.Command{
    Use:   <span class="string">"myapp"</span>,
    Short: <span class="string">"My application"</span>,
}

<span class="function">func</span> <span class="function">Execute</span>() {
    <span class="keyword">if</span> err := rootCmd.<span class="function">Execute</span>(); err != <span class="keyword">nil</span> {
        os.<span class="function">Exit</span>(<span class="number">1</span>)
    }
}

<span class="comment">// cmd/create.go</span>
<span class="keyword">package</span> cmd

<span class="keyword">var</span> createCmd = &cobra.Command{
    Use:   <span class="string">"create"</span>,
    Short: <span class="string">"Create resource"</span>,
}

<span class="function">func</span> <span class="function">init</span>() {
    rootCmd.<span class="function">AddCommand</span>(createCmd)
}</code></pre>
                
                <h4>2. 配置管理</h4>
                <pre><code><span class="comment">// 使用 Viper 管理配置</span>
<span class="keyword">var</span> cfgFile <span class="keyword">string</span>

<span class="function">func</span> <span class="function">init</span>() {
    cobra.<span class="function">OnInitialize</span>(<span class="function">initConfig</span>)
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">StringVar</span>(&cfgFile, <span class="string">"config"</span>, <span class="string">""</span>, <span class="string">"config file"</span>)
}

<span class="function">func</span> <span class="function">initConfig</span>() {
    <span class="keyword">if</span> cfgFile != <span class="string">""</span> {
        viper.<span class="function">SetConfigFile</span>(cfgFile)
    } <span class="keyword">else</span> {
        home, _ := os.<span class="function">UserHomeDir</span>()
        viper.<span class="function">AddConfigPath</span>(home)
        viper.<span class="function">SetConfigName</span>(<span class="string">".myapp"</span>)
    }
    
    viper.<span class="function">ReadInConfig</span>()
}</code></pre>
                
                <h4>3. 生成文档</h4>
                <pre><code><span class="comment">// 自动生成文档</span>
<span class="keyword">go</span> run main.go docs</code></pre>
            </div>
            
            <h3>Go-Micro 最佳实践</h3>
            <div class="note-box">
                <h4>1. 服务拆分</h4>
                <pre><code><span class="comment">// 按业务领域拆分服务</span>
<span class="comment">// - user-service</span>
<span class="comment">// - order-service</span>
<span class="comment">// - payment-service</span></code></pre>
                
                <h4>2. 接口设计</h4>
                <pre><code><span class="comment">// 使用 Protobuf 定义接口</span>
syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> user;

<span class="keyword">service</span> UserService {
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
}</code></pre>
                
                <h4>3. 错误处理</h4>
                <pre><code><span class="comment">// 统一错误处理</span>
<span class="keyword">type</span> ErrorResponse <span class="keyword">struct</span> {
    Code    <span class="keyword">string</span> <span class="string">`json:"code"`</span>
    Message <span class="keyword">string</span> <span class="string">`json:"message"`</span>
}

<span class="function">func</span> <span class="function">HandleError</span>(err <span class="keyword">error</span>) *ErrorResponse {
    <span class="keyword">return</span> &ErrorResponse{
        Code:    <span class="string">"ERROR"</span>,
        Message: err.<span class="function">Error</span>(),
    }
}</code></pre>
            </div>
            
            <h3>Etcd 最佳实践</h3>
            <div class="note-box">
                <h4>1. 键命名规范</h4>
                <pre><code><span class="comment">// 使用层次化的键名</span>
<span class="comment">// /services/user-service/instances/192.168.1.1:8080</span>
<span class="comment">// /config/database/host</span>
<span class="comment">// /locks/resource-123</span></code></pre>
                
                <h4>2. 租约管理</h4>
                <pre><code><span class="comment">// 自动续租</span>
keepAlive, err := cli.<span class="function">KeepAlive</span>(ctx, lease.ID)
<span class="keyword">defer</span> cli.<span class="function">Revoke</span>(ctx, lease.ID)</code></pre>
                
                <h4>3. 事务使用</h4>
                <pre><code><span class="comment">// 使用事务实现原子操作</span>
txn := cli.<span class="function">Txn</span>(ctx)
<span class="comment">// ...</span>
txn.<span class="function">Commit</span>()</code></pre>
                
                <h4>4. 监听机制</h4>
                <pre><code><span class="comment">// 使用监听实现配置热更新</span>
watchChan := cli.<span class="function">Watch</span>(ctx, <span class="string">"/config"</span>, clientv3.<span class="function">WithPrefix</span>())</code></pre>
            </div>
            
            <h3>微服务架构最佳实践</h3>
            <div class="note-box">
                <h4>1. 服务注册与发现</h4>
                <pre><code><span class="comment">// 使用 Etcd 作为注册中心</span>
registry := etcd.<span class="function">NewRegistry</span>(registry.<span class="function">Addrs</span>(<span class="string">"127.0.0.1:2379"</span>))
service := micro.<span class="function">NewService</span>(micro.<span class="function">Registry</span>(registry))</code></pre>
                
                <h4>2. 配置中心</h4>
                <pre><code><span class="comment">// 使用 Etcd 存储配置</span>
cli.<span class="function">Put</span>(ctx, <span class="string">"/config/database/host"</span>, <span class="string">"localhost"</span>)</code></pre>
                
                <h4>3. 分布式锁</h4>
                <pre><code><span class="comment">// 使用 Etcd 实现分布式锁</span>
<span class="function">func</span> <span class="function">acquireLock</span>(cli *clientv3.Client, key <span class="keyword">string</span>) (<span class="keyword">bool</span>, error) {
    <span class="comment">// ...</span>
}</code></pre>
                
                <h4>4. 消息队列</h4>
                <pre><code><span class="comment">// 使用 Go-Micro Broker</span>
micro.<span class="function">RegisterSubscriber</span>(<span class="string">"topic"</span>, service.<span class="function">Server</span>(), handler)</code></pre>
            </div>
            
            
            <h2 id="protobuf">Protobuf 数据序列化</h2>
            <p>Protocol Buffers (Protobuf) 是 Google 开发的一种语言无关、平台无关的序列化结构数据的方法。</p>
            
            <h3>快速开始</h3>
            <pre><code><span class="comment">// 安装 protoc 编译器</span>
<span class="comment">// macOS: brew install protobuf</span>
<span class="comment">// Ubuntu: apt-get install protobuf-compiler</span>

<span class="comment">// 安装 Go 插件</span>
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></pre>
            
            <h3>定义 .proto 文件</h3>
            <pre><code><span class="comment">// user.proto</span>
syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> user;

<span class="keyword">option</span> go_package = <span class="string">"./user"</span>;

<span class="keyword">message</span> User {
    <span class="keyword">int32</span> id = 1;
    <span class="keyword">string</span> name = 2;
    <span class="keyword">string</span> email = 3;
    <span class="keyword">repeated</span> <span class="keyword">string</span> tags = 4;
    <span class="keyword">enum</span> Status {
        UNKNOWN = 0;
        ACTIVE = 1;
        INACTIVE = 2;
    }
    Status status = 5;
}

<span class="keyword">message</span> GetUserRequest {
    <span class="keyword">int32</span> id = 1;
}

<span class="keyword">message</span> GetUserResponse {
    User user = 1;
}</code></pre>
            
            <h3>生成 Go 代码</h3>
            <pre><code><span class="comment">// 生成代码</span>
protoc --go_out=. --go_opt=paths=source_relative \
       --go-grpc_out=. --go-grpc_opt=paths=source_relative \
       user.proto</code></pre>
            
            <h3>序列化和反序列化</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"google.golang.org/protobuf/proto"</span>
    <span class="string">"path/to/user"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建消息</span>
    u := &user.User{
        Id:    1,
        Name:  <span class="string">"张三"</span>,
        Email: <span class="string">"zhangsan@example.com"</span>,
        Tags:  []<span class="keyword">string</span>{<span class="string">"admin"</span>, <span class="string">"user"</span>},
        Status: user.User_ACTIVE,
    }
    
    <span class="comment">// 序列化</span>
    data, err := proto.<span class="function">Marshal</span>(u)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"序列化结果: %x\n"</span>, data)
    
    <span class="comment">// 反序列化</span>
    <span class="keyword">var</span> u2 user.User
    err = proto.<span class="function">Unmarshal</span>(data, &u2)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"反序列化结果: %+v\n"</span>, u2)
}</code></pre>
            
            <h3>Protobuf 最佳实践</h3>
            <div class="note-box">
                <h4>1. 字段编号规范</h4>
                <pre><code><span class="comment">// 1-15: 单字节编码，常用字段</span>
<span class="comment">// 16-2047: 两字节编码，不常用字段</span>
<span class="comment">// 保留字段编号：19000-19999</span>

<span class="keyword">message</span> User {
    <span class="keyword">string</span> name = 1;   <span class="comment">// 常用字段</span>
    <span class="keyword">string</span> email = 2;  <span class="comment">// 常用字段</span>
    <span class="keyword">string</span> phone = 16; <span class="comment">// 不常用字段</span>
}</code></pre>
                
                <h4>2. 使用 oneof</h4>
                <pre><code><span class="keyword">message</span> Result {
    <span class="keyword">oneof</span> result {
        <span class="keyword">string</span> error = 1;
        <span class="keyword">string</span> data = 2;
    }
}</code></pre>
                
                <h4>3. 使用 map</h4>
                <pre><code><span class="keyword">message</span> User {
    <span class="keyword">map</span>&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; metadata = 10;
}</code></pre>
                
                <h4>4. 版本兼容性</h4>
                <pre><code><span class="comment">// 新增字段时使用 optional</span>
<span class="keyword">message</span> User {
    <span class="keyword">string</span> name = 1;
    <span class="keyword">optional</span> <span class="keyword">string</span> nickname = 10; <span class="comment">// 新增字段</span>
}

<span class="comment">// 保留废弃字段</span>
<span class="keyword">message</span> User {
    <span class="keyword">int32</span> old_id = 1 [deprecated = <span class="keyword">true</span>];
    <span class="keyword">string</span> new_id = 2;
}</code></pre>
            </div>

            <h2 id="sonic">Sonic JSON</h2>
            <p>Sonic 是字节跳动开源的高性能 JSON 库，基于 SIMD 指令集优化，在 Go 语言中提供了比标准库 `encoding/json` 更快的 JSON 序列化和反序列化性能。它完全兼容标准库 API，可以作为标准库的替代品使用。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>极致性能</strong>：基于 SIMD 指令集优化，序列化和反序列化性能比标准库快 2-10 倍</li>
                <li><strong>完全兼容</strong>：100% 兼容标准库 `encoding/json` 的 API，无需修改现有代码</li>
                <li><strong>零依赖</strong>：纯 Go 实现，无 CGO 依赖，跨平台支持</li>
                <li><strong>内存安全</strong>：使用安全的内存管理，避免内存泄漏</li>
                <li><strong>类型推断</strong>：支持自动类型推断，减少代码量</li>
            </ul>
            
            <h3>性能对比</h3>
            <div class="example-box">
                <p>与标准库和其他 JSON 库的性能对比（数据来源：Sonic 官方基准测试）：</p>
                <table>
                    <tr>
                        <th>库</th>
                        <th>序列化</th>
                        <th>反序列化</th>
                    </tr>
                    <tr>
                        <td>encoding/json</td>
                        <td>1x (基准)</td>
                        <td>1x (基准)</td>
                    </tr>
                    <tr>
                        <td>json-iterator/go</td>
                        <td>1.5x</td>
                        <td>1.8x</td>
                    </tr>
                    <tr>
                        <td>easyjson</td>
                        <td>2.5x</td>
                        <td>3.0x</td>
                    </tr>
                    <tr>
                        <td><strong>sonic</strong></td>
                        <td><strong>3.5x</strong></td>
                        <td><strong>4.2x</strong></td>
                    </tr>
                </table>
            </div>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u github.com/bytedance/sonic</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/bytedance/sonic"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID    <span class="keyword">int</span>    <span class="string">`json:"id"`</span>
    Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span>
    Email <span class="keyword">string</span> <span class="string">`json:"email"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 序列化</span>
    user := User{ID: 1, Name: <span class="string">"Alice"</span>, Email: <span class="string">"alice@example.com"</span>}
    data, err := sonic.<span class="function">Marshal</span>(user)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Println</span>(<span class="keyword">string</span>(data))
    <span class="comment">// 输出: {"id":1,"name":"Alice","email":"alice@example.com"}</span>
    
    <span class="comment">// 反序列化</span>
    <span class="keyword">var</span> decoded User
    err = sonic.<span class="function">Unmarshal</span>(data, &decoded)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"%+v\n"</span>, decoded)
    <span class="comment">// 输出: {ID:1 Name:Alice Email:alice@example.com}</span>
}</code></pre>
            
            <h3>高级用法</h3>
            
            <h4>1. 使用配置选项</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/bytedance/sonic"</span>
    <span class="string">"github.com/bytedance/sonic/option"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建自定义配置</span>
    cfg := sonic.<span class="function">Config</span>{
        EscapeHTML: <span class="keyword">false</span>,
        SortKeys:   <span class="keyword">true</span>,
    }
    
    api := sonic.<span class="function">ConfigStd</span>(cfg)
    
    user := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{
        <span class="string">"name"</span>:  <span class="string">"Bob"</span>,
        <span class="string">"email"</span>: <span class="string">"bob@example.com"</span>,
    }
    
    data, _ := api.<span class="function">Marshal</span>(user)
    fmt.<span class="function">Println</span>(<span class="keyword">string</span>(data))
}</code></pre>
            
            <h4>2. 流式处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"bytes"</span>
    <span class="string">"fmt"</span>
    <span class="string">"github.com/bytedance/sonic"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 使用 Encoder 进行流式序列化</span>
    <span class="keyword">var</span> buf bytes.Buffer
    encoder := sonic.<span class="function">ConfigDefault</span>().<span class="function">NewEncoder</span>(&buf)
    
    users := []<span class="keyword">string</span>{<span class="string">"Alice"</span>, <span class="string">"Bob"</span>, <span class="string">"Charlie"</span>}
    <span class="keyword">for</span> _, name := <span class="keyword">range</span> users {
        encoder.<span class="function">Encode</span>(name)
    }
    
    fmt.<span class="function">Println</span>(buf.<span class="function">String</span>())
}</code></pre>
            
            <h4>3. 使用 Node API 处理动态 JSON</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/bytedance/sonic"</span>
    <span class="string">"github.com/bytedance/sonic/ast"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    jsonStr := <span class="string">`{"name":"Alice","age":30,"email":"alice@example.com"}`</span>
    
    <span class="comment">// 解析为 Node</span>
    node, err := ast.<span class="function">NewNode</span>(jsonStr)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    
    <span class="comment">// 访问字段</span>
    name, _ := node.<span class="function">GetByPath</span>(<span class="string">"name"</span>).<span class="function">String</span>()
    age, _ := node.<span class="function">GetByPath</span>(<span class="string">"age"</span>).<span class="function">Int64</span>()
    
    fmt.<span class="function">Printf</span>(<span class="string">"Name: %s, Age: %d\n"</span>, name, age)
    
    <span class="comment">// 修改字段</span>
    node.<span class="function">SetByPath</span>(<span class="string">"age"</span>, 31)
    
    <span class="comment">// 转换回 JSON</span>
    modified, _ := node.<span class="function">MarshalJSON</span>()
    fmt.<span class="function">Println</span>(<span class="keyword">string</span>(modified))
}</code></pre>
            
            <h4>4. 与 HTTP 服务器集成</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json"</span>
    <span class="string">"net/http"</span>
    <span class="string">"github.com/bytedance/sonic"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID   <span class="keyword">int</span>    <span class="string">`json:"id"`</span>
    Name <span class="keyword">string</span> <span class="string">`json:"name"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    http.<span class="function">HandleFunc</span>(<span class="string">"/user"</span>, <span class="keyword">func</span>(w http.ResponseWriter, r *http.Request) {
        <span class="keyword">if</span> r.Method == <span class="string">"POST"</span> {
            <span class="keyword">var</span> user User
            <span class="comment">// 使用 Sonic 解析 JSON</span>
            err := sonic.<span class="function">Unmarshal</span>([]<span class="keyword">byte</span>(r.FormValue(<span class="string">"data"</span>)), &user)
            <span class="keyword">if</span> err != <span class="keyword">nil</span> {
                http.<span class="function">Error</span>(w, err.<span class="function">Error</span>(), http.StatusBadRequest)
                <span class="keyword">return</span>
            }
            
            <span class="comment">// 使用 Sonic 序列化响应</span>
            data, _ := sonic.<span class="function">Marshal</span>(user)
            w.<span class="function">Header</span>().<span class="function">Set</span>(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)
            w.<span class="function">Write</span>(data)
        }
    })
    
    http.<span class="function">ListenAndServe</span>(<span class="string">":8080"</span>, <span class="keyword">nil</span>)
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 性能优化</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/bytedance/sonic"</span>
    <span class="string">"github.com/bytedance/sonic/option"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 使用预编译的 API 提升性能</span>
    api := sonic.<span class="function">ConfigFastest</span>()
    
    <span class="comment">// 对于频繁使用的类型，使用预编译</span>
    type User <span class="keyword">struct</span> {
        Name <span class="keyword">string</span> <span class="string">`json:"name"`</span>
        Age  <span class="keyword">int</span>    <span class="string">`json:"age"`</span>
    }
    
    <span class="comment">// 预编译类型的序列化器</span>
    marshaler, _ := api.<span class="function">NewMarshaler</span>(User{})
    
    user := User{Name: <span class="string">"Alice"</span>, Age: 30}
    data, _ := marshaler.<span class="function">Marshal</span>(user)
}</code></pre>
            
            <h4>2. 错误处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/bytedance/sonic"</span>
)

<span class="function">func</span> <span class="function">safeUnmarshal</span>(data []<span class="keyword">byte</span>, v <span class="keyword">interface</span>{}) <span class="keyword">error</span> {
    <span class="keyword">if</span> err := sonic.<span class="function">Unmarshal</span>(data, v); err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"JSON 解析失败: %w"</span>, err)
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">safeMarshal</span>(v <span class="keyword">interface</span>{}) ([]<span class="keyword">byte</span>, <span class="keyword">error</span>) {
    data, err := sonic.<span class="function">Marshal</span>(v)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">nil</span>, fmt.<span class="function">Errorf</span>(<span class="string">"JSON 序列化失败: %w"</span>, err)
    }
    <span class="keyword">return</span> data, <span class="keyword">nil</span>
}</code></pre>
            
            <h4>3. 兼容性处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json"</span>
    <span class="string">"github.com/bytedance/sonic"</span>
)

<span class="keyword">type</span> JSONMarshaler <span class="keyword">interface</span> {
    <span class="function">MarshalJSON</span>() ([]<span class="keyword">byte</span>, <span class="keyword">error</span>)
}

<span class="keyword">type</span> JSONUnmarshaler <span class="keyword">interface</span> {
    <span class="function">UnmarshalJSON</span>([]<span class="keyword">byte</span>) <span class="keyword">error</span>
}

<span class="comment">// Sonic 完全支持标准库的 MarshalJSON 和 UnmarshalJSON 接口</span>
<span class="keyword">type</span> CustomType <span class="keyword">struct</span> {
    Value <span class="keyword">string</span>
}

<span class="function">func</span> (c *CustomType) <span class="function">MarshalJSON</span>() ([]<span class="keyword">byte</span>, <span class="keyword">error</span>) {
    <span class="keyword">return</span> json.<span class="function">Marshal</span>(c.Value)
}

<span class="function">func</span> (c *CustomType) <span class="function">UnmarshalJSON</span>(data []<span class="keyword">byte</span>) <span class="keyword">error</span> {
    <span class="keyword">return</span> json.<span class="function">Unmarshal</span>(data, &c.Value)
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>高性能 API 服务</strong>：需要处理大量 JSON 请求和响应的 Web 服务</li>
                <li><strong>微服务架构</strong>：服务间通信使用 JSON 协议的场景</li>
                <li><strong>数据处理管道</strong>：需要快速解析和生成 JSON 数据的数据处理流程</li>
                <li><strong>实时系统</strong>：对性能要求极高的实时数据处理系统</li>
                <li><strong>大数据处理</strong>：需要处理海量 JSON 数据的大数据应用</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>Sonic 在某些特殊情况下可能与标准库的行为有细微差异</li>
                <li>对于非常复杂的嵌套结构，建议进行充分的测试</li>
                <li>在生产环境使用前，建议进行性能基准测试</li>
                <li>Sonic 需要 Go 1.16+ 版本支持</li>
            </ul>
            </div>

            <h2 id="gocsv">GoCarina/gocsv</h2>
            <p>gocsv 是一个功能强大且易于使用的 Go 语言 CSV 文件读写库，由 GoCarina 开发。它提供了简洁的 API，支持将 CSV 文件与 Go 结构体进行自动映射，大大简化了 CSV 文件的处理工作。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>自动映射</strong>：通过结构体标签自动映射 CSV 列到结构体字段</li>
                <li><strong>高性能</strong>：优化的读写性能，适合处理大型 CSV 文件</li>
                <li><strong>灵活配置</strong>：支持自定义分隔符、引号字符、注释等</li>
                <li><strong>流式处理</strong>：支持流式读写，内存占用低</li>
                <li><strong>类型转换</strong>：自动处理基本类型和自定义类型的转换</li>
                <li><strong>错误处理</strong>：详细的错误信息和行号追踪</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/gocarina/gocsv</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/csv"</span>
    <span class="string">"fmt"</span>
    <span class="string">"os"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="keyword">type</span> Client <span class="keyword">struct</span> {
    Id      <span class="keyword">string</span> <span class="string">`csv:"id"`</span>
    Name    <span class="string">`csv:"name"`</span>
    Age     <span class="keyword">int</span>    <span class="string">`csv:"age"`</span>
    Country <span class="keyword">string</span> <span class="string">`csv:"country"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    clients := []Client{
        {Id: <span class="string">"1"</span>, Name: <span class="string">"Alice"</span>, Age: 30, Country: <span class="string">"USA"</span>},
        {Id: <span class="string">"2"</span>, Name: <span class="string">"Bob"</span>, Age: 25, Country: <span class="string">"UK"</span>},
        {Id: <span class="string">"3"</span>, Name: <span class="string">"Charlie"</span>, Age: 35, Country: <span class="string">"Canada"</span>},
    }
    
    <span class="comment">// 写入 CSV 文件</span>
    file, _ := os.<span class="function">OpenFile</span>(<span class="string">"clients.csv"</span>, os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0755)
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    gocsv.<span class="function">MarshalFile</span>(&clients, file)
    
    <span class="comment">// 读取 CSV 文件</span>
    clientsFile, _ := os.<span class="function">OpenFile</span>(<span class="string">"clients.csv"</span>, os.O_RDWR|os.O_CREATE, 0755)
    <span class="keyword">defer</span> clientsFile.<span class="function">Close</span>()
    
    <span class="keyword">var</span> clientsRead []Client
    gocsv.<span class="function">UnmarshalFile</span>(clientsFile, &clientsRead)
    
    fmt.<span class="function">Printf</span>(<span class="string">"%+v\n"</span>, clientsRead)
}</code></pre>
            
            <h3>高级用法</h3>
            
            <h4>1. 自定义分隔符和配置</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 使用分号作为分隔符</span>
    gocsv.<span class="function">SetCSVReader</span>(gocsv.<span class="function">CustomReader</span>{
        Separator: <span class="string">';'</span>,
    })
    
    <span class="comment">// 使用分号作为分隔符写入</span>
    gocsv.<span class="function">SetCSVWriter</span>(gocsv.<span class="function">CustomWriter</span>{
        Separator: <span class="string">';'</span>,
    })
}</code></pre>
            
            <h4>2. 处理带标题的 CSV</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"os"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="keyword">type</span> Product <span class="keyword">struct</span> {
    SKU      <span class="keyword">string</span>  <span class="string">`csv:"SKU"`</span>
    Name     <span class="keyword">string</span>  <span class="string">`csv:"Product Name"`</span>
    Price    <span class="keyword">float64</span> <span class="string">`csv:"Price"`</span>
    Quantity <span class="keyword">int</span>     <span class="string">`csv:"Quantity"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    file, _ := os.<span class="function">Open</span>(<span class="string">"products.csv"</span>)
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    <span class="keyword">var</span> products []Product
    gocsv.<span class="function">UnmarshalFile</span>(file, &products)
    
    fmt.<span class="function">Printf</span>(<span class="string">"读取到 %d 个产品\n"</span>, <span class="function">len</span>(products))
}</code></pre>
            
            <h4>3. 流式读取大型 CSV 文件</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"os"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="keyword">type</span> LogEntry <span class="keyword">struct</span> {
    Timestamp <span class="keyword">string</span> <span class="string">`csv:"timestamp"`</span>
    Level     <span class="keyword">string</span> <span class="string">`csv:"level"`</span>
    Message   <span class="keyword">string</span> <span class="string">`csv:"message"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    file, _ := os.<span class="function">Open</span>(<span class="string">"large_logs.csv"</span>)
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    <span class="comment">// 流式读取，逐行处理</span>
    reader := gocsv.<span class="function">NewDecoder</span>(file)
    
    <span class="keyword">for</span> {
        <span class="keyword">var</span> entry LogEntry
        err := reader.<span class="function">Decode</span>(&entry)
        <span class="keyword">if</span> err == io.EOF {
            <span class="keyword">break</span>
        }
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            fmt.<span class="function">Printf</span>(<span class="string">"解析错误: %v\n"</span>, err)
            <span class="keyword">continue</span>
        }
        
        <span class="comment">// 处理每行数据</span>
        fmt.<span class="function">Printf</span>(<span class="string">"[%s] %s: %s\n"</span>, entry.Timestamp, entry.Level, entry.Message)
    }
}</code></pre>
            
            <h4>4. 处理嵌套结构</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="keyword">type</span> Address <span class="keyword">struct</span> {
    Street  <span class="keyword">string</span> <span class="string">`csv:"street"`</span>
    City    <span class="keyword">string</span> <span class="string">`csv:"city"`</span>
    Country <span class="keyword">string</span> <span class="string">`csv:"country"`</span>
}

<span class="keyword">type</span> Person <span class="keyword">struct</span> {
    Name    <span class="keyword">string</span>  <span class="string">`csv:"name"`</span>
    Age     <span class="keyword">int</span>     <span class="string">`csv:"age"`</span>
    Address Address  <span class="string">`csv:"address"`</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// gocsv 支持嵌套结构</span>
    csvData := <span class="string">`name,age,street,city,country
Alice,30,123 Main St,New York,USA
Bob,25,456 Oak Ave,London,UK`</span>
    
    <span class="keyword">var</span> people []Person
    gocsv.<span class="function">Unmarshal</span>([]<span class="keyword">byte</span>(csvData), &people)
    
    fmt.<span class="function">Printf</span>(<span class="string">"%+v\n"</span>, people)
}</code></pre>
            
            <h4>5. 自定义类型转换</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="keyword">type</span> Transaction <span class="keyword">struct</span> {
    ID        <span class="keyword">string</span>    <span class="string">`csv:"id"`</span>
    Amount    <span class="keyword">float64</span>   <span class="string">`csv:"amount"`</span>
    Date      <span class="keyword">string</span>    <span class="string">`csv:"date"`</span>
    DateParsed time.Time  <span class="string">`csv:"-"`</span> <span class="comment">// 不从 CSV 读取</span>
}

<span class="function">func</span> (t *Transaction) <span class="function">UnmarshalCSV</span>(csv <span class="keyword">string</span>) <span class="keyword">error</span> {
    <span class="comment">// 自定义解析逻辑</span>
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> (t *Transaction) <span class="function">MarshalCSV</span>() (<span class="keyword">string</span>, <span class="keyword">error</span>) {
    <span class="comment">// 自定义序列化逻辑</span>
    <span class="keyword">return</span> <span class="string">""</span>, <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 使用自定义类型转换</span>
    transactions := []Transaction{
        {ID: <span class="string">"1"</span>, Amount: 100.50, Date: <span class="string">"2024-01-15"</span>},
    }
    
    csvData, _ := gocsv.<span class="function">MarshalString</span>(&transactions)
    fmt.<span class="function">Println</span>(csvData)
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 错误处理和验证</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"os"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="keyword">type</span> ValidatedRecord <span class="keyword">struct</span> {
    Email <span class="keyword">string</span> <span class="string">`csv:"email" validate:"required,email"`</span>
    Phone <span class="keyword">string</span> <span class="string">`csv:"phone" validate:"required"`</span>
}

<span class="function">func</span> <span class="function">validateRecord</span>(record ValidatedRecord) <span class="keyword">error</span> {
    <span class="keyword">if</span> record.Email == <span class="string">""</span> {
        <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"邮箱不能为空"</span>)
    }
    <span class="comment">// 更多验证逻辑...</span>
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    file, _ := os.<span class="function">Open</span>(<span class="string">"data.csv"</span>)
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    <span class="keyword">var</span> records []ValidatedRecord
    <span class="keyword">if</span> err := gocsv.<span class="function">UnmarshalFile</span>(file, &records); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Printf</span>(<span class="string">"CSV 解析失败: %v\n"</span>, err)
        <span class="keyword">return</span>
    }
    
    <span class="comment">// 验证每条记录</span>
    <span class="keyword">for</span> i, record := <span class="keyword">range</span> records {
        <span class="keyword">if</span> err := <span class="function">validateRecord</span>(record); err != <span class="keyword">nil</span> {
            fmt.<span class="function">Printf</span>(<span class="string">"第 %d 行验证失败: %v\n"</span>, i+1, err)
        }
    }
}</code></pre>
            
            <h4>2. 性能优化</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"bufio"</span>
    <span class="string">"os"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="function">func</span> <span class="function">processLargeCSV</span>(filePath <span class="keyword">string</span>) <span class="keyword">error</span> {
    <span class="comment">// 使用缓冲读取提升性能</span>
    file, err := os.<span class="function">Open</span>(filePath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    <span class="comment">// 使用 bufio 包装文件</span>
    bufferedFile := bufio.<span class="function">NewReader</span>(file)
    
    <span class="comment">// 流式处理，避免内存溢出</span>
    reader := gocsv.<span class="function">NewDecoder</span>(bufferedFile)
    
    <span class="keyword">for</span> {
        <span class="keyword">var</span> record <span class="keyword">interface</span>{}
        err := reader.<span class="function">Decode</span>(&record)
        <span class="keyword">if</span> err == io.EOF {
            <span class="keyword">break</span>
        }
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            <span class="keyword">continue</span>
        }
        
        <span class="comment">// 处理记录</span>
    }
    
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h4>3. 处理特殊字符和转义</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 配置处理包含特殊字符的字段</span>
    gocsv.<span class="function">SetCSVReader</span>(gocsv.<span class="function">CustomReader</span>{
        LazyQuotes:    <span class="keyword">true</span>,  <span class="comment">// 宽松的引号处理</span>
        TrimLeadingSpace: <span class="keyword">true</span>,  <span class="comment">// 去除前导空格</span>
        ReuseRecord:    <span class="keyword">true</span>,  <span class="comment">// 重用记录以减少内存分配</span>
    })
    
    <span class="comment">// 处理包含逗号、引号、换行符的字段</span>
    data := <span class="keyword">struct</span> {
        Name    <span class="keyword">string</span> <span class="string">`csv:"name"`</span>
        Comment <span class="keyword">string</span> <span class="string">`csv:"comment"`</span>
    }{
        Name:    <span class="string">"Alice, Bob"</span>,
        Comment: <span class="string">"This is a \"quoted\" string"</span>,
    }
}</code></pre>
            
            <h4>4. 批量处理和并发</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"sync"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="function">func</span> <span class="function">processBatch</span>(records []<span class="keyword">interface</span>{}) {
    <span class="comment">// 使用 worker pool 并发处理</span>
    <span class="keyword">var</span> wg sync.WaitGroup
    workerCount := 10
    
    recordChan := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>{}, workerCount*2)
    
    <span class="comment">// 启动 workers</span>
    <span class="keyword">for</span> i := 0; i < workerCount; i++ {
        wg.<span class="function">Add</span>(1)
        <span class="keyword">go</span> <span class="function">worker</span>(recordChan, &wg)
    }
    
    <span class="comment">// 发送记录</span>
    <span class="keyword">for</span> _, record := <span class="keyword">range</span> records {
        recordChan <- record
    }
    
    <span class="function">close</span>(recordChan)
    wg.<span class="function">Wait</span>()
}

<span class="function">func</span> <span class="function">worker</span>(recordChan <span class="keyword">chan</span> <span class="keyword">interface</span>{}, wg *sync.WaitGroup) {
    <span class="keyword">defer</span> wg.<span class="function">Done</span>()
    <span class="keyword">for</span> record := <span class="keyword">range</span> recordChan {
        <span class="comment">// 处理记录</span>
        _ = record
    }
}</code></pre>
            
            <h4>5. 与数据库集成</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"database/sql"</span>
    <span class="string">"fmt"</span>
    <span class="string">"os"</span>
    <span class="string">"_ github.com/go-sql-driver/mysql"</span>
    <span class="string">"github.com/gocarina/gocsv"</span>
)

<span class="keyword">type</span> Customer <span class="keyword">struct</span> {
    ID   <span class="keyword">int</span>    <span class="string">`csv:"id" db:"id"`</span>
    Name <span class="keyword">string</span> <span class="string">`csv:"name" db:"name"`</span>
    Email <span class="keyword">string</span> <span class="string">`csv:"email" db:"email"`</span>
}

<span class="function">func</span> <span class="function">importCSVToDatabase</span>(csvPath <span class="keyword">string</span>, db *sql.DB) <span class="keyword">error</span> {
    <span class="comment">// 从 CSV 读取数据</span>
    file, err := os.<span class="function">Open</span>(csvPath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    <span class="keyword">var</span> customers []Customer
    <span class="keyword">if</span> err := gocsv.<span class="function">UnmarshalFile</span>(file, &customers); err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="comment">// 批量插入数据库</span>
    stmt, err := db.<span class="function">Prepare</span>(<span class="string">"INSERT INTO customers (name, email) VALUES (?, ?)"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> stmt.<span class="function">Close</span>()
    
    <span class="keyword">for</span> _, customer := <span class="keyword">range</span> customers {
        _, err := stmt.<span class="function">Exec</span>(customer.Name, customer.Email)
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            fmt.<span class="function">Printf</span>(<span class="string">"插入失败: %v\n"</span>, err)
        }
    }
    
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">exportDatabaseToCSV</span>(db *sql.DB, csvPath <span class="keyword">string</span>) <span class="keyword">error</span> {
    <span class="comment">// 从数据库查询数据</span>
    rows, err := db.<span class="function">Query</span>(<span class="string">"SELECT id, name, email FROM customers"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> rows.<span class="function">Close</span>()
    
    <span class="keyword">var</span> customers []Customer
    <span class="keyword">for</span> rows.<span class="function">Next</span>() {
        <span class="keyword">var</span> customer Customer
        err := rows.<span class="function">Scan</span>(&customer.ID, &customer.Name, &customer.Email)
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            <span class="keyword">continue</span>
        }
        customers = <span class="function">append</span>(customers, customer)
    }
    
    <span class="comment">// 写入 CSV 文件</span>
    file, err := os.<span class="function">Create</span>(csvPath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> file.<span class="function">Close</span>()
    
    <span class="keyword">return</span> gocsv.<span class="function">MarshalFile</span>(&customers, file)
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>数据导入导出</strong>：将数据库数据导出为 CSV 或从 CSV 导入数据</li>
                <li><strong>数据迁移</strong>：在不同系统之间迁移数据</li>
                <li><strong>日志分析</strong>：处理和分析 CSV 格式的日志文件</li>
                <li><strong>报表生成</strong>：生成 CSV 格式的业务报表</li>
                <li><strong>数据交换</strong>：与外部系统进行数据交换</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>处理大型 CSV 文件时，建议使用流式处理避免内存溢出</li>
                <li>注意处理 CSV 文件中的特殊字符（逗号、引号、换行符等）</li>
                <li>建议对数据进行验证，确保数据质量</li>
                <li>处理日期时间等特殊类型时，需要自定义类型转换逻辑</li>
                <li>在并发环境中使用时，注意线程安全问题</li>
            </ul>
            </div>

            <h2 id="excelize">Excelize Excel</h2>
            <p>Excelize 是一个用于处理 Microsoft Excel™（.xlsx）文件的 Go 语言库。它提供了丰富的功能来创建、读取、修改和写入 Excel 文件，支持复杂的格式设置、图表、图片、数据透视表等功能，是 Go 生态中最强大的 Excel 处理库之一。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>读写 Excel</strong>：支持读取和写入 .xlsx 格式的 Excel 文件（97-2003 和 2007+）</li>
                <li><strong>格式设置</strong>：支持单元格格式、字体、颜色、边框、对齐方式等</li>
                <li><strong>图表支持</strong>：支持创建柱状图、折线图、饼图等多种图表类型</li>
                <li><strong>图片插入</strong>：支持在 Excel 文件中插入图片和形状</li>
                <li><strong>数据透视</strong>：支持创建和操作数据透视表</li>
                <li><strong>公式计算</strong>：支持 Excel 公式和函数</li>
                <li><strong>流式处理</strong>：支持流式读取大型 Excel 文件，降低内存占用</li>
                <li><strong>模板支持</strong>：支持从模板创建新文件</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/xuri/excelize/v2</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建新的 Excel 文件</span>
    f := excelize.<span class="function">NewFile</span>()
    <span class="keyword">defer</span> <span class="function">func</span>() {
        <span class="keyword">if</span> err := f.<span class="function">Close</span>(); err != <span class="keyword">nil</span> {
            fmt.<span class="function">Println</span>(err)
        }
    }()
    
    <span class="comment">// 设置单元格值</span>
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A1"</span>, <span class="string">"姓名"</span>)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"B1"</span>, <span class="string">"年龄"</span>)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A2"</span>, <span class="string">"Alice"</span>)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"B2"</span>, 30)
    
    <span class="comment">// 保存文件</span>
    <span class="keyword">if</span> err := f.<span class="function">SaveAs</span>(<span class="string">"Book1.xlsx"</span>); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
    }
}</code></pre>
            
            <h3>高级用法</h3>
            
            <h4>1. 读取 Excel 文件</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 打开现有文件</span>
    f, err := excelize.<span class="function">OpenFile</span>(<span class="string">"Book1.xlsx"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
        <span class="keyword">return</span>
    }
    <span class="keyword">defer</span> <span class="function">func</span>() {
        <span class="keyword">if</span> err := f.<span class="function">Close</span>(); err != <span class="keyword">nil</span> {
            fmt.<span class="function">Println</span>(err)
        }
    }()
    
    <span class="comment">// 获取单元格值</span>
    cell, _ := f.<span class="function">GetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A2"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"A2 的值:"</span>, cell)
    
    <span class="comment">// 获取所有行</span>
    rows, _ := f.<span class="function">GetRows</span>(<span class="string">"Sheet1"</span>)
    <span class="keyword">for</span> _, row := <span class="keyword">range</span> rows {
        fmt.<span class="function">Println</span>(row)
    }
}</code></pre>
            
            <h4>2. 单元格格式设置</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    f := excelize.<span class="function">NewFile</span>()
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    <span class="comment">// 设置字体样式</span>
    style, _ := f.<span class="function">NewStyle</span>(&excelize.Style{
        Font: &excelize.Font{
            Bold:   <span class="keyword">true</span>,
            Italic: <span class="keyword">true</span>,
            Family: <span class="string">"Arial"</span>,
            Size:   14,
            Color:  <span class="string">"#FF0000"</span>,
        },
    })
    f.<span class="function">SetCellStyle</span>(<span class="string">"Sheet1"</span>, <span class="string">"A1"</span>, <span class="string">"A1"</span>, style)
    
    <span class="comment">// 设置边框</span>
    borderStyle, _ := f.<span class="function">NewStyle</span>(&excelize.Style{
        Border: []excelize.Border{
            {Type: <span class="string">"left"</span>, Color: <span class="string">"#000000"</span>, Style: 1},
            {Type: <span class="string">"top"</span>, Color: <span class="string">"#000000"</span>, Style: 1},
            {Type: <span class="string">"bottom"</span>, Color: <span class="string">"#000000"</span>, Style: 1},
            {Type: <span class="string">"right"</span>, Color: <span class="string">"#000000"</span>, Style: 1},
        },
    })
    f.<span class="function">SetCellStyle</span>(<span class="string">"Sheet1"</span>, <span class="string">"A1"</span>, <span class="string">"C10"</span>, borderStyle)
    
    <span class="comment">// 设置背景颜色</span>
    fillStyle, _ := f.<span class="function">NewStyle</span>(&excelize.Style{
        Fill: excelize.Fill{
            Type:    <span class="string">"pattern"</span>,
            Color:   []<span class="keyword">string</span>{<span class="string">"#E0E0E0"</span>},
            Pattern: 1,
        },
    })
    f.<span class="function">SetCellStyle</span>(<span class="string">"Sheet1"</span>, <span class="string">"A1"</span>, <span class="string">"A1"</span>, fillStyle)
    
    f.<span class="function">SaveAs</span>(<span class="string">"styled.xlsx"</span>)
}</code></pre>
            
            <h4>3. 创建图表</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    f := excelize.<span class="function">NewFile</span>()
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    <span class="comment">// 添加数据</span>
    <span class="keyword">for</span> i, row := <span class="keyword">range</span> [][]<span class="keyword">interface</span>{}{
        {<span class="string">"产品"</span>, <span class="string">"销售量"</span>},
        {<span class="string">"A"</span>, 100},
        {<span class="string">"B"</span>, 200},
        {<span class="string">"C"</span>, 150},
    } {
        <span class="keyword">for</span> j, cell := <span class="keyword">range</span> row {
            f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, 
                fmt.<span class="function">Sprintf</span>(<span class="string">"%c%d"</span>, <span class="string">'A'</span>+j, i+1), cell)
        }
    }
    
    <span class="comment">// 创建柱状图</span>
    <span class="keyword">if</span> err := f.<span class="function">AddChart</span>(<span class="string">"Sheet1"</span>, <span class="string">"E1"</span>, &excelize.Chart{
        Type: excelize.<span class="function">Col</span>,
        Series: []excelize.ChartSeries{
            {
                Name:       <span class="string">"Sheet1!$B$1"</span>,
                Categories: <span class="string">"Sheet1!$A$2:$A$4"</span>,
                Values:     <span class="string">"Sheet1!$B$2:$B$4"</span>,
            },
        },
        Format: excelize.GraphicOptions{
            ScaleX: 1,
            ScaleY: 1,
        },
        Title: []excelize.ChartTitle{
            {Text: <span class="string">"产品销售量柱状图"</span>},
        },
    }); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
    }
    
    f.<span class="function">SaveAs</span>(<span class="string">"chart.xlsx"</span>)
}</code></pre>
            
            <h4>4. 插入图片</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/xuri/excelize/v2"</span>
    <span class="string">_ "image/jpeg"</span>
    <span class="string">_ "image/png"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    f := excelize.<span class="function">NewFile</span>()
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    <span class="comment">// 插入图片</span>
    <span class="keyword">if</span> err := f.<span class="function">AddPicture</span>(<span class="string">"Sheet1"</span>, <span class="string">"A1"</span>, <span class="string">"image.png"</span>, 
        &excelize.Picture{
            Format:     excelize.<span class="function">PictureType</span>(<span class="string">"image/png"</span>),
            Width:      200,
            Height:     150,
            PrintObj:   <span class="keyword">true</span>,
            LockAspect: <span class="keyword">true</span>,
        }); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
    }
    
    f.<span class="function">SaveAs</span>(<span class="string">"image.xlsx"</span>)
}</code></pre>
            
            <h4>5. 流式读取大型 Excel 文件</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    f, err := excelize.<span class="function">OpenFile</span>(<span class="string">"large_file.xlsx"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
        <span class="keyword">return</span>
    }
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    <span class="comment">// 使用流式读取器</span>
    rows, err := f.<span class="function">Rows</span>(<span class="string">"Sheet1"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(err)
        <span class="keyword">return</span>
    }
    <span class="keyword">defer</span> rows.<span class="function">Close</span>()
    
    <span class="keyword">for</span> rows.<span class="function">Next</span>() {
        row, err := rows.<span class="function">Columns</span>()
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            fmt.<span class="function">Println</span>(err)
            <span class="keyword">continue</span>
        }
        fmt.<span class="function">Println</span>(row)
    }
}</code></pre>
            
            <h4>6. 使用公式和函数</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    f := excelize.<span class="function">NewFile</span>()
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    <span class="comment">// 设置数据</span>
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A1"</span>, 10)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A2"</span>, 20)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A3"</span>, 30)
    
    <span class="comment">// 使用公式</span>
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A4"</span>, <span class="string">"=SUM(A1:A3)"</span>)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A5"</span>, <span class="string">"=AVERAGE(A1:A3)"</span>)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A6"</span>, <span class="string">"=MAX(A1:A3)"</span>)
    f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A7"</span>, <span class="string">"=MIN(A1:A3)"</span>)
    
    <span class="comment">// 计算公式结果</span>
    result, _ := f.<span class="function">GetCellValue</span>(<span class="string">"Sheet1"</span>, <span class="string">"A4"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"SUM 结果:"</span>, result)
    
    f.<span class="function">SaveAs</span>(<span class="string">"formula.xlsx"</span>)
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 内存管理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">processLargeExcel</span>(filePath <span class="keyword">string</span>) <span class="keyword">error</span> {
    <span class="comment">// 使用流式读取避免内存溢出</span>
    f, err := excelize.<span class="function">OpenFile</span>(filePath, excelize.Options{
        Password: <span class="string">""</span>,
    })
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    <span class="comment">// 使用 Rows 流式读取</span>
    rows, err := f.<span class="function">Rows</span>(<span class="string">"Sheet1"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> rows.<span class="function">Close</span>()
    
    <span class="keyword">for</span> rows.<span class="function">Next</span>() {
        row, _ := rows.<span class="function">Columns</span>()
        <span class="comment">// 处理每一行</span>
        _ = row
    }
    
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h4>2. 错误处理和验证</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">safeSetCellValue</span>(f *excelize.File, sheet, cell <span class="keyword">string</span>, value <span class="keyword">interface</span>{}) <span class="keyword">error</span> {
    <span class="keyword">if</span> err := f.<span class="function">SetCellValue</span>(sheet, cell, value); err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"设置单元格 %s 失败: %v"</span>, cell, err)
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">validateCellValue</span>(value <span class="keyword">interface</span>{}) <span class="keyword">error</span> {
    <span class="keyword">switch</span> v := value.(<span class="keyword">type</span>) {
    <span class="keyword">case</span> <span class="keyword">string</span>:
        <span class="keyword">if</span> <span class="function">len</span>(v) > 32767 {
            <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"字符串长度超过 Excel 限制"</span>)
        }
    <span class="keyword">case</span> <span class="keyword">int</span>, <span class="keyword">int64</span>:
        <span class="keyword">if</span> v < -9007199254740992 || v > 9007199254740992 {
            <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"数值超出 Excel 范围"</span>)
        }
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h4>3. 性能优化</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">batchWriteCells</span>(f *excelize.File, sheet <span class="keyword">string</span>, data [][]<span class="keyword">interface</span>{}) <span class="keyword">error</span> {
    <span class="comment">// 批量写入单元格，减少 I/O 操作</span>
    <span class="keyword">for</span> i, row := <span class="keyword">range</span> data {
        <span class="keyword">for</span> j, cell := <span class="keyword">range</span> row {
            cellName, _ := excelize.<span class="function">CoordinatesToCellName</span>(j+1, i+1)
            <span class="keyword">if</span> err := f.<span class="function">SetCellValue</span>(sheet, cellName, cell); err != <span class="keyword">nil</span> {
                <span class="keyword">return</span> err
            }
        }
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">optimizeStyle</span>(f *excelize.File) {
    <span class="comment">// 复用样式对象，减少内存分配</span>
    headerStyle, _ := f.<span class="function">NewStyle</span>(&excelize.Style{
        Font: &excelize.Font{Bold: <span class="keyword">true</span>},
    })
    
    <span class="comment">// 应用样式到多个单元格</span>
    f.<span class="function">SetCellStyle</span>(<span class="string">"Sheet1"</span>, <span class="string">"A1"</span>, <span class="string">"Z1"</span>, headerStyle)
}</code></pre>
            
            <h4>4. 模板处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">generateReportFromTemplate</span>(templatePath, outputPath <span class="keyword">string</span>, data <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}) <span class="keyword">error</span> {
    <span class="comment">// 从模板创建新文件</span>
    f, err := excelize.<span class="function">OpenFile</span>(templatePath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    <span class="comment">// 替换模板中的占位符</span>
    <span class="keyword">for</span> key, value := <span class="keyword">range</span> data {
        f.<span class="function">SetCellValue</span>(<span class="string">"Sheet1"</span>, key, value)
    }
    
    <span class="comment">// 保存为新文件</span>
    <span class="keyword">return</span> f.<span class="function">SaveAs</span>(outputPath)
}</code></pre>
            
            <h4>5. 并发处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"sync"</span>
    <span class="string">"github.com/xuri/excelize/v2"</span>
)

<span class="function">func</span> <span class="function">processMultipleSheets</span>(filePath <span class="keyword">string</span>) <span class="keyword">error</span> {
    f, err := excelize.<span class="function">OpenFile</span>(filePath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> f.<span class="function">Close</span>()
    
    sheets := f.<span class="function">GetSheetList</span>()
    <span class="keyword">var</span> wg sync.WaitGroup
    
    <span class="comment">// 并发处理多个工作表</span>
    <span class="keyword">for</span> _, sheet := <span class="keyword">range</span> sheets {
        wg.<span class="function">Add</span>(1)
        <span class="keyword">go</span> <span class="function">func</span>(s <span class="keyword">string</span>) {
            <span class="keyword">defer</span> wg.<span class="function">Done</span>()
            <span class="comment">// 处理工作表</span>
            _ = s
        }(sheet)
    }
    
    wg.<span class="function">Wait</span>()
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>报表生成</strong>：生成业务报表、财务报表、销售报表等</li>
                <li><strong>数据导出</strong>：将数据库数据导出为 Excel 文件</li>
                <li><strong>数据导入</strong>：从 Excel 文件导入数据到数据库</li>
                <li><strong>数据分析</strong>：读取 Excel 数据进行分析和处理</li>
                <li><strong>模板填充</strong>：基于模板生成标准化文档</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>处理大型 Excel 文件时，建议使用流式读取避免内存溢出</li>
                <li>注意 Excel 的单元格限制（字符串长度 32767 字符，数值范围等）</li>
                <li>样式对象应该复用，避免重复创建</li>
                <li>使用完毕后记得关闭文件，释放资源</li>
                <li>在并发环境中使用时，注意线程安全问题</li>
                <li>公式计算可能需要额外的性能开销</li>
            </ul>
            </div>

            <h2 id="imaging">Imaging 图片处理</h2>
            <p>Imaging 是一个简单而强大的 Go 语言图片处理库，提供了丰富的功能来处理图片，包括缩放、裁剪、旋转、滤镜、颜色调整等。它基于标准库 `image` 和 `image/draw`，易于使用且性能优秀。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>基础操作</strong>：支持图片缩放、裁剪、旋转、翻转等基础操作</li>
                <li><strong>滤镜效果</strong>：提供模糊、锐化、边缘检测等滤镜效果</li>
                <li><strong>颜色调整</strong>：支持亮度、对比度、饱和度、色相调整</li>
                <li><strong>格式支持</strong>：支持 JPEG、PNG、GIF、TIFF、BMP 等常见格式</li>
                <li><strong>高性能</strong>：优化的算法，处理速度快</li>
                <li><strong>简单易用</strong>：简洁的 API 设计，易于集成</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/disintegration/imaging</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log"</span>
    <span class="string">"github.com/disintegration/imaging"</span>
    <span class="string">"image"</span>
    <span class="string">_ "image/jpeg"</span>
    <span class="string">_ "image/png"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 打开图片</span>
    src, err := imaging.<span class="function">Open</span>(<span class="string">"input.jpg"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatal</span>(err)
    }
    <span class="keyword">defer</span> src.<span class="function">Close</span>()
    
    <span class="comment">// 缩放图片</span>
    dst := imaging.<span class="function">Resize</span>(src, 800, 0, imaging.<span class="function">Lanczos</span>)
    
    <span class="comment">// 保存图片</span>
    err = imaging.<span class="function">Save</span>(dst, <span class="string">"output.jpg"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatal</span>(err)
    }
}</code></pre>
            
            <h3>常用功能</h3>
            
            <h4>1. 缩放和裁剪</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/disintegration/imaging"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    src, _ := imaging.<span class="function">Open</span>(<span class="string">"input.jpg"</span>)
    <span class="keyword">defer</span> src.<span class="function">Close</span>()
    
    <span class="comment">// 按宽度缩放，保持宽高比</span>
    resized1 := imaging.<span class="function">Resize</span>(src, 800, 0, imaging.<span class="function">Lanczos</span>)
    
    <span class="comment">// 按高度缩放，保持宽高比</span>
    resized2 := imaging.<span class="function">Resize</span>(src, 0, 600, imaging.<span class="function">Lanczos</span>)
    
    <span class="comment">// 缩放到指定尺寸（可能变形）</span>
    resized3 := imaging.<span class="function">Resize</span>(src, 800, 600, imaging.<span class="function">Lanczos</span>)
    
    <span class="comment">// 裁剪图片</span>
    cropped := imaging.<span class="function">Crop</span>(src, image.Rect(100, 100, 500, 500))
    
    <span class="comment">// 缩略图生成</span>
    thumbnail := imaging.<span class="function">Thumbnail</span>(src, 100, 100, imaging.<span class="function">Lanczos</span>)
    
    imaging.<span class="function">Save</span>(resized1, <span class="string">"resized1.jpg"</span>)
    imaging.<span class="function">Save</span>(cropped, <span class="string">"cropped.jpg"</span>)
    imaging.<span class="function">Save</span>(thumbnail, <span class="string">"thumbnail.jpg"</span>)
}</code></pre>
            
            <h4>2. 旋转和翻转</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/disintegration/imaging"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    src, _ := imaging.<span class="function">Open</span>(<span class="string">"input.jpg"</span>)
    <span class="keyword">defer</span> src.<span class="function">Close</span>()
    
    <span class="comment">// 旋转 90 度</span>
    rotated90 := imaging.<span class="function">Rotate90</span>(src)
    
    <span class="comment">// 旋转 180 度</span>
    rotated180 := imaging.<span class="function">Rotate180</span>(src)
    
    <span class="comment">// 旋转 270 度</span>
    rotated270 := imaging.<span class="function">Rotate270</span>(src)
    
    <span class="comment">// 旋转任意角度</span>
    rotated45 := imaging.<span class="function">Rotate</span>(src, 45, <span class="keyword">nil</span>)
    
    <span class="comment">// 水平翻转</span>
    flippedH := imaging.<span class="function">FlipH</span>(src)
    
    <span class="comment">// 垂直翻转</span>
    flippedV := imaging.<span class="function">FlipV</span>(src)
    
    imaging.<span class="function">Save</span>(rotated90, <span class="string">"rotated90.jpg"</span>)
    imaging.<span class="function">Save</span>(flippedH, <span class="string">"flipped_h.jpg"</span>)
}</code></pre>
            
            <h4>3. 滤镜效果</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/disintegration/imaging"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    src, _ := imaging.<span class="function">Open</span>(<span class="string">"input.jpg"</span>)
    <span class="keyword">defer</span> src.<span class="function">Close</span>()
    
    <span class="comment">// 模糊效果</span>
    blurred := imaging.<span class="function">Blur</span>(src, 5.0)
    
    <span class="comment">// 锐化效果</span>
    sharpened := imaging.<span class="function">Sharpen</span>(src, 2.0)
    
    <span class="comment">// 调整亮度</span>
    brighter := imaging.<span class="function">AdjustBrightness</span>(src, 20)
    darker := imaging.<span class="function">AdjustBrightness</span>(src, -20)
    
    <span class="comment">// 调整对比度</span>
    contrast := imaging.<span class="function">AdjustContrast</span>(src, 20)
    
    <span class="comment">// 调整饱和度</span>
    saturated := imaging.<span class="function">AdjustSaturation</span>(src, 50)
    
    <span class="comment">// 灰度化</span>
    grayscale := imaging.<span class="function">Grayscale</span>(src)
    
    <span class="comment">// 反色</span>
    inverted := imaging.<span class="function">Invert</span>(src)
    
    imaging.<span class="function">Save</span>(blurred, <span class="string">"blurred.jpg"</span>)
    imaging.<span class="function">Save</span>(grayscale, <span class="string">"grayscale.jpg"</span>)
    imaging.<span class="function">Save</span>(inverted, <span class="string">"inverted.jpg"</span>)
}</code></pre>
            
            <h4>4. 图片合成</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/disintegration/imaging"</span>
    <span class="string">"image"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 加载两张图片</span>
    bg, _ := imaging.<span class="function">Open</span>(<span class="string">"background.jpg"</span>)
    <span class="keyword">defer</span> bg.<span class="function">Close</span>()
    
    overlay, _ := imaging.<span class="function">Open</span>(<span class="string">"overlay.png"</span>)
    <span class="keyword">defer</span> overlay.<span class="function">Close</span>()
    
    <span class="comment">// 调整overlay图片大小</span>
    overlay = imaging.<span class="function">Resize</span>(overlay, 200, 0, imaging.<span class="function">Lanczos</span>)
    
    <span class="comment">// 在背景图上绘制overlay</span>
    dst := imaging.<span class="function">Overlay</span>(bg, overlay, image.Pt(100, 100), 1.0)
    
    <span class="comment">// 创建水印效果（半透明）</span>
    watermark := imaging.<span class="function">Overlay</span>(bg, overlay, image.Pt(100, 100), 0.5)
    
    imaging.<span class="function">Save</span>(dst, <span class="string">"overlay.jpg"</span>)
    imaging.<span class="function">Save</span>(watermark, <span class="string">"watermark.jpg"</span>)
}</code></pre>
            
            <h4>5. 批量处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"os"</span>
    <span class="string">"path/filepath"</span>
    <span class="string">"github.com/disintegration/imaging"</span>
)

<span class="function">func</span> <span class="function">batchProcessImages</span>(inputDir, outputDir <span class="keyword">string</span>) <span class="keyword">error</span> {
    <span class="comment">// 遍历输入目录</span>
    err := filepath.<span class="function">Walk</span>(inputDir, <span class="function">func</span>(path <span class="keyword">string</span>, info os.FileInfo, err <span class="keyword">error</span>) <span class="keyword">error</span> {
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            <span class="keyword">return</span> err
        }
        
        <span class="comment">// 跳过目录</span>
        <span class="keyword">if</span> info.<span class="function">IsDir</span>() {
            <span class="keyword">return</span> <span class="keyword">nil</span>
        }
        
        <span class="comment">// 只处理图片文件</span>
        ext := filepath.<span class="function">Ext</span>(path)
        <span class="keyword">if</span> ext != <span class="string">".jpg"</span> && ext != <span class="string">".png"</span> {
            <span class="keyword">return</span> <span class="keyword">nil</span>
        }
        
        <span class="comment">// 打开图片</span>
        src, err := imaging.<span class="function">Open</span>(path)
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            <span class="keyword">return</span> err
        }
        <span class="keyword">defer</span> src.<span class="function">Close</span>()
        
        <span class="comment">// 调整大小</span>
        dst := imaging.<span class="function">Resize</span>(src, 800, 0, imaging.<span class="function">Lanczos</span>)
        
        <span class="comment">// 保存到输出目录</span>
        outputPath := filepath.<span class="function">Join</span>(outputDir, filepath.<span class="function">Base</span>(path))
        <span class="keyword">return</span> imaging.<span class="function">Save</span>(dst, outputPath)
    })
    
    <span class="keyword">return</span> err
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 内存管理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/disintegration/imaging"</span>
)

<span class="function">func</span> <span class="function">processLargeImage</span>(filePath <span class="keyword">string</span>) <span class="keyword">error</span> {
    <span class="comment">// 使用 io.Reader 逐步读取大图片</span>
    src, err := imaging.<span class="function">Open</span>(filePath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> src.<span class="function">Close</span>()
    
    <span class="comment">// 处理完后立即释放资源</span>
    dst := imaging.<span class="function">Resize</span>(src, 800, 0, imaging.<span class="function">Lanczos</span>)
    
    <span class="comment">// 保存后关闭</span>
    err = imaging.<span class="function">Save</span>(dst, <span class="string">"output.jpg"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    <span class="comment">// 显式释放内存</span>
    dst = <span class="keyword">nil</span>
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h4>2. 错误处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/disintegration/imaging"</span>
)

<span class="function">func</span> <span class="function">safeProcessImage</span>(inputPath, outputPath <span class="keyword">string</span>) <span class="keyword">error</span> {
    <span class="comment">// 验证输入文件</span>
    src, err := imaging.<span class="function">Open</span>(inputPath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"无法打开图片 %s: %v"</span>, inputPath, err)
    }
    <span class="keyword">defer</span> src.<span class="function">Close</span>()
    
    <span class="comment">// 验证输出路径</span>
    <span class="keyword">if</span> outputPath == <span class="string">""</span> {
        <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"输出路径不能为空"</span>)
    }
    
    <span class="comment">// 处理图片</span>
    dst := imaging.<span class="function">Resize</span>(src, 800, 0, imaging.<span class="function">Lanczos</span>)
    
    <span class="comment">// 保存并处理错误</span>
    <span class="keyword">if</span> err := imaging.<span class="function">Save</span>(dst, outputPath); err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> fmt.<span class="function">Errorf</span>(<span class="string">"保存图片失败: %v"</span>, err)
    }
    
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h4>3. 性能优化</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/disintegration/imaging"</span>
    <span class="string">"image"</span>
)

<span class="function">func</span> <span class="function">optimizeProcessing</span>(src image.Image) image.Image {
    <span class="comment">// 使用合适的插值算法</span>
    <span class="comment">// Lanczos: 高质量但慢</span>
    <span class="comment">// CatmullRom: 平衡质量和速度</span>
    <span class="comment">// Linear: 快速但质量较低</span>
    
    <span class="comment">// 根据图片大小选择算法</span>
    bounds := src.<span class="function">Bounds</span>()
    <span class="keyword">if</span> bounds.<span class="function">Dx</span>() > 2000 || bounds.<span class="function">Dy</span>() > 2000 {
        <span class="comment">// 大图片使用快速算法</span>
        <span class="keyword">return</span> imaging.<span class="function">Resize</span>(src, 800, 0, imaging.<span class="function">Linear</span>)
    } <span class="keyword">else</span> {
        <span class="comment">// 小图片使用高质量算法</span>
        <span class="keyword">return</span> imaging.<span class="function">Resize</span>(src, 800, 0, imaging.<span class="function">Lanczos</span>)
    }
}</code></pre>
            
            <h4>4. 格式转换</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"path/filepath"</span>
    <span class="string">"github.com/disintegration/imaging"</span>
)

<span class="function">func</span> <span class="function">convertFormat</span>(inputPath, outputFormat <span class="keyword">string</span>) <span class="keyword">error</span> {
    src, err := imaging.<span class="function">Open</span>(inputPath)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">defer</span> src.<span class="function">Close</span>()
    
    <span class="comment">// 构建输出路径</span>
    outputPath := filepath.<span class="function">Join</span>(
        filepath.<span class="function">Dir</span>(inputPath),
        filepath.<span class="function">Base</span>(inputPath[:<span class="function">len</span>(inputPath)-<span class="function">len</span>(filepath.<span class="function">Ext</span>(inputPath))])+<span class="string">"."</span>+outputFormat,
    )
    
    <span class="comment">// 根据格式调整质量</span>
    <span class="keyword">if</span> outputFormat == <span class="string">"jpg"</span> {
        <span class="comment">// JPEG 格式，使用默认质量</span>
        <span class="keyword">return</span> imaging.<span class="function">Save</span>(src, outputPath)
    } <span class="keyword">else if</span> outputFormat == <span class="string">"png"</span> {
        <span class="comment">// PNG 格式，无损压缩</span>
        <span class="keyword">return</span> imaging.<span class="function">Save</span>(src, outputPath)
    }
    
    <span class="keyword">return</span> <span class="keyword">nil</span>
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>图片缩略图</strong>：生成网站或应用的缩略图</li>
                <li><strong>图片压缩</strong>：优化图片大小，节省存储空间</li>
                <li><strong>图片水印</strong>：为图片添加版权水印</li>
                <li><strong>图片编辑</strong>：实现简单的图片编辑功能</li>
                <li><strong>批量处理</strong>：批量处理大量图片文件</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>处理大图片时注意内存使用，及时释放资源</li>
                <li>选择合适的插值算法平衡质量和性能</li>
                <li>JPEG 格式是有损压缩，PNG 是无损压缩</li>
                <li>注意处理透明通道（PNG）</li>
                <li>批量处理时建议使用 goroutine 并发处理</li>
                <li>保存图片时注意选择合适的格式和质量</li>
            </ul>
            </div>

            <h2 id="testify">Testify 测试框架</h2>
            <p>Testify 是一个 Go 语言流行的测试工具包，提供了断言、模拟（Mock）、套件（Suite）等功能，让编写测试更加简单和强大。它提供了丰富的断言方法、模拟对象和测试套件功能，是 Go 测试生态中不可或缺的工具。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>丰富的断言</strong>：提供大量断言方法，简化测试代码</li>
                <li><strong>模拟对象</strong>：支持创建 Mock 对象，便于测试依赖</li>
                <li><strong>测试套件</strong>：支持测试套件和生命周期管理</li>
                <li><strong>HTTP 测试</strong>：提供 HTTP 请求/响应的断言和模拟</li>
                <li><strong>易于集成</strong>：与 Go 标准测试框架无缝集成</li>
                <li><strong>清晰的错误信息</strong>：提供详细的错误报告和堆栈跟踪</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/stretchr/testify</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> math

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestAdd</span>(t *testing.T) {
    result := <span class="function">Add</span>(2, 3)
    assert.<span class="function">Equal</span>(t, 5, result, <span class="string">"2 + 3 应该等于 5"</span>)
}</code></pre>
            
            <h3>常用功能</h3>
            
            <h4>1. 基本断言</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestAssertions</span>(t *testing.T) {
    <span class="comment">// 相等断言</span>
    assert.<span class="function">Equal</span>(t, <span class="string">"hello"</span>, <span class="string">"hello"</span>)
    assert.<span class="function">NotEqual</span>(t, <span class="string">"hello"</span>, <span class="string">"world"</span>)
    
    <span class="comment">// 布尔断言</span>
    assert.<span class="function">True</span>(t, <span class="keyword">true</span>)
    assert.<span class="function">False</span>(t, <span class="keyword">false</span>)
    
    <span class="comment">// 数值断言</span>
    assert.<span class="function">Equal</span>(t, 42, 42)
    assert.<span class="function">NotEqual</span>(t, 42, 43)
    
    <span class="comment">// nil 断言</span>
    <span class="keyword">var</span> ptr *<span class="keyword">int</span>
    assert.<span class="function">Nil</span>(t, ptr)
    assert.<span class="function">NotNil</span>(t, &ptr)
    
    <span class="comment">// 错误断言</span>
    err := <span class="function">someFunction</span>()
    assert.<span class="function">NoError</span>(t, err)
    assert.<span class="function">Error</span>(t, err)
}</code></pre>
            
            <h4>2. 集合断言</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestCollectionAssertions</span>(t *testing.T) {
    <span class="comment">// 切片断言</span>
    slice := []<span class="keyword">int</span>{1, 2, 3}
    assert.<span class="function">Contains</span>(t, slice, 2)
    assert.<span class="function">NotContains</span>(t, slice, 4)
    assert.<span class="function">Len</span>(t, slice, 3)
    assert.<span class="function">Empty</span>(t, []<span class="keyword">int</span>{})
    assert.<span class="function">NotEmpty</span>(t, slice)
    
    <span class="comment">// Map 断言</span>
    m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>{<span class="string">"a"</span>: 1, <span class="string">"b"</span>: 2}
    assert.<span class="function">ContainsKey</span>(t, m, <span class="string">"a"</span>)
    assert.<span class="function">NotContainsKey</span>(t, m, <span class="string">"c"</span>)
    assert.<span class="function">Len</span>(t, m, 2)
}</code></pre>
            
            <h4>3. 对象断言</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name <span class="keyword">string</span>
    Age  <span class="keyword">int</span>
}

<span class="function">func</span> <span class="function">TestObjectAssertions</span>(t *testing.T) {
    user1 := User{Name: <span class="string">"Alice"</span>, Age: 30}
    user2 := User{Name: <span class="string">"Alice"</span>, Age: 30}
    user3 := User{Name: <span class="string">"Bob"</span>, Age: 25}
    
    <span class="comment">// 对象相等断言</span>
    assert.<span class="function">Equal</span>(t, user1, user2)
    assert.<span class="function">NotEqual</span>(t, user1, user3)
    
    <span class="comment">// 指针断言</span>
    ptr1 := &user1
    ptr2 := &user2
    assert.<span class="function">Same</span>(t, ptr1, ptr1)
    assert.<span class="function">NotSame</span>(t, ptr1, ptr2)
    
    <span class="comment">// 类型断言</span>
    <span class="keyword">var</span> <span class="keyword">interface</span>{} = user1
    assert.<span class="function">IsType</span>(t, User{}, <span class="keyword">interface</span>{})
    assert.<span class="function">Implements</span>(t, (*<span class="keyword">interface</span>{})(<span class="keyword">nil</span>), user1)
}</code></pre>
            
            <h4>4. Mock 对象</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="string">"github.com/stretchr/testify/mock"</span>
)

<span class="comment">// 定义接口</span>
<span class="keyword">type</span> Database <span class="keyword">interface</span> {
    <span class="function">GetUser</span>(id <span class="keyword">int</span>) (*User, <span class="keyword">error</span>)
    <span class="function">SaveUser</span>(user *User) <span class="keyword">error</span>
}

<span class="comment">// 创建 Mock</span>
<span class="keyword">type</span> MockDatabase <span class="keyword">struct</span> {
    mock.Mock
}

<span class="function">func</span> (m *MockDatabase) <span class="function">GetUser</span>(id <span class="keyword">int</span>) (*User, <span class="keyword">error</span>) {
    args := m.<span class="function">Called</span>(id)
    <span class="keyword">if</span> args.Get(0) == <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">nil</span>, args.<span class="function">Error</span>(1)
    }
    <span class="keyword">return</span> args.Get(0).(*User), args.<span class="function">Error</span>(1)
}

<span class="function">func</span> (m *MockDatabase) <span class="function">SaveUser</span>(user *User) <span class="keyword">error</span> {
    args := m.<span class="function">Called</span>(user)
    <span class="keyword">return</span> args.<span class="function">Error</span>(0)
}

<span class="function">func</span> <span class="function">TestUserService</span>(t *testing.T) {
    <span class="comment">// 创建 Mock 对象</span>
    mockDB := <span class="keyword">new</span>(MockDatabase)
    
    <span class="comment">// 设置期望</span>
    mockDB.<span class="function">On</span>(<span class="string">"GetUser"</span>, 1).<span class="function">Return</span>(&User{Name: <span class="string">"Alice"</span>}, <span class="keyword">nil</span>)
    mockDB.<span class="function">On</span>(<span class="string">"SaveUser"</span>, mock.Anything).<span class="function">Return</span>(<span class="keyword">nil</span>)
    
    <span class="comment">// 使用 Mock 进行测试</span>
    user, err := mockDB.<span class="function">GetUser</span>(1)
    assert.<span class="function">NoError</span>(t, err)
    assert.<span class="function">Equal</span>(t, <span class="string">"Alice"</span>, user.Name)
    
    err = mockDB.<span class="function">SaveUser</span>(&User{Name: <span class="string">"Bob"</span>})
    assert.<span class="function">NoError</span>(t, err)
    
    <span class="comment">// 验证期望</span>
    mockDB.<span class="function">AssertExpectations</span>(t)
}</code></pre>
            
            <h4>5. 测试套件</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/suite"</span>
)

<span class="keyword">type</span> CalculatorTestSuite <span class="keyword">struct</span> {
    suite.Suite
    calc *Calculator
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">SetupTest</span>() {
    <span class="comment">// 每个测试前执行</span>
    suite.calc = <span class="function">NewCalculator</span>()
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TearDownTest</span>() {
    <span class="comment">// 每个测试后执行</span>
    suite.calc = <span class="keyword">nil</span>
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">SetupSuite</span>() {
    <span class="comment">// 套件开始前执行</span>
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TearDownSuite</span>() {
    <span class="comment">// 套件结束后执行</span>
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TestAdd</span>() {
    result := suite.calc.<span class="function">Add</span>(2, 3)
    suite.<span class="function">Equal</span>(5, result)
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TestSubtract</span>() {
    result := suite.calc.<span class="function">Subtract</span>(5, 3)
    suite.<span class="function">Equal</span>(2, result)
}

<span class="function">func</span> <span class="function">TestCalculatorTestSuite</span>(t *testing.T) {
    suite.<span class="function">Run</span>(t, <span class="keyword">new</span>(CalculatorTestSuite))
}</code></pre>
            
            <h4>6. HTTP 测试</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"net/http"</span>
    <span class="string">"net/http/httptest"</span>
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="string">"github.com/stretchr/testify/http"</span>
)

<span class="function">func</span> <span class="function">TestHTTPHandler</span>(t *testing.T) {
    <span class="comment">// 创建测试服务器</span>
    router := <span class="function">SetupRouter</span>()
    w := httptest.<span class="function">NewRecorder</span>()
    req, _ := http.<span class="function">NewRequest</span>(<span class="string">"GET"</span>, <span class="string">"/users/1"</span>, <span class="keyword">nil</span>)
    
    <span class="comment">// 执行请求</span>
    router.<span class="function">ServeHTTP</span>(w, req)
    
    <span class="comment">// 断言响应</span>
    assert.<span class="function">Equal</span>(t, http.StatusOK, w.Code)
    assert.<span class="function">JSONEq</span>(t, <span class="string">`{"id":1,"name":"Alice"}`</span>, w.Body.<span class="function">String</span>())
    
    <span class="comment">// 使用 httpassert</span>
    http.<span class="function">AssertSuccess</span>(t, w.Code)
    http.<span class="function">AssertJSONPath</span>(t, w, <span class="string">"$.name"</span>, <span class="string">"Alice"</span>)
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 测试组织</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="comment">// 使用子测试组织测试</span>
<span class="function">func</span> <span class="function">TestCalculator</span>(t *testing.T) {
    t.<span class="function">Run</span>(<span class="string">"Add"</span>, <span class="function">func</span>(t *testing.T) {
        calc := <span class="function">NewCalculator</span>()
        result := calc.<span class="function">Add</span>(2, 3)
        assert.<span class="function">Equal</span>(t, 5, result)
    })
    
    t.<span class="function">Run</span>(<span class="string">"Subtract"</span>, <span class="function">func</span>(t *testing.T) {
        calc := <span class="function">NewCalculator</span>()
        result := calc.<span class="function">Subtract</span>(5, 3)
        assert.<span class="function">Equal</span>(t, 2, result)
    })
}</code></pre>
            
            <h4>2. 表驱动测试</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestAdd</span>(t *testing.T) {
    tests := []<span class="keyword">struct</span> {
        name     <span class="keyword">string</span>
        a, b     <span class="keyword">int</span>
        expected <span class="keyword">int</span>
    }{
        {<span class="string">"positive"</span>, 2, 3, 5},
        {<span class="string">"negative"</span>, -2, -3, -5},
        {<span class="string">"mixed"</span>, 2, -3, -1},
        {<span class="string">"zero"</span>, 0, 0, 0},
    }
    
    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests {
        t.<span class="function">Run</span>(tt.name, <span class="function">func</span>(t *testing.T) {
            result := <span class="function">Add</span>(tt.a, tt.b)
            assert.<span class="function">Equal</span>(t, tt.expected, result, <span class="string">"Add(%d, %d) = %d; want %d"</span>, tt.a, tt.b, result, tt.expected)
        })
    }
}</code></pre>
            
            <h4>3. 测试覆盖率</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="comment">// 测试所有分支</span>
<span class="function">func</span> <span class="function">TestDivide</span>(t *testing.T) {
    <span class="comment">// 正常情况</span>
    result, err := <span class="function">Divide</span>(10, 2)
    assert.<span class="function">Equal</span>(t, 5, result)
    assert.<span class="function">NoError</span>(t, err)
    
    <span class="comment">// 除零错误</span>
    result, err = <span class="function">Divide</span>(10, 0)
    assert.<span class="function">Zero</span>(t, result)
    assert.<span class="function">Error</span>(t, err)
    
    <span class="comment">// 负数除法</span>
    result, err = <span class="function">Divide</span>(-10, 2)
    assert.<span class="function">Equal</span>(t, -5, result)
    assert.<span class="function">NoError</span>(t, err)
}</code></pre>
            
            <h4>4. Mock 最佳实践</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="keyword">"github.com/stretchr/testify/mock"</span>
)

<span class="function">func</span> <span class="function">TestWithProperMocking</span>(t *testing.T) {
    mockDB := <span class="keyword">new</span>(MockDatabase)
    
    <span class="comment">// 明确设置期望</span>
    mockDB.<span class="function">On</span>(<span class="string">"GetUser"</span>, 1).<span class="function">Return</span>(&User{Name: <span class="string">"Alice"</span>}, <span class="keyword">nil</span>).<span class="function">Once</span>()
    
    <span class="comment">// 执行测试</span>
    user, err := mockDB.<span class="function">GetUser</span>(1)
    assert.<span class="function">NoError</span>(t, err)
    assert.<span class="function">Equal</span>(t, <span class="string">"Alice"</span>, user.Name)
    
    <span class="comment">// 验证所有期望都被满足</span>
    mockDB.<span class="function">AssertExpectations</span>(t)
    
    <span class="comment">// 测试错误情况</span>
    mockDB.<span class="function">On</span>(<span class="string">"GetUser"</span>, 999).<span class="function">Return</span>(<span class="keyword">nil</span>, assert.AnError).<span class="function">Once</span>()
    
    user, err = mockDB.<span class="function">GetUser</span>(999)
    assert.<span class="function">Nil</span>(t, user)
    assert.<span class="function">Error</span>(t, err)
    
    mockDB.<span class="function">AssertExpectations</span>(t)
}</code></pre>
            
            <h4>5. 测试辅助函数</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="string">"github.com/stretchr/testify/require"</span>
)

<span class="comment">// 辅助函数创建测试数据</span>
<span class="function">func</span> <span class="function">createTestUser</span>(name <span class="keyword">string</span>, age <span class="keyword">int</span>) *User {
    <span class="keyword">return</span> &User{
        Name: name,
        Age:  age,
        ID:   <span class="function">generateTestID</span>(),
    }
}

<span class="function">func</span> <span class="function">generateTestID</span>() <span class="keyword">int</span> {
    <span class="keyword">return</span> 42
}

<span class="function">func</span> <span class="function">TestWithHelpers</span>(t *testing.T) {
    <span class="comment">// 使用 require 立即失败</span>
    user := <span class="function">createTestUser</span>(<span class="string">"Alice"</span>, 30)
    require.<span class="function">NotNil</span>(t, user)
    
    <span class="comment">// 使用 assert 继续执行</span>
    assert.<span class="function">Equal</span>(t, <span class="string">"Alice"</span>, user.Name)
    assert.<span class="function">Equal</span>(t, 30, user.Age)
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>单元测试</strong>：编写简洁易读的单元测试</li>
                <li><strong>集成测试</strong>：使用 Mock 对象隔离依赖</li>
                <li><strong>API 测试</strong>：测试 HTTP API 的响应</li>
                <li><strong>数据库测试</strong>：使用 Mock 数据库进行测试</li>
                <li><strong>并发测试</strong>：测试并发场景和竞态条件</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>Mock 对象应该明确设置期望和返回值</li>
                <li>使用 require 断言立即失败，使用 assert 断言继续执行</li>
                <li>测试应该独立，不依赖执行顺序</li>
                <li>测试应该快速，避免使用 sleep 等延迟</li>
                <li>使用表驱动测试提高测试覆盖率</li>
                <li>定期检查测试覆盖率，确保代码质量</li>
            </ul>
            </div>

            <h2 id="gods">GoDS 数据结构</h2>
            <p>GoDS（Go Data Structures）是一个纯 Go 语言实现的、高性能的开源数据结构和算法库。它提供了丰富的数据结构，如链表、栈、队列、集合、树、堆、哈希表等，以及多种算法实现。GoDS 的设计目标是提供与 Go 标准库兼容的 API，同时提供更好的性能和更丰富的功能。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>丰富的数据结构</strong>：提供链表、栈、队列、集合、树、堆、哈希表等</li>
                <li><strong>高性能</strong>：优化的实现，性能优于标准库</li>
                <li><strong>内存高效</strong>：使用内存池和对象池减少内存分配</li>
                <li><strong>并发安全</strong>：提供并发安全的数据结构实现</li>
                <li><strong>序列化支持</strong>：支持 JSON、Gob 等序列化格式</li>
                <li><strong>类型安全</strong>：使用泛型提供类型安全的 API</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/emirpasic/gods/v2</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建链表</span>
    l := list.<span class="function">New</span>()
    l.<span class="function">PushBack</span>(1)
    l.<span class="function">PushBack</span>(2)
    l.<span class="function">PushBack</span>(3)
    
    <span class="comment">// 遍历链表</span>
    it := l.<span class="function">Front</span>()
    <span class="keyword">for</span> it.<span class="function">Next</span>() {
        fmt.<span class="function">Println</span>(it.<span class="function">Value</span>())
    }
}</code></pre>
            
            <h3>常用数据结构</h3>
            
            <h4>1. 链表（List）</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建链表</span>
    l := list.<span class="function">New</span>()
    
    <span class="comment">// 添加元素</span>
    l.<span class="function">PushBack</span>(1)
    l.<span class="function">PushFront</span>(0)
    l.<span class="function">PushBack</span>(2)
    
    <span class="comment">// 访问元素</span>
    fmt.<span class="function">Println</span>(<span class="string">"Front:"</span>, l.<span class="function">Front</span>().<span class="function">Value</span>())
    fmt.<span class="function">Println</span>(<span class="string">"Back:"</span>, l.<span class="function">Back</span>().<span class="function">Value</span>())
    
    <span class="comment">// 移除元素</span>
    l.<span class="function">Remove</span>(l.<span class="function">Front</span>())
    
    <span class="comment">// 遍历</span>
    <span class="keyword">for</span> it := l.<span class="function">Front</span>(); it != <span class="keyword">nil</span>; it = it.<span class="function">Next</span>() {
        fmt.<span class="function">Println</span>(it.<span class="function">Value</span>())
    }
}</code></pre>
            
            <h4>2. 栈（Stack）</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/emirpasic/gods/v2/stack"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建栈</span>
    s := stack.<span class="function">New</span>()
    
    <span class="comment">// 入栈</span>
    s.<span class="function">Push</span>(1)
    s.<span class="function">Push</span>(2)
    s.<span class="function">Push</span>(3)
    
    <span class="comment">// 查看栈顶</span>
    <span class="keyword">if</span> top, ok := s.<span class="function">Peek</span>(); ok {
        fmt.<span class="function">Println</span>(<span class="string">"Top:"</span>, top)
    }
    
    <span class="comment">// 出栈</span>
    <span class="keyword">if</span> value, ok := s.<span class="function">Pop</span>(); ok {
        fmt.<span class="function">Println</span>(<span class="string">"Popped:"</span>, value)
    }
    
    <span class="comment">// 检查栈是否为空</span>
    fmt.<span class="function">Println</span>(<span class="string">"Empty:"</span>, s.<span class="function">Empty</span>())
}</code></pre>
            
            <h4>3. 队列（Queue）</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/emirpasic/gods/v2/queue"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建队列</span>
    q := queue.<span class="function">New</span>()
    
    <span class="comment">// 入队</span>
    q.<span class="function">Enqueue</span>(1)
    q.<span class="function">Enqueue</span>(2)
    q.<span class="function">Enqueue</span>(3)
    
    <span class="comment">// 查看队首</span>
    <span class="keyword">if</span> front, ok := q.<span class="function">Peek</span>(); ok {
        fmt.<span class="function">Println</span>(<span class="string">"Front:"</span>, front)
    }
    
    <span class="comment">// 出队</span>
    <span class="keyword">if</span> value, ok := q.<span class="function">Dequeue</span>(); ok {
        fmt.<span class="function">Println</span>(<span class="string">"Dequeued:"</span>, value)
    }
    
    <span class="comment">// 检查队列大小</span>
    fmt.<span class="function">Println</span>(<span class="string">"Size:"</span>, q.<span class="function">Size</span>())
}</code></pre>
            
            <h4>4. 集合（Set）</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/emirpasic/gods/v2/hashset"</span>
)

<span class="function">func</span> <span class="function">main</span> {
    <span class="comment">// 创建集合</span>
    set := hashset.<span class="function">New</span>()
    
    <span class="comment">// 添加元素</span>
    set.<span class="function">Add</span>(1)
    set.<span class="function">Add</span>(2)
    set.<span class="function">Add</span>(3)
    
    <span class="comment">// 检查元素是否存在</span>
    fmt.<span class="function">Println</span>(<span class="string">"Contains 2:"</span>, set.<span class="function">Contains</span>(2))
    
    <span class="comment">// 移除元素</span>
    set.<span class="function">Remove</span>(2)
    
    <span class="comment">// 遍历集合</span>
    set.<span class="function">Each</span>(<span class="function">func</span>(value <span class="keyword">interface</span>{}) <span class="keyword">bool</span> {
        fmt.<span class="function">Println</span>(value)
        <span class="keyword">return</span> <span class="keyword">true</span>
    })
}</code></pre>
            
            <h4>5. 树（Tree）</h4>
pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/emirpasic/gods/v2/treemap"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建树形映射</span>
    tree := treemap.<span class="function">NewWithStringComparator</span>()
    
    <span class="comment">// 添加键值对</span>
    tree.<span class="function">Put</span>(<span class="string">"a"</span>, 1)
    tree.<span class="function">Put</span>(<span class="string">"b"</span>, 2)
    tree.<span class="function">Put</span>(<span class="string">"c"</span>, 3)
    
    <span class="comment">// 获取值</span>
    <span class="keyword">if</span> value, ok := tree.<span class="function">Get</span>(<span class="string">"b"</span>); ok {
        fmt.<span class="function">Println</span>(<span class="string">"Value for 'b':"</span>, value)
    }
    
    <span class="comment">// 遍历树</span>
    it := tree.<span class="function">Iterator</span>()
    <span class="keyword">for</span> it.<span class="function">Begin</span>(); it.<span class="function">End</span>(); it.<span class="function">Next</span>()() {
        key, value := it.<span class="function">Key</span>(), it.<span class="function">Value</span>()
        fmt.<span class="function">Printf</span>(<span class="string">"%s: %v\n"</span>, key, value)
    }
}</code></pre>
            
            <h4>6. 堆（Heap）</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"container/heap"</span>
    <span class="string">"github.com/emirpasic/gods/v2/treemap"</span>
)

<span class="keyword">type</span> IntHeap []<span class="keyword">int</span>

<span class="function">func</span> (h IntHeap) <span class="function">Len</span>() <span class="keyword">int</span>           { <span class="keyword">return</span> <span class="function">len</span>(h) }
<span class="function">func</span> (h IntHeap) <span class="function">Less</span>(i, j <span class="keyword">int</span>) <span class="keyword">bool</span> { <span class="keyword">return</span> h[i] < h[j] }
<span class="function">func</span> (h IntHeap) <span class="function">Swap</span>(i, j <span class="keyword">int</span>)      { h[i], h[j] = h[j], h[i] }
<span class="function">func</span> (h IntHeap) <span class="function">Push</span>(x <span class="keyword">int</span>)      { heap.<span class="function">Push</span>(h, x) }
<span class="function">func</span> (h *IntHeap) <span class="function">Pop</span>() <span class="keyword">int</span>     { <span class="keyword">return</span> heap.<span class="function">Pop</span>(h) }

<span class="function">func</span> <span class="function">main</span>() {
    h := &IntHeap{3, 1, 4, 1, 5, 9}
    heap.<span class="function">Init</span>(h)
    
    <span class="comment">// 弹出最小值</span>
    <span class="keyword">for</span> h.<span class="function">Len</span>() > 0 {
        fmt.<span class="function">Println</span>(heap.<span class="function">Pop</span>(h))
    }
}</code></pre>
            
            <h3>高级功能</h3>
            
            <h4>1. 并发安全的数据结构</h4>
            <pre><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"sync"</span>
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建并发安全的链表</span>
    l := list.<span class="function">New</span>()
    <span class="keyword">var</span> mu sync.Mutex
    
    <span class="comment">// 并发操作</span>
    <span class="keyword">for</span> i := 0; i < 10; i++ {
        <span class="keyword">go</span> <span class="function">func</span>(n <span class="keyword">int</span>) {
            mu.<span class="function">Lock</span>()
            <span class="keyword">defer</span> mu.<span class="function">Unlock</span>()
            l.<span class="function">PushBack</span>(n)
        }(i)
    }
}</code></pre>
            
            <h4>2. 自定义比较器</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/emirpasic/gods/v2/treemap"</span>
    <span class="string">"github.com/emirpasic/gods/v2/utils"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name <span class="keyword">string</span>
    Age  <span class="keyword">int</span>
}

<span class="comment">// 自定义比较器</span>
<span class="keyword">type</span> ByAge <span class="keyword">struct</span>{ users []*User }

<span class="function">func</span> (a ByAge) <span class="function">Len</span>() <span class="keyword">int</span> <span class="keyword">return</span> <span class="function">len</span>(a.users) }
<span class="function">func</span> (a ByAge) <span class="function">Less</span>(i, j <span class="keyword">int</span>) <span class="keyword">bool</span> <span class="keyword">return</span> a.users[i].Age < a.users[j].Age }
<span class="function">func</span> (a ByAge) <span class="function">Swap</span>(i, j <span class="keyword">int</span>)      { a.users[i], a.users[j] = a.users[j], a.users[i] }

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 使用自定义比较器创建树</span>
    tree := treemap.<span class="function">NewWith</span>(utils.<span class="function">Comparator</span>(<span class="keyword">func</span>(a, b <span class="keyword">interface</span>{}) <span class="keyword">int</span> {
        return a.(<span class="keyword">int</span>) - b.(<span class="keyword">int</span>)
    }))
    
    tree.<span class="function">Put</span>(10, <span class="string">"ten"</span>)
    tree.<span class="function">Put</span>(5, <span class="string">"five"</span>)
}</code></pre>
            
            <h4>3. 序列化</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"encoding/json"</span>
    <span class="string">"fmt"</span>
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    l := list.<span class="function">New</span>()
    l.<span class="function">PushBack</span>(1)
    l.<span class="function">PushBack</span>(2)
    l.<span class="function">PushBack</span>(3)
    
    <span class="comment">// 转换为切片</span>
    values := l.<span class="function">Values</span>()
    
    <span class="comment">// JSON 序列化</span>
    data, _ := json.<span class="function">Marshal</span>(values)
    fmt.<span class="function">Println</span>(<span class="function">String</span>(data))
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 选择合适的数据结构</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
    <span class="string">"github.com/emirpasic/gods/v2/hashmap"</span>
    <span class="string">"github.com/emirpasic/gods/v2/hashset"</span>
)

<span class="function">func</span> <span class="function">chooseDataStructure</span>() {
    <span class="comment">// 频繁的插入和删除 - 使用链表</span>
    l := list.<span class="function">New</span>()
    
    <span class="comment">// 需要快速查找 - 使用哈希表</span>
    m := hashmap.<span><span class="function">New</span>()
    
    <span class="comment">// 需要唯一元素 - 使用集合</span>
    s := hashset.<span class="function">New</span>()
    
    <span class="comment">// 需要排序 - 使用树</span>
}</code></pre>
            
            <h4>2. 内存管理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
)

<span class="function">func</span> <span class="function">manageMemory</span>() {
    l := list.<span class="function">New</span>()
    
    <span class="comment">// 及时清理不需要的元素</span>
    <span class="keyword">for</span> l.<span class="function">Size</span>() > 1000 {
        l.<span class="function">Remove</span>(l.<span class="function">Front</span>())
    }
    
    <span class="comment">// 使用迭代器避免创建不必要的切片</span>
    <span class="keyword">for</span> it := l.<span class="function">Front</span>(); it != <span class="keyword">nil</span>; it = it.<span class="function">Next</span>() {
        _ = it.<span class="function">Value</span>()
    }
}</code></pre>
            
            <h4>3. 性能优化</h4>
预计算容量：
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/emirpasic/gods/v2/hashmap"</span>
)

<span class="function</span> <span class="keyword">func</span> <span class="function">optimizePerformance</span>() {
    <span class="comment">// 预分配容量</span>
    m := hashmap.<span class="function">New</span>()
    m.<span class="function">Resize</span>(1000)
    
    <span class="span class="comment">// 批量操作</span>
    <span class="keyword">for</span> i := 0; i < 1000; i++ {
        m.<span class="function">Put</span>(i, i*2)
    }
}</code></pre>
            
            <h4>4. 迭代器使用</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
)

<span class="function">func</span> <span class="function">useIterator</span>() {
    l := list.<span class="function">New</span>()
    l.<span class="function">PushBack</span>(1)
    l.<span class="function">PushBack</span>(2)
    l.<span class="function">PushBack</span>(3)
    
    <span class="comment">// 正向迭代</span>
    <span class="keyword">for</span> it := l.<span class="function">Front</span>(); it != <span class="keyword">nil</span>(); it = it.<span class="function">Next</span>()() {
        _ = it.<span class="function">Value</span>()
    }
    
    <span class="comment">// 反向迭代</span>
    <span class="keyword">for</span> it := l.<span class="function">Back</span>(); it != <span class="keyword">nil</span>(); it = it.<span class="function">Prev</span>()() {
        _ = it.<span class="function">Value</span>()
    }
}</code></pre>
            
            <h4>5. 与标准库对比</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"container/list"</span>
    <span class="string">"github.com/emirpasic/gods/v2/list"</span>
)

<span class="function">func</span> <span class="function">compareWithStdLib</span>() {
    <span class="comment">// 标准库链表</span>
    stdList := list.<span class="function">New</span>()
    stdList.<span class="function">PushBack</span>(1)
    
    <span class="comment">// GoDS 链表</span>
    godsList := list.<span class="function">New</span>()
    godsList.<span class="function">PushBack</span>(1)
    
    <span class="comment">// GoDS 提供了更丰富的功能</span>
    <span class="comment">// 如：Values()、Each()、Select() 等</span>
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>算法实现</strong>：实现各种算法如排序、搜索、图算法</li>
                <li><strong>缓存系统</strong>：使用 LRU 缓存等数据结构</li>
                <li><strong>任务队列</span>：使用队列和栈管理任务</li>
                <li><strong>数据去重</span>：使用集合进行数据去重</span>
                <li><strong>事件处理</span>：使用队列处理事件流</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>根据使用场景选择合适的数据结构</li>
                <li>注意内存使用，特别是对于大型数据集</li>
                <li>并发环境中使用适当的同步机制</li>
                <li>GoDS 的 API 与标准库不同，需要适应</li>
                <li>定期检查性能，确保选择的数据结构合适</li>
                <li>注意迭代器的使用，避免在迭代时修改数据结构</li>
            </ul>
            </div>

            <h2 id="gg">gg 图形库</h2>
            <p>gg 是一个纯 Go 语言实现的高性能 2D 图形库，提供了丰富的绘图功能，包括路径绘制、图像处理、文本渲染、变换、渐变、透明度等。gg 的设计目标是提供简单易用、性能优秀的 2D 图形处理能力，适用于数据可视化、游戏开发、图像处理等场景。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>纯 Go 实现</strong>：不依赖任何外部 C 库，完全用 Go 语言实现</li>
                <li><strong>高性能</strong>：优化的渲染引擎，支持硬件加速</li>
                <li><strong>丰富的绘图功能</strong>：支持路径、形状、文本、图像等</li>
                <li><strong>变换支持</strong>：支持平移、旋转、缩放等变换</li>
                <li><strong>渐变和透明度</strong>：支持线性渐变、径向渐变、透明度</li>
                <li><strong>多种输出格式</strong>：支持 PNG、JPEG、GIF、TIFF 等格式</li>
                <li><strong>字体支持</strong>：支持 TrueType 和 OpenType 字体</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/fogleman/gg</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建 800x600 的画布</span>
    dc := gg.<span class="function">NewContext</span>(800, 600)
    
    <span class="comment">// 设置背景色</span>
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 绘制红色矩形</span>
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">DrawRectangle</span>(100, 100, 200, 150)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 保存为 PNG</span>
    dc.<span class="function">SavePNG</span>(<span class="string">"output.png"</span>)
}</code></pre>
            
            <h3>常用功能</h3>
            
            <h4>1. 基本形状绘制</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 绘制矩形</span>
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">DrawRectangle</span>(50, 50, 200, 150)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 绘制圆形</span>
    dc.<span class="function">SetRGB255</span>(0, 255, 0)
    dc.<span class="function">DrawCircle</span>(400, 300, 100)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 绘制椭圆</span>
    dc.<span class="function">SetRGB255</span>(0, 0, 255)
    dc.<span class="function">DrawEllipse</span>(600, 200, 100, 50)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 绘制线条</span>
    dc.<span class="function">SetRGB255</span>(0, 0, 0)
    dc.<span class="function">SetLineWidth</span>(5)
    dc.<span class="function">DrawLine</span>(50, 400, 750, 400)
    dc.<span class="function">Stroke</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"shapes.png"</span>)
}</code></pre>
            
            <h4>2. 路径绘制</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 绘制多边形路径</span>
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">MoveTo</span>(100, 100)
    dc.<span class="function">LineTo</span>(200, 50)
    dc.<span class="function">LineTo</span>(300, 100)
    dc.<span class="function">LineTo</span>(300, 200)
    dc.<span class="function">LineTo</span>(200, 250)
    dc.<span class="function">LineTo</span>(100, 200)
    dc.<span class="function">ClosePath</span>()
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 绘制贝塞尔曲线</span>
    dc.<span class="function">SetRGB255</span>(0, 0, 255)
    dc.<span class="function">SetLineWidth</span>(3)
    dc.<span class="function">MoveTo</span>(400, 300)
    dc.<span class="function">QuadCurveTo</span>(500, 200, 600, 300)
    dc.<span class="function">CubicCurveTo</span>(650, 350, 700, 250, 750, 300)
    dc.<span class="function">Stroke</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"paths.png"</span>)
}</code></pre>
            
            <h4>3. 文本渲染</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 加载字体</span>
    <span class="keyword">if</span> err := dc.<span class="function">LoadFontFace</span>(<span class="string">"arial.ttf"</span>, 48); err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    
    <span class="comment">// 绘制文本</span>
    dc.<span class="function">SetRGB255</span>(0, 0, 0)
    dc.<span class="function">DrawString</span>(<span class="string">"Hello, gg!"</span>, 100, 100)
    
    <span class="comment">// 绘制带阴影的文本</span>
    dc.<span class="function">SetRGB255</span>(200, 200, 200)
    dc.<span class="function">DrawString</span>(<span class="string">"Shadow Text"</span>, 102, 202)
    dc.<span class="function">SetRGB255</span>(0, 0, 0)
    dc.<span class="function">DrawString</span>(<span class="string">"Shadow Text"</span>, 100, 200)
    
    <span class="comment">// 绘制旋转的文本</span>
    dc.<span class="function">Push</span>()
    dc.<span class="function">RotateAbout</span>(gg.<span class="function">Radians</span>(45), 400, 400)
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">DrawString</span>(<span class="string">"Rotated Text"</span>, 350, 400)
    dc.<span class="function">Pop</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"text.png"</span>)
}</code></pre>
            
            <h4>4. 图像处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 加载图像</span>
    img, err := gg.<span class="function">LoadImage</span>(<span class="string">"input.png"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    
    <span class="comment">// 绘制图像（原始大小）</span>
    dc.<span class="function">DrawImage</span>(img, 50, 50)
    
    <span class="comment">// 绘制缩放后的图像</span>
    dc.<span class="function">DrawImageAnchored</span>(img, 400, 300, 0.5, 0.5)
    
    <span class="comment">// 绘制旋转后的图像</span>
    dc.<span class="function">Push</span>()
    dc.<span class="function">RotateAbout</span>(gg.<span class="function">Radians</span>(30), 600, 400)
    dc.<span class="function">DrawImageAnchored</span>(img, 600, 400, 0.5, 0.5)
    dc.<span class="function">Pop</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"image.png"</span>)
}</code></pre>
            
            <h4>5. 渐变和透明度</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 线性渐变</span>
    gradient := gg.<span class="function">NewLinearGradient</span>(0, 0, 400, 400)
    gradient.<span class="function">AddColorStop</span>(0, gg.<span class="function">NewRGBA</span>(255, 0, 0, 255))
    gradient.<span class="function">AddColorStop</span>(1, gg.<span class="function">NewRGBA</span>(0, 0, 255, 255))
    dc.<span class="function">SetFillStyle</span>(gradient)
    dc.<span class="function">DrawRectangle</span>(50, 50, 300, 300)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 径向渐变</span>
    radial := gg.<span class="function">NewRadialGradient</span>(600, 300, 0, 600, 300, 150)
    radial.<span class="function">AddColorStop</span>(0, gg.<span class="function">NewRGBA</span>(255, 255, 0, 255))
    radial.<span class="function">AddColorStop</span>(1, gg.<span class="function">NewRGBA</span>(255, 0, 0, 255))
    dc.<span class="function">SetFillStyle</span>(radial)
    dc.<span class="function">DrawCircle</span>(600, 300, 150)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 透明度</span>
    dc.<span class="function">SetRGBA255</span>(0, 255, 0, 128)
    dc.<span class="function">DrawRectangle</span>(100, 400, 200, 150)
    dc.<span class="function">Fill</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"gradient.png"</span>)
}</code></pre>
            
            <h4>6. 变换操作</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 平移</span>
    dc.<span class="function">Push</span>()
    dc.<span class="function">Translate</span>(100, 100)
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">DrawRectangle</span>(0, 0, 100, 100)
    dc.<span class="function">Fill</span>()
    dc.<span class="function">Pop</span>()
    
    <span class="comment">// 旋转</span>
    dc.<span class="function">Push</span>()
    dc.<span class="function">Translate</span>(300, 300)
    dc.<span class="function">Rotate</span>(gg.<span class="function">Radians</span>(45))
    dc.<span class="function">SetRGB255</span>(0, 255, 0)
    dc.<span class="function">DrawRectangle</span>(-50, -50, 100, 100)
    dc.<span class="function">Fill</span>()
    dc.<span class="function">Pop</span>()
    
    <span class="comment">// 缩放</span>
    dc.<span class="function">Push</span>()
    dc.<span class="function">Translate</span>(500, 400)
    dc.<span class="function">Scale</span>(2, 0.5)
    dc.<span class="function">SetRGB255</span>(0, 0, 255)
    dc.<span class="function">DrawCircle</span>(0, 0, 50)
    dc.<span class="function">Fill</span>()
    dc.<span class="function">Pop</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"transform.png"</span>)
}</code></pre>
            
            <h3>高级功能</h3>
            
            <h4>1. 裁剪</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 绘制圆形裁剪区域</span>
    dc.<span class="function">DrawCircle</span>(400, 300, 200)
    dc.<span class="function">Clip</span>()
    
    <span class="comment">// 在裁剪区域内绘制</span>
    <span class="keyword">for</span> i := 0; i < 10; i++ {
        dc.<span class="function">SetRGB255</span>(<span class="function">byte</span>(i*25), 0, <span class="function">byte</span>(255-i*25))
        dc.<span class="function">DrawRectangle</span>(<span class="function">float64</span>(i*80), 0, 80, 600)
        dc.<span class="function">Fill</span>()
    }
    
    dc.<span class="function">SavePNG</span>(<span class="string">"clip.png"</span>)
}</code></pre>
            
            <h4>2. 阴影</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 绘制阴影</span>
    dc.<span class="function">SetRGBA255</span>(0, 0, 0, 100)
    dc.<span class="function">DrawRoundedRectangle</span>(110, 110, 200, 150, 20)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 绘制主体</span>
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">DrawRoundedRectangle</span>(100, 100, 200, 150, 20)
    dc.<span class="function">Fill</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"shadow.png"</span>)
}</code></pre>
            
            <h4>3. 混合模式</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">SetRGB</span>(1, 1, 1)
    dc.<span class="function">Clear</span>()
    
    <span class="comment">// 绘制红色圆形</span>
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">DrawCircle</span>(300, 300, 150)
    dc.<span class="function">Fill</span>()
    
    <span class="comment">// 使用混合模式绘制蓝色圆形</span>
    dc.<span class="function">SetCompositionOp</span>(gg.<span class="function">CompositionOperatorXor</span>)
    dc.<span class="function">SetRGB255</span>(0, 0, 255)
    dc.<span class="function">DrawCircle</span>(500, 300, 150)
    dc.<span class="function">Fill</span>()
    
    dc.<span class="function">SavePNG</span>(<span class="string">"blend.png"</span>)
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 性能优化</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">optimizePerformance</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    
    <span class="comment">// 批量绘制</span>
    <span class="keyword">for</span> i := 0; i < 1000; i++ {
        dc.<span class="function">MoveTo</span>(<span class="function">float64</span>(i), <span class="function">float64</span>(i%600))
        dc.<span class="function">LineTo</span>(<span class="function">float64</span>(i+1), <span class="function">float64</span>((i+1)%600))
    }
    dc.<span class="function">Stroke</span>()
    
    <span class="comment">// 避免频繁的状态切换</span>
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    <span class="keyword">for</span> i := 0; i < 100; i++ {
        dc.<span class="function">DrawCircle</span>(<span class="function">float64</span>(i*8), 300, 5)
    }
    dc.<span class="function">Fill</span>()
}</code></pre>
            
            <h4>2. 资源管理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">manageResources</span>() {
    <span class="comment">// 重用 Context</span>
    dc := gg.<span class="function">NewContext</span>(800, 600)
    
    <span class="comment">// 加载图像一次，多次使用</span>
    img, _ := gg.<span class="function">LoadImage</span>(<span class="string">"sprite.png"</span>)
    
    <span class="keyword">for</span> i := 0; i < 10; i++ {
        dc.<span class="function">Clear</span>()
        dc.<span class="function">DrawImage</span>(img, <span class="function">float64</span>(i*80), 100)
        dc.<span class="function">SavePNG</span>(<span class="function">Sprintf</span>(<span class="string">"frame%d.png"</span>, i))
    }
}</code></pre>
            
            <h4>3. 错误处理</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log"</span>
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">handleErrors</span>() {
    dc := gg.<span class="function">NewContext</span>(800, 600)
    
    <span class="comment">// 加载字体</span>
    <span class="keyword">if</span> err := dc.<span class="function">LoadFontFace</span>(<span class="string">"font.ttf"</span>, 24); err != <span class="keyword">nil</span> {
        log.<span class="function">Fatal</span>(<span class="string">"Failed to load font:"</span>, err)
    }
    
    <span class="comment">// 保存图像</span>
    <span class="keyword">if</span> err := dc.<span class="function">SavePNG</span>(<span class="string">"output.png"</span>); err != <span class="keyword">nil</span> {
        log.<span class="function">Fatal</span>(<span class="string">"Failed to save image:"</span>, err)
    }
}</code></pre>
            
            <h4>4. 使用模板</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"github.com/fogleman/gg"</span>
)

<span class="function">func</span> <span class="function">useTemplates</span>() {
    <span class="comment">// 创建模板</span>
    templateDC := gg.<span class="function">NewContext</span>(800, 600)
    templateDC.<span class="function">SetRGB</span>(1, 1, 1)
    templateDC.<span class="function">Clear</span>()
    templateDC.<span class="function">DrawRectangle</span>(10, 10, 780, 580)
    templateDC.<span class="function">SetLineWidth</span>(5)
    templateDC.<span class="function">Stroke</span>()
    
    <span class="comment">// 使用模板创建新图像</span>
    dc := gg.<span class="function">NewContext</span>(800, 600)
    dc.<span class="function">DrawImage</span>(templateDC.<span class="function">Image</span>(), 0, 0)
    
    <span class="comment">// 添加自定义内容</span>
    dc.<span class="function">SetRGB255</span>(255, 0, 0)
    dc.<span class="function">DrawCircle</span>(400, 300, 100)
    dc.<span class="function">Fill</span>()
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>数据可视化</strong>：创建图表、图形、仪表盘</li>
                <li><strong>图像处理</strong>：图像编辑、滤镜、合成</li>
                <li><strong>游戏开发</strong>：2D 游戏渲染、精灵绘制</li>
                <li><strong>报告生成</strong>：生成 PDF、图片报告</li>
                <li><strong>Web 图形</strong>：生成网站图形、缩略图</li>
                <li><strong>艺术创作</strong>：生成艺术、创意设计</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>字体文件需要单独提供，确保字体文件存在</li>
                <li>大尺寸图像可能消耗较多内存</li>
                <li>频繁的保存操作会影响性能</li>
                <li>注意坐标系统的方向（左上角为原点）</li>
                <li>变换操作会影响后续所有绘制，使用 Push/Pop 管理状态</li>
                <li>路径操作需要正确关闭路径</li>
                <li>透明度和混合模式可能影响性能</li>
            </ul>
            </div>

            <h2 id="grpc">gRPC RPC框架</h2>
            <p>gRPC 是 Google 开发的高性能、开源的通用 RPC 框架，基于 HTTP/2 和 Protocol Buffers。它支持多种语言，提供了简单、高效的远程调用方式，广泛应用于微服务架构中。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>基于 HTTP/2</strong>：支持双向流、多路复用、头部压缩</li>
                <li><strong>使用 Protobuf</strong>：高效的二进制序列化格式</li>
                <li><strong>多语言支持</strong>：支持 Go、Java、Python、C++ 等多种语言</li>
                <li><strong>四种服务方法</strong>：一元调用、服务端流、客户端流、双向流</li>
                <li><strong>拦截器</strong>：支持请求拦截和响应处理</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u google.golang.org/grpc
<span class="keyword">go</span> install google.golang.org/protobuf/cmd/protoc-gen-go@latest
<span class="keyword">go</span> install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></pre>
            
            <h3>定义服务</h3>
            <pre><code>syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> example;

<span class="keyword">option</span> go_package = <span class="string">"./example"</span>;

<span class="keyword">service</span> Greeter {
    <span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) {}
    <span class="keyword">rpc</span> SayHelloStream (HelloRequest) <span class="keyword">returns</span> (stream HelloReply) {}
}

<span class="keyword">message</span> HelloRequest {
    <span class="keyword">string</span> name = 1;
}

<span class="keyword">message</span> HelloReply {
    <span class="keyword">string</span> message = 1;
}</code></pre>
            
            <h3>实现服务端</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"log"</span>
    <span class="string">"net"</span>
    <span class="string">"google.golang.org/grpc"</span>
    pb <span class="string">"path/to/your/proto"</span>
)

<span class="keyword">type</span> server <span class="keyword">struct</span> {
    pb.UnimplementedGreeterServer
}

<span class="function">func</span> (s *server) <span class="function">SayHello</span>(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, <span class="keyword">error</span>) {
    log.<span class="function">Printf</span>(<span class="string">"Received: %v"</span>, in.GetName())
    <span class="keyword">return</span> &pb.HelloReply{Message: <span class="string">"Hello "</span> + in.GetName()}, <span class="keyword">nil</span>
}

<span class="function">func</span> (s *server) <span class="function">SayHelloStream</span>(in *pb.HelloRequest, stream pb.Greeter_SayHelloStreamServer) <span class="keyword">error</span> {
    <span class="keyword">for</span> i := <span class="number">0</span>; i < <span class="number">5</span>; i++ {
        stream.<span class="function">Send</span>(&pb.HelloReply{
            Message: <span class="string">"Hello "</span> + in.GetName() + <span class="string">" "</span> + string(rune(<span class="string">'0'</span>+i)),
        })
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    lis, err := net.<span class="function">Listen</span>(<span class="string">"tcp"</span>, <span class="string">":50051"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"failed to listen: %v"</span>, err)
    }
    
    s := grpc.<span class="function">NewServer</span>()
    pb.<span class="function">RegisterGreeterServer</span>(s, &server{})
    
    log.<span class="function">Printf</span>(<span class="string">"server listening at %v"</span>, lis.<span class="function">Addr</span>())
    <span class="keyword">if</span> err := s.<span class="function">Serve</span>(lis); err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"failed to serve: %v"</span>, err)
    }
}</code></pre>
            
            <h3>实现客户端</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"io"</span>
    <span class="string">"log"</span>
    <span class="string">"time"</span>
    <span class="string">"google.golang.org/grpc"</span>
    pb <span class="string">"path/to/your/proto"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    conn, err := grpc.<span class="function">Dial</span>(<span class="string">"localhost:50051"</span>, grpc.<span class="function">WithTransportCredentials</span>(insecure.<span class="function">NewCredentials</span>()))
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"did not connect: %v"</span>, err)
    }
    <span class="keyword">defer</span> conn.<span class="function">Close</span>()
    
    c := pb.<span class="function">NewGreeterClient</span>(conn)
    
    <span class="comment">// 一元调用</span>
    ctx, cancel := context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), time.Second)
    <span class="keyword">defer</span> cancel()
    
    r, err := c.<span class="function">SayHello</span>(ctx, &pb.HelloRequest{Name: <span class="string">"World"</span>})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"could not greet: %v"</span>, err)
    }
    log.<span class="function">Printf</span>(<span class="string">"Greeting: %s"</span>, r.GetMessage())
    
    <span class="comment">// 流式调用</span>
    stream, err := c.<span class="function">SayHelloStream</span>(ctx, &pb.HelloRequest{Name: <span class="string">"Stream"</span>})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"could not stream: %v"</span>, err)
    }
    
    <span class="keyword">for</span> {
        reply, err := stream.<span class="function">Recv</span>()
        <span class="keyword">if</span> err == io.EOF {
            <span class="keyword">break</span>
        }
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            log.<span class="function">Fatalf</span>(<span class="string">"failed to recv: %v"</span>, err)
        }
        log.<span class="function">Printf</span>(<span class="string">"Stream reply: %s"</span>, reply.GetMessage())
    }
}</code></pre>
            </div>

            <h2 id="gateway">Gateway API网关</h2>
            <p>gRPC-Gateway 是 Google 提供的一个插件，用于将 gRPC 服务转换为 RESTful API。它允许客户端通过 HTTP/JSON 调用 gRPC 服务，同时保持 gRPC 的高性能和类型安全。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>自动生成</strong>：从 Protobuf 定义自动生成 RESTful API</li>
                <li><strong>双向转换</strong>：支持 HTTP/JSON 到 gRPC 的双向转换</li>
                <li><strong>OpenAPI 支持</strong>：自动生成 OpenAPI (Swagger) 文档</li>
                <li><strong>反向代理</strong>：作为反向代理转发请求到 gRPC 服务</li>
                <li><strong>中间件支持</strong>：支持认证、日志、CORS 等中间件</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@latest
<span class="keyword">go</span> install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@latest</code></pre>
            
            <h3>定义服务</h3>
            <pre><code>syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> example;

<span class="keyword">option</span> go_package = <span class="string">"./example"</span>;

<span class="keyword">import</span> <span class="string">"google/api/annotations.proto"</span>;

<span class="keyword">service</span> Greeter {
    <span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) {
        <span class="keyword">option</span> (google.api.http) = {
            <span class="keyword">get</span>: <span class="string">"/v1/hello/{name}"</span>
        };
    }
    
    <span class="keyword">rpc</span> CreateUser (CreateUserRequest) <span class="keyword">returns</span> (User) {
        <span class="keyword">option</span> (google.api.http) = {
            <span class="keyword">post</span>: <span class="string">"/v1/users"</span>
            body: <span class="string">"*"</span>
        };
    }
}

<span class="keyword">message</span> HelloRequest {
    <span class="keyword">string</span> name = 1;
}

<span class="keyword">message</span> HelloReply {
    <span class="keyword">string</span> message = 1;
}

<span class="keyword">message</span> CreateUserRequest {
    <span class="keyword">string</span> name = 1;
    <span class="keyword">string</span> email = 2;
}

<span class="keyword">message</span> User {
    <span class="keyword">string</span> id = 1;
    <span class="keyword">string</span> name = 2;
    <span class="keyword">string</span> email = 3;
}</code></pre>
            
            <h3>生成代码</h3>
            <pre><code>protoc -I. \
    --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    --grpc-gateway_out=. --grpc-gateway_opt=paths=source_relative \
    --openapiv2_out=. --openapiv2_opt=paths=source_relative \
    service.proto</code></pre>
            
            <h3>实现 Gateway 服务</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"log"</span>
    <span class="string">"net/http"</span>
    <span class="string">"github.com/grpc-ecosystem/grpc-gateway/v2/runtime"</span>
    <span class="string">"google.golang.org/grpc"</span>
    <span class="string">"google.golang.org/grpc/credentials/insecure"</span>
    gw <span class="string">"path/to/your/proto"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建 gRPC 连接</span>
    conn, err := grpc.<span class="function">DialContext</span>(
        context.<span class="function">Background</span>(),
        <span class="string">"localhost:50051"</span>,
        grpc.<span class="function">WithTransportCredentials</span>(insecure.<span class="function">NewCredentials</span>()),
    )
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"failed to dial server: %v"</span>, err)
    }
    
    <span class="comment">// 创建 Gateway mux</span>
    mux := runtime.<span class="function">NewServeMux</span>()
    
    <span class="comment">// 注册服务</span>
    err = gw.<span class="function">RegisterGreeterHandler</span>(context.<span class="function">Background</span>(), mux, conn)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"failed to register handler: %v"</span>, err)
    }
    
    <span class="comment">// 启动 HTTP 服务</span>
    addr := <span class="string">":8080"</span>
    log.<span class="function">Printf</span>(<span class="string">"Gateway server listening on %s"</span>, addr)
    
    <span class="keyword">if</span> err := http.<span class="function">ListenAndServe</span>(addr, mux); err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"failed to serve: %v"</span>, err)
    }
}</code></pre>
            
            <h3>添加中间件</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"log"</span>
    <span class="string">"net/http"</span>
)

<span class="comment">// CORS 中间件</span>
<span class="function">func</span> <span class="function">corsMiddleware</span>(h http.Handler) http.Handler {
    <span class="keyword">return</span> http.<span class="function">HandlerFunc</span>(<span class="keyword">func</span>(w http.ResponseWriter, r *http.Request) {
        w.<span class="function">Header</span>().<span class="function">Set</span>(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)
        w.<span class="function">Header</span>().<span class="function">Set</span>(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET, POST, PATCH, DELETE, OPTIONS"</span>)
        w.<span class="function">Header</span>().<span class="function">Set</span>(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type, Authorization"</span>)
        
        <span class="keyword">if</span> r.Method == <span class="string">"OPTIONS"</span> {
            w.<span class="function">WriteHeader</span>(http.StatusOK)
            <span class="keyword">return</span>
        }
        
        h.<span class="function">ServeHTTP</span>(w, r)
    })
}

<span class="comment">// 日志中间件</span>
<span class="function">func</span> <span class="function">loggingMiddleware</span>(h http.Handler) http.Handler {
    <span class="keyword">return</span> http.<span class="function">HandlerFunc</span>(<span class="keyword">func</span>(w http.ResponseWriter, r *http.Request) {
        log.<span class="function">Printf</span>(<span class="string">"Request: %s %s"</span>, r.Method, r.URL.Path)
        h.<span class="function">ServeHTTP</span>(w, r)
    })
}

<span class="comment">// 使用中间件</span>
<span class="function">func</span> <span class="function">main</span>() {
    mux := runtime.<span class="function">NewServeMux</span>()
    
    <span class="comment">// 使用中间件包装</span>
    handler := <span class="function">corsMiddleware</span>(<span class="function">loggingMiddleware</span>(mux))
    
    http.<span class="function">ListenAndServe</span>(<span class="string">":8080"</span>, handler)
}</code></pre>
            
            <h3>测试 API</h3>
            <pre><code><span class="comment"># GET 请求</span>
curl http://localhost:8080/v1/hello/World

<span class="comment"># POST 请求</span>
curl -X POST http://localhost:8080/v1/users \
  -H <span class="string">"Content-Type: application/json"</span> \
  -d <span class="string">'{"name": "Alice", "email": "alice@example.com"}'</span>

<span class="comment"># 查看 OpenAPI 文档</span>
curl http://localhost:8080/swagger.json</code></pre>
            </div>

            <h2 id="redis">Redis 客户端</h2>
            <p>Redis 是一个高性能的键值存储数据库，Go 中常用 go-redis 库进行操作。</p>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">go get</span> github.com/redis/go-redis/v9</code></pre>
            
            <h3>基本操作</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
    <span class="string">"github.com/redis/go-redis/v9"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// 创建客户端</span>
    rdb := redis.<span class="function">NewClient</span>(&redis.Options{
        Addr:     <span class="string">"localhost:6379"</span>,
        Password: <span class="string">""</span>,
        DB:       0,
    })
    
    ctx := context.<span class="function">Background</span>()
    
    <span class="comment">// 设置键值</span>
    err := rdb.<span class="function">Set</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>, 0).<span class="function">Err</span>()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    
    <span class="comment">// 获取键值</span>
    val, err := rdb.<span class="function">Get</span>(ctx, <span class="string">"key"</span>).<span class="function">Result</span>()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Println</span>(<span class="string">"key:"</span>, val)
    
    <span class="comment">// 设置过期时间</span>
    rdb.<span class="function">Set</span>(ctx, <span class="string">"key"</span>, <span class="string">"value"</span>, 10*time.Minute)
    
    <span class="comment">// 删除键</span>
    rdb.<span class="function">Del</span>(ctx, <span class="string">"key"</span>)
}</code></pre>
            
            <h3>数据结构操作</h3>
            <pre><code><span class="comment">// 1. Hash 操作</span>
rdb.<span class="function">HSet</span>(ctx, <span class="string">"user:1"</span>, <span class="string">"name"</span>, <span class="string">"张三"</span>)
rdb.<span class="function">HSet</span>(ctx, <span class="string">"user:1"</span>, <span class="string">"email"</span>, <span class="string">"zhangsan@example.com"</span>)
name, _ := rdb.<span class="function">HGet</span>(ctx, <span class="string">"user:1"</span>, <span class="string">"name"</span>).<span class="function">Result</span>()

<span class="comment">// 2. List 操作</span>
rdb.<span class="function">LPush</span>(ctx, <span class="string">"list"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>)
val, _ := rdb.<span class="function">RPop</span>(ctx, <span class="string">"list"</span>).<span class="function">Result</span>()

<span class="comment">// 3. Set 操作</span>
rdb.<span class="function">SAdd</span>(ctx, <span class="string">"set"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>)
members, _ := rdb.<span class="function">SMembers</span>(ctx, <span class="string">"set"</span>).<span class="function">Result</span>()

<span class="comment">// 4. Sorted Set 操作</span>
rdb.<span class="function">ZAdd</span>(ctx, <span class="string">"zset"</span>, redis.Z{Score: 1, Member: <span class="string">"a"</span>})
rdb.<span class="function">ZAdd</span>(ctx, <span class="string">"zset"</span>, redis.Z{Score: 2, Member: <span class="string">"b"</span>})
result, _ := rdb.<span class="function">ZRangeWithScores</span>(ctx, <span class="string">"zset"</span>, 0, -1).<span class="function">Result</span>()</code></pre>
            
            <h3>发布订阅</h3>
            <pre><code><span class="comment">// 发布消息</span>
err := rdb.<span class="function">Publish</span>(ctx, <span class="string">"channel"</span>, <span class="string">"message"</span>).<span class="function">Err</span>()

<span class="comment">// 订阅消息</span>
pubsub := rdb.<span class="function">Subscribe</span>(ctx, <span class="string">"channel"</span>)
<span class="keyword">defer</span> pubsub.<span class="function">Close</span>()

<span class="keyword">for</span> {
    msg, err := pubsub.<span class="function">ReceiveMessage</span>(ctx)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
    fmt.<span class="function">Println</span>(<span class="string">"收到消息:"</span>, msg.Payload)
}</code></pre>
            
            <h3>事务</h3>
            <pre><code><span class="comment">// 使用事务</span>
<span class="function">func</span> <span class="function">transfer</span>(from, to <span class="keyword">string</span>, amount <span class="keyword">int64</span>) <span class="keyword">error</span> {
    tx := rdb.<span class="function">TxPipeline</span>()
    
    err := tx.<span class="function">DecrBy</span>(ctx, from, amount).<span class="function">Err</span>()
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    
    tx.<span class="function">IncrBy</span>(ctx, to, amount)
    
    _, err = tx.<span class="function">Exec</span>(ctx)
    <span class="keyword">return</span> err
}</code></pre>
            
            <h3>Redis 最佳实践</h3>
            <div class="note-box">
                <h4>1. 连接池配置</h4>
                <pre><code>rdb := redis.<span class="function">NewClient</span>(&redis.Options{
    Addr:         <span class="string">"localhost:6379"</span>,
    Password:     <span class="string">""</span>,
    DB:           0,
    PoolSize:     10,   <span class="comment">// 连接池大小</span>
    MinIdleConns: 5,    <span class="comment">// 最小空闲连接</span>
    MaxRetries:   3,    <span class="comment">// 最大重试次数</span>
})</code></pre>
                
                <h4>2. 使用 Pipeline</h4>
                <pre><code><span class="comment">// 批量操作使用 Pipeline</span>
pipe := rdb.<span class="function">Pipeline</span>()
pipe.<span class="function">Set</span>(ctx, <span class="string">"key1"</span>, <span class="string">"value1"</span>, 0)
pipe.<span class="function">Set</span>(ctx, <span class="string">"key2"</span>, <span class="string">"value2"</span>, 0)
pipe.<span class="function">Set</span>(ctx, <span class="string">"key3"</span>, <span class="string">"value3"</span>, 0)
cmds, err := pipe.<span class="function">Exec</span>(ctx)</code></pre>
                
                <h4>3. 键命名规范</h4>
                <pre><code><span class="comment">// 使用冒号分隔的层次结构</span>
<span class="string">"user:1:name"</span>
<span class="string">"user:1:email"</span>
<span class="string">"session:abc123"</span>
<span class="string">"cache:product:123"</span></code></pre>
                
                <h4>4. 缓存策略</h4>
                <pre><code><span class="comment">// Cache-Aside 模式</span>
<span class="function">func</span> <span class="function">getUser</span>(id <span class="keyword">int64</span>) (*User, <span class="keyword">error</span>) {
    <span class="comment">// 1. 先查缓存</span>
    key := fmt.<span class="function">Sprintf</span>(<span class="string">"user:%d"</span>, id)
    val, err := rdb.<span class="function">Get</span>(ctx, key).<span class="function">Result</span>()
    <span class="keyword">if</span> err == <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="function">unmarshalUser</span>(val)
    }
    
    <span class="comment">// 2. 查数据库</span>
    user, err := db.<span class="function">GetUser</span>(id)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">nil</span>, err
    }
    
    <span class="comment">// 3. 写入缓存</span>
    data, _ := json.<span class="function">Marshal</span>(user)
    rdb.<span class="function">Set</span>(ctx, key, data, 10*time.Minute)
    
    <span class="keyword">return</span> user, <span class="keyword">nil</span>
}</code></pre>
            </div>

            <h2 id="mysql">MySQL 客户端</h2>
            <p>Go 中常用 GORM 或 database/sql 操作 MySQL 数据库。</p>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">go get</span> gorm.io/gorm
<span class="keyword">go get</span> gorm.io/driver/mysql</code></pre>
            
            <h3>连接数据库</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"gorm.io/driver/mysql"</span>
    <span class="string">"gorm.io/gorm"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    dsn := <span class="string">"user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"</span>
    db, err := gorm.<span class="function">Open</span>(mysql.<span class="function">Open</span>(dsn), &gorm.Config{})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">panic</span>(err)
    }
}</code></pre>
            
            <h3>定义模型</h3>
            <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    ID        <span class="keyword">uint</span>           <span class="string">`gorm:"primaryKey"`</span>
    Name      <span class="keyword">string</span>         <span class="string">`gorm:"size:255;not null"`</span>
    Email     <span class="keyword">string</span>         <span class="string">`gorm:"size:255;uniqueIndex"`</span>
    Age       <span class="keyword">int</span>            <span class="string">`gorm:"default:0"`</span>
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}

<span class="comment">// 自动迁移</span>
db.<span class="function">AutoMigrate</span>(&User{})</code></pre>
            
            <h3>CRUD 操作</h3>
            <pre><code><span class="comment">// 创建</span>
user := User{Name: <span class="string">"张三"</span>, Email: <span class="string">"zhangsan@example.com"</span>}
result := db.<span class="function">Create</span>(&user)

<span class="comment">// 查询</span>
<span class="keyword">var</span> user User
db.<span class="function">First</span>(&user, 1)  <span class="comment">// 根据 ID 查询</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"张三"</span>).<span class="function">First</span>(&user)
db.<span class="function">Find</span>(&users)  <span class="comment">// 查询所有</span>

<span class="comment">// 更新</span>
db.<span class="function">Model</span>(&user).<span class="function">Update</span>(<span class="string">"name"</span>, <span class="string">"李四"</span>)
db.<span class="function">Model</span>(&user).<span class="function">Updates</span>(User{Name: <span class="string">"李四"</span>, Age: 30})

<span class="comment">// 删除</span>
db.<span class="function">Delete</span>(&user)  <span class="comment">// 软删除</span>
db.<span class="function">Unscoped</span>().<span class="function">Delete</span>(&user)  <span class="comment">// 永久删除</span></code></pre>
            
            <h3>复杂查询</h3>
            <pre><code><span class="comment">// 条件查询</span>
db.<span class="function">Where</span>(<span class="string">"age > ?"</span>, 18).<span class="function">Find</span>(&users)
db.<span class="function">Where</span>(<span class="string">"name LIKE ?"</span>, <span class="string">"%张%"</span>).<span class="function">Find</span>(&users)

<span class="comment">// Or 查询</span>
db.<span class="function">Where</span>(<span class="string">"name = ?"</span>, <span class="string">"张三"</span>).<span class="function">Or</span>(<span class="string">"name = ?"</span>, <span class="string">"李四"</span>).<span class="function">Find</span>(&users)

<span class="comment">// 排序和分页</span>
db.<span class="function">Order</span>(<span class="string">"age desc"</span>).<span class="function">Offset</span>(0).<span class="function">Limit</span>(10).<span class="function">Find</span>(&users)

<span class="comment">// 统计</span>
<span class="keyword">var</span> count <span class="keyword">int64</span>
db.<span class="function">Model</span>(&User{}).<span class="function">Count</span>(&count)

<span class="comment">// 原生 SQL</span>
db.<span class="function">Raw</span>(<span class="string">"SELECT * FROM users WHERE age > ?"</span>, 18).<span class="function">Scan</span>(&users)</code></pre>
            
            <h3>事务</h3>
            <pre><code><span class="comment">// 自动事务</span>
err := db.<span class="function">Transaction</span>(<span class="keyword">func</span>(tx *gorm.DB) <span class="keyword">error</span> {
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&user1).<span class="function">Error</span>; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">if</span> err := tx.<span class="function">Create</span>(&user2).<span class="function">Error</span>; err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> err
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
})

<span class="comment">// 手动事务</span>
tx := db.<span class="function">Begin</span>()
<span class="keyword">defer</span> <span class="function">func</span>() {
    <span class="keyword">if</span> r := <span class="function">recover</span>(); r != <span class="keyword">nil</span> {
        tx.<span class="function">Rollback</span>()
    }
}()

<span class="keyword">if</span> err := tx.<span class="function">Create</span>(&user).<span class="function">Error</span>; err != <span class="keyword">nil</span> {
    tx.<span class="function">Rollback</span>()
    <span class="keyword">return</span> err
}

tx.<span class="function">Commit</span>()</code></pre>
            
            <h3>MySQL 最佳实践</h3>
            <div class="note-box">
                <h4>1. 连接池配置</h4>
                <pre><code>sqlDB, _ := db.<span class="function">DB</span>()
sqlDB.<span class="function">SetMaxIdleConns</span>(10)
sqlDB.<span class="function">SetMaxOpenConns</span>(100)
sqlDB.<span class="function">SetConnMaxLifetime</span>(time.Hour)</code></pre>
                
                <h4>2. 使用索引</h4>
                <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    Email <span class="keyword">string</span> <span class="string">`gorm:"uniqueIndex"`</span>
    Age   <span class="keyword">int</span>    <span class="string">`gorm:"index"`</span>
}</code></pre>
                
                <h4>3. 批量操作</h4>
                <pre><code><span class="comment">// 使用 CreateInBatches 批量插入</span>
users := []User{{Name: <span class="string">"a"</span>}, {Name: <span class="string">"b"</span>}, {Name: <span class="string">"c"</span>}}
db.<span class="function">CreateInBatches</span>(users, 100)</code></pre>
                
                <h4>4. 预加载避免 N+1</h4>
                <pre><code><span class="comment">// 使用 Preload 预加载关联</span>
db.<span class="function">Preload</span>(<span class="string">"Orders"</span>).<span class="function">Find</span>(&users)</code></pre>
                
                <h4>5. 使用软删除</h4>
                <pre><code><span class="keyword">type</span> User <span class="keyword">struct</span> {
    DeletedAt gorm.DeletedAt <span class="string">`gorm:"index"`</span>
}</code></pre>
            </div>

            <h3>集成最佳实践</h3>
            <div class="example-box">
                <h4>完整的数据访问层</h4>
                <pre><code><span class="keyword">type</span> UserRepository <span class="keyword">interface</span> {
    <span class="function">Create</span>(user *User) <span class="keyword">error</span>
    <span class="function">GetByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>)
    <span class="function">GetByEmail</span>(email <span class="keyword">string</span>) (*User, <span class="keyword">error</span>)
    <span class="function">Update</span>(user *User) <span class="keyword">error</span>
    <span class="function">Delete</span>(id <span class="keyword">uint</span>) <span class="keyword">error</span>
}

<span class="keyword">type</span> userRepository <span class="keyword">struct</span> {
    db *gorm.DB
}

<span class="function">func</span> <span class="function">NewUserRepository</span>(db *gorm.DB) UserRepository {
    <span class="keyword">return</span> &userRepository{db: db}
}

<span class="function">func</span> (r *userRepository) <span class="function">GetByID</span>(id <span class="keyword">uint</span>) (*User, <span class="keyword">error</span>) {
    <span class="keyword">var</span> user User
    err := r.db.<span class="function">First</span>(&user, id).<span class="function">Error</span>
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">nil</span>, err
    }
    <span class="keyword">return</span> &user, <span class="keyword">nil</span>
}</code></pre>
            </div>
<h3>总结</h3>
            <div class="example-box">
                <p>本章介绍了 Go 语言生态中更多重要的社区库：</p>
                <ul>
                    <li><strong>Validator</strong>：强大的参数校验库，支持多种校验规则和自定义规则</li>
                    <li><strong>Cobra</strong>：功能丰富的命令行框架，适合构建 CLI 应用</li>
                    <li><strong>Go-Micro</strong>：微服务框架，提供服务发现、RPC 通信等功能</li>
                    <li><strong>Etcd</strong>：分布式键值存储，用于配置管理和服务发现</li>
                    <li><strong>YAML</strong>：配置文件处理库，支持 YAML 格式的读取、写入和序列化</li>
                    <li><strong>Sonyflake</strong>：分布式唯一 ID 生成器，基于 Snowflake 算法优化</li>
                    <li><strong>jinzhu/now</strong>：轻量级时间工具库，提供丰富的时间处理功能</li>
                </ul>
                <p>这些库在构建企业级应用时非常有用，掌握它们可以帮助您构建高性能、可扩展的微服务架构。</p>
            </div>
        </div>
    </div>
<script src="code-collapse.js"></script>

</body>
    <script src="navigation.js"></script>
</html>