<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gRPC RPC框架 - Go 学习教程</title>
    <link rel="stylesheet" href="styles.css?v=1.3">
    <script src="navigation.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- 导航栏将通过JavaScript动态加载 -->
    </aside>
        <div class="content">
            <a href="ecosystem.html" class="back-link">← 返回社区库</a>
            <h2 id="grpc">gRPC RPC框架</h2>
            <p>gRPC 是 Google 开发的高性能、开源的通用 RPC 框架，基于 HTTP/2 和 Protocol Buffers。它支持多种语言，提供了简单、高效的远程调用方式，广泛应用于微服务架构中。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>基于 HTTP/2</strong>：支持双向流、多路复用、头部压缩</li>
                <li><strong>使用 Protobuf</strong>：高效的二进制序列化格式</li>
                <li><strong>多语言支持</strong>：支持 Go、Java、Python、C++ 等多种语言</li>
                <li><strong>四种服务方法</strong>：一元调用、服务端流、客户端流、双向流</li>
                <li><strong>拦截器</strong>：支持请求拦截和响应处理</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get -u google.golang.org/grpc
<span class="keyword">go</span> install google.golang.org/protobuf/cmd/protoc-gen-go@latest
<span class="keyword">go</span> install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></pre>
            
            <h3>定义服务</h3>
            <pre><code>syntax = <span class="string">"proto3"</span>;

<span class="keyword">package</span> example;

<span class="keyword">option</span> go_package = <span class="string">"./example"</span>;

<span class="keyword">service</span> Greeter {
    <span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) {}
    <span class="keyword">rpc</span> SayHelloStream (HelloRequest) <span class="keyword">returns</span> (stream HelloReply) {}
}

<span class="keyword">message</span> HelloRequest {
    <span class="keyword">string</span> name = 1;
}

<span class="keyword">message</span> HelloReply {
    <span class="keyword">string</span> message = 1;
}</code></pre>
            
            <h3>实现服务端</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"log"</span>
    <span class="string">"net"</span>
    <span class="string">"google.golang.org/grpc"</span>
    pb <span class="string">"path/to/your/proto"</span>
)

<span class="keyword">type</span> server <span class="keyword">struct</span> {
    pb.UnimplementedGreeterServer
}

<span class="function">func</span> (s *server) <span class="function">SayHello</span>(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, <span class="keyword">error</span>) {
    log.<span class="function">Printf</span>(<span class="string">"Received: %v"</span>, in.GetName())
    <span class="keyword">return</span> &pb.HelloReply{Message: <span class="string">"Hello "</span> + in.GetName()}, <span class="keyword">nil</span>
}

<span class="function">func</span> (s *server) <span class="function">SayHelloStream</span>(in *pb.HelloRequest, stream pb.Greeter_SayHelloStreamServer) <span class="keyword">error</span> {
    <span class="keyword">for</span> i := <span class="number">0</span>; i < <span class="number">5</span>; i++ {
        stream.<span class="function">Send</span>(&pb.HelloReply{
            Message: <span class="string">"Hello "</span> + in.GetName() + <span class="string">" "</span> + string(rune(<span class="string">'0'</span>+i)),
        })
    }
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    lis, err := net.<span class="function">Listen</span>(<span class="string">"tcp"</span>, <span class="string">":50051"</span>)
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"failed to listen: %v"</span>, err)
    }
    
    s := grpc.<span class="function">NewServer</span>()
    pb.<span class="function">RegisterGreeterServer</span>(s, &server{})
    
    log.<span class="function">Printf</span>(<span class="string">"server listening at %v"</span>, lis.<span class="function">Addr</span>())
    <span class="keyword">if</span> err := s.<span class="function">Serve</span>(lis); err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"failed to serve: %v"</span>, err)
    }
}</code></pre>
            
            <h3>实现客户端</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"io"</span>
    <span class="string">"log"</span>
    <span class="string">"time"</span>
    <span class="string">"google.golang.org/grpc"</span>
    <span class="string">"google.golang.org/grpc/credentials/insecure"</span>
    pb <span class="string">"path/to/your/proto"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    conn, err := grpc.<span class="function">Dial</span>(<span class="string">"localhost:50051"</span>, grpc.<span class="function">WithTransportCredentials</span>(insecure.<span class="function">NewCredentials</span>()))
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"did not connect: %v"</span>, err)
    }
    <span class="keyword">defer</span> conn.<span class="function">Close</span>()
    
    c := pb.<span class="function">NewGreeterClient</span>(conn)
    
    <span class="comment">// 一元调用</span>
    ctx, cancel := context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), time.Second)
    <span class="keyword">defer</span> cancel()
    
    r, err := c.<span class="function">SayHello</span>(ctx, &pb.HelloRequest{Name: <span class="string">"World"</span>})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"could not greet: %v"</span>, err)
    }
    log.<span class="function">Printf</span>(<span class="string">"Greeting: %s"</span>, r.GetMessage())
    
    <span class="comment">// 流式调用</span>
    stream, err := c.<span class="function">SayHelloStream</span>(ctx, &pb.HelloRequest{Name: <span class="string">"Stream"</span>})
    <span class="keyword">if</span> err != <span class="keyword">nil</span> {
        log.<span class="function">Fatalf</span>(<span class="string">"could not stream: %v"</span>, err)
    }
    
    <span class="keyword">for</span> {
        reply, err := stream.<span class="function">Recv</span>()
        <span class="keyword">if</span> err == io.EOF {
            <span class="keyword">break</span>
        }
        <span class="keyword">if</span> err != <span class="keyword">nil</span> {
            log.<span class="function">Fatalf</span>(<span class="string">"failed to recv: %v"</span>, err)
        }
        log.<span class="function">Printf</span>(<span class="string">"Stream reply: %s"</span>, reply.GetMessage())
    }
}</code></pre>
        </div>
    </div>
</body>
</html>