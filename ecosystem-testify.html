<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testify 测试框架 - Go 学习教程</title>
    <link rel="stylesheet" href="styles.css?v=1.3">
    </head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- 导航栏将通过JavaScript动态加载 -->
    </aside>
        <div class="content">
            <a href="ecosystem.html" class="back-link">← 返回社区库</a>
            <h2 id="testify">Testify 测试框架</h2>
            <p>Testify 是一个 Go 语言流行的测试工具包，提供了断言、模拟（Mock）、套件（Suite）等功能，让编写测试更加简单和强大。它提供了丰富的断言方法、模拟对象和测试套件功能，是 Go 测试生态中不可或缺的工具。</p>
            
            <h3>核心特性</h3>
            <ul>
                <li><strong>丰富的断言</strong>：提供大量断言方法，简化测试代码</li>
                <li><strong>模拟对象</strong>：支持创建 Mock 对象，便于测试依赖</li>
                <li><strong>测试套件</strong>：支持测试套件和生命周期管理</li>
                <li><strong>HTTP 测试</strong>：提供 HTTP 请求/响应的断言和模拟</li>
                <li><strong>易于集成</strong>：与 Go 标准测试框架无缝集成</li>
                <li><strong>清晰的错误信息</strong>：提供详细的错误报告和堆栈跟踪</li>
            </ul>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/stretchr/testify</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> math

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestAdd</span>(t *testing.T) {
    result := <span class="function">Add</span>(2, 3)
    assert.<span class="function">Equal</span>(t, 5, result, <span class="string">"2 + 3 应该等于 5"</span>)
}</code></pre>
            
            <h3>常用功能</h3>
            
            <h4>1. 基本断言</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestAssertions</span>(t *testing.T) {
    <span class="comment">// 相等断言</span>
    assert.<span class="function">Equal</span>(t, <span class="string">"hello"</span>, <span class="string">"hello"</span>)
    assert.<span class="function">NotEqual</span>(t, <span class="string">"hello"</span>, <span class="string">"world"</span>)
    
    <span class="comment">// 布尔断言</span>
    assert.<span class="function">True</span>(t, <span class="keyword">true</span>)
    assert.<span class="function">False</span>(t, <span class="keyword">false</span>)
    
    <span class="comment">// 数值断言</span>
    assert.<span class="function">Equal</span>(t, 42, 42)
    assert.<span class="function">NotEqual</span>(t, 42, 43)
    
    <span class="comment">// nil 断言</span>
    <span class="keyword">var</span> ptr *<span class="keyword">int</span>
    assert.<span class="function">Nil</span>(t, ptr)
    assert.<span class="function">NotNil</span>(t, &ptr)
    
    <span class="comment">// 错误断言</span>
    err := <span class="function">someFunction</span>()
    assert.<span class="function">NoError</span>(t, err)
    assert.<span class="function">Error</span>(t, err)
}</code></pre>
            
            <h4>2. 集合断言</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestCollectionAssertions</span>(t *testing.T) {
    <span class="comment">// 切片断言</span>
    slice := []<span class="keyword">int</span>{1, 2, 3}
    assert.<span class="function">Contains</span>(t, slice, 2)
    assert.<span class="function">NotContains</span>(t, slice, 4)
    assert.<span class="function">Len</span>(t, slice, 3)
    assert.<span class="function">Empty</span>(t, []<span class="keyword">int</span>{})
    assert.<span class="function">NotEmpty</span>(t, slice)
    
    <span class="comment">// Map 断言</span>
    m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>{<span class="string">"a"</span>: 1, <span class="string">"b"</span>: 2}
    assert.<span class="function">ContainsKey</span>(t, m, <span class="string">"a"</span>)
    assert.<span class="function">NotContainsKey</span>(t, m, <span class="string">"c"</span>)
    assert.<span class="function">Len</span>(t, m, 2)
}</code></pre>
            
            <h4>3. 对象断言</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="keyword">type</span> User <span class="keyword">struct</span> {
    Name <span class="keyword">string</span>
    Age  <span class="keyword">int</span>
}

<span class="function">func</span> <span class="function">TestObjectAssertions</span>(t *testing.T) {
    user1 := User{Name: <span class="string">"Alice"</span>, Age: 30}
    user2 := User{Name: <span class="string">"Alice"</span>, Age: 30}
    user3 := User{Name: <span class="string">"Bob"</span>, Age: 25}
    
    <span class="comment">// 对象相等断言</span>
    assert.<span class="function">Equal</span>(t, user1, user2)
    assert.<span class="function">NotEqual</span>(t, user1, user3)
    
    <span class="comment">// 指针断言</span>
    ptr1 := &user1
    ptr2 := &user2
    assert.<span class="function">Same</span>(t, ptr1, ptr1)
    assert.<span class="function">NotSame</span>(t, ptr1, ptr2)
    
    <span class="comment">// 类型断言</span>
    <span class="keyword">var</span> <span class="keyword">interface</span>{} = user1
    assert.<span class="function">IsType</span>(t, User{}, <span class="keyword">interface</span>{})
    assert.<span class="function">Implements</span>(t, (*<span class="keyword">interface</span>{})(<span class="keyword">nil</span>), user1)
}</code></pre>
            
            <h4>4. Mock 对象</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="string">"github.com/stretchr/testify/mock"</span>
)

<span class="comment">// 定义接口</span>
<span class="keyword">type</span> Database <span class="keyword">interface</span> {
    <span class="function">GetUser</span>(id <span class="keyword">int</span>) (*User, <span class="keyword">error</span>)
    <span class="function">SaveUser</span>(user *User) <span class="keyword">error</span>
}

<span class="comment">// 创建 Mock</span>
<span class="keyword">type</span> MockDatabase <span class="keyword">struct</span> {
    mock.Mock
}

<span class="function">func</span> (m *MockDatabase) <span class="function">GetUser</span>(id <span class="keyword">int</span>) (*User, <span class="keyword">error</span>) {
    args := m.<span class="function">Called</span>(id)
    <span class="keyword">if</span> args.Get(0) == <span class="keyword">nil</span> {
        <span class="keyword">return</span> <span class="keyword">nil</span>, args.<span class="function">Error</span>(1)
    }
    <span class="keyword">return</span> args.Get(0).(*User), args.<span class="function">Error</span>(1)
}

<span class="function">func</span> (m *MockDatabase) <span class="function">SaveUser</span>(user *User) <span class="keyword">error</span> {
    args := m.<span class="function">Called</span>(user)
    <span class="keyword">return</span> args.<span class="function">Error</span>(0)
}

<span class="function">func</span> <span class="function">TestUserService</span>(t *testing.T) {
    <span class="comment">// 创建 Mock 对象</span>
    mockDB := <span class="keyword">new</span>(MockDatabase)
    
    <span class="comment">// 设置期望</span>
    mockDB.<span class="function">On</span>(<span class="string">"GetUser"</span>, 1).<span class="function">Return</span>(&User{Name: <span class="string">"Alice"</span>}, <span class="keyword">nil</span>)
    mockDB.<span class="function">On</span>(<span class="string">"SaveUser"</span>, mock.Anything).<span class="function">Return</span>(<span class="keyword">nil</span>)
    
    <span class="comment">// 使用 Mock 进行测试</span>
    user, err := mockDB.<span class="function">GetUser</span>(1)
    assert.<span class="function">NoError</span>(t, err)
    assert.<span class="function">Equal</span>(t, <span class="string">"Alice"</span>, user.Name)
    
    err = mockDB.<span class="function">SaveUser</span>(&User{Name: <span class="string">"Bob"</span>})
    assert.<span class="function">NoError</span>(t, err)
    
    <span class="comment">// 验证期望</span>
    mockDB.<span class="function">AssertExpectations</span>(t)
}</code></pre>
            
            <h4>5. 测试套件</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/suite"</span>
)

<span class="keyword">type</span> CalculatorTestSuite <span class="keyword">struct</span> {
    suite.Suite
    calc *Calculator
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">SetupTest</span>() {
    <span class="comment">// 每个测试前执行</span>
    suite.calc = <span class="function">NewCalculator</span>()
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TearDownTest</span>() {
    <span class="comment">// 每个测试后执行</span>
    suite.calc = <span class="keyword">nil</span>
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">SetupSuite</span>() {
    <span class="comment">// 套件开始前执行</span>
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TearDownSuite</span>() {
    <span class="comment">// 套件结束后执行</span>
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TestAdd</span>() {
    result := suite.calc.<span class="function">Add</span>(2, 3)
    suite.<span class="function">Equal</span>(5, result)
}

<span class="function">func</span> (suite *CalculatorTestSuite) <span class="function">TestSubtract</span>() {
    result := suite.calc.<span class="function">Subtract</span>(5, 3)
    suite.<span class="function">Equal</span>(2, result)
}

<span class="function">func</span> <span class="function">TestCalculatorTestSuite</span>(t *testing.T) {
    suite.<span class="function">Run</span>(t, <span class="keyword">new</span>(CalculatorTestSuite))
}</code></pre>
            
            <h4>6. HTTP 测试</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"net/http"</span>
    <span class="string">"net/http/httptest"</span>
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="string">"github.com/stretchr/testify/http"</span>
)

<span class="function">func</span> <span class="function">TestHTTPHandler</span>(t *testing.T) {
    <span class="comment">// 创建测试服务器</span>
    router := <span class="function">SetupRouter</span>()
    w := httptest.<span class="function">NewRecorder</span>()
    req, _ := http.<span class="function">NewRequest</span>(<span class="string">"GET"</span>, <span class="string">"/users/1"</span>, <span class="keyword">nil</span>)
    
    <span class="comment">// 执行请求</span>
    router.<span class="function">ServeHTTP</span>(w, req)
    
    <span class="comment">// 断言响应</span>
    assert.<span class="function">Equal</span>(t, http.StatusOK, w.Code)
    assert.<span class="function">JSONEq</span>(t, <span class="string">`{"id":1,"name":"Alice"}`</span>, w.Body.<span class="function">String</span>())
    
    <span class="comment">// 使用 httpassert</span>
    http.<span class="function">AssertSuccess</span>(t, w.Code)
    http.<span class="function">AssertJSONPath</span>(t, w, <span class="string">"$.name"</span>, <span class="string">"Alice"</span>)
}</code></pre>
            
            <h3>最佳实践</h3>
            
            <h4>1. 测试组织</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="comment">// 使用子测试组织测试</span>
<span class="function">func</span> <span class="function">TestCalculator</span>(t *testing.T) {
    t.<span class="function">Run</span>(<span class="string">"Add"</span>, <span class="function">func</span>(t *testing.T) {
        calc := <span class="function">NewCalculator</span>()
        result := calc.<span class="function">Add</span>(2, 3)
        assert.<span class="function">Equal</span>(t, 5, result)
    })
    
    t.<span class="function">Run</span>(<span class="string">"Subtract"</span>, <span class="function">func</span>(t *testing.T) {
        calc := <span class="function">NewCalculator</span>()
        result := calc.<span class="function">Subtract</span>(5, 3)
        assert.<span class="function">Equal</span>(t, 2, result)
    })
}</code></pre>
            
            <h4>2. 表驱动测试</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="function">func</span> <span class="function">TestAdd</span>(t *testing.T) {
    tests := []<span class="keyword">struct</span> {
        name     <span class="keyword">string</span>
        a, b     <span class="keyword">int</span>
        expected <span class="keyword">int</span>
    }{
        {<span class="string">"positive"</span>, 2, 3, 5},
        {<span class="string">"negative"</span>, -2, -3, -5},
        {<span class="string">"mixed"</span>, 2, -3, -1},
        {<span class="string">"zero"</span>, 0, 0, 0},
    }
    
    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests {
        t.<span class="function">Run</span>(tt.name, <span class="function">func</span>(t *testing.T) {
            result := <span class="function">Add</span>(tt.a, tt.b)
            assert.<span class="function">Equal</span>(t, tt.expected, result, <span class="string">"Add(%d, %d) = %d; want %d"</span>, tt.a, tt.b, result, tt.expected)
        })
    }
}</code></pre>
            
            <h4>3. 测试覆盖率</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
)

<span class="comment">// 测试所有分支</span>
<span class="function">func</span> <span class="function">TestDivide</span>(t *testing.T) {
    <span class="comment">// 正常情况</span>
    result, err := <span class="function">Divide</span>(10, 2)
    assert.<span class="function">Equal</span>(t, 5, result)
    assert.<span class="function">NoError</span>(t, err)
    
    <span class="comment">// 除零错误</span>
    result, err = <span class="function">Divide</span>(10, 0)
    assert.<span class="function">Zero</span>(t, result)
    assert.<span class="function">Error</span>(t, err)
    
    <span class="comment">// 负数除法</span>
    result, err = <span class="function">Divide</span>(-10, 2)
    assert.<span class="function">Equal</span>(t, -5, result)
    assert.<span class="function">NoError</span>(t, err)
}</code></pre>
            
            <h4>4. Mock 最佳实践</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="keyword">"github.com/stretchr/testify/mock"</span>
)

<span class="function">func</span> <span class="function">TestWithProperMocking</span>(t *testing.T) {
    mockDB := <span class="keyword">new</span>(MockDatabase)
    
    <span class="comment">// 明确设置期望</span>
    mockDB.<span class="function">On</span>(<span class="string">"GetUser"</span>, 1).<span class="function">Return</span>(&User{Name: <span class="string">"Alice"</span>}, <span class="keyword">nil</span>).<span class="function">Once</span>()
    
    <span class="comment">// 执行测试</span>
    user, err := mockDB.<span class="function">GetUser</span>(1)
    assert.<span class="function">NoError</span>(t, err)
    assert.<span class="function">Equal</span>(t, <span class="string">"Alice"</span>, user.Name)
    
    <span class="comment">// 验证所有期望都被满足</span>
    mockDB.<span class="function">AssertExpectations</span>(t)
    
    <span class="comment">// 测试错误情况</span>
    mockDB.<span class="function">On</span>(<span class="string">"GetUser"</span>, 999).<span class="function">Return</span>(<span class="keyword">nil</span>, assert.AnError).<span class="function">Once</span>()
    
    user, err = mockDB.<span class="function">GetUser</span>(999)
    assert.<span class="function">Nil</span>(t, user)
    assert.<span class="function">Error</span>(t, err)
    
    mockDB.<span class="function">AssertExpectations</span>(t)
}</code></pre>
            
            <h4>5. 测试辅助函数</h4>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"testing"</span>
    <span class="string">"github.com/stretchr/testify/assert"</span>
    <span class="string">"github.com/stretchr/testify/require"</span>
)

<span class="comment">// 辅助函数创建测试数据</span>
<span class="function">func</span> <span class="function">createTestUser</span>(name <span class="keyword">string</span>, age <span class="keyword">int</span>) *User {
    <span class="keyword">return</span> &User{
        Name: name,
        Age:  age,
        ID:   <span class="function">generateTestID</span>(),
    }
}

<span class="function">func</span> <span class="function">generateTestID</span>() <span class="keyword">int</span> {
    <span class="keyword">return</span> 42
}

<span class="function">func</span> <span class="function">TestWithHelpers</span>(t *testing.T) {
    <span class="comment">// 使用 require 立即失败</span>
    user := <span class="function">createTestUser</span>(<span class="string">"Alice"</span>, 30)
    require.<span class="function">NotNil</span>(t, user)
    
    <span class="comment">// 使用 assert 继续执行</span>
    assert.<span class="function">Equal</span>(t, <span class="string">"Alice"</span>, user.Name)
    assert.<span class="function">Equal</span>(t, 30, user.Age)
}</code></pre>
            
            <h3>使用场景</h3>
            <ul>
                <li><strong>单元测试</strong>：编写简洁易读的单元测试</li>
                <li><strong>集成测试</strong>：使用 Mock 对象隔离依赖</li>
                <li><strong>API 测试</strong>：测试 HTTP API 的响应</li>
                <li><strong>数据库测试</strong>：使用 Mock 数据库进行测试</li>
                <li><strong>并发测试</strong>：测试并发场景和竞态条件</li>
            </ul>
            
            <h3>注意事项</h3>
            <ul>
                <li>Mock 对象应该明确设置期望和返回值</li>
                <li>使用 require 断言立即失败，使用 assert 断言继续执行</li>
                <li>测试应该独立，不依赖执行顺序</li>
                <li>测试应该快速，避免使用 sleep 等延迟</li>
                <li>使用表驱动测试提高测试覆盖率</li>
                <li>定期检查测试覆盖率，确保代码质量</li>
            </ul>
        </div>
    </div>
<script src="code-collapse.js"></script>

</body>
    <script src="navigation.js"></script>
</html>