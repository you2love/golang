<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¶å‘ - Go å­¦ä¹ æ•™ç¨‹</title>
    <link rel="stylesheet" href="styles.css?v=1.3">
    <script src="scroll.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h3>ğŸ“š å­¦ä¹ ç›®å½•</h3>
            <ul>
                <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
                
                                <li class="level-1">
                    <span class="level-badge">é˜¶æ®µä¸€ï¼šå…¥é—¨</span>
                </li>
                <li class="nav-item">
                    <a href="introduction.html"><span>ğŸ“– 1. Go è¯­è¨€ç®€ä»‹</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="introduction.html#history">Go çš„å†å²</a></li>
                        <li><a href="introduction.html#features">Go çš„ç‰¹ç‚¹</a></li>
                        <li><a href="introduction.html#install">å®‰è£…ä¸é…ç½®</a></li>
                        <li><a href="introduction.html#helloworld">Hello World</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="basics.html"><span>ğŸ”¤ 2. åŸºç¡€è¯­æ³•</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="basics.html#variables">å˜é‡å£°æ˜</a></li>
                        <li><a href="basics.html#datatypes">æ•°æ®ç±»å‹</a></li>
                        <li><a href="basics.html#operators">è¿ç®—ç¬¦</a></li>
                        <li><a href="basics.html#arrays">æ•°ç»„ä¸åˆ‡ç‰‡</a></li>
                        <li><a href="basics.html#maps">æ˜ å°„</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="control-flow.html"><span>ğŸ”„ 3. æ§åˆ¶æµ</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="control-flow.html#if">if è¯­å¥</a></li>
                        <li><a href="control-flow.html#switch">switch è¯­å¥</a></li>
                        <li><a href="control-flow.html#for">for å¾ªç¯</a></li>
                        <li><a href="control-flow.html#defer">defer è¯­å¥</a></li>
                    </ul>
                </li>
                <li class="level-1">
                    <span class="level-badge">é˜¶æ®µäºŒï¼šè¿›é˜¶</span>
                </li>
                <li class="nav-item">
                    <a href="functions.html"><span>âš¡ 4. å‡½æ•°</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="functions.html#basic">åŸºæœ¬å‡½æ•°</a></li>
                        <li><a href="functions.html#multiple">å¤šè¿”å›å€¼</a></li>
                        <li><a href="functions.html#variadic">å¯å˜å‚æ•°</a></li>
                        <li><a href="functions.html#closure">é—­åŒ…</a></li>
                        <li><a href="functions.html#methods">æ–¹æ³•</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="structs.html"><span>ğŸ—ï¸ 5. ç»“æ„ä½“ä¸æ¥å£</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="structs.html#struct">ç»“æ„ä½“</a></li>
                        <li><a href="structs.html#nested">åµŒå¥—ç»“æ„ä½“</a></li>
                        <li><a href="structs.html#methods">ç»“æ„ä½“æ–¹æ³•</a></li>
                        <li><a href="structs.html#interface">æ¥å£</a></li>
                        <li><a href="structs.html#tags">ç»“æ„ä½“æ ‡ç­¾</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="modules.html"><span>ğŸ“¦ 6. æ¨¡å—åŒ–ä¸ Go Module</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="modules.html#introduction">Go Module ç®€ä»‹</a></li>
                        <li><a href="modules.html#init">åˆå§‹åŒ– Module</a></li>
                        <li><a href="modules.html#dependency">ä¾èµ–ç®¡ç†</a></li>
                        <li><a href="modules.html#version">ç‰ˆæœ¬æ§åˆ¶</a></li>
                        <li><a href="modules.html#private">ç§æœ‰ Module</a></li>
                    </ul>
                </li>
                <li class="level-1">
                    <span class="level-badge">é˜¶æ®µä¸‰ï¼šé«˜çº§</span>
                </li>
                <li class="nav-item">
                    <a href="concurrency.html"><span>ğŸš€ 7. å¹¶å‘ç¼–ç¨‹</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="concurrency.html#goroutine">Goroutine</a></li>
                        <li><a href="concurrency.html#channel">Channel</a></li>
                        <li><a href="concurrency.html#select">Select</a></li>
                        <li><a href="concurrency.html#mutex">äº’æ–¥é”</a></li>
                        <li><a href="concurrency.html#context">Context</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="embed.html"><span>ğŸ“ 8. Embed æ ‡å‡†åº“</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="embed.html#introduction">Embed ç®€ä»‹</a></li>
                        <li><a href="embed.html#basics">åŸºç¡€ç”¨æ³•</a></li>
                        <li><a href="embed.html#filesystem">æ–‡ä»¶ç³»ç»Ÿ</a></li>
                        <li><a href="embed.html#advanced">é«˜çº§ç”¨æ³•</a></li>
                        <li><a href="embed.html#bestpractices">æœ€ä½³å®è·µ</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="stdlib.html"><span>ğŸ“š 9. å¸¸ç”¨æ ‡å‡†åº“</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="stdlib.html#regexp">regexp æ­£åˆ™è¡¨è¾¾å¼</a></li>
                        <li><a href="stdlib.html#sync">sync å¹¶å‘åŸè¯­</a></li>
                        <li><a href="stdlib.html#json">json æ•°æ®ç¼–ç </a></li>
                        <li><a href="stdlib.html#time">time æ—¶é—´å¤„ç†</a></li>
                        <li><a href="stdlib.html#io">io è¾“å…¥è¾“å‡º</a></li>
                        <li><a href="stdlib.html#bufio">bufio ç¼“å†² I/O</a></li>
                        <li><a href="stdlib.html#exp">exp å®éªŒæ€§åº“</a></li>
                        <li><a href="stdlib.html#bestpractices">æœ€ä½³å®è·µ</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="tips.html"><span>ğŸ’¡ 10. å¸¸ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="tips.html#idioms">æƒ¯ç”¨æ¨¡å¼</a></li>
                        <li><a href="tips.html#performance">æ€§èƒ½ä¼˜åŒ–</a></li>
                        <li><a href="tips.html#error">é”™è¯¯å¤„ç†</a></li>
                        <li><a href="tips.html#testing">æµ‹è¯•æŠ€å·§</a></li>
                        <li><a href="tips.html#debug">è°ƒè¯•æŠ€å·§</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="ecosystem.html"><span>ğŸŒ 11. ç¤¾åŒºåº“</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="ecosystem.html#gin">Gin Web æ¡†æ¶</a></li>
                        <li><a href="ecosystem.html#gorm">GORM ORM</a></li>
                        <li><a href="ecosystem.html#viper">Viper é…ç½®</a></li>
                        <li><a href="ecosystem.html#zap">Zap æ—¥å¿—</a></li>
                        <li><a href="ecosystem.html#validator">Validator å‚æ•°æ ¡éªŒ</a></li>
                        <li><a href="ecosystem.html#cobra">Cobra å‘½ä»¤è¡Œå·¥å…·</a></li>
                        <li><a href="ecosystem.html#gomicro">Go-Micro å¾®æœåŠ¡</a></li>
                        <li><a href="ecosystem.html#etcd">Etcd åˆ†å¸ƒå¼å­˜å‚¨</a></li>
                        <li><a href="ecosystem.html#bestpractices">æœ€ä½³å®è·µ</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="generics.html"><span>ğŸ§© 12. æ³›å‹</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="generics.html#functions">æ³›å‹å‡½æ•°</a></li>
                        <li><a href="generics.html#types">æ³›å‹ç±»å‹</a></li>
                        <li><a href="generics.html#constraints">ç±»å‹çº¦æŸ</a></li>
                        <li><a href="generics.html#inference">ç±»å‹æ¨æ–­</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="reflection.html"><span>ğŸ” 13. åå°„</span><span class="nav-toggle">â–¼</span></a>
                    <ul class="nav-submenu">
                        <li><a href="reflection.html#typevalue">Type å’Œ Value</a></li>
                        <li><a href="reflection.html#struct">ç»“æ„ä½“åå°„</a></li>
                        <li><a href="reflection.html#modify">ä¿®æ”¹å€¼</a></li>
                        <li><a href="reflection.html#methods">è°ƒç”¨æ–¹æ³•</a></li>
                        <li><a href="reflection.html#performance">æ€§èƒ½è€ƒè™‘</a></li>
                    </ul>
                </li>

        </aside>
        <div class="content">
            <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <h1>å¹¶å‘</h1>

            <h2 id="goroutine">Goroutine</h2>
            <p>Goroutine æ˜¯ Go è¯­è¨€è½»é‡çº§çš„çº¿ç¨‹å®ç°ï¼Œç”± Go è¿è¡Œæ—¶ç®¡ç†ã€‚</p>

            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">say</span>(s <span class="keyword">string</span>) {
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {
        time.<span class="function">Sleep</span>(<span class="number">100</span> * time.Millisecond)
        fmt.<span class="function">Println</span>(s)
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// å¯åŠ¨ goroutine</span>
    <span class="keyword">go</span> <span class="function">say</span>(<span class="string">"world"</span>)
    <span class="function">say</span>(<span class="string">"hello"</span>)
}</code></pre>

            <div class="note-box">
                <h3>Goroutine å†…éƒ¨å®ç°åŸç†</h3>
                <p><strong>1. Goroutine çš„å†…éƒ¨ç»“æ„ï¼š</strong></p>
                <p>Goroutine æ˜¯ Go è¿è¡Œæ—¶ï¼ˆruntimeï¼‰ç®¡ç†çš„è½»é‡çº§çº¿ç¨‹ï¼Œå…¶å†…éƒ¨ç»“æ„åŒ…å«ï¼š</p>
                <pre><code><span class="comment">// Goroutine çš„å†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
<span class="keyword">type</span> g <span class="keyword">struct</span> {
    stack       stack   <span class="comment">// æ ˆå†…å­˜</span>
    stackguard0 uintptr <span class="comment">// æ ˆæº¢å‡ºæ£€æŸ¥</span>
    m           *m      <span class="comment">// å…³è”çš„ Mï¼ˆMachineï¼‰</span>
    sched       gobuf   <span class="comment">// è°ƒåº¦ä¿¡æ¯</span>
    goid        int64   <span class="comment">// Goroutine ID</span>
    gopc        uintptr <span class="comment">// åˆ›å»ºè¯¥ goroutine çš„ PC</span>
    startpc     uintptr <span class="comment">// goroutine å‡½æ•°çš„èµ·å§‹ PC</span>
    atomicstatus uint32 <span class="comment">// åŸå­çŠ¶æ€</span>
    goid        int64   <span class="comment">// Goroutine å”¯ä¸€æ ‡è¯†</span>
}</code></pre>

                <p><strong>2. Mï¼ˆMachineï¼‰ç»“æ„ï¼š</strong></p>
                <p>M ä»£è¡¨æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œè´Ÿè´£æ‰§è¡Œ goroutineï¼š</p>
                <pre><code><span class="comment">// M çš„å†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
<span class="keyword">type</span> m <span class="keyword">struct</span> {
    g0      *g      <span class="comment">// è°ƒåº¦ç”¨çš„ goroutine</span>
    curg    *g      <span class="comment">// å½“å‰è¿è¡Œçš„ goroutine</span>
    p       *p      <span class="comment">// å…³è”çš„ Pï¼ˆProcessorï¼‰</span>
    nextp   *p      <span class="comment">// ä¸‹ä¸€ä¸ª P</span>
    id      int64   <span class="comment">// M çš„ ID</span>
    spinning <span class="keyword">bool</span>   <span class="comment">// æ˜¯å¦åœ¨è‡ªæ—‹å¯»æ‰¾å·¥ä½œ</span>
    blocked <span class="keyword">bool</span>   <span class="comment">// æ˜¯å¦é˜»å¡</span>
}</code></pre>

                <p><strong>3. Pï¼ˆProcessorï¼‰ç»“æ„ï¼š</strong></p>
                <p>P ä»£è¡¨å¤„ç†å™¨ï¼Œç»´æŠ¤ä¸€ä¸ªæœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼š</p>
                <pre><code><span class="comment">// P çš„å†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
<span class="keyword">type</span> p <span class="keyword">struct</span> {
    id          int32
    status      uint32
    link        *p
    schedtick   uint32
    syscalltick uint32
    m           *m      <span class="comment">// å…³è”çš„ M</span>
    mcache      *mcache <span class="comment">// å†…å­˜åˆ†é…ç¼“å­˜</span>
    runqhead    uint32
    runqtail    uint32
    runq        [<span class="number">256</span>]<span class="keyword">guintptr</span> <span class="comment">// æœ¬åœ°è¿è¡Œé˜Ÿåˆ—</span>
    runnext     guintptr <span class="comment">// ä¸‹ä¸€ä¸ªè¿è¡Œçš„ goroutine</span>
}</code></pre>

                <p><strong>4. GMP è°ƒåº¦æ¨¡å‹ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"runtime"</span>
    <span class="string">"sync"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">worker</span>(id <span class="keyword">int</span>, wg *sync.WaitGroup) {
    <span class="keyword">defer</span> wg.<span class="function">Done</span>()
    fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å¼€å§‹å·¥ä½œ\n"</span>, id)
    time.<span class="function">Sleep</span>(<span class="number">100</span> * time.Millisecond)
    fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å®Œæˆå·¥ä½œ\n"</span>, id)
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// è®¾ç½®ä½¿ç”¨çš„ P æ•°é‡</span>
    runtime.<span class="function">GOMAXPROCS</span>(<span class="number">4</span>)
    
    fmt.<span class="function">Printf</span>(<span class="string">"CPU æ ¸å¿ƒæ•°: %d\n"</span>, runtime.<span class="function">NumCPU</span>())
    fmt.<span class="function">Printf</span>(<span class="string">"GOMAXPROCS: %d\n"</span>, runtime.<span class="function">GOMAXPROCS</span>(<span class="number">0</span>))
    
    <span class="keyword">var</span> wg sync.WaitGroup
    
    <span class="comment">// å¯åŠ¨å¤šä¸ª goroutine</span>
    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="function">worker</span>(i, &amp;wg)
    }
    
    wg.<span class="function">Wait</span>()
    fmt.<span class="function">Println</span>(<span class="string">"æ‰€æœ‰ worker å®Œæˆ"</span>)
}</code></pre>

                <p><strong>5. Goroutine è°ƒåº¦è¿‡ç¨‹ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"runtime"</span>
)

<span class="function">func</span> <span class="function">task</span>(id <span class="keyword">int</span>) {
    fmt.<span class="function">Printf</span>(<span class="string">"Task %d åœ¨ P%d ä¸Šè¿è¡Œ\n"</span>, id, runtime.<span class="function">GOMAXPROCS</span>(<span class="number">0</span>))
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// Goroutine è°ƒåº¦è¿‡ç¨‹ï¼š</span>
    <span class="comment">// 1. åˆ›å»º goroutineï¼šgo func() {}</span>
    <span class="comment">// 2. å°† goroutine æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼ˆP çš„ runqï¼‰</span>
    <span class="comment">// 3. M ä» P çš„ runq ä¸­è·å– goroutine æ‰§è¡Œ</span>
    <span class="comment">// 4. å¦‚æœ P çš„ runq ä¸ºç©ºï¼Œä»å…¨å±€é˜Ÿåˆ—æˆ–å…¶ä»– P çªƒå– goroutine</span>
    <span class="comment">// 5. Goroutine æ‰§è¡Œå®Œæˆæˆ–é˜»å¡ï¼ŒM ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª goroutine</span>
    
    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++ {
        <span class="keyword">go</span> <span class="function">task</span>(i)
    }
    
    <span class="comment">// ç­‰å¾… goroutine å®Œæˆ</span>
    <span class="keyword">select</span> {}
}</code></pre>

                <p><strong>6. å·¥ä½œçªƒå–ï¼ˆWork Stealingï¼‰ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"runtime"</span>
    <span class="string">"sync"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">heavyTask</span>(id <span class="keyword">int</span>, wg *sync.WaitGroup) {
    <span class="keyword">defer</span> wg.<span class="function">Done</span>()
    
    <span class="comment">// æ¨¡æ‹Ÿä¸åŒè´Ÿè½½çš„ä»»åŠ¡</span>
    duration := time.Duration(<span class="number">50</span>+id*<span class="number">10</span>) * time.Millisecond
    time.<span class="function">Sleep</span>(duration)
    
    fmt.<span class="function">Printf</span>(<span class="string">"Task %d å®Œæˆï¼Œè€—æ—¶ %v\n"</span>, id, duration)
}

<span class="function">func</span> <span class="function">main</span>() {
    runtime.<span class="function">GOMAXPROCS</span>(<span class="number">2</span>) <span class="comment">// ä½¿ç”¨ 2 ä¸ª P</span>
    
    <span class="keyword">var</span> wg sync.WaitGroup
    
    <span class="comment">// åˆ›å»ºä¸åŒè´Ÿè½½çš„ä»»åŠ¡</span>
    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="function">heavyTask</span>(i, &amp;wg)
    }
    
    wg.<span class="function">Wait</span>()
    fmt.<span class="function">Println</span>(<span class="string">"æ‰€æœ‰ä»»åŠ¡å®Œæˆ"</span>)
    
    <span class="comment">// å·¥ä½œçªƒå–æœºåˆ¶ï¼š</span>
    <span class="comment">// 1. P1 çš„ä»»åŠ¡è¾ƒå¤šï¼ŒP2 çš„ä»»åŠ¡è¾ƒå°‘</span>
    <span class="comment">// 2. P2 å®Œæˆè‡ªå·±çš„ä»»åŠ¡åï¼Œä¼šä» P1 çªƒå–ä»»åŠ¡æ‰§è¡Œ</span>
    <span class="comment">// 3. è¿™å®ç°äº†è´Ÿè½½å‡è¡¡ï¼Œå……åˆ†åˆ©ç”¨ CPU èµ„æº</span>
}</code></pre>

                <p><strong>7. Goroutine æ ˆç®¡ç†ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"runtime"</span>
)

<span class="function">func</span> <span class="function">recursive</span>(depth <span class="keyword">int</span>) {
    <span class="keyword">var</span> buf [<span class="number">1024</span>]<span class="keyword">byte</span> <span class="comment">// åˆ†é… 1KB æ ˆç©ºé—´</span>
    
    <span class="keyword">if</span> depth &lt; <span class="number">100</span> {
        fmt.<span class="function">Printf</span>(<span class="string">"é€’å½’æ·±åº¦: %d, æ ˆåœ°å€: %p\n"</span>, depth, &amp;buf)
        <span class="function">recursive</span>(depth + <span class="number">1</span>)
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    fmt.<span class="function">Printf</span>(<span class="string">"åˆå§‹æ ˆå¤§å°: %d KB\n"</span>, runtime.<span class="function">GoroutineStack</span>()/<span class="number">1024</span>)
    
    <span class="comment">// Goroutine æ ˆç®¡ç†ç‰¹ç‚¹ï¼š</span>
    <span class="comment">// 1. åˆå§‹æ ˆå¤§å°ï¼š2KBï¼ˆGo 1.4+ï¼‰</span>
    <span class="comment">// 2. åŠ¨æ€å¢é•¿ï¼šæ ˆç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨æ‰©å®¹</span>
    <span class="comment">// 3. æœ€å¤§æ ˆå¤§å°ï¼š1GBï¼ˆå¯é…ç½®ï¼‰</span>
    <span class="comment">// 4. æ ˆæ‹·è´ï¼šæ‰©å®¹æ—¶å°†æ—§æ ˆå†…å®¹æ‹·è´åˆ°æ–°æ ˆ</span>
    
    <span class="keyword">go</span> <span class="function">recursive</span>(<span class="number">0</span>)
    
    <span class="keyword">select</span> {}
}</code></pre>

                <p><strong>8. Goroutine çŠ¶æ€è½¬æ¢ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"runtime"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">demonstrateStates</span>() {
    fmt.<span class="function">Println</span>(<span class="string">"Goroutine çŠ¶æ€è½¬æ¢ï¼š"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"_Gidle: åˆšåˆ›å»ºï¼Œæœªåˆå§‹åŒ–"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"_Grunnable: åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ‰§è¡Œ"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"_Grunning: æ­£åœ¨æ‰§è¡Œ"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"_Gsyscall: æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"_Gwaiting: ç­‰å¾…ï¼ˆchannelã€sleep ç­‰ï¼‰"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"_Gdead: å·²é€€å‡º"</span>)
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="keyword">go</span> <span class="function">demonstrateStates</span>()
    
    <span class="comment">// Goroutine çŠ¶æ€è½¬æ¢ç¤ºä¾‹ï¼š</span>
    <span class="comment">// _Gidle -> _Grunnable: åˆ›å»º goroutine</span>
    <span class="comment">// _Grunnable -> _Grunning: è¢«è°ƒåº¦æ‰§è¡Œ</span>
    <span class="comment">// _Grunning -> _Gwaiting: ç­‰å¾… channel æˆ– sleep</span>
    <span class="comment">// _Gwaiting -> _Grunnable: å”¤é†’åé‡æ–°è¿›å…¥é˜Ÿåˆ—</span>
    <span class="comment">// _Grunning -> _Gdead: æ‰§è¡Œå®Œæˆ</span>
    
    time.<span class="function">Sleep</span>(<span class="number">100</span> * time.Millisecond)
}</code></pre>
            </div>

            <div class="example-box">
                <h3>Goroutine æœ€ä½³å®è·µ</h3>
                <p><strong>1. åˆç†æ§åˆ¶ Goroutine æ•°é‡ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"runtime"</span>
    <span class="string">"sync"</span>
    <span class="string">"time"</span>
)

<span class="comment">// ä½¿ç”¨ worker pool æ¨¡å¼é™åˆ¶ goroutine æ•°é‡</span>
<span class="keyword">type</span> WorkerPool <span class="keyword">struct</span> {
    tasks   <span class="keyword">chan</span> <span class="keyword">int</span>
    workers <span class="keyword">int</span>
    wg      sync.WaitGroup
}

<span class="function">func</span> <span class="function">NewWorkerPool</span>(workers <span class="keyword">int</span>) *WorkerPool {
    <span class="keyword">return</span> &amp;WorkerPool{
        tasks:   <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>),
        workers: workers,
    }
}

<span class="function">func</span> (wp *WorkerPool) <span class="function">Start</span>() {
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; wp.workers; i++ {
        wp.wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> wp.<span class="function">worker</span>(i)
    }
}

<span class="function">func</span> (wp *WorkerPool) <span class="function">worker</span>(id <span class="keyword">int</span>) {
    <span class="keyword">defer</span> wp.wg.<span class="function">Done</span>()
    <span class="keyword">for</span> task := <span class="keyword">range</span> wp.tasks {
        fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å¤„ç†ä»»åŠ¡ %d\n"</span>, id, task)
        time.<span class="function">Sleep</span>(<span class="number">100</span> * time.Millisecond)
    }
}

<span class="function">func</span> (wp *WorkerPool) <span class="function">Submit</span>(task <span class="keyword">int</span>) {
    wp.tasks &lt;- task
}

<span class="function">func</span> (wp *WorkerPool) <span class="function">Stop</span>() {
    <span class="keyword">close</span>(wp.tasks)
    wp.wg.<span class="function">Wait</span>()
}

<span class="function">func</span> <span class="function">main</span>() {
    pool := <span class="function">NewWorkerPool</span>(<span class="number">5</span>) <span class="comment">// é™åˆ¶ä¸º 5 ä¸ª worker</span>
    pool.<span class="function">Start</span>()
    
    <span class="comment">// æäº¤ 20 ä¸ªä»»åŠ¡</span>
    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++ {
        pool.<span class="function">Submit</span>(i)
    }
    
    pool.<span class="function">Stop</span>()
    fmt.<span class="function">Println</span>(<span class="string">"æ‰€æœ‰ä»»åŠ¡å®Œæˆ"</span>)
}</code></pre>

                <p><strong>2. é¿å… Goroutine æ³„éœ²ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="comment">// é”™è¯¯ç¤ºä¾‹ï¼šgoroutine æ³„éœ²</span>
<span class="function">func</span> <span class="function">leak</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        val := &lt;-ch <span class="comment">// æ°¸è¿œé˜»å¡ï¼Œgoroutine æ³„éœ²</span>
        fmt.<span class="function">Println</span>(val)
    }()
}

<span class="comment">// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ context æ§åˆ¶</span>
<span class="keyword">import</span> <span class="string">"context"</span>

<span class="function">func</span> <span class="function">noLeak</span>(ctx context.Context) {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        <span class="keyword">select</span> {
        <span class="keyword">case</span> val := &lt;-ch:
            fmt.<span class="function">Println</span>(val)
        <span class="keyword">case</span> &lt;-ctx.<span class="function">Done</span>():
            fmt.<span class="function">Println</span>(<span class="string">"goroutine è¢«å–æ¶ˆ"</span>)
            <span class="keyword">return</span>
        }
    }()
}

<span class="function">func</span> <span class="function">main</span>() {
    ctx, cancel := context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), <span class="number">2</span>*time.Second)
    <span class="keyword">defer</span> cancel()
    
    <span class="function">noLeak</span>(ctx)
    time.<span class="function">Sleep</span>(<span class="number">3</span> * time.Second)
}</code></pre>

                <p><strong>3. ä½¿ç”¨ WaitGroup ç­‰å¾… Goroutineï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"sync"</span>
)

<span class="function">func</span> <span class="function">worker</span>(id <span class="keyword">int</span>, wg *sync.WaitGroup) {
    <span class="keyword">defer</span> wg.<span class="function">Done</span>()
    fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å®Œæˆ\n"</span>, id)
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> wg sync.WaitGroup
    
    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="function">worker</span>(i, &amp;wg)
    }
    
    wg.<span class="function">Wait</span>()
    fmt.<span class="function">Println</span>(<span class="string">"æ‰€æœ‰ worker å®Œæˆ"</span>)
}</code></pre>

                <p><strong>4. ä½¿ç”¨ ErrGroup å¤„ç†é”™è¯¯ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"errors"</span>
    <span class="string">"fmt"</span>
    <span class="string">"golang.org/x/sync/errgroup"</span>
)

<span class="function">func</span> <span class="function">task</span>(name <span class="keyword">string</span>, shouldFail <span class="keyword">bool</span>) <span class="keyword">error</span> {
    fmt.<span class="function">Printf</span>(<span class="string">"Task %s å¼€å§‹\n"</span>, name)
    <span class="keyword">if</span> shouldFail {
        <span class="keyword">return</span> errors.<span class="function">New</span>(<span class="string">"task failed"</span>)
    }
    fmt.<span class="function">Printf</span>(<span class="string">"Task %s å®Œæˆ\n"</span>, name)
    <span class="keyword">return</span> <span class="keyword">nil</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> g errgroup.Group
    
    g.<span class="function">Go</span>(<span class="keyword">func</span>() <span class="keyword">error</span> {
        <span class="keyword">return</span> <span class="function">task</span>(<span class="string">"A"</span>, <span class="keyword">false</span>)
    })
    
    g.<span class="function">Go</span>(<span class="keyword">func</span>() <span class="keyword">error</span> {
        <span class="keyword">return</span> <span class="function">task</span>(<span class="string">"B"</span>, <span class="keyword">true</span>) <span class="comment">// è¿™ä¸ªä¼šå¤±è´¥</span>
    })
    
    g.<span class="function">Go</span>(<span class="keyword">func</span>() <span class="keyword">error</span> {
        <span class="keyword">return</span> <span class="function">task</span>(<span class="string">"C"</span>, <span class="keyword">false</span>)
    })
    
    <span class="keyword">if</span> err := g.<span class="function">Wait</span>(); err != <span class="keyword">nil</span> {
        fmt.<span class="function">Println</span>(<span class="string">"é”™è¯¯:"</span>, err)
    }
}</code></pre>

                <p><strong>5. ä½¿ç”¨ Channel è¿›è¡Œé€šä¿¡ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">producer</span>(ch <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>) {
    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++ {
        ch &lt;- i
        fmt.<span class="function">Printf</span>(<span class="string">"ç”Ÿäº§: %d\n"</span>, i)
        time.<span class="function">Sleep</span>(<span class="number">100</span> * time.Millisecond)
    }
    <span class="keyword">close</span>(ch)
}

<span class="function">func</span> <span class="function">consumer</span>(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>) {
    <span class="keyword">for</span> val := <span class="keyword">range</span> ch {
        fmt.<span class="function">Printf</span>(<span class="string">"æ¶ˆè´¹: %d\n"</span>, val)
        time.<span class="function">Sleep</span>(<span class="number">150</span> * time.Millisecond)
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)
    
    <span class="keyword">go</span> <span class="function">producer</span>(ch)
    <span class="keyword">go</span> <span class="function">consumer</span>(ch)
    
    time.<span class="function">Sleep</span>(<span class="number">2</span> * time.Second)
}</code></pre>

                <p><strong>6. ä½¿ç”¨ Context å–æ¶ˆ Goroutineï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">worker</span>(ctx context.Context, id <span class="keyword">int</span>) {
    <span class="keyword">for</span> {
        <span class="keyword">select</span> {
        <span class="keyword">case</span> &lt;-ctx.<span class="function">Done</span>():
            fmt.<span class="function">Printf</span>(<span class="string">"Worker %d è¢«å–æ¶ˆ\n"</span>, id)
            <span class="keyword">return</span>
        <span class="keyword">default</span>:
            fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å·¥ä½œä¸­...\n"</span>, id)
            time.<span class="function">Sleep</span>(<span class="number">500</span> * time.Millisecond)
        }
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    ctx, cancel := context.<span class="function">WithCancel</span>(context.<span class="function">Background</span>())
    
    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ {
        <span class="keyword">go</span> <span class="function">worker</span>(ctx, i)
    }
    
    time.<span class="function">Sleep</span>(<span class="number">2</span> * time.Second)
    cancel() <span class="comment">// å–æ¶ˆæ‰€æœ‰ goroutine</span>
    
    time.<span class="function">Sleep</span>(<span class="number">1</span> * time.Second)
}</code></pre>

                <p><strong>7. ä½¿ç”¨ Mutex ä¿æŠ¤å…±äº«èµ„æºï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"sync"</span>
)

<span class="keyword">type</span> Counter <span class="keyword">struct</span> {
    mu    sync.Mutex
    value <span class="keyword">int</span>
}

<span class="function">func</span> (c *Counter) <span class="function">Increment</span>() {
    c.mu.<span class="function">Lock</span>()
    <span class="keyword">defer</span> c.mu.<span class="function">Unlock</span>()
    c.value++
}

<span class="function">func</span> (c *Counter) <span class="function">Value</span>() <span class="keyword">int</span> {
    c.mu.<span class="function">Lock</span>()
    <span class="keyword">defer</span> c.mu.<span class="function">Unlock</span>()
    <span class="keyword">return</span> c.value
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> counter Counter
    <span class="keyword">var</span> wg sync.WaitGroup
    
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="keyword">func</span>() {
            <span class="keyword">defer</span> wg.<span class="function">Done</span>()
            counter.<span class="function">Increment</span>()
        }()
    }
    
    wg.<span class="function">Wait</span>()
    fmt.<span class="function">Printf</span>(<span class="string">"æœ€ç»ˆå€¼: %d\n"</span>, counter.<span class="function">Value</span>())
}</code></pre>

                <p><strong>8. æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼š</strong></p>
                <ul>
                    <li><strong>é¿å…è¿‡åº¦åˆ›å»º goroutine</strong>ï¼šä½¿ç”¨ worker pool æ¨¡å¼</li>
                    <li><strong>åˆç†è®¾ç½® GOMAXPROCS</strong>ï¼šæ ¹æ® CPU æ ¸å¿ƒæ•°è°ƒæ•´</li>
                    <li><strong>ä½¿ç”¨ç¼“å†² channel</strong>ï¼šå‡å°‘é˜»å¡</li>
                    <li><strong>é¿å…é”ç«äº‰</strong>ï¼šå°½é‡ä½¿ç”¨ channel é€šä¿¡</li>
                    <li><strong>ä½¿ç”¨ sync.Pool</strong>ï¼šé‡ç”¨å¯¹è±¡ï¼Œå‡å°‘ GC å‹åŠ›</li>
                    <li><strong>ç›‘æ§ goroutine æ•°é‡</strong>ï¼šä½¿ç”¨ runtime.NumGoroutine()</li>
                </ul>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"runtime"</span>
    <span class="string">"sync"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">monitorGoroutines</span>() {
    ticker := time.<span class="function">NewTicker</span>(<span class="number">1</span> * time.Second)
    <span class="keyword">defer</span> ticker.<span class="function">Stop</span>()
    
    <span class="keyword">for</span> <span class="keyword">range</span> ticker.C {
        fmt.<span class="function">Printf</span>(<span class="string">"å½“å‰ goroutine æ•°é‡: %d\n"</span>, runtime.<span class="function">NumGoroutine</span>())
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="keyword">go</span> <span class="function">monitorGoroutines</span>()
    
    <span class="keyword">var</span> wg sync.WaitGroup
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="keyword">func</span>() {
            <span class="keyword">defer</span> wg.<span class="function">Done</span>()
            time.<span class="function">Sleep</span>(<span class="number">2</span> * time.Second)
        }()
    }
    
    wg.<span class="function">Wait</span>()
    fmt.<span class="function">Println</span>(<span class="string">"æ‰€æœ‰ goroutine å®Œæˆ"</span>)
}</code></pre>
            </div>

            <h2 id="channel">Channel</h2>
            <p>Channel æ˜¯ goroutine ä¹‹é—´é€šä¿¡çš„ç®¡é“ã€‚</p>

            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="function">func</span> <span class="function">sum</span>(s []<span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>) {
    sum := <span class="number">0</span>
    <span class="keyword">for</span> _, v := <span class="keyword">range</span> s {
        sum += v
    }
    c &lt;- sum <span class="comment">// å°†å’Œå‘é€åˆ° channel</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    s := []<span class="keyword">int</span>{<span class="number">7</span>, <span class="number">2</span>, <span class="number">8</span>, -<span class="number">9</span>, <span class="number">4</span>, <span class="number">0</span>}

    c := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">go</span> <span class="function">sum</span>(s[:<span class="function">len</span>(s)/<span class="number">2</span>], c)
    <span class="keyword">go</span> <span class="function">sum</span>(s[<span class="function">len</span>(s)/<span class="number">2</span>:], c)
    x, y := &lt;-c, &lt;-c <span class="comment">// ä» channel æ¥æ”¶</span>

    fmt.<span class="function">Println</span>(x, y, x+y)
}</code></pre>

            <div class="note-box">
                <h3>Channel å†…éƒ¨å®ç°åŸç†</h3>
                
                <p><strong>1. Channel çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</strong></p>
                <p>Channel åœ¨ Go è¿è¡Œæ—¶ä¸­çš„æ ¸å¿ƒç»“æ„æ˜¯ <code>hchan</code>ï¼š</p>
                <pre><code><span class="comment">// runtime/chan.go - Channel çš„æ ¸å¿ƒç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
<span class="keyword">type</span> hchan <span class="keyword">struct</span> {
    qcount   uint           <span class="comment">// å½“å‰é˜Ÿåˆ—ä¸­å…ƒç´ ä¸ªæ•°</span>
    dataqsiz uint           <span class="comment">// ç¯å½¢é˜Ÿåˆ—å¤§å°ï¼ˆå®¹é‡ï¼‰</span>
    buf      unsafe.Pointer <span class="comment">// ç¯å½¢é˜Ÿåˆ—æŒ‡é’ˆ</span>
    elemsize uint16         <span class="comment">// å…ƒç´ å¤§å°</span>
    closed   uint32         <span class="comment">// channel æ˜¯å¦å…³é—­</span>
    elemtype *_type         <span class="comment">// å…ƒç´ ç±»å‹</span>
    sendx    uint           <span class="comment">// å‘é€ç´¢å¼•</span>
    recvx    uint           <span class="comment">// æ¥æ”¶ç´¢å¼•</span>
    recvq    waitq          <span class="comment">// æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—</span>
    sendq    waitq          <span class="comment">// å‘é€ç­‰å¾…é˜Ÿåˆ—</span>
    lock     mutex          <span class="comment">// äº’æ–¥é”</span>
}</code></pre>

                <p><strong>2. ç¯å½¢é˜Ÿåˆ—å®ç°ï¼š</strong></p>
                <p>Channel ä½¿ç”¨ç¯å½¢é˜Ÿåˆ—æ¥å­˜å‚¨æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å¾ªç¯ç¼“å†²åŒºï¼š</p>
                <pre><code><span class="comment">// ç¯å½¢é˜Ÿåˆ—çš„å·¥ä½œåŸç†ç¤ºä¾‹</span>
<span class="comment">// å‡è®¾å®¹é‡ä¸º 5 çš„ channel</span>

<span class="comment">// åˆå§‹çŠ¶æ€: []</span>
<span class="comment">// sendx = 0, recvx = 0</span>

<span class="comment">// å‘é€ 1, 2, 3: [1, 2, 3, _, _]</span>
<span class="comment">// sendx = 3, recvx = 0</span>

<span class="comment">// æ¥æ”¶ 2 ä¸ªå€¼: [_, _, 3, _, _]</span>
<span class="comment">// sendx = 3, recvx = 2</span>

<span class="comment">// ç»§ç»­å‘é€ 4, 5: [_, _, 3, 4, 5]</span>
<span class="comment">// sendx = 0, recvx = 2 (å¾ªç¯å›åˆ°å¼€å¤´)</span>

<span class="comment">// æ¥æ”¶ 3 ä¸ªå€¼: [_, _, _, _, _]</span>
<span class="comment">// sendx = 0, recvx = 0 (é˜Ÿåˆ—ä¸ºç©º)</span></code></pre>

                <p><strong>3. å‘é€æ“ä½œæµç¨‹ï¼š</strong></p>
                <pre><code><span class="comment">// å‘é€æ“ä½œ: ch &lt;- value</span>

<span class="comment">// æ­¥éª¤ 1: è·å– channel é”</span>
<span class="comment">// lock(&amp;c.lock)</span>

<span class="comment">// æ­¥éª¤ 2: æ£€æŸ¥æ˜¯å¦æœ‰æ¥æ”¶è€…åœ¨ç­‰å¾…</span>
<span class="keyword">if</span> sg := c.recvq.<span class="function">dequeue</span>(); sg != <span class="keyword">nil</span> {
    <span class="comment">// ç›´æ¥ä¼ é€’æ•°æ®ç»™æ¥æ”¶è€…ï¼Œä¸ç»è¿‡ç¼“å†²åŒº</span>
    <span class="function">send</span>(c, sg, ep)
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 3: å¦‚æœç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œæ”¾å…¥ç¼“å†²åŒº</span>
<span class="keyword">if</span> c.qcount &lt; c.dataqsiz {
    <span class="comment">// å°†æ•°æ®æ”¾å…¥ç¯å½¢é˜Ÿåˆ—</span>
    qp := <span class="function">chanbuf</span>(c, c.sendx)
    <span class="function">typedmemmove</span>(c.elemtype, qp, ep)
    c.sendx++
    <span class="keyword">if</span> c.sendx == c.dataqsiz {
        c.sendx = <span class="number">0</span>
    }
    c.qcount++
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 4: ç¼“å†²åŒºå·²æ»¡ï¼Œé˜»å¡å½“å‰ goroutine</span>
<span class="comment">// å°†å½“å‰ goroutine åŠ å…¥å‘é€ç­‰å¾…é˜Ÿåˆ—</span>
<span class="comment">// gopark() - è®©å‡º CPUï¼Œç­‰å¾…è¢«å”¤é†’</span></code></pre>

                <p><strong>4. æ¥æ”¶æ“ä½œæµç¨‹ï¼š</strong></p>
                <pre><code><span class="comment">// æ¥æ”¶æ“ä½œ: value := &lt;-ch</span>

<span class="comment">// æ­¥éª¤ 1: è·å– channel é”</span>
<span class="comment">// lock(&amp;c.lock)</span>

<span class="comment">// æ­¥éª¤ 2: æ£€æŸ¥æ˜¯å¦æœ‰å‘é€è€…åœ¨ç­‰å¾…</span>
<span class="keyword">if</span> sg := c.sendq.<span class="function">dequeue</span>(); sg != <span class="keyword">nil</span> {
    <span class="comment">// ç›´æ¥ä»å‘é€è€…è·å–æ•°æ®</span>
    <span class="function">recv</span>(c, sg, ep)
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 3: å¦‚æœç¼“å†²åŒºæœ‰æ•°æ®ï¼Œä»ç¼“å†²åŒºè¯»å–</span>
<span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> {
    qp := <span class="function">chanbuf</span>(c, c.recvx)
    <span class="keyword">if</span> ep != <span class="keyword">nil</span> {
        <span class="function">typedmemmove</span>(c.elemtype, ep, qp)
    }
    <span class="function">typedmemclr</span>(c.elemtype, qp)
    c.recvx++
    <span class="keyword">if</span> c.recvx == c.dataqsiz {
        c.recvx = <span class="number">0</span>
    }
    c.qcount--
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 4: ç¼“å†²åŒºä¸ºç©ºä¸”æœªå…³é—­ï¼Œé˜»å¡å½“å‰ goroutine</span>
<span class="comment">// å°†å½“å‰ goroutine åŠ å…¥æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—</span>
<span class="comment">// gopark() - è®©å‡º CPUï¼Œç­‰å¾…è¢«å”¤é†’</span></code></pre>

                <p><strong>5. å…³é—­æ“ä½œæµç¨‹ï¼š</strong></p>
                <pre><code><span class="comment">// å…³é—­æ“ä½œ: close(ch)</span>

<span class="comment">// æ­¥éª¤ 1: è·å– channel é”</span>
<span class="comment">// lock(&amp;c.lock)</span>

<span class="comment">// æ­¥éª¤ 2: æ ‡è®° channel ä¸ºå·²å…³é—­</span>
c.closed = <span class="number">1</span>

<span class="comment">// æ­¥éª¤ 3: å”¤é†’æ‰€æœ‰ç­‰å¾…çš„æ¥æ”¶è€…</span>
<span class="keyword">for</span> {
    sg := c.recvq.<span class="function">dequeue</span>()
    <span class="keyword">if</span> sg == <span class="keyword">nil</span> {
        <span class="keyword">break</span>
    }
    sg.elem = <span class="keyword">nil</span>  <span class="comment">// æ¥æ”¶è€…è·å¾—é›¶å€¼</span>
    <span class="function">goready</span>(sg.g)  <span class="comment">// å”¤é†’ goroutine</span>
}

<span class="comment">// æ­¥éª¤ 4: å”¤é†’æ‰€æœ‰ç­‰å¾…çš„å‘é€è€…ï¼ˆå®ƒä»¬ä¼š panicï¼‰</span>
<span class="keyword">for</span> {
    sg := c.sendq.<span class="function">dequeue</span>()
    <span class="keyword">if</span> sg == <span class="keyword">nil</span> {
        <span class="keyword">break</span>
    }
    sg.elem = <span class="keyword">nil</span>
    <span class="function">goready</span>(sg.g)  <span class="comment">// å”¤é†’åå‘é€è€…ä¼š panic</span>
}</code></pre>
            </div>

            <div class="example-box">
                <h3>Channel æœ€ä½³å®è·µ</h3>
                
                <p><strong>1. é€‰æ‹©åˆé€‚çš„ Channel ç±»å‹ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="comment">// æ— ç¼“å†² Channelï¼ˆåŒæ­¥ï¼‰- é€‚ç”¨äºéœ€è¦åŒæ­¥çš„åœºæ™¯</span>
<span class="function">func</span> <span class="function">synchronousExample</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        fmt.<span class="function">Println</span>(<span class="string">"å‘é€è€…: å‡†å¤‡å‘é€"</span>)
        ch &lt;- <span class="number">42</span>  <span class="comment">// é˜»å¡ç›´åˆ°æœ‰æ¶ˆè´¹è€…æ¥æ”¶</span>
        fmt.<span class="function">Println</span>(<span class="string">"å‘é€è€…: æ•°æ®å·²å‘é€"</span>)
    }()
    
    fmt.<span class="Function">Println</span>(<span class="string">"æ¥æ”¶è€…: ç­‰å¾…æ•°æ®"</span>)
    val := &lt;-ch
    fmt.<span class="function">Printf</span>(<span class="string">"æ¥æ”¶è€…: æ”¶åˆ° %d\n"</span>, val)
}

<span class="comment">// ç¼“å†² Channelï¼ˆå¼‚æ­¥ï¼‰- é€‚ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€Ÿåº¦ä¸åŒ¹é…</span>
<span class="function">func</span> <span class="function">bufferedExample</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)  <span class="comment">// ç¼“å†²å¤§å°ä¸º 3</span>
    
    <span class="comment">// å¯ä»¥å‘é€ 3 ä¸ªæ•°æ®è€Œä¸ä¼šé˜»å¡</span>
    ch &lt;- <span class="number">1</span>
    ch &lt;- <span class="number">2</span>
    ch &lt;- <span class="number">3</span>
    fmt.<span class="function">Println</span>(<span class="string">"å·²å‘é€ 3 ä¸ªæ•°æ®"</span>)
    
    fmt.<span class="function">Println</span>(&lt;-ch)
    fmt.<span class="function">Println</span>(&lt;-ch)
    fmt.<span class="function">Println</span>(&lt;-ch)
}</code></pre>

                <p><strong>2. é¿å… Goroutine æ³„éœ²ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="comment">// é”™è¯¯ç¤ºä¾‹ï¼šgoroutine æ³„éœ²</span>
<span class="function">func</span> <span class="function">leakExample</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        val := &lt;-ch  <span class="comment">// æ°¸è¿œé˜»å¡ï¼Œgoroutine æ³„éœ²</span>
        fmt.<span class="function">Println</span>(val)
    }()
    <span class="comment">// å¦‚æœ ch æ°¸è¿œä¸å‘é€æ•°æ®ï¼Œgoroutine æ°¸ä¸é€€å‡º</span>
}

<span class="comment">// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ context æ§åˆ¶</span>
<span class="function">func</span> <span class="function">noLeakExample</span>() {
    ctx, cancel := context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), <span class="number">2</span>*time.Second)
    <span class="keyword">defer</span> cancel()
    
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        <span class="keyword">select</span> {
        <span class="keyword">case</span> val := &lt;-ch:
            fmt.<span class="function">Println</span>(val)
        <span class="keyword">case</span> &lt;-ctx.<span class="function">Done</span>():
            fmt.<span class="function">Println</span>(<span class="string">"goroutine è¢«å–æ¶ˆ"</span>)
            <span class="keyword">return</span>
        }
    }()
}</code></pre>

                <p><strong>3. æ­£ç¡®å…³é—­ Channelï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="comment">// åŸåˆ™ï¼šåªåœ¨å‘é€æ–¹å…³é—­ channelï¼Œä¸è¦åœ¨æ¥æ”¶æ–¹å…³é—­</span>
<span class="function">func</span> <span class="function">producer</span>(ch <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>) {
    <span class="keyword">defer</span> <span class="keyword">close</span>(ch)  <span class="comment">// å‘é€å®Œæˆåå…³é—­</span>
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {
        ch &lt;- i
    }
}

<span class="function">func</span> <span class="function">consumer</span>(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>) {
    <span class="keyword">for</span> v := <span class="keyword">range</span> ch {  <span class="comment">// è‡ªåŠ¨æ£€æµ‹ channel å…³é—­</span>
        fmt.<span class="function">Println</span>(v)
    }
    fmt.<span class="function">Println</span>(<span class="string">"channel å·²å…³é—­"</span>)
}

<span class="comment">// ä½¿ç”¨æ–¹å‘æ€§ channel</span>
<span class="function">func</span> <span class="function">directionalExample</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">go</span> <span class="function">producer</span>(ch)
    <span class="function">consumer</span>(ch)
}</code></pre>

                <p><strong>4. å¤„ç† Channel å…³é—­åçš„é›¶å€¼ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="function">func</span> <span class="function">safeReceive</span>(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>) (int, bool) {
    v, ok := &lt;-ch
    <span class="keyword">if</span> !ok {
        <span class="comment">// channel å·²å…³é—­ï¼Œv æ˜¯é›¶å€¼</span>
        fmt.<span class="function">Println</span>(<span class="string">"channel å·²å…³é—­"</span>)
        <span class="keyword">return</span> <span class="number">0</span>, <span class="keyword">false</span>
    }
    <span class="keyword">return</span> v, <span class="keyword">true</span>
}</code></pre>

                <p><strong>5. ä½¿ç”¨ Select å®ç°è¶…æ—¶ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">workerWithTimeout</span>(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, timeout time.Duration) {
    <span class="keyword">select</span> {
    <span class="keyword">case</span> v := &lt;-ch:
        fmt.<span class="function">Printf</span>(<span class="string">"æ”¶åˆ°: %d\n"</span>, v)
    <span class="keyword">case</span> &lt;-time.<span class="function">After</span>(timeout):
        fmt.<span class="function">Println</span>(<span class="string">"è¶…æ—¶"</span>)
    }
}</code></pre>

                <p><strong>6. æ‰‡å‡ºæ¨¡å¼ï¼ˆFan-outï¼‰ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="function">func</span> <span class="function">worker</span>(id <span class="keyword">int</span>, input &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, output <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>) {
    <span class="keyword">defer</span> <span class="keyword">close</span>(output)
    <span class="keyword">for</span> v := <span class="keyword">range</span> input {
        result := v * <span class="number">2</span>  <span class="comment">// å¤„ç†æ•°æ®</span>
        output &lt;- result
        fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å¤„ç†: %d -> %d\n"</span>, id, v, result)
    }
}

<span class="function">func</span> <span class="function">fanOut</span>(input &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, numWorkers <span class="keyword">int</span>) []&lt;-<span class="keyword">chan</span> <span class="keyword">int</span> {
    outputs := <span class="function">make</span>([]&lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, numWorkers)
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; numWorkers; i++ {
        outputs[i] = <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
        <span class="keyword">go</span> <span class="function">worker</span>(i, input, outputs[i])
    }
    <span class="keyword">return</span> outputs
}</code></pre>

                <p><strong>7. æ‰‡å…¥æ¨¡å¼ï¼ˆFan-inï¼‰ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"sync"</span>
)

<span class="function">func</span> <span class="function">fanIn</span>(inputs ...&lt;-<span class="keyword">chan</span> <span class="keyword">int</span>) &lt;-<span class="keyword">chan</span> <span class="keyword">int</span> {
    output := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">var</span> wg sync.WaitGroup
    
    <span class="keyword">for</span> _, input := <span class="keyword">range</span> inputs {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="keyword">func</span>(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>) {
            <span class="keyword">defer</span> wg.<span class="function">Done</span>()
            <span class="keyword">for</span> v := <span class="keyword">range</span> ch {
                output &lt;- v
            }
        }(input)
    }
    
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        wg.<span class="function">Wait</span>()
        <span class="keyword">close</span>(output)
    }()
    
    <span class="keyword">return</span> output
}</code></pre>

                <p><strong>8. ä½¿ç”¨ Channel å®ç°ä¿¡å·é‡ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="comment">// é™åˆ¶å¹¶å‘æ•°</span>
<span class="function">func</span> <span class="function">semaphore</span>(maxConcurrent <span class="keyword">int</span>) {
    sem := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{}, maxConcurrent)
    
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {
        sem &lt;- <span class="keyword">struct</span>{}{}  <span class="comment">// è·å–ä¿¡å·é‡</span>
        <span class="keyword">go</span> <span class="keyword">func</span>(id <span class="keyword">int</span>) {
            <span class="keyword">defer</span> <span class="keyword">func</span>() { &lt;-sem }()  <span class="comment">// é‡Šæ”¾ä¿¡å·é‡</span>
            <span class="function">doWork</span>(id)
        }(i)
    }
}

<span class="function">func</span> <span class="function">doWork</span>(id <span class="keyword">int</span>) {
    fmt.<span class="function">Printf</span>(<span class="string">"Task %d å¼€å§‹\n"</span>, id)
}</code></pre>

                <p><strong>9. Channel æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼š</strong></p>
                <ul>
                    <li><strong>é¢„åˆ†é…ç¼“å†²åŒº</strong>ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ç¼“å†²å¤§å°</li>
                    <li><strong>é¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ channel</strong>ï¼šé‡ç”¨ channel</li>
                    <li><strong>ä½¿ç”¨æŒ‡é’ˆä¼ é€’å¤§å¯¹è±¡</strong>ï¼šå‡å°‘æ‹·è´å¼€é”€</li>
                    <li><strong>æ‰¹é‡å¤„ç†æ•°æ®</strong>ï¼šå‡å°‘ channel æ“ä½œæ¬¡æ•°</li>
                </ul>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">type</span> LargeData <span class="keyword">struct</span> {
    <span class="comment">// å¤§é‡å­—æ®µ</span>
}

<span class="comment">// ä¼ é€’æŒ‡é’ˆè€Œä¸æ˜¯å€¼</span>
<span class="function">func</span> <span class="function">pointerChannel</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> *LargeData, <span class="number">100</span>)
    
    data := &amp;LargeData{}
    ch &lt;- data  <span class="comment">// åªä¼ é€’æŒ‡é’ˆ</span>
}

<span class="comment">// æ‰¹é‡å¤„ç†</span>
<span class="function">func</span> <span class="function">batchProcess</span>(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, batchSize <span class="keyword">int</span>) {
    batch := <span class="function">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, batchSize)
    <span class="keyword">for</span> v := <span class="keyword">range</span> ch {
        batch = <span class="function">append</span>(batch, v)
        <span class="keyword">if</span> <span class="function">len</span>(batch) &gt;= batchSize {
            <span class="function">processBatch</span>(batch)
            batch = batch[:<span class="number">0</span>]
        }
    }
    <span class="keyword">if</span> <span class="function">len</span>(batch) &gt; <span class="number">0</span> {
        <span class="function">processBatch</span>(batch)
    }
}</code></pre>

                <p><strong>10. Channel é”™è¯¯å¤„ç†ï¼š</strong></p>
                <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">safeChannelOperations</span>() {
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    
    <span class="keyword">go</span> <span class="keyword">func</span>() {
        <span class="keyword">defer</span> <span class="keyword">close</span>(ch)
        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {
            ch &lt;- i
        }
    }()
    
    <span class="keyword">for</span> {
        <span class="keyword">select</span> {
        <span class="keyword">case</span> v, ok := &lt;-ch:
            <span class="keyword">if</span> !ok {
                fmt.<span class="function">Println</span>(<span class="string">"Channel å·²å…³é—­"</span>)
                <span class="keyword">return</span>
            }
            fmt.<span class="function">Printf</span>(<span class="string">"æ”¶åˆ°: %d\n"</span>, v)
        <span class="keyword">case</span> &lt;-time.<span class="function">After</span>(<span class="number">1</span> * time.Second):
            fmt.<span class="function">Println</span>(<span class="string">"è¶…æ—¶"</span>)
            <span class="keyword">return</span>
        }
    }
}</code></pre>

                <p><strong>æ€»ç»“ï¼š</strong></p>
                <ul>
                    <li><strong>å†…éƒ¨åŸç†è¦ç‚¹</strong>ï¼šç¯å½¢é˜Ÿåˆ—ã€ç­‰å¾…é˜Ÿåˆ—ã€ç›´æ¥ä¼ é€’ã€é”ä¿æŠ¤</li>
                    <li><strong>æœ€ä½³å®è·µè¦ç‚¹</strong>ï¼šæ­£ç¡®å…³é—­ã€é¿å…æ³„éœ²ã€ä½¿ç”¨æ–¹å‘æ€§ã€æ‰‡å‡ºæ‰‡å…¥æ¨¡å¼</li>
                    <li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šåˆç†ç¼“å†²ã€æ‰¹é‡å¤„ç†ã€æŒ‡é’ˆä¼ é€’ã€é‡ç”¨ channel</li>
                </ul>
            </div>

            <h2 id="buffered">Buffered Channel</h2>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºå¸¦ç¼“å†²çš„ channel</span>
    ch := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">2</span>)

    ch &lt;- <span class="number">1</span>
    ch &lt;- <span class="number">2</span>

    fmt.<span class="function">Println</span>(&lt;-ch)
    fmt.<span class="function">Println</span>(&lt;-ch)
}</code></pre>

            <h2 id="range">Range å’Œ Close</h2>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="function">func</span> <span class="function">fibonacci</span>(n <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>) {
    x, y := <span class="number">0</span>, <span class="number">1</span>
    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ {
        c &lt;- x
        x, y = y, x+y
    }
    <span class="keyword">close</span>(c) <span class="comment">// å…³é—­ channel</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    c := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)
    <span class="keyword">go</span> <span class="function">fibonacci</span>(<span class="number">cap</span>(c), c)

    <span class="comment">// range ä¼šæŒç»­ä» channel æ¥æ”¶ï¼Œç›´åˆ° channel è¢«å…³é—­</span>
    <span class="keyword">for</span> i := <span class="keyword">range</span> c {
        fmt.<span class="function">Println</span>(i)
    }
}</code></pre>

            <h2 id="select">Select</h2>
            <p>Select è¯­å¥è®© goroutine å¯ä»¥ç­‰å¾…å¤šä¸ªé€šä¿¡æ“ä½œã€‚</p>

            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="function">func</span> <span class="function">fibonacci</span>(c, quit <span class="keyword">chan</span> <span class="keyword">int</span>) {
    x, y := <span class="number">0</span>, <span class="number">1</span>
    <span class="keyword">for</span> {
        <span class="keyword">select</span> {
        <span class="keyword">case</span> c &lt;- x:
            x, y = y, x+y
        <span class="keyword">case</span> &lt;-quit:
            fmt.<span class="function">Println</span>(<span class="string">"quit"</span>)
            <span class="keyword">return</span>
        }
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    c := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    quit := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)

    <span class="keyword">go</span> <span class="function">func</span>() {
        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {
            fmt.<span class="function">Println</span>(&lt;-c)
        }
        quit &lt;- <span class="number">0</span>
    }()

    <span class="function">fibonacci</span>(c, quit)
}</code></pre>

            <h2 id="default">é»˜è®¤é€‰æ‹©</h2>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    tick := time.<span class="function">Tick</span>(<span class="number">100</span> * time.Millisecond)
    boom := time.<span class="function">After</span>(<span class="number">500</span> * time.Millisecond)

    <span class="keyword">for</span> {
        <span class="keyword">select</span> {
        <span class="keyword">case</span> &lt;-tick:
            fmt.<span class="function">Println</span>(<span class="string">"tick."</span>)
        <span class="keyword">case</span> &lt;-boom:
            fmt.<span class="function">Println</span>(<span class="string">"BOOM!"</span>)
            <span class="keyword">return</span>
        <span class="keyword">default</span>:
            fmt.<span class="function">Println</span>(<span class="string">"    ."</span>)
            time.<span class="function">Sleep</span>(<span class="number">50</span> * time.Millisecond)
        }
    }
}</code></pre>

            <h2 id="mutex">äº’æ–¥é”ï¼ˆMutexï¼‰</h2>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"sync"</span>
    <span class="string">"time"</span>
)

<span class="comment">// SafeCounter æ˜¯å¹¶å‘å®‰å…¨çš„è®¡æ•°å™¨</span>
<span class="keyword">type</span> SafeCounter <span class="keyword">struct</span> {
    mu sync.Mutex
    v  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>
}

<span class="function">func</span> (c *SafeCounter) <span class="function">Inc</span>(key <span class="keyword">string</span>) {
    c.mu.<span class="function">Lock</span>()
    <span class="comment">// Lock ä¹‹ååŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª goroutine èƒ½è®¿é—® c.v</span>
    c.v[key]++
    c.mu.<span class="function">Unlock</span>()
}

<span class="function">func</span> (c *SafeCounter) <span class="function">Value</span>(key <span class="keyword">string</span>) <span class="keyword">int</span> {
    c.mu.<span class="function">Lock</span>()
    <span class="comment">// Lock ä¹‹ååŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª goroutine èƒ½è®¿é—® c.v</span>
    <span class="keyword">defer</span> c.mu.<span class="function">Unlock</span>()
    <span class="keyword">return</span> c.v[key]
}

<span class="function">func</span> <span class="function">main</span>() {
    c := SafeCounter{v: <span class="function">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)}

    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ {
        <span class="keyword">go</span> c.<span class="function">Inc</span>(<span class="string">"somekey"</span>)
    }

    time.<span class="function">Sleep</span>(time.Second)
    fmt.<span class="function">Println</span>(c.<span class="function">Value</span>(<span class="string">"somekey"</span>))
}</code></pre>

            <h2 id="waitgroup">WaitGroup</h2>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"sync"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">worker</span>(id <span class="keyword">int</span>, wg *sync.WaitGroup) {
    <span class="keyword">defer</span> wg.<span class="function">Done</span>()

    fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å¼€å§‹å·¥ä½œ\n"</span>, id)
    time.<span class="function">Sleep</span>(time.Second)
    fmt.<span class="function">Printf</span>(<span class="string">"Worker %d å®Œæˆå·¥ä½œ\n"</span>, id)
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="keyword">var</span> wg sync.WaitGroup

    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++ {
        wg.<span class="function">Add</span>(<span class="number">1</span>)
        <span class="keyword">go</span> <span class="function">worker</span>(i, &amp;wg)
    }

    wg.<span class="function">Wait</span>()
    fmt.<span class="function">Println</span>(<span class="string">"æ‰€æœ‰ worker å®Œæˆ"</span>)
}</code></pre>

            <h2 id="context">Context</h2>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// åˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„ context</span>
    ctx, cancel := context.<span class="function">WithCancel</span>(context.<span class="function">Background</span>())

    <span class="keyword">go</span> <span class="function">func</span>() {
        <span class="keyword">for</span> {
            <span class="keyword">select</span> {
            <span class="keyword">case</span> &lt;-ctx.<span class="function">Done</span>():
                fmt.<span class="function">Println</span>(<span class="string">"goroutine è¢«å–æ¶ˆ"</span>)
                <span class="keyword">return</span>
            <span class="keyword">default</span>:
                fmt.<span class="function">Println</span>(<span class="string">"goroutine è¿è¡Œä¸­"</span>)
                time.<span class="function">Sleep</span>(<span class="number">500</span> * time.Millisecond)
            }
        }
    }()

    time.<span class="function">Sleep</span>(<span class="number">2</span> * time.Second)
    fmt.<span class="function">Println</span>(<span class="string">"å–æ¶ˆ goroutine"</span>)
    <span class="function">cancel</span>()
    time.<span class="function">Sleep</span>(time.Second)
}</code></pre>

            <h2 id="timeout">è¶…æ—¶æ§åˆ¶</h2>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"context"</span>
    <span class="string">"fmt"</span>
    <span class="string">"time"</span>
)

<span class="function">func</span> <span class="function">longRunningTask</span>(ctx context.Context) {
    <span class="keyword">select</span> {
    <span class="keyword">case</span> &lt;-time.<span class="function">After</span>(<span class="number">5</span> * time.Second):
        fmt.<span class="function">Println</span>(<span class="string">"ä»»åŠ¡å®Œæˆ"</span>)
    <span class="keyword">case</span> &lt;-ctx.<span class="function">Done</span>():
        fmt.<span class="function">Println</span>(<span class="string">"ä»»åŠ¡è¶…æ—¶:"</span>, ctx.<span class="function">Err</span>())
    }
}

<span class="function">func</span> <span class="function">main</span>() {
    <span class="comment">// è®¾ç½® 2 ç§’è¶…æ—¶</span>
    ctx, cancel := context.<span class="function">WithTimeout</span>(context.<span class="function">Background</span>(), <span class="number">2</span>*time.Second)
    <span class="keyword">defer</span> <span class="function">cancel</span>()

    <span class="function">longRunningTask</span>(ctx)
}</code></pre>
        </div>
    </div>
</body>
</html>