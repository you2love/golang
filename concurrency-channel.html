<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channel - Go å­¦ä¹ æ•™ç¨‹</title>
    <link rel="stylesheet" href="styles.css?v=1.4">
    </head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- å¯¼èˆªæ å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </aside>
                <div class="content">
            <a href="concurrency.html" class="back-link">â† è¿”å› concurrency</a>
            <h1>Channel</h1>
            <p class="intro">Channel æ˜¯ goroutine ä¹‹é—´çš„é€šä¿¡ç®¡é“ï¼Œå®ç° CSP æ¨¡å‹ã€‚</p>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="icon">ğŸ“¨</div>
                    <h4>åˆ›å»º</h4>
                    <p>make(chan Type)</p>
                </div>
                <div class="feature-card">
                    <div class="icon">ğŸ“¤</div>
                    <h4>å‘é€</h4>
                    <p>ch <- value</p>
                </div>
                <div class="feature-card">
                    <div class="icon">ğŸ“¥</div>
                    <h4>æ¥æ”¶</h4>
                    <p><-ch</p>
                </div>
                <div class="feature-card">
                    <div class="icon">ğŸ”’</div>
                    <h4>å…³é—­</h4>
                    <p>close(ch)</p>
                </div>
            </div>

            <h2 id="channel">Channel</h2>
            <p>Channel æ˜¯ goroutine ä¹‹é—´é€šä¿¡çš„ç®¡é“ã€‚</p>

            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string">"fmt"</span>

<span class="function">func</span> <span class="function">sum</span>(s []<span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>) {
    sum := <span class="number">0</span>
    <span class="keyword">for</span> _, v := <span class="keyword">range</span> s {
        sum += v
    }
    c &lt;- sum <span class="comment">// å°†å’Œå‘é€åˆ° channel</span>
}

<span class="function">func</span> <span class="function">main</span>() {
    s := []<span class="keyword">int</span>{<span class="number">7</span>, <span class="number">2</span>, <span class="number">8</span>, -<span class="number">9</span>, <span class="number">4</span>, <span class="number">0</span>}

    c := <span class="function">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)
    <span class="keyword">go</span> <span class="function">sum</span>(s[:<span class="function">len</span>(s)/<span class="number">2</span>], c)
    <span class="keyword">go</span> <span class="function">sum</span>(s[<span class="function">len</span>(s)/<span class="number">2</span>:], c)
    x, y := &lt;-c, &lt;-c <span class="comment">// ä» channel æ¥æ”¶</span>

    fmt.<span class="function">Println</span>(x, y, x+y)
}</code></pre>

            <div class="note-box">
                <h3>Channel å†…éƒ¨å®ç°åŸç†</h3>
                
                <p><strong>1. Channel çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</strong></p>
                <p>Channel åœ¨ Go è¿è¡Œæ—¶ä¸­çš„æ ¸å¿ƒç»“æ„æ˜¯ <code>hchan</code>ï¼š</p>
                <pre><code><span class="comment">// runtime/chan.go - Channel çš„æ ¸å¿ƒç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
<span class="keyword">type</span> hchan <span class="keyword">struct</span> {
    qcount   uint           <span class="comment">// å½“å‰é˜Ÿåˆ—ä¸­å…ƒç´ ä¸ªæ•°</span>
    dataqsiz uint           <span class="comment">// ç¯å½¢é˜Ÿåˆ—å¤§å°ï¼ˆå®¹é‡ï¼‰</span>
    buf      unsafe.Pointer <span class="comment">// ç¯å½¢é˜Ÿåˆ—æŒ‡é’ˆ</span>
    elemsize uint16         <span class="comment">// å…ƒç´ å¤§å°</span>
    closed   uint32         <span class="comment">// channel æ˜¯å¦å…³é—­</span>
    elemtype *_type         <span class="comment">// å…ƒç´ ç±»å‹</span>
    sendx    uint           <span class="comment">// å‘é€ç´¢å¼•</span>
    recvx    uint           <span class="comment">// æ¥æ”¶ç´¢å¼•</span>
    recvq    waitq          <span class="comment">// æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—</span>
    sendq    waitq          <span class="comment">// å‘é€ç­‰å¾…é˜Ÿåˆ—</span>
    lock     mutex          <span class="comment">// äº’æ–¥é”</span>
}</code></pre>

                <p><strong>2. ç¯å½¢é˜Ÿåˆ—å®ç°ï¼š</strong></p>
                <p>Channel ä½¿ç”¨ç¯å½¢é˜Ÿåˆ—æ¥å­˜å‚¨æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å¾ªç¯ç¼“å†²åŒºï¼š</p>
                <pre><code><span class="comment">// ç¯å½¢é˜Ÿåˆ—çš„å·¥ä½œåŸç†ç¤ºä¾‹</span>
<span class="comment">// å‡è®¾å®¹é‡ä¸º 5 çš„ channel</span>

<span class="comment">// åˆå§‹çŠ¶æ€: []</span>
<span class="comment">// sendx = 0, recvx = 0</span>

<span class="comment">// å‘é€ 1, 2, 3: [1, 2, 3, _, _]</span>
<span class="comment">// sendx = 3, recvx = 0</span>

<span class="comment">// æ¥æ”¶ 2 ä¸ªå€¼: [_, _, 3, _, _]</span>
<span class="comment">// sendx = 3, recvx = 2</span>

<span class="comment">// ç»§ç»­å‘é€ 4, 5: [_, _, 3, 4, 5]</span>
<span class="comment">// sendx = 0, recvx = 2 (å¾ªç¯å›åˆ°å¼€å¤´)</span>

<span class="comment">// æ¥æ”¶ 3 ä¸ªå€¼: [_, _, _, _, _]</span>
<span class="comment">// sendx = 0, recvx = 0 (é˜Ÿåˆ—ä¸ºç©º)</span></code></pre>

                <p><strong>3. å‘é€æ“ä½œæµç¨‹ï¼š</strong></p>
                <pre><code><span class="comment">// å‘é€æ“ä½œ: ch &lt;- value</span>

<span class="comment">// æ­¥éª¤ 1: è·å– channel é”</span>
<span class="comment">// lock(&amp;c.lock)</span>

<span class="comment">// æ­¥éª¤ 2: æ£€æŸ¥æ˜¯å¦æœ‰æ¥æ”¶è€…åœ¨ç­‰å¾…</span>
<span class="keyword">if</span> sg := c.recvq.<span class="function">dequeue</span>(); sg != <span class="keyword">nil</span> {
    <span class="comment">// ç›´æ¥ä¼ é€’æ•°æ®ç»™æ¥æ”¶è€…ï¼Œä¸ç»è¿‡ç¼“å†²åŒº</span>
    <span class="function">send</span>(c, sg, ep)
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 3: å¦‚æœç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œæ”¾å…¥ç¼“å†²åŒº</span>
<span class="keyword">if</span> c.qcount &lt; c.dataqsiz {
    <span class="comment">// å°†æ•°æ®æ”¾å…¥ç¯å½¢é˜Ÿåˆ—</span>
    qp := <span class="function">chanbuf</span>(c, c.sendx)
    <span class="function">typedmemmove</span>(c.elemtype, qp, ep)
    c.sendx++
    <span class="keyword">if</span> c.sendx == c.dataqsiz {
        c.sendx = <span class="number">0</span>
    }
    c.qcount++
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 4: ç¼“å†²åŒºå·²æ»¡ï¼Œé˜»å¡å½“å‰ goroutine</span>
<span class="comment">// å°†å½“å‰ goroutine åŠ å…¥å‘é€ç­‰å¾…é˜Ÿåˆ—</span>
<span class="comment">// gopark() - è®©å‡º CPUï¼Œç­‰å¾…è¢«å”¤é†’</span></code></pre>

                <p><strong>4. æ¥æ”¶æ“ä½œæµç¨‹ï¼š</strong></p>
                <pre><code><span class="comment">// æ¥æ”¶æ“ä½œ: value := &lt;-ch</span>

<span class="comment">// æ­¥éª¤ 1: è·å– channel é”</span>
<span class="comment">// lock(&amp;c.lock)</span>

<span class="comment">// æ­¥éª¤ 2: æ£€æŸ¥æ˜¯å¦æœ‰å‘é€è€…åœ¨ç­‰å¾…</span>
<span class="keyword">if</span> sg := c.sendq.<span class="function">dequeue</span>(); sg != <span class="keyword">nil</span> {
    <span class="comment">// ç›´æ¥ä»å‘é€è€…è·å–æ•°æ®</span>
    <span class="function">recv</span>(c, sg, ep)
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 3: å¦‚æœç¼“å†²åŒºæœ‰æ•°æ®ï¼Œä»ç¼“å†²åŒºè¯»å–</span>
<span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> {
    qp := <span class="function">chanbuf</span>(c, c.recvx)
    <span class="keyword">if</span> ep != <span class="keyword">nil</span> {
        <span class="function">typedmemmove</span>(c.elemtype, ep, qp)
    }
    <span class="function">typedmemclr</span>(c.elemtype, qp)
    c.recvx++
    <span class="keyword">if</span> c.recvx == c.dataqsiz {
        c.recvx = <span class="number">0</span>
    }
    c.qcount--
    <span class="keyword">return</span>
}

<span class="comment">// æ­¥éª¤ 4: ç¼“å†²åŒºä¸ºç©ºä¸”æœªå…³é—­ï¼Œé˜»å¡å½“å‰ goroutine</span>
<span class="comment">// å°†å½“å‰ goroutine åŠ å…¥æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—</span>
<span class="comment">// gopark() - è®©å‡º CPUï¼Œç­‰å¾…è¢«å”¤é†’</span></code></pre>

                <p><strong>5. å…³é—­æ“ä½œæµç¨‹ï¼š</strong></p>
                <pre><code><span class="comment">// å…³é—­æ“ä½œ: close(ch)</span>

<span class="comment">// æ­¥éª¤ 1: è·å– channel é”</span>
<span class="comment">// lock(&amp;c.lock)</span>

<span class="comment">// æ­¥éª¤ 2: æ ‡è®° channel ä¸ºå·²å…³é—­</span>
c.closed = <span class="number">1</span>

<span class="comment">// æ­¥éª¤ 3: å”¤é†’æ‰€æœ‰ç­‰å¾…çš„æ¥æ”¶è€…</span>
<span class="keyword">for</span> {
    sg := c.recvq.<span class="function">dequeue</span>()
    <span class="keyword">if</span> sg == <span class="keyword">nil</span> {
        <span class="keyword">break</span>
    }
    sg.elem = <span class="keyword">nil</span>  <span class="comment">// æ¥æ”¶è€…è·å¾—é›¶å€¼</span>
    <span class="function">goready</span>(sg.g)  <span class="comment">// å”¤é†’ goroutine</span>
}

<span class="comment">// æ­¥éª¤ 4: å”¤é†’æ‰€æœ‰ç­‰å¾…çš„å‘é€è€…ï¼ˆå®ƒä»¬ä¼š panicï¼‰</span>
<span class="keyword">for</span> {
    sg := c.sendq.<span class="function">dequeue</span>()
    <span class="keyword">if</span> sg == <span class="keyword">nil</span> {
        <span class="keyword">break</span>
    }
    sg.elem = <span class="keyword">nil</span>
    <span class="function">goready</span>(sg.g)  <span class="comment">// å”¤é†’åå‘é€è€…ä¼š panic</span>
}</code></pre>
            
        </div>
    </div>
<script src="code-collapse.js"></script>

</body>
    <script src="navigation.js"></script>
</html>