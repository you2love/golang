<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viper 配置 - Go 学习教程</title>
    <link rel="stylesheet" href="styles.css?v=1.3">
    </head>
<body>
    <div class="container">
        <aside class="sidebar">
        <!-- 导航栏将通过JavaScript动态加载 -->
    </aside>
                <div class="content">
            <a href="ecosystem.html" class="back-link">← 返回社区库</a>
            <h2 id="viper">Viper 配置</h2>
            
            <h3>简介</h3>
            <p>Viper 是 Go 语言的配置管理库，支持多种配置格式（JSON、TOML、YAML、HCL、envfile 等），可以从文件、环境变量、命令行参数等多种来源读取配置，并支持配置热重载。</p>
            
            <h3>安装</h3>
            <pre><code><span class="keyword">go</span> get github.com/spf13/viper</code></pre>
            
            <h3>快速开始</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// 设置配置文件名和路径</span>
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    
    <span class="comment">// 读取配置文件</span>
    <span class="keyword">if</span> err := v.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(fmt.<span class="function">Errorf</span>(<span class="string">"Failed to read config file: %s"</span>, err))
    }
    
    <span class="comment">// 获取配置值</span>
    fmt.<span class="function">Println</span>(<span class="string">"Server Port:"</span>, v.<span class="function">GetString</span>(<span class="string">"server.port"</span>))
    fmt.<span class="function">Println</span>(<span class="string">"Database Host:"</span>, v.<span class="function">GetString</span>(<span class="string">"database.host"</span>))
}</code></pre>
            
            <h3>配置文件示例</h3>
            <pre><code><span class="comment"># config.yaml</span>
server:
  port: <span class="number">8080</span>
  host: localhost

database:
  host: localhost
  port: <span class="number">3306</span>
  name: mydb
  user: root
  password: secret

logging:
  level: info
  format: json</code></pre>
            
            <h3>读取配置</h3>
            <pre><code><span class="comment">// 获取字符串</span>
port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)

<span class="comment">// 获取整数</span>
port := v.<span class="function">GetInt</span>(<span class="string">"server.port"</span>)

<span class="comment">// 获取布尔值</span>
debug := v.<span class="function">GetBool</span>(<span class="string">"debug"</span>)

<span class="comment">// 获取浮点数</span>
timeout := v.<span class="function">GetFloat64</span>(<span class="string">"timeout"</span>)

<span class="comment">// 获取时间</span>
duration := v.<span class="function">GetDuration</span>(<span class="string">"timeout"</span>)

<span class="comment">// 获取字符串切片</span>
hosts := v.<span class="function">GetStringSlice</span>(<span class="string">"servers.hosts"</span>)

<span class="comment">// 获取所有配置</span>
all := v.<span class="function">AllSettings</span>()

<span class="comment">// 检查键是否存在</span>
<span class="keyword">if</span> v.<span class="function">IsSet</span>(<span class="string">"server.port"</span>) {
    port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
}

<span class="comment">// 获取子配置</span>
server := v.<span class="function">Sub</span>(<span class="string">"server"</span>)
port := server.<span class="function">GetString</span>(<span class="string">"port"</span>)</code></pre>
            
            <h3>环境变量</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// 绑定环境变量</span>
    v.<span class="function">BindEnv</span>(<span class="string">"server.port"</span>, <span class="string">"SERVER_PORT"</span>)
    v.<span class="function">BindEnv</span>(<span class="string">"database.host"</span>, <span class="string">"DB_HOST"</span>)
    
    <span class="comment">// 自动绑定环境变量（使用前缀）</span>
    v.<span class="function">SetEnvPrefix</span>(<span class="string">"APP"</span>)
    v.<span class="function">AutomaticEnv</span>()
    <span class="comment">// APP_SERVER_PORT -> server.port</span>
    
    <span class="comment">// 设置默认值</span>
    v.<span class="function">SetDefault</span>(<span class="string">"server.port"</span>, <span class="number">8080</span>)
    v.<span class="function">SetDefault</span>(<span class="string">"debug"</span>, <span class="keyword">false</span>)
    
    <span class="comment">// 读取环境变量</span>
    port := v.<span class="function">GetString</span>(<span class="string">"server.port"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
}</code></pre>
            
            <h3>命令行参数</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/cobra"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="keyword">var</span> rootCmd = &cobra.Command{
    <span class="function">Run</span>: <span class="keyword">func</span>(cmd *cobra.Command, args []<span class="keyword">string</span>) {
        port := viper.<span class="function">GetInt</span>(<span class="string">"port"</span>)
        fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
    },
}

<span class="function">func</span> <span class="function">init</span>() {
    rootCmd.<span class="function">PersistentFlags</span>().<span class="function">Int</span>(<span class="string">"port"</span>, <span class="number">8080</span>, <span class="string">"Server port"</span>)
    viper.<span class="function">BindPFlag</span>(<span class="string">"port"</span>, rootCmd.<span class="function">PersistentFlags</span>().<span class="function">Lookup</span>(<span class="string">"port"</span>))
}

<span class="function">func</span> <span class="function">main</span>() {
    cobra.<span class="function">Execute</span>()
}</code></pre>
            
            <h3>配置热重载</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"log"</span>
    <span class="string">"github.com/fsnotify/fsnotify"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    
    <span class="keyword">if</span> err := v.<span class="function">ReadInConfig</span>(); err != <span class="keyword">nil</span> {
        <span class="function">panic</span>(err)
    }
    
    <span class="comment">// 监听配置文件变化</span>
    v.<span class="function">OnConfigChange</span>(<span class="keyword">func</span>(e fsnotify.Event) {
        fmt.<span class="function">Printf</span>(<span class="string">"Config file changed: %s\n"</span>, e.Name)
        log.<span class="function">Println</span>(<span class="string">"Reloading config..."</span>)
    })
    
    v.<span class="function">WatchConfig</span>()
    
    <span class="comment">// 主循环</span>
    <span class="keyword">select</span> {}
}</code></pre>
            
            <h3>多配置源</h3>
            <pre><code><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string">"fmt"</span>
    <span class="string">"github.com/spf13/viper"</span>
)

<span class="function">func</span> <span class="function">main</span>() {
    v := viper.<span class="function">New</span>()
    
    <span class="comment">// 1. 设置默认值</span>
    v.<span class="function">SetDefault</span>(<span class="string">"server.port"</span>, <span class="number">8080</span>)
    
    <span class="comment">// 2. 读取配置文件</span>
    v.<span class="function">SetConfigName</span>(<span class="string">"config"</span>)
    v.<span class="function">SetConfigType</span>(<span class="string">"yaml"</span>)
    v.<span class="function">AddConfigPath</span>(<span class="string">"./"</span>)
    v.<span class="function">ReadInConfig</span>()
    
    <span class="comment">// 3. 读取环境变量</span>
    v.<span class="function">SetEnvPrefix</span>(<span class="string">"APP"</span>)
    v.<span class="function">AutomaticEnv</span>()
    
    <span class="comment">// 4. 读取命令行参数</span>
    <span class="comment">// 使用 cobra 绑定</span>
    
    <span class="comment">// 优先级：命令行参数 > 环境变量 > 配置文件 > 默认值</span>
    port := v.<span class="function">GetInt</span>(<span class="string">"server.port"</span>)
    fmt.<span class="function">Println</span>(<span class="string">"Port:"</span>, port)
}</code></pre>
            
            
        </div>
    </div>
<script src="code-collapse.js"></script>

</body>
    <script src="navigation.js"></script>
</html>